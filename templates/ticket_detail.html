<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="AutoAssistGroup Support Ticket #{{ ticket.ticket_id }} - {{ ticket.subject[:100] }}">
    <meta name="robots" content="noindex, nofollow">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="theme-color" content="#4f46e5">
    <title>Ticket #{{ ticket.ticket_id }} - AutoAssistGroup Portal</title>

    <!-- Preconnect to external domains for performance -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Optimized external stylesheets -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" media="all">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" media="all">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet"
        media="all">
    <style>
        /* CRITICAL: Hide sidebar immediately when page loads */
        .right-sidebar {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            transform: translateX(200%) !important;
            pointer-events: none !important;
        }

        /* Only show when explicitly opened */
        .right-sidebar.sidebar-open,
        .right-sidebar.ultra-wide-open {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            transform: translateX(0) !important;
            pointer-events: auto !important;
        }
        
        /* CRITICAL: Ensure sidebar is hidden by default on page load */
        .right-sidebar:not(.sidebar-open):not(.ultra-wide-open) {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            transform: translateX(200%) !important;
            pointer-events: none !important;
        }

        :root {
            --primary: #4f46e5;
            --urgent: #ef4444;
            --fast: #f59e0b;
            --medium: #ec4899;
            --low: #10b981;
        }

        /* ===== NORMAL UI STYLES - READABLE SIZES ===== */

        /* Critical CSS optimizations */
        * {
            box-sizing: border-box;
        }

        /* IMMEDIATE SIDEBAR HIDING - runs before any other CSS */
        .right-sidebar {
            transform: translateX(200%) !important;
            pointer-events: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            display: none !important;
        }

        /* Force hide sidebar on page load - highest specificity */
        body .right-sidebar {
            transform: translateX(120%) !important;
            pointer-events: none !important;
            visibility: visible !important;
            opacity: 1 !important;
            display: block !important;
        }

        /* Only show when explicitly opened */
        body .right-sidebar.sidebar-open,
        body .right-sidebar.ultra-wide-open {
            transform: translateX(0) !important;
            pointer-events: auto !important;
            visibility: visible !important;
            opacity: 1 !important;
            display: block !important;
        }

        /* Additional force hiding for any edge cases */
        html body .right-sidebar {
            transform: translateX(200%) !important;
            pointer-events: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            display: none !important;
        }

        html body .right-sidebar.sidebar-open,
        html body .right-sidebar.ultra-wide-open {
            transform: translateX(0) !important;
            pointer-events: auto !important;
            visibility: visible !important;
            opacity: 1 !important;
            display: block !important;
        }

        /* CRITICAL: Force hide sidebar on page load with maximum specificity */
        html body div#rightSidebar.right-sidebar {
            transform: translateX(200%) !important;
            pointer-events: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            display: none !important;
        }

        /* CRITICAL: Only show when explicitly opened with maximum specificity */
        html body div#rightSidebar.right-sidebar.sidebar-open,
        html body div#rightSidebar.right-sidebar.ultra-wide-open {
            transform: translateX(0) !important;
            pointer-events: auto !important;
            visibility: visible !important;
            opacity: 1 !important;
            display: block !important;
        }

        /* NUCLEAR OPTION: Completely remove sidebar from layout when hidden */
        .right-sidebar:not(.sidebar-open):not(.ultra-wide-open) {
            position: absolute !important;
            left: -9999px !important;
            top: -9999px !important;
            width: 0 !important;
            height: 0 !important;
            overflow: hidden !important;
            clip: rect(0, 0, 0, 0) !important;
            margin: -1px !important;
            padding: 0 !important;
            border: 0 !important;
        }

        /* CRITICAL: Force hide sidebar by default - this MUST work */
        .right-sidebar {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            transform: translateX(200%) !important;
            pointer-events: none !important;
        }

        /* Only show when explicitly opened */
        .right-sidebar.sidebar-open,
        .right-sidebar.ultra-wide-open {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            transform: translateX(0) !important;
            pointer-events: auto !important;
        }

        /* ===== 2560PX OPTIMIZATION STYLES ===== */
        
        /* Container optimization for 2560px */
        .max-w-screen-ultra {
            max-width: 2400px;
        }
        
        /* Grid optimization for ultra-wide */
        .grid-cols-ultra {
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        }

        /* Enhanced ticket header layout for ultra-wide */
        .ticket-header-ultra {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 3rem;
            align-items: start;
        }

        .ticket-header-main {
            grid-column: 1;
        }

        .ticket-header-actions {
            grid-column: 2;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: flex-end;
        }

        /* Enhanced badge layout for ultra-wide */
        .badge-container-ultra {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: center;
        }

        /* Enhanced action buttons layout for ultra-wide */
        .action-buttons-ultra {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            align-items: flex-end;
        }
        
        /* Enhanced layout for ultra-wide screens */
        @media (min-width: 2560px) {
            body {
                font-size: 1.1rem !important;
            }
            
            .container {
                max-width: 2400px !important;
                padding-left: 3rem !important;
                padding-right: 3rem !important;
            }
            
            /* Enhanced stats cards layout */
            .stats-grid {
                grid-template-columns: repeat(4, minmax(300px, 1fr)) !important;
                gap: 2.5rem !important;
            }
            
            /* Enhanced management sections */
            .management-grid {
                grid-template-columns: repeat(3, minmax(400px, 1fr)) !important;
                gap: 2.5rem !important;
            }
            
            /* Enhanced cards */
            .dashboard-card, .ticket-card, .stats-card {
                padding: 2rem !important;
                margin-bottom: 2rem !important;
                border-radius: 0.75rem !important;
            }
            
            /* Enhanced typography */
            h1 { font-size: 2.25rem !important; }
            h2 { font-size: 1.875rem !important; }
            h3 { font-size: 1.5rem !important; }
            h4 { font-size: 1.25rem !important; }
            
            /* Enhanced buttons */
            button, .btn {
                padding: 1rem 2rem !important;
                font-size: 1.1rem !important;
                border-radius: 0.5rem !important;
            }
            
            /* Enhanced modals */
            .modal-content {
                padding: 3rem !important;
                max-width: 600px !important;
            }
            
            /* Optimize navigation for ultra-wide */
            nav .container {
                padding-left: 3rem !important;
                padding-right: 3rem !important;
            }
            
            nav .hidden.md\:flex {
                gap: 2rem !important;
            }
            
            /* Better ticket card layout for wide screens */
            .ticket-card {
                display: grid;
                grid-template-columns: 1fr auto;
                gap: 1.5rem;
            }
            
            .ticket-info {
                grid-column: 1;
            }
            
            .ticket-actions {
                grid-column: 2;
                display: flex;
                flex-direction: column;
                justify-content: center;
                gap: 0.5rem;
            }
            
            /* Enhanced sidebar for ultra-wide displays */
            .right-sidebar {
                width: 340px !important;
                right: 2rem !important;
                top: 150px !important;
                bottom: 2rem !important;
                border-radius: 1rem !important;
                box-shadow: -4px 0 20px rgba(0, 0, 0, 0.15) !important;
            }
            
            .right-sidebar .sidebar-section {
                padding: 1.5rem 2rem !important;
                margin-bottom: 2rem !important;
                border-radius: 0.75rem !important;
            }
            
            .right-sidebar .sidebar-title {
                font-size: 1.25rem !important;
                margin-bottom: 1rem !important;
            }
            
            /* Optimize toggle button for ultra-wide */
            .sidebar-toggle {
                width: 64px !important;
                height: 64px !important;
                right: 2rem !important;
                font-size: 1.5rem !important;
                box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25) !important;
            }
            
            /* Enhance main layout spacing */
            .main-layout {
                padding: 0 3rem !important;
            }
            
            .parallel-container {
                gap: 3rem !important;
            }
            
            /* Optimize app container for ultra-wide */
            .app-container {
                flex: 1 !important;
                max-width: none !important;
            }
            
            /* Enhance container responsiveness */
            .container {
                max-width: none !important;
                padding-left: 0 !important;
                padding-right: 0 !important;
            }
            
            /* Optimize priority and classification badges */
            .priority-badge,
            .status-badge {
                padding: 0.75rem 1.5rem !important;
                font-size: 0.875rem !important;
                border-radius: 0.5rem !important;
            }
            
            /* Enhance dropdown styling for large screens */
            .relative.inline-block select {
                padding: 0.75rem 1.5rem !important;
                font-size: 0.875rem !important;
                border-radius: 0.5rem !important;
            }
            
            /* Optimize action buttons for ultra-wide */
            .action-buttons button {
                padding: 1rem 2rem !important;
                font-size: 1rem !important;
                border-radius: 0.5rem !important;
            }
        }


        /* ===== NORMAL UI STYLES - STANDARD SIZES ===== */

        /* ===== NAVBAR HEIGHT REDUCTION ===== */
        nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 10vh;
            min-height: auto;
            z-index: 1000;
        }

        nav .container {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
            height: 100%;
        }

        nav .flex {
            align-items: center;
            min-height: 2.5rem;
            height: 100%;
        }

        /* Normal base font size - READABLE */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f9fafb;
            font-size: 1rem !important;
            line-height: 1.5 !important;
            padding-top: 10vh;
            /* Account for fixed navbar */
            /* Performance optimizations */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            text-rendering: optimizeLegibility;
        }

        /* Normal Cards and Elements */
        .dashboard-card,
        .ticket-card,
        .stats-card {
            padding: 1rem !important;
            margin-bottom: 1rem !important;
            border-radius: 0.5rem !important;
        }

        /* Normal Badges */
        .badge {
            padding: 0.25rem 0.75rem !important;
            font-size: 0.875rem !important;
            font-weight: 500 !important;
        }

        /* Normal Buttons */
        button,
        .btn {
            padding: 0.5rem 1rem !important;
            font-size: 0.875rem !important;
            border-radius: 0.375rem !important;
        }

        /* Normal Headers */
        h1 {
            font-size: 1.875rem !important;
        }

        h2 {
            font-size: 1.5rem !important;
        }

        h3 {
            font-size: 1.25rem !important;
        }

        h4 {
            font-size: 1.125rem !important;
        }

        /* Normal Spacing */
        .p-6 {
            padding: 1.5rem !important;
        }

        .p-4 {
            padding: 1rem !important;
        }

        .m-6 {
            margin: 1.5rem !important;
        }

        .m-4 {
            margin: 1rem !important;
        }

        .mb-6 {
            margin-bottom: 1.5rem !important;
        }

        .mb-4 {
            margin-bottom: 1rem !important;
        }

        /* Normal Icons */
        .fas,
        .fab,
        .far {
            font-size: 1rem !important;
        }

        .ticket-header {
            border-left: 4px solid;
            transition: all 0.3s ease;
        }

        .priority-urgent {
            border-left-color: var(--urgent);
        }

        .priority-fast {
            border-left-color: var(--fast);
        }

        .priority-medium {
            border-left-color: var(--medium);
        }

        .priority-low {
            border-left-color: var(--low);
        }

        .btn-primary {
            background-color: var(--primary);
        }

        .btn-primary:hover {
            background-color: #4338ca;
        }

        /* ===== ENHANCED DRAG & DROP STYLES ===== */

        /* Enhanced drop zone styling */
        #replyDropzone {
            transition: all 0.2s ease;
            position: relative;
        }

        #replyDropzone.drag-over {
            border-color: #3b82f6 !important;
            background-color: #eff6ff !important;
            transform: scale(1.01);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        #replyDropzone.has-attachments {
            border-color: #10b981 !important;
            background-color: #f0fdf4 !important;
        }

        /* Enhanced attachment preview styling */
        #enhancedAttachmentPreview {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-top: 1px solid #e2e8f0;
        }

        #attachmentPreviewList {
            max-height: 200px;
            overflow-y: auto;
        }

        /* Attachment card styling */
        .attachment-card {
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 8px 12px;
            margin: 4px 0;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .attachment-card:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        /* File type icons */
        .file-icon {
            font-size: 1.25rem;
            margin-right: 12px;
            opacity: 0.8;
        }

        /* Remove button styling */
        .remove-attachment {
            color: #ef4444;
            transition: all 0.2s ease;
        }

        .remove-attachment:hover {
            color: #dc2626;
            background-color: #fef2f2;
            transform: scale(1.1);
        }

        /* Clear all button styling */
        #clearAllAttachments {
            transition: all 0.2s ease;
            border-radius: 4px;
        }

        #clearAllAttachments:hover {
            background-color: #fef2f2;
        }

        /* ===== OVERRIDE ALL SMALL SIZES FOR BETTER READABILITY ===== */

        /* Force all text to be readable */
        * {
            font-size: 1rem !important;
        }

        /* Specific overrides for common elements */
        .text-sm,
        .text-xs,
        .text-2xs {
            font-size: 1rem !important;
        }

        /* Override all small padding and margins */
        [class*="p-"] {
            padding: 1.5rem !important;
        }

        [class*="m-"] {
            margin: 1rem !important;
        }

        /* Specific padding overrides */
        .p-1,
        .p-2,
        .p-3,
        .p-4,
        .p-5,
        .p-6 {
            padding: 1rem !important;
        }

        .px-1,
        .px-2,
        .px-3,
        .px-4,
        .px-5,
        .px-6 {
            padding-left: 1rem !important;
            padding-right: 1rem !important;
        }

        .py-1,
        .py-2,
        .py-3,
        .py-4,
        .py-5,
        .py-6 {
            padding-top: 1rem !important;
            padding-bottom: 1rem !important;
        }

        /* Specific margin overrides */
        .m-1,
        .m-2,
        .m-3,
        .m-4,
        .m-5,
        .m-6 {
            margin: 1rem !important;
        }

        .mb-1,
        .mb-2,
        .mb-3,
        .mb-4,
        .mb-5,
        .mb-6 {
            margin-bottom: 1rem !important;
        }

        .mt-1,
        .mt-2,
        .mt-3,
        .mt-4,
        .mt-5,
        .mt-6 {
            margin-top: 1rem !important;
        }

        /* Override all small font sizes */
        .text-xs {
            font-size: 1rem !important;
        }

        .text-sm {
            font-size: 1.125rem !important;
        }

        .text-base {
            font-size: 1.25rem !important;
        }

        .text-lg {
            font-size: 1.5rem !important;
        }

        .text-xl {
            font-size: 1.75rem !important;
        }

        .text-2xl {
            font-size: 2rem !important;
        }

        /* Override icon sizes */
        .fas,
        .fab,
        .far,
        .fa,
        i {
            font-size: 1.25rem !important;
        }

        /* Override button sizes */
        .btn-sm,
        button[class*="btn-"] {
            padding: 0.75rem 1.5rem !important;
            font-size: 1rem !important;
            border-radius: 0.5rem !important;
        }

        /* Override badge sizes */
        .badge-sm,
        .badge-xs {
            padding: 0.5rem 1rem !important;
            font-size: 1rem !important;
            border-radius: 0.5rem !important;
        }

        /* Override card padding */
        .card,
        .dashboard-card,
        .ticket-card,
        .stats-card {
            padding: 1.5rem !important;
            margin-bottom: 1.5rem !important;
            border-radius: 0.75rem !important;
        }

        /* Override form elements */
        input,
        textarea,
        select {
            font-size: 1rem !important;
            padding: 0.75rem !important;
            border-radius: 0.5rem !important;
        }

        /* Override table elements */
        table,
        th,
        td {
            font-size: 1rem !important;
            padding: 0.75rem !important;
        }

        /* Override modal and overlay elements */
        .modal,
        .modal-content,
        .overlay {
            font-size: 1rem !important;
        }

        /* Ensure minimum sizes for touch targets */
        button,
        .btn,
        a,
        input,
        select,
        textarea {
            min-height: 2.5rem !important;
            min-width: 2.5rem !important;
        }

        /* Drop zone instructions */
        .drop-instructions {
            text-align: center;
            padding: 20px;
            color: #6b7280;
            font-size: 0.875rem;
        }

        .drop-instructions i {
            font-size: 2rem;
            margin-bottom: 8px;
            opacity: 0.6;
        }

        /* Animation for new attachments */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .attachment-card {
            animation: slideIn 0.3s ease-out;
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transform: translateX(200%);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            display: flex;
            align-items: center;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background-color: #10b981;
            color: white;
        }

        .notification.error {
            background-color: #ef4444;
            color: white;
        }

        /* Original Message styles */
        .original-message-container {
            background-color: #f8fafc;
            border-radius: 0.75rem;
            padding: 1rem;
        }

        .original-message-content {
            white-space: pre-line;
            word-break: break-word;
            overflow-wrap: break-word;
            max-height: 200px;
            overflow: hidden;
            position: relative;
            hyphens: auto;
        }

        .original-message-content.expanded {
            max-height: none;
        }

        .read-more-btn {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to bottom, transparent, rgba(248, 250, 252, 0.9));
            padding: 2rem 0 0.5rem;
            text-align: center;
            cursor: pointer;
            color: var(--primary);
            font-weight: 500;
            display: none;
        }

        .original-message-content.truncated .read-more-btn {
            display: block;
        }

        /* Importance button styles - NO CIRCLE, JUST STAR */
        .importance-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f9fafb;
            transition: all 0.2s ease;
            border: 1px solid #d1d5db;
            border-radius: 50%;
        }

        .importance-btn:hover {
            border-color: #9ca3af;
            background-color: #f3f4f6;
            border-radius: 50%;
        }

        .importance-btn.important {
            border-color: #f59e0b;
            background-color: #fffbeb;
            border-radius: 50%;
        }

        .importance-btn .star-icon {
            color: #d1d5db;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .importance-btn:hover .star-icon {
            color: #f59e0b;
        }

        .importance-btn.important .star-icon {
            color: #f59e0b;
        }

        /* Conversation styles */
        .conversation-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 1rem 0;
        }

        .message {
            display: flex;
            flex-direction: column;
            max-width: 70%;
            border-radius: 1rem;
            padding: 0.75rem 1rem;
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
            min-width: 0;
        }

        .customer-message {
            align-self: flex-start;
            background-color: #f3f4f6;
            margin-right: 15%;
        }

        .support-message {
            align-self: flex-end;
            background-color: #e0e7ff;
            margin-left: 15%;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .customer-message .message-header {
            color: #4b5563;
        }

        .support-message .message-header {
            color: #1e293b;
        }

        .message-time {
            font-size: 0.75rem;
            font-weight: 600;
            opacity: 0.8;
        }

        .message-content {
            white-space: pre-line;
            word-break: break-word;
            overflow-wrap: break-word;
            font-size: 0.9375rem;
            padding: 8px 0;
            hyphens: auto;
            min-width: 0;
        }

        .reply-message-box {
            max-height: 50px;
            overflow: hidden;
            position: relative;
            transition: max-height 0.3s ease;
        }

        .reply-message-box.expanded {
            max-height: none;
        }

        .reply-message-box .expand-btn {
            position: absolute;
            bottom: 20px;
            left: 6;
            right: 0;
            padding: 20px 0 5px;
            text-align: center;
            cursor: pointer;
            color: rgb(112, 147, 243);
            font-weight: 600;
            display: none;
        }

        .reply-message-box.truncated .expand-btn {
            display: block;
        }

        /* Modern icons */
        .customer-icon {
            color: #4f46e5;
            margin-right: 18px;
            font-size: 1.5rem;
        }

        .support-icon {
            color: #4f46e5;
            margin-right: 8px;
            font-size: 1.2rem;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transform: translateY(20px);
            transition: all 0.3s ease;
            max-width: 90%;
            width: 500px;
            overflow: hidden;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        /* Mobile responsive improvements */
        @media (max-width: 768px) {
            .message {
                max-width: 85%;
                margin-left: 10px !important;
                margin-right: 10px !important;
            }

            .customer-message {
                margin-right: 5%;
            }

            .support-message {
                margin-left: 5%;
            }

            .modal-content {
                max-width: 95%;
                margin: 1rem;
                max-height: 90vh;
            }

            .flex.flex-col.md\:flex-row {
                gap: 1rem;
            }

            .grid.grid-cols-1.md\:grid-cols-3 {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        @media (max-width: 480px) {
            .message {
                max-width: 90%;
                padding: 0.5rem 0.75rem;
            }

            .ticket-header {
                padding: 1rem !important;
            }

            h1 {
                font-size: 1.25rem !important;
                line-height: 1.4;
            }

            .px-6 {
                padding-left: 1rem !important;
                padding-right: 1rem !important;
            }
        }

        /* Line clamp utilities for text truncation */
        .line-clamp-1 {
            display: -webkit-box;
            -webkit-line-clamp: 1;
            line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Responsive word breaking */
        .break-words {
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
        }

        /* Auto-expanding textarea styles */
        .auto-expand-textarea {
            transition: height 0.2s ease-out;
            resize: none;
            overflow: hidden;
        }

        /* Smooth transition for height changes */
        .auto-expand-textarea:focus {
            transition: height 0.15s ease-out;
        }

        /* REMOVED: Annoying blinking blue dot animation
           The pulse animation was causing endless blinking on forwarded tickets */

        /* Forward/Takeover specific styles */
        .forwarded-badge {
            background-color: #e0f2fe !important;
            color: #0369a1 !important;
        }

        .takeover-badge {
            background-color: #dcfce7 !important;
            color: #166534 !important;
            border-left: 3px solid #4ade80 !important;
        }

        .assignment-status {
            position: relative;
            font-size: 0.75rem;
            line-height: 1.2;
        }

        /* REMOVED: All blinking assignment status animations
           These were causing annoying endless blinking on forwarded tickets */

        .takeover-badge.assignment-status::before {
            background-color: #166534;
        }

        /* Card styling */
        .detail-card {
            background-color: #f9fafb;
            border-radius: 0.75rem;
            padding: 0.875rem;
        }

        /* FIXED LAYOUT STYLES */

        /* Custom max-width for 1440px constraint */
        .max-w-1440 {
            max-width: 1440px;
        }

        /* Main layout container - ensure proper positioning for sidebar */
        .main-layout {
            position: relative;
            width: 100%;
            min-height: 100vh;
        }

        /* Parallel container - ensure proper layout for app and sidebar */
        .parallel-container {
            display: flex;
            width: 100%;
            position: relative;
            align-items: flex-start;
        }

        /* App container - ensure it takes up available space */
        .app-container {
            flex: 1;
            width: 100%;
            position: relative;
            transition: all 0.3s ease-in-out;
        }

        /* Right sidebar styles - Ultra compact design */
        .right-sidebar {
            width: 340px;
            position: fixed;
            right: 0;
            height: 100%;
            top: 4rem;
            bottom: 0;
            background: #f8fafc;
            border-left: 1px solid #e2e8f0;
            overflow-y: auto;
            z-index: 42;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            transform: translateX(0);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
        }

        /* Minimized sidebar state */
        .right-sidebar.minimized {
            width: 60px;
            padding: 0.5rem;
        }

        .right-sidebar.minimized .sidebar-section {
            display: none;
        }

        .right-sidebar.minimized .sidebar-header {
            display: none;
        }

        .right-sidebar.minimized .sidebar-content {
            display: none;
        }

        /* Minimize button styles */
        .minimize-btn {
            background: #e2e8f0;
            border: none;
            border-radius: 0.25rem;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .minimize-btn:hover {
            background: #cbd5e1;
        }

        .minimize-btn i {
            font-size: 0.75rem;
            color: #64748b;
        }

        /* Toggle button visibility control */
        .sidebar-toggle {
            display: flex !important;
            position: fixed !important;
            top: 50% !important;
            right: 1rem !important;
            transform: translateY(-50%) !important;
            z-index: 9999 !important;
            background: #4f46e5 !important;
            color: white !important;
            border: 3px solid #ffffff !important;
            width: 56px !important;
            height: 56px !important;
            border-radius: 50% !important;
            align-items: center !important;
            justify-content: center !important;
            cursor: pointer !important;
            box-shadow: 0 4px 16px rgba(79, 70, 229, 0.4) !important;
            transition: all 0.3s ease !important;
        }

        .sidebar-toggle.hidden {
            display: none !important;
        }

        .sidebar-toggle:hover {
            background: #4338ca !important;
            transform: translateY(-50%) scale(1.05) !important;
            box-shadow: 0 6px 20px rgba(79, 70, 229, 0.5) !important;
        }

        .sidebar-toggle i {
            font-size: 1.25rem !important;
        }

        /* Ensure toggle button is always visible when sidebar is closed */
        .sidebar-toggle:not(.hidden) {
            display: flex !important;
            opacity: 1 !important;
            visibility: visible !important;
        }

        /* Hide toggle button only when explicitly hidden */
        .sidebar-toggle.hidden {
            display: none !important;
            opacity: 0 !important;
            visibility: hidden !important;
        }

        /* Responsive toggle button positioning */
        @media (min-width: 1921px) {
            .sidebar-toggle:not(.hidden) {
                right: 2rem !important;
                width: 64px !important;
                height: 64px !important;
            }
            
            .sidebar-toggle:not(.hidden) i {
                font-size: 1.5rem !important;
            }
        }

        @media (max-width: 1920px) {
            .sidebar-toggle:not(.hidden) {
                right: 1rem !important;
                width: 56px !important;
                height: 56px !important;
            }
            
            .sidebar-toggle:not(.hidden) i {
                font-size: 1.25rem !important;
            }
        }

        /* Enhanced mobile and tablet behavior with better responsive coverage */
        @media (max-width: 1280px) {
            .right-sidebar {
                transform: translateX(120%) !important;
                box-shadow: -4px 0 16px rgba(0, 0, 0, 0.1);
                width: 100%;
                top: 118px;
                max-width: 300px;
            }

            .right-sidebar.sidebar-open {
                transform: translateX(0);
                box-shadow: -4px 0 16px rgba(0, 0, 0, 0.12);
            }

            /* Add overlay for mobile - lower z-index to allow drag interactions */
            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.3);
                /* Lighter overlay */
                z-index: 35;
                /* Lower z-index */
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s ease;
            }

            .sidebar-overlay.active {
                opacity: 1;
                visibility: visible;
            }

            /* Ensure draggable elements and main content have higher z-index */
            .main-content,
            .document-item,
            .conversation-container,
            .ticket-header {
                position: relative;
                z-index: 36;
                /* Higher than overlay */
            }

            /* Draggable document items get even higher z-index */
            .document-item[draggable="true"] {
                z-index: 45;
                /* Higher than sidebar */
            }

            /* Interactive form elements should also be above overlay */
            #replyForm,
            .reply-message-box,
            .attachment-preview,
            textarea,
            input {
                position: relative;
                z-index: 36;
                /* Higher than overlay */
            }

            /* Ensure dropzone for file uploads works */
            #attachmentDropzone,
            #attachmentSection {
                position: relative;
                z-index: 36;
            }
        }

        /* Enhanced mobile portrait behavior */
        @media (max-width: 768px) {
            .right-sidebar {
                max-width: 280px;
                top: 100px;
            }

            .sidebar-toggle:not(.hidden) {
                width: 48px !important;
                height: 48px !important;
                right: 0.75rem !important;
            }

            .sidebar-toggle:not(.hidden) i {
                font-size: 1.1rem !important;
            }
        }

        /* Enhanced small mobile behavior */
        @media (max-width: 480px) {
            .right-sidebar {
                max-width: 260px;
                top: 90px;
            }

            .sidebar-toggle:not(.hidden) {
                width: 44px !important;
                height: 44px !important;
                right: 0.5rem !important;
            }

            .sidebar-toggle:not(.hidden) i {
                font-size: 1rem !important;
            }
        }

        /* Enhanced very small mobile behavior */
        @media (max-width: 360px) {
            .right-sidebar {
                max-width: 240px;
                top: 80px;
            }

            .sidebar-toggle:not(.hidden) {
                width: 40px !important;
                height: 40px !important;
                right: 0.25rem !important;
            }

            .sidebar-toggle:not(.hidden) i {
                font-size: 0.9rem !important;
            }

            .container {
                padding-left: 0.75rem;
                padding-right: 0.75rem;
            }
        }

        /* Enhanced landscape mobile behavior */
        @media (max-width: 768px) and (orientation: landscape) {
            .right-sidebar {
                top: 70px;
                max-width: 300px;
            }

            .sidebar-toggle:not(.hidden) {
                top: 60% !important;
            }
        }

        /* Enhanced tablet portrait behavior */
        @media (min-width: 768px) and (max-width: 1024px) and (orientation: portrait) {
            .right-sidebar {
                max-width: 340px;
                top: 120px;
            }

            .sidebar-toggle:not(.hidden) {
                width: 56px !important;
                height: 56px !important;
            }

            .sidebar-toggle:not(.hidden) i {
                font-size: 1.3rem !important;
            }
        }

        /* Container optimization for desktop screens */
        @media (min-width: 1281px) and (max-width: 1920px) {
            /* Ensure container takes full available width */
            .container {
                max-width: none;
                width: 100%;
            }

            /* Hide sidebar by default on all desktop screens */
            .right-sidebar {
                transform: translateX(120%);
                box-shadow: -4px 0 16px rgba(0, 0, 0, 0.1);
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .right-sidebar.sidebar-open {
                transform: translateX(0);
                box-shadow: -4px 0 16px rgba(0, 0, 0, 0.12);
            }

            .app-container.sidebar-open {
                width: calc(100% - 340px) !important;
                max-width: calc(100% - 340px) !important;
            }

            .app-container.sidebar-closed {
                width: 100% !important;
                max-width: 100% !important;
            }
        }

        /* Enhanced responsive breakpoints for better coverage */
        @media (min-width: 1025px) and (max-width: 1280px) {
            /* Medium desktop: hide sidebar by default but allow toggling */
            .right-sidebar {
                transform: translateX(120%);
                box-shadow: -4px 0 16px rgba(0, 0, 0, 0.1);
            }

            .right-sidebar.sidebar-open {
                transform: translateX(0);
                box-shadow: -4px 0 16px rgba(0, 0, 0, 0.12);
            }

            .app-container.sidebar-open {
                width: calc(100% - 340px) !important;
                max-width: calc(100% - 340px) !important;
            }

            .app-container.sidebar-closed {
                width: 100% !important;
                max-width: 100% !important;
            }

            /* Show toggle button for medium desktop */
            .sidebar-toggle {
                display: flex !important;
                position: fixed !important;
                top: 50% !important;
                right: 1rem !important;
                transform: translateY(-50%) !important;
                z-index: 1000 !important;
                background: #4f46e5 !important;
                color: white !important;
                border: none !important;
                border-radius: 50% !important;
                width: 48px !important;
                height: 48px !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                transition: all 0.3s ease !important;
                box-shadow: 0 4px 16px rgba(79, 70, 229, 0.3) !important;
            }

            .sidebar-toggle:hover {
                background: #4338ca;
                transform: translateY(-50%) scale(1.05);
                box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
            }

            .sidebar-toggle i {
                font-size: 1.1rem;
            }
        }

        /* Enhanced tablet landscape behavior */
        @media (min-width: 769px) and (max-width: 1024px) {
            .right-sidebar {
                transform: translateX(100%);
                box-shadow: -4px 0 16px rgba(0, 0, 0, 0.1);
                width: 100%;
                top: 118px;
                max-width: 320px;
            }

            .right-sidebar.sidebar-open {
                transform: translateX(0);
                box-shadow: -4px 0 16px rgba(0, 0, 0, 0.12);
            }

            .app-container {
                width: 100% !important;
                margin-right: 0 !important;
                max-width: 100% !important;
            }

            /* Enhanced toggle button for tablet */
            .sidebar-toggle:not(.hidden) {
                display: flex !important;
                position: fixed !important;
                top: 50% !important;
                right: 1rem !important;
                transform: translateY(-50%) !important;
                z-index: 1000 !important;
                background: #4f46e5 !important;
                color: white !important;
                border: none !important;
                border-radius: 50% !important;
                width: 52px !important;
                height: 52px !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                transition: all 0.3s ease !important;
                box-shadow: 0 4px 16px rgba(79, 70, 229, 0.3) !important;
            }

            .sidebar-toggle:not(.hidden):hover {
                background: #4338ca;
                transform: translateY(-50%) scale(1.05);
                box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
            }

            .sidebar-toggle:not(.hidden) i {
                font-size: 1.2rem;
            }
        }

        /* Enhanced main content expansion when sidebar is hidden */
        .main-content.expanded {
            margin-right: 0 !important;
            max-width: 100% !important;
            width: 100% !important;
            padding-right: 0 !important;
            transition: all 0.3s ease-in-out;
        }

        /* Make main content expanded by default */
        .main-content {
            margin-right: 0 !important;
            max-width: 100% !important;
            width: 100% !important;
            padding-right: 0 !important;
        }

        /* Enhanced responsive behavior for all screen sizes */
        .right-sidebar {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            /* Default state - hidden on all screens */
            transform: translateX(120%) !important;
            pointer-events: none !important;
        }

        /* Ensure sidebar is hidden by default on all screen sizes */
        .right-sidebar:not(.sidebar-open):not(.ultra-wide-open) {
            transform: translateX(120%) !important;
            pointer-events: none !important;
        }

        /* Force sidebar to be hidden on page load - highest priority */
        .right-sidebar {
            transform: translateX(120%) !important;
            pointer-events: none !important;
        }

        /* Only show sidebar when explicitly opened */
        .right-sidebar.sidebar-open,
        .right-sidebar.ultra-wide-open {
            transform: translateX(0) !important;
            pointer-events: auto !important;
        }

        .app-container {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Ensure smooth transitions for all interactive elements */
        .sidebar-toggle,
        .minimize-btn,
        .right-sidebar,
        .sidebar-overlay {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Enhanced responsive container behavior */
        .container {
            transition: all 0.3s ease-in-out;
        }

        /* Ensure consistent spacing across all screen sizes */
        @media (min-width: 320px) {
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
            }
        }

        @media (min-width: 768px) {
            .container {
                padding-left: 1.5rem;
                padding-right: 1.5rem;
            }
        }

        @media (min-width: 1024px) {
            .container {
                padding-left: 2rem;
                padding-right: 2rem;
            }
        }

        @media (min-width: 1280px) {
            .container {
                padding-left: 2.5rem;
                padding-right: 2.5rem;
            }
        }

        @media (min-width: 1920px) {
            .container {
                padding-left: 3rem;
                padding-right: 3rem;
            }
        }

        /* When sidebar is closed, expand app container to full width */
        .app-container.sidebar-closed {
            width: 100% !important;
            margin-right: 0 !important;
            max-width: 100% !important;
            flex: 1 !important;
            transition: all 0.3s ease-in-out;
        }

        /* When sidebar is open, give space for sidebar */
        .app-container.sidebar-open {
            width: calc(100% - 340px) !important;
            margin-right: 0 !important;
            max-width: calc(100% - 340px) !important;
            flex: 1 !important;
            transition: all 0.3s ease-in-out;
        }

        /* Enhanced expansion effects for better visual feedback */
        .main-content.expanded .ticket-header {
            padding-right: 2rem !important;
        }

        .main-content.expanded .conversation-container {
            max-width: 100% !important;
            padding-right: 2rem !important;
        }

        .main-content.expanded #replyForm {
            max-width: 100% !important;
            padding-right: 2rem !important;
        }

        .main-content.expanded .outcome-section {
            max-width: 100% !important;
            padding-right: 2rem !important;
        }

        /* Ensure main content inside app container expands properly */
        .app-container.sidebar-closed .main-content {
            width: 100% !important;
            max-width: 100% !important;
            margin-right: 0 !important;
            padding-right: 0 !important;
        }

        .app-container.sidebar-open .main-content {
            width: 100% !important;
            max-width: 100% !important;
            margin-right: 0 !important;
        }

        /* Smooth transition for all expandable elements */
        .main-content,
        .ticket-header,
        .conversation-container,
        #replyForm,
        .outcome-section {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Ultra-wide screens with hidden sidebar - maximize content width */
        @media (min-width: 1921px) {
            .main-content.expanded {
                margin-right: 0 !important;
                max-width: 100% !important;
                width: 100% !important;
                padding-right: 0 !important;
            }
        }

        /* Mobile/tablet with hidden sidebar - maximize content width */
        @media (max-width: 1280px) {
            .main-content.expanded {
                margin-right: 0 !important;
                max-width: 100% !important;
                width: 100% !important;
                padding-right: 0 !important;
            }

            .app-container {
                width: 100% !important;
                margin-right: 0 !important;
                max-width: 100% !important;
            }
        }

        /* Ultra-wide screens (1921px+) - Auto-hide sidebar for better space utilization */
        @media (min-width: 1921px) {
            .right-sidebar {
                transform: translateX(120%);
                box-shadow: -4px 0 16px rgba(0, 0, 0, 0.1);
                position: fixed !important;
                z-index: 1000 !important;
                background: white !important;
                overflow-y: auto !important;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            }

            /* Ensure sidebar is completely hidden when not open */
            .right-sidebar:not(.ultra-wide-open) {
                clip-path: inset(0 100% 0 0) !important;
            }

            .right-sidebar.ultra-wide-open {
                transform: translateX(0);
                box-shadow: -4px 0 16px rgba(0, 0, 0, 0.12);
                visibility: visible !important;
                opacity: 1 !important;
                pointer-events: auto !important;
            }

            .main-content {
                margin-right: 0 !important;
                max-width: 100% !important;
                width: 100% !important;
                padding-right: 0 !important;
            }

            .app-container {
                width: 100% !important;
                margin-right: 0 !important;
                max-width: 100% !important;
            }

            /* Show hamburger menu on ultra-wide screens */
            .sidebar-toggle {
                display: flex !important;
                position: fixed !important;
                top: 50% !important;
                right: 1rem !important;
                transform: translateY(-50%) !important;
                z-index: 1000 !important;
                background: #4f46e5 !important;
                color: white !important;
                border: none !important;
                border-radius: 50% !important;
                width: 56px !important;
                height: 56px !important;
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                transition: all 0.3s ease !important;
                box-shadow: 0 4px 16px rgba(79, 70, 229, 0.3) !important;
            }

            .sidebar-toggle:hover {
                background: #4338ca;
                transform: translateY(-50%) scale(1.05);
                box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4);
            }

            .sidebar-toggle i {
                font-size: 1.25rem;
            }
        }

        /* Enhanced ultra-wide screen behavior (2560px+) */
        @media (min-width: 2560px) {
            /* Base sidebar behavior - hidden by default */
            .right-sidebar {
                transform: translateX(120%) !important;
                box-shadow: -4px 0 16px rgba(0, 0, 0, 0.1) !important;
                max-width: 400px !important;
                width: 400px !important;
                right: 2rem !important;
                top: 150px !important;
                bottom: 2rem !important;
                border-radius: 1rem !important;
                position: fixed !important;
                z-index: 1000 !important;
                background: white !important;
                overflow-y: auto !important;
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
            }

            /* Show sidebar when ultra-wide-open class is present */
            .right-sidebar.ultra-wide-open {
                transform: translateX(0) !important;
                box-shadow: -4px 0 16px rgba(0, 0, 0, 0.12) !important;
                visibility: visible !important;
                opacity: 1 !important;
                pointer-events: auto !important;
            }

            /* Ensure sidebar is hidden by default on ultra-wide screens */
            .right-sidebar:not(.ultra-wide-open) {
                transform: translateX(120%) !important;
                visibility: visible !important;
                opacity: 1 !important;
                pointer-events: none !important;
                /* Ensure no part of the sidebar is visible */
                clip-path: inset(0 100% 0 0) !important;
            }

            /* Additional hiding for ultra-wide screens - ensure complete concealment */
            @media (min-width: 2560px) {
                .right-sidebar:not(.ultra-wide-open) {
                    transform: translateX(150%) !important;
                    clip-path: inset(0 100% 0 0) !important;
                }
            }

            /* Enhanced toggle button for 2560px+ */
            .sidebar-toggle {
                width: 64px !important;
                height: 64px !important;
                right: 1.5rem !important;
                display: flex !important;
                position: fixed !important;
                top: 50% !important;
                transform: translateY(-50%) !important;
                z-index: 1001 !important;
                background: #4f46e5 !important;
                color: white !important;
                border: none !important;
                border-radius: 50% !important;
                align-items: center !important;
                justify-content: center !important;
                cursor: pointer !important;
                transition: all 0.3s ease !important;
                box-shadow: 0 4px 16px rgba(79, 70, 229, 0.3) !important;
                visibility: visible !important;
                opacity: 1 !important;
                pointer-events: auto !important;
            }

            /* Ensure toggle button is visible when not hidden */
            .sidebar-toggle:not(.hidden) {
                display: flex !important;
                visibility: visible !important;
                opacity: 1 !important;
                pointer-events: auto !important;
            }

            .sidebar-toggle:hover {
                background: #4338ca !important;
                transform: translateY(-50%) scale(1.05) !important;
                box-shadow: 0 6px 20px rgba(79, 70, 229, 0.4) !important;
            }

            .sidebar-toggle i {
                font-size: 1.5rem !important;
            }

            /* When sidebar is open, adjust app container */
            .app-container.sidebar-open {
                width: calc(100% - 400px) !important;
                max-width: calc(100% - 400px) !important;
                margin-right: 0 !important;
                transition: all 0.3s ease-in-out !important;
            }

            /* When sidebar is closed, expand app container */
            .app-container.sidebar-closed {
                width: 100% !important;
                max-width: 100% !important;
                margin-right: 0 !important;
                transition: all 0.3s ease-in-out !important;
            }

            /* Ensure main content expands properly */
            .main-content {
                margin-right: 0 !important;
                max-width: 100% !important;
                width: 100% !important;
                padding-right: 0 !important;
            }

            /* Enhanced sidebar content styling for 2560px+ */
            .right-sidebar .sidebar-section {
                padding: 2rem 2.5rem !important;
                margin-bottom: 2.5rem !important;
                border-radius: 1rem !important;
            }

            .right-sidebar .sidebar-title {
                font-size: 1.5rem !important;
                margin-bottom: 1.5rem !important;
                font-weight: 600 !important;
            }

            .right-sidebar .sidebar-content {
                font-size: 1.1rem !important;
                line-height: 1.6 !important;
            }

            /* Ensure proper spacing for ultra-wide screens */
            .container {
                padding-left: 3rem !important;
                padding-right: 3rem !important;
            }

            /* Debug styles for 2560px+ - ensure sidebar is visible when needed */
            .right-sidebar.ultra-wide-open {
                visibility: visible !important;
                opacity: 1 !important;
                pointer-events: auto !important;
            }

            /* Ensure proper layering for ultra-wide screens */
            .right-sidebar {
                z-index: 1000 !important;
            }

            .sidebar-toggle {
                z-index: 1001 !important;
            }
        }

        /* Enhanced 4K screen behavior (3840px+) */
        @media (min-width: 3840px) {
            .sidebar-toggle {
                width: 72px !important;
                height: 72px !important;
                right: 2rem !important;
            }

            .sidebar-toggle i {
                font-size: 1.75rem !important;
            }

            .right-sidebar {
                max-width: 450px;
            }

            .container {
                padding-left: 4rem;
                padding-right: 4rem;
            }
        }

        /* Very large screens (2560px+) - Enhanced layout optimization */
        @media (min-width: 2560px) {

            /* Increase main content width for better space utilization */
            .main-content {
                max-width: 1800px !important;
                margin: 0 auto !important;
                padding: 0 3rem !important;
                width: 100% !important;
            }

            .app-container {
                width: 100% !important;
                margin-right: 0 !important;
                max-width: 100% !important;
            }

            /* Optimize ticket header for ultra-wide displays */
            .ticket-header {
                padding: 3rem 4rem !important;
                margin-bottom: 3rem !important;
            }

            .ticket-header h1 {
                font-size: 2.5rem !important;
                line-height: 1.3 !important;
            }

            /* Enhance badge spacing and sizing */
            .ticket-header .flex.flex-wrap.items-center.gap-2 {
                gap: 1.5rem !important;
            }

            .ticket-header .px-3.py-1.text-xs {
                padding: 1rem 2rem !important;
                font-size: 1rem !important;
            }

            /* Optimize action buttons layout */
            .ticket-header .flex.flex-wrap.items-center.gap-3 {
                gap: 2rem !important;
            }

            /* Enhance conversation container for ultra-wide */
            .conversation-container {
                max-width: 1600px !important;
                margin: 0 auto !important;
                padding: 0 2rem !important;
            }

            /* Optimize reply cards for large screens */
            .reply-card {
                padding: 2rem 3rem !important;
                margin-bottom: 2rem !important;
                border-radius: 1rem !important;
            }

            .reply-card .reply-header {
                margin-bottom: 1.5rem !important;
            }

            .reply-card .reply-content {
                font-size: 1.1rem !important;
                line-height: 1.7 !important;
            }

            /* Enhance form inputs for large screens */
            .reply-form input,
            .reply-form textarea {
                padding: 1.5rem 2rem !important;
                font-size: 1.1rem !important;
                border-radius: 0.75rem !important;
            }

            /* Optimize attachment display */
            .attachments-container {
                max-width: 1600px !important;
                margin: 0 auto !important;
            }

            .attachment-item {
                padding: 2rem !important;
                margin-bottom: 2rem !important;
                border-radius: 1rem !important;
            }

            /* Enhanced grid layouts for ultra-wide */
            .grid.grid-cols-1.md\:grid-cols-3 {
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 2.5rem !important;
            }

            /* Enhanced detail cards for ultra-wide */
            .detail-card {
                padding: 2rem !important;
                margin-bottom: 2rem !important;
                border-radius: 1rem !important;
            }

            /* Enhanced message styling for ultra-wide */
            .message {
                max-width: 60% !important;
                padding: 1.5rem 2rem !important;
                border-radius: 1.25rem !important;
            }

            .customer-message {
                margin-right: 20% !important;
            }

            .support-message {
                margin-left: 20% !important;
            }

            /* Enhanced reply form for ultra-wide */
            #replyForm {
                max-width: 1600px !important;
                margin: 0 auto !important;
            }

            #replyDropzone {
                padding: 2rem !important;
                border-radius: 1rem !important;
            }

            #response {
                font-size: 1.1rem !important;
                padding: 1.5rem 2rem !important;
            }

            /* Enhanced outcome section for ultra-wide */
            .outcome-section {
                max-width: 1600px !important;
                margin: 0 auto !important;
                padding: 3rem 4rem !important;
            }

            /* Enhanced vehicle information grid */
            .vehicle-info-grid {
                grid-template-columns: repeat(4, 1fr) !important;
                gap: 2.5rem !important;
            }

            /* Enhanced checklist grid */
            .checklist-grid {
                grid-template-columns: repeat(3, 1fr) !important;
                gap: 2.5rem !important;
            }

            /* Enhanced sidebar for ultra-wide displays */
            .right-sidebar {
                width: 340px !important;
                right: 3rem !important;
                top: 180px !important;
                bottom: 3rem !important;
                border-radius: 1.25rem !important;
                box-shadow: -6px 0 25px rgba(0, 0, 0, 0.2) !important;
            }

            .right-sidebar .sidebar-section {
                padding: 2rem 2.5rem !important;
                margin-bottom: 2.5rem !important;
                border-radius: 1rem !important;
            }

            .right-sidebar .sidebar-title {
                font-size: 1.5rem !important;
                margin-bottom: 1.5rem !important;
            }

            /* Optimize toggle button for ultra-wide */
            .sidebar-toggle {
                width: 72px !important;
                height: 72px !important;
                right: 3rem !important;
                font-size: 1.75rem !important;
                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3) !important;
            }

            /* Enhance main layout spacing */
            .main-layout {
                padding: 0 4rem !important;
            }

            .parallel-container {
                gap: 4rem !important;
            }

            /* Optimize app container for ultra-wide */
            .app-container {
                flex: 1 !important;
                max-width: none !important;
            }

            /* Enhance container responsiveness */
            .container {
                max-width: none !important;
                padding-left: 0 !important;
                padding-right: 0 !important;
            }

            /* Optimize priority and classification badges */
            .priority-badge,
            .status-badge {
                padding: 1rem 2rem !important;
                font-size: 1rem !important;
                border-radius: 0.75rem !important;
            }

            /* Enhance dropdown styling for large screens */
            .relative.inline-block select {
                padding: 1rem 2rem !important;
                font-size: 1rem !important;
                border-radius: 0.75rem !important;
            }

            /* Optimize action buttons for ultra-wide */
            .action-buttons button {
                padding: 1.25rem 2.5rem !important;
                font-size: 1.1rem !important;
                border-radius: 0.75rem !important;
            }

            /* Enhanced importance button for ultra-wide */
            .importance-btn {
                width: 48px !important;
                height: 48px !important;
            }

            .importance-btn .star-icon {
                font-size: 18px !important;
            }

            /* Enhanced modal styling for ultra-wide */
            .modal-content {
                max-width: 800px !important;
                padding: 3rem !important;
            }

            /* Enhanced notification positioning for ultra-wide */
            .notification {
                top: 3rem !important;
                right: 3rem !important;
                padding: 2rem 3rem !important;
                font-size: 1.1rem !important;
            }
        }

        /* Sidebar toggle button for mobile */
        .sidebar-toggle {
            position: fixed !important;
            top: 50% !important;
            right: 1rem !important;
            transform: translateY(-50%) !important;
            z-index: 9999 !important;
            /* Highest z-index to always be accessible */
            background: var(--primary) !important;
            color: white !important;
            border: none !important;
            width: 56px !important;
            height: 56px !important;
            border-radius: 50% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2) !important;
            cursor: pointer !important;
            transition: all 0.3s ease !important;
            font-size: 1.25rem !important;
            touch-action: manipulation !important;
            /* Ensure button is always visible */
            opacity: 1 !important;
            visibility: visible !important;
            /* Make button more visible for debugging */
            border: 3px solid #ffffff !important;
            animation: pulse 2s infinite !important;
        }

        /* Pulse animation for debugging */
        @keyframes pulse {
            0% {
                box-shadow: 0 4px 16px rgba(79, 70, 229, 0.4);
            }
            50% {
                box-shadow: 0 4px 20px rgba(79, 70, 229, 0.8);
            }
            100% {
                box-shadow: 0 4px 16px rgba(79, 70, 229, 0.4);
            }
        }

        .sidebar-toggle:hover {
            background: #4338ca;
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }

        .sidebar-toggle:active {
            transform: translateY(-50%) scale(0.95);
        }

        .sidebar-toggle:active {
            transform: translateY(-50%) scale(0.95);
        }

        /* Hide toggle button on larger desktop screens only */
        @media (min-width: 1281px) and (max-width: 1710px) {
            .sidebar-toggle {
                display: flex !important;
                position: fixed !important;
                top: 50% !important;
                right: 1rem !important;
                transform: translateY(-50%) !important;
                z-index: 9999 !important;
            }

            .right-sidebar {
                transform: translateX(100%) !important;
                position: fixed;
                right: 0;
                top: 137px;
                bottom: 0;
                width: 340px;
                box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
                transition: transform 0.3s ease-in-out;
            }

            .right-sidebar.sidebar-open {
                transform: translateX(0) !important;
            }

            .main-content {
                margin-right: 0 !important;
                max-width: 100% !important;
                padding-right: 1rem;
            }
        }

        /* Show sidebar by default on wide screens (1711px - 1920px) */
        @media (min-width: 1711px) and (max-width: 1920px) {
            .sidebar-toggle {
                display: none !important;
            }

            .right-sidebar {
                transform: translateX(0) !important;
                position: fixed;
                right: 0;
                top: 137px;
                bottom: 0;
                width: 340px;
                box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
            }

            .main-content {
                margin-right: 360px;
                max-width: calc(100% - 360px);
                padding-right: 1rem;
            }

            .sidebar-overlay {
                display: none !important;
            }
        }



        /* Ensure draggable elements and main content have higher z-index */
        .main-content,
        .document-item,
        .conversation-container,
        .ticket-header {
            position: relative;
            z-index: 36;
            /* Higher than overlay */
        }

        /* Draggable document items get even higher z-index */
        .document-item[draggable="true"] {
            z-index: 45;
            /* Higher than sidebar */
        }

        /* Interactive form elements should also be above overlay */
        #replyForm,
        .reply-message-box,
        .attachment-preview,
        textarea,
        input {
            position: relative;
            z-index: 36;
            /* Higher than overlay */
        }

        /* Ensure dropzone for file uploads works */
        #attachmentDropzone,
        #attachmentSection {
            position: relative;
            z-index: 36;
        }

        /* Adjust main content margins for larger screens with smooth transitions */
        @media (min-width: 1401px) and (max-width: 1710px) {
            .main-content {
                margin: 0 !important;
                /* No margins to ensure left alignment */
                max-width: none;
                /* Remove max-width restriction */
                width: auto;
                /* Ensure proper width calculation */
                transition: margin-right 0.3s ease-in-out;
            }

            /* Ensure container takes full available width */
            .container {
                max-width: none;
                width: 100%;
                margin-left: 0;
                /* Ensure left alignment */
            }
        }

        /* Wide desktop screens (1711px+) - ensure sidebar margin is respected */
        @media (min-width: 1711px) {
            .main-content {
                margin-right: 360px !important;
                max-width: calc(100% - 360px) !important;
                transition: margin-right 0.3s ease-in-out;
            }
        }

        /* Comprehensive Responsive Design for Ticket Detail */

        /* Small mobile devices (320px - 480px) */
        @media (max-width: 480px) {
            .container {
                padding-left: 0.75rem;
                padding-right: 0.75rem;
            }

            .ticket-header {
                padding: 0.625rem;
            }

            .detail-card {
                padding: 0.5rem;
                margin-bottom: 0.625rem;
            }

            .conversation-container {
                padding: 0.5rem 0;
                gap: 0.75rem;
            }

            .message {
                max-width: 90%;
                padding: 0.5rem 0.625rem;
                font-size: 0.875rem;
            }

            .customer-message {
                margin-right: 2%;
            }

            .support-message {
                margin-left: 2%;
            }

            .message-header {
                font-size: 0.75rem;
                margin-bottom: 0.375rem;
            }

            .message-time {
                font-size: 0.6875rem;
            }

            /* Navigation responsive */
            nav .container {
                padding: 0.5rem;
            }

            /* Grid layout for small screens */
            .grid.grid-cols-1.md\:grid-cols-3 {
                grid-template-columns: repeat(1, 1fr) !important;
                gap: 0.75rem;
            }

            /* Button responsiveness */
            .px-3.py-1 {
                padding: 0.375rem 0.5rem;
                font-size: 0.6875rem;
            }

            /* Reply form */
            textarea {
                min-height: 80px;
                font-size: 0.875rem;
            }
        }

        /* Mobile devices (481px - 768px) */
        @media (min-width: 481px) and (max-width: 768px) {
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
                margin-right: 0 !important;
            }

            .main-content {
                margin-right: 0 !important;
                padding: 1rem;
            }

            .ticket-header {
                padding: 1rem;
            }

            .detail-card {
                padding: 1rem;
            }

            .conversation-container {
                padding: 0.5rem 0;
            }

            .message {
                max-width: 85%;
                padding: 0.75rem 1rem;
            }

            .customer-message {
                margin-right: 7.5%;
            }

            .support-message {
                margin-left: 7.5%;
            }

            .grid.grid-cols-1.md\:grid-cols-3 {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 1rem;
            }

            /* Touch-friendly buttons */
            button,
            .btn,
            a.btn {
                min-height: 44px;
                padding: 0.75rem 1rem;
                touch-action: manipulation;
            }

            /* Better spacing for tablet */
            h1 {
                font-size: 1.375rem;
                line-height: 1.25;
            }

            /* Modal improvements */
            .modal-content {
                margin: 1rem;
                max-width: calc(100vw - 2rem);
            }
        }

        /* Tablet devices (769px - 1024px) */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                padding-left: 1.5rem;
                padding-right: 1.5rem;
                margin-right: 0 !important;
            }

            .main-content {
                margin-right: 0 !important;
                padding: 1.5rem;
            }

            .ticket-header {
                padding: 1.5rem;
            }

            .detail-card {
                padding: 1.25rem;
            }

            .message {
                max-width: 80%;
                padding: 0.875rem 1.125rem;
            }

            .customer-message {
                margin-right: 10%;
            }

            .support-message {
                margin-left: 10%;
            }

            /* Better button sizing for tablet */
            button,
            .btn,
            a.btn {
                min-height: 44px;
                padding: 0.75rem 1.25rem;
            }

            /* Grid improvements */
            .grid.grid-cols-1.md\:grid-cols-3 {
                grid-template-columns: repeat(3, 1fr);
                gap: 1.5rem;
            }
        }

        /* Laptop screens (1025px - 1400px) */
        @media (min-width: 1025px) and (max-width: 1400px) {
            .container {
                max-width: 100%;
                padding-left: 2rem;
                padding-right: 2rem;
                margin-right: 0 !important;
            }

            .main-content {
                margin-right: 0 !important;
                padding: 2rem;
            }

            .ticket-header {
                padding: 1.75rem;
            }

            .detail-card {
                padding: 1.5rem;
            }

            .message {
                max-width: 75%;
                padding: 1rem 1.25rem;
            }

            .customer-message {
                margin-right: 12.5%;
            }

            .support-message {
                margin-left: 12.5%;
            }

            /* Full grid layout */
            .grid.grid-cols-1.md\:grid-cols-3 {
                grid-template-columns: repeat(3, 1fr);
                gap: 2rem;
            }
        }

        /* Large desktop screens (1401px+) - With sidebar */
        @media (min-width: 1401px) {
            .container {
                max-width: none;
                margin: 0;
                /* Ensure left alignment */
                padding-left: 1.5rem;
                padding-right: 1.5rem;
            }

            .main-content {
                margin-right: 0 !important;
                /* No margin needed with flexbox layout */
                padding: 1.5rem;
            }

            .ticket-header {
                padding: 1.5rem;
            }

            .detail-card {
                padding: 1.25rem;
            }

            .message {
                max-width: 70%;
                padding: 1rem 1.5rem;
            }

            .customer-message {
                margin-right: 15%;
            }

            .support-message {
                margin-left: 15%;
            }

            /* Full grid layout for desktop */
            .grid.grid-cols-1.md\:grid-cols-3 {
                grid-template-columns: repeat(3, 1fr);
                gap: 2rem;
            }
        }

        /* Extra large screens (1441px+) */
        @media (min-width: 1441px) {
            .container {
                max-width: 1600px;
                margin: 0 auto;
            }

            .main-content {
                margin-right: 0 !important;
                padding: 2.5rem;
            }

            .ticket-header {
                padding: 2.5rem;
            }

            .detail-card {
                padding: 2rem;
            }
        }

        /* Extra large screens (1441px+) */
        @media (min-width: 1441px) {
                .container {
                    max-width: 1600px;
                    margin: 0;
                    /* Ensure left alignment */
                }

                .main-content {
                    margin-right: 0 !important;
                    /* No margin needed with flexbox layout */
                    padding: 2.5rem;
                }

                .ticket-header {
                    padding: 2.5rem;
                }

                .detail-card {
                    padding: 2rem;
                }
            }

            /* Desktop sidebar behavior - REMOVED CONFLICTING STYLES */
            /* These styles were conflicting with the main layout system */

            .sidebar-section {
                margin-bottom: 0.5rem;
                background: white;
                border: 1px solid #e2e8f0;
                border-radius: 0.375rem;
                padding: 0.5rem;
                box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
                transition: all 0.2s ease-in-out;
            }

            .sidebar-section:hover {
                box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            }

            .sidebar-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 0.5rem;
                padding-bottom: 0.25rem;
                border-bottom: 1px solid #e2e8f0;
            }

            .sidebar-title {
                font-size: 0.875rem;
                font-weight: 600;
                color: #374151;
            }

            .add-btn {
                width: 24px;
                height: 24px;
                border-radius: 4px;
                background: #3b82f6;
                color: white;
                border: none;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
                transition: all 0.2s ease-in-out;
                font-size: 0.75rem;
            }

            .add-btn:hover {
                background: #2563eb;
            }

            /* Note card styles */
            .note-card {
                background-color: white;
                border-radius: 0.5rem;
                padding: 1rem;
                margin-bottom: 1rem;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                border-left: 3px solid #4f46e5;
            }

            .note-title {
                font-weight: 600;
                margin-bottom: 0.5rem;
                color: #1e293b;
            }

            .note-content {
                color: #475569;
                font-size: 0.875rem;
                white-space: pre-line;
            }

            .note-meta {
                display: flex;
                justify-content: space-between;
                font-size: 0.75rem;
                color: #64748b;
                margin-top: 0.5rem;
            }

            .note-actions {
                display: flex;
                gap: 0.5rem;
            }

            .note-action-btn {
                color: #64748b;
                cursor: pointer;
                transition: color 0.2s ease;
            }

            .note-action-btn:hover {
                color: #4f46e5;
            }

            /* Template styles */
            .template-item {
                border: 1px solid #e2e8f0;
                border-radius: 0.5rem;
                padding: 0.75rem;
                margin-bottom: 0.5rem;
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .template-item:hover {
                background-color: #f1f5f9;
                border-color: #cbd5e1;
            }

            .template-title {
                font-weight: 600;
                margin-bottom: 0.25rem;
            }

            .template-content {
                color: #64748b;
                font-size: 0.875rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .template-actions {
                display: flex;
                justify-content: flex-end;
                gap: 0.5rem;
                margin-top: 0.5rem;
            }

            .template-action-btn {
                font-size: 0.75rem;
                padding: 0.25rem 0.5rem;
                border-radius: 0.25rem;
                cursor: pointer;
            }

            .template-use-btn {
                background-color: #e0e7ff;
                color: #4f46e5;
            }

            .template-use-btn:hover {
                background-color: #c7d2fe;
            }

            .template-edit-btn {
                background-color: #f1f5f9;
                color: #64748b;
            }

            .template-edit-btn:hover {
                background-color: #e2e8f0;
            }

            /* Document item styles */
            .document-item {
                transition: all 0.2s ease;
                position: relative;
                overflow: hidden;
            }

            .document-item:hover {
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            }

            .document-item button {
                transition: all 0.15s ease;
            }

            .document-item:hover button {
                opacity: 1;
            }

            .empty-state {
                text-align: center;
                padding: 2rem 1rem;
                color: #64748b;
                background: rgba(248, 250, 252, 0.5);
                border: 2px dashed rgba(203, 213, 225, 0.6);
                border-radius: 1rem;
                margin: 0.5rem 0;
                transition: all 0.2s ease-in-out;
            }

            .empty-state:hover {
                border-color: rgba(59, 130, 246, 0.3);
                background: rgba(239, 246, 255, 0.5);
            }

            .empty-icon {
                font-size: 2.5rem;
                margin-bottom: 0.75rem;
                color: #cbd5e1;
                opacity: 0.8;
            }

            .empty-state p {
                font-size: 0.875rem;
                font-weight: 500;
                color: #64748b;
            }



            .sidebar-section {
                margin-bottom: 1.25rem;
                background: white;
                border-radius: 0.5rem;
                padding: 0.875rem;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }

            .sidebar-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 1rem;
                padding-bottom: 0.5rem;
                border-bottom: 1px solid #e2e8f0;
            }

            .sidebar-title {
                font-size: 1rem;
                font-weight: 600;
                color: #1e293b;
            }

            /* Note card styles */
            .note-card {
                background-color: white;
                border-radius: 0.5rem;
                padding: 1rem;
                margin-bottom: 1rem;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
                border-left: 3px solid #4f46e5;
            }

            .note-title {
                font-weight: 600;
                margin-bottom: 0.5rem;
                color: #1e293b;
            }

            .note-content {
                color: #475569;
                font-size: 0.875rem;
                white-space: pre-line;
            }

            .note-meta {
                display: flex;
                justify-content: space-between;
                font-size: 0.75rem;
                color: #64748b;
                margin-top: 0.5rem;
            }

            .note-actions {
                display: flex;
                gap: 0.5rem;
            }

            .note-action-btn {
                color: #64748b;
                cursor: pointer;
                transition: color 0.2s ease;
            }

            .note-action-btn:hover {
                color: #4f46e5;
            }

            /* Template styles */
            .template-item {
                border: 1px solid #e2e8f0;
                border-radius: 0.5rem;
                padding: 0.75rem;
                margin-bottom: 0.5rem;
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .template-item:hover {
                background-color: #f1f5f9;
                border-color: #cbd5e1;
            }

            .template-title {
                font-weight: 600;
                margin-bottom: 0.25rem;
            }

            .template-content {
                color: #64748b;
                font-size: 0.875rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .template-actions {
                display: flex;
                justify-content: flex-end;
                gap: 0.5rem;
                margin-top: 0.5rem;
            }

            .template-action-btn {
                font-size: 0.75rem;
                padding: 0.25rem 0.5rem;
                border-radius: 0.25rem;
                cursor: pointer;
            }

            .template-use-btn {
                background-color: #e0e7ff;
                color: #4f46e5;
            }

            .template-use-btn:hover {
                background-color: #c7d2fe;
            }

            .template-edit-btn {
                background-color: #f1f5f9;
                color: #64748b;
            }

            .template-edit-btn:hover {
                background-color: #e2e8f0;
            }

            /* Document item styles */
            .document-item {
                transition: all 0.2s ease;
                position: relative;
                overflow: hidden;
            }

            .document-item:hover {
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            }

            .document-item button {
                transition: all 0.15s ease;
            }

            .document-item:hover button {
                opacity: 1;
            }

            .empty-state {
                text-align: center;
                padding: 1.5rem;
                color: #64748b;
            }

            .empty-icon {
                font-size: 2rem;
                margin-bottom: 0.5rem;
                color: #cbd5e1;
            }

            .add-btn {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                padding: 0.5rem;
                border-radius: 50%;
                background-color: #e0e7ff;
                color: #4f46e5;
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .add-btn:hover {
                background-color: #c7d2fe;
            }

            /* Status dropdown styles */
            .status-dropdown {
                position: relative;
                display: inline-block;
            }

            .status-dropdown-btn {
                padding: 0.5rem 1rem;
                background-color: #f1f5f9;
                border-radius: 0.375rem;
                display: flex;
                align-items: center;
                gap: 0.5rem;
                cursor: pointer;
                transition: all 0.2s ease;
            }

            .status-dropdown-btn:hover {
                background-color: #e2e8f0;
            }

            .status-dropdown-content {
                position: absolute;
                background-color: white;
                min-width: 220px;
                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
                border-radius: 0.375rem;
                z-index: 50;
                display: none;
            }

            .status-dropdown-content.show {
                display: block;
            }

            .status-option {
                padding: 0.5rem 1rem;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .status-option:hover {
                background-color: #f1f5f9;
            }

            /* Status badge colors */
            .status-new {
                background-color: #dbeafe;
                color: #1e40af;
            }

            .status-form-sent {
                background-color: #fef3c7;
                color: #92400e;
            }

            .status-awaiting-submission {
                background-color: #fef3c7;
                color: #92400e;
            }

            .status-under-review {
                background-color: #e0e7ff;
                color: #3730a3;
            }

            .status-info-requested {
                background-color: #fef3c7;
                color: #92400e;
            }

            .status-warranty-form-received {
                background-color: #d1fae5;
                color: #065f46;
            }

            .status-referred-to-tech-director {
                background-color: #fce7f3;
                color: #be185d;
            }

            .status-approved--revisit-booked {
                background-color: #d1fae5;
                color: #065f46;
            }

            .status-declined--not-covered {
                background-color: #fee2e2;
                color: #991b1b;
            }

            .status-closed {
                background-color: #f3f4f6;
                color: #374151;
            }

            /* Status dropdown button styling based on current status */
            .status-dropdown-btn.status-new {
                background-color: #dbeafe;
                color: #1e40af;
                border-color: #93c5fd;
            }

            .status-dropdown-btn.status-form-sent {
                background-color: #fef3c7;
                color: #92400e;
                border-color: #fbbf24;
            }

            .status-dropdown-btn.status-awaiting-submission {
                background-color: #fef3c7;
                color: #92400e;
                border-color: #fbbf24;
            }

            .status-dropdown-btn.status-under-review {
                background-color: #e0e7ff;
                color: #3730a3;
                border-color: #a5b4fc;
            }

            .status-dropdown-btn.status-info-requested {
                background-color: #fef3c7;
                color: #92400e;
                border-color: #fbbf24;
            }

            .status-dropdown-btn.status-warranty-form-received {
                background-color: #d1fae5;
                color: #065f46;
                border-color: #6ee7b7;
            }

            .status-dropdown-btn.status-referred-to-tech-director {
                background-color: #fce7f3;
                color: #be185d;
                border-color: #f9a8d4;
            }

            .status-dropdown-btn.status-approved--revisit-booked {
                background-color: #d1fae5;
                color: #065f46;
                border-color: #6ee7b7;
            }

            .status-dropdown-btn.status-declined--not-covered {
                background-color: #fee2e2;
                color: #991b1b;
                border-color: #fca5a5;
            }

            .status-dropdown-btn.status-closed {
                background-color: #f3f4f6;
                color: #374151;
                border-color: #d1d5db;
            }

            /* Enhanced Email Template Modal Styles */
            .email-template-modal {
                display: flex;
                flex-direction: column;
                max-height: 90vh;
                overflow: hidden;
            }

            .email-template-content {
                flex: 1;
                overflow-y: auto;
                padding-right: 4px;
            }

            .email-template-content::-webkit-scrollbar {
                width: 8px;
            }

            .email-template-content::-webkit-scrollbar-track {
                background: #f1f5f9;
                border-radius: 4px;
            }

            .email-template-content::-webkit-scrollbar-thumb {
                background: #cbd5e1;
                border-radius: 4px;
                transition: background 0.2s ease;
            }

            .email-template-content::-webkit-scrollbar-thumb:hover {
                background: #94a3b8;
            }

            /* Enhanced form field styles */
            .email-template-content input,
            .email-template-content select,
            .email-template-content textarea {
                transition: all 0.2s ease;
            }

            .email-template-content input:focus,
            .email-template-content select:focus,
            .email-template-content textarea:focus {
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            }

            /* Responsive adjustments for email template modal */
            @media (max-width: 768px) {
                .email-template-modal {
                    max-height: 95vh;
                    width: 95vw !important;
                    margin: 1rem;
                }

                .email-template-content {
                    max-height: calc(95vh - 180px);
                }

                .email-template-modal .flex.flex-wrap {
                    gap: 0.5rem;
                }

                .email-template-modal button {
                    padding: 0.5rem 0.75rem;
                    font-size: 0.875rem;
                }
            }

            @media (max-width: 480px) {
                .email-template-modal {
                    max-height: 98vh;
                    width: 98vw !important;
                    margin: 0.5rem;
                }

                .email-template-content {
                    max-height: calc(98vh - 160px);
                }

                .email-template-modal .flex.flex-wrap {
                    flex-direction: column;
                    gap: 0.5rem;
                }

                .email-template-modal button {
                    width: 100%;
                    justify-content: center;
                }
            }

            /* Additional enhancements for very small screens */
            @media (max-width: 360px) {
                .email-template-modal {
                    width: 100vw !important;
                    margin: 0;
                    border-radius: 0;
                }

                .email-template-content {
                    padding: 0.5rem;
                }

                .email-template-modal .p-6 {
                    padding: 1rem;
                }
            }

            /* Landscape orientation adjustments */
            @media (max-height: 500px) and (orientation: landscape) {
                .email-template-modal {
                    max-height: 95vh;
                }

                .email-template-content {
                    max-height: calc(95vh - 140px);
                }

                .email-template-modal .p-6 {
                    padding: 1rem;
                }
            }
    </style>
</head>

<body class="min-h-screen bg-gray-50 max-w-screen-ultra">
    <nav class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-2">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-2 md:space-x-4">
                    <a href="/" class="flex items-center">
                        <img src="/static/logo.png" alt="AutoAssistGroup Logo" class="h-6 md:h-8">
                    </a>
                    <div class="hidden md:flex space-x-4">
                        <a href="/" class="px-3 py-1.5 rounded bg-pink-50 text-pink-600 font-medium">Tickets</a>
                        <a href="/dashboard" class="px-3 py-1.5 rounded hover:bg-gray-100 transition">Dashboard</a>
                        <a href="/status" class="px-3 py-1.5 rounded hover:bg-gray-100 transition">Status</a>
                        <a href="/create-ticket" class="px-3 py-1.5 rounded hover:bg-gray-100 transition">Create
                            Ticket</a>
                        {% if current_user_role == 'Administrator' %}
                        <a href="/technicians" class="px-3 py-1.5 rounded hover:bg-gray-100 transition">Technicians</a>
                        <a href="/members" class="px-3 py-1.5 rounded hover:bg-gray-100 transition">Members</a>
                        <a href="/admin" class="px-3 py-1.5 rounded hover:bg-gray-100 transition">Admin Panel</a>
                        {% endif %}
                    </div>
                </div>
                <div class="flex items-center space-x-2 md:space-x-4">
                    {% if current_user %}
                    <span class="hidden sm:inline text-gray-600 text-sm md:text-base">{{ current_user }}</span>
                    <a href="/logout"
                        class="px-2 py-1 md:px-3 md:py-1.5 rounded bg-gray-100 hover:bg-gray-200 transition text-xs md:text-sm">Logout</a>
                    {% endif %}

                    <!-- Mobile menu button -->
                    <button class="md:hidden p-2 rounded-md hover:bg-gray-100 mobile-menu-btn"
                        onclick="toggleMobileMenu()">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- Mobile menu -->
            <div id="mobileMenu" class="md:hidden mt-3 pb-3 border-t border-gray-200 hidden">
                <div class="flex flex-col space-y-2 pt-3">
                    <a href="/" class="px-3 py-1.5 rounded bg-pink-50 text-pink-600 font-medium">Tickets</a>
                    <a href="/dashboard" class="px-3 py-1.5 rounded hover:bg-gray-100 transition">Dashboard</a>
                    <a href="/status" class="px-3 py-1.5 rounded hover:bg-gray-100 transition">Status</a>
                    <a href="/create-ticket" class="px-3 py-1.5 rounded hover:bg-gray-100 transition">Create Ticket</a>
                    {% if current_user_role == 'Administrator' %}
                    <a href="/technicians" class="px-3 py-1.5 rounded hover:bg-gray-100 transition">Technicians</a>
                    <a href="/members" class="px-3 py-1.5 rounded hover:bg-gray-100 transition">Members</a>
                    <a href="/admin" class="px-3 py-1.5 rounded hover:bg-gray-100 transition">Admin Panel</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <!-- Notification System -->
    <div id="notification" class="notification hidden">
        <i class="fas fa-check-circle mr-2"></i>
        <span id="notification-message"></span>
    </div>

    <!-- Message Expansion Modal -->
    <div id="messageModal" class="modal-overlay">
        <div class="modal-content p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Full Message</h3>
                <button id="closeMessageModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="modalMessageContent" class="p-4 bg-gray-50 rounded-lg whitespace-pre-wrap"></div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content p-6">
            <h3 class="text-xl font-semibold mb-4">Confirm Ticket Closure</h3>
            <p class="mb-6">Are you sure you want to close this ticket? This action cannot be undone.</p>
            <div class="flex justify-end space-x-3">
                <button id="cancelClose"
                    class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">
                    Cancel
                </button>
                <button id="confirmClose"
                    class="px-4 py-2 text-white rounded-lg hover:opacity-90 transition bg-indigo-600">
                    Confirm Close
                </button>
            </div>
        </div>
    </div>

    <!-- Forward Modal -->
    <div id="forwardModal" class="modal-overlay">
        <div class="modal-content p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Forward Ticket</h3>
                <button id="closeForwardModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="mb-4">
                <label for="forwardMemberSelect" class="block text-gray-700 text-sm font-medium mb-1">Select
                    Member</label>
                <select id="forwardMemberSelect"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white shadow-sm transition-all duration-200 text-gray-900 font-medium">
                    <option value="" class="text-gray-500">Select a member...</option>
                    {% for member in members %}
                    <option value="{{ member.id }}">{{ member.name }} ({{ member.role }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-4">
                <label for="forwardNotes" class="block text-gray-700 text-sm font-medium mb-1">Notes</label>
                <textarea id="forwardNotes"
                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="Add any notes explaining why the ticket is being forwarded"></textarea>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancelForward"
                    class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">
                    Cancel
                </button>
                <button id="confirmForward"
                    class="px-4 py-2 text-white rounded-lg hover:opacity-90 transition bg-indigo-600">
                    Forward Ticket
                </button>
            </div>
        </div>
    </div>

    <!-- Add Note Modal -->
    <div id="noteModal" class="modal-overlay">
        <div class="modal-content p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Add Private Note</h3>
                <button id="closeNoteModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-medium mb-1">Title</label>
                <input type="text" id="noteTitle"
                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="Note title">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-medium mb-1">Content</label>
                <textarea id="noteContent" rows="4"
                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="Write your note here..."></textarea>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancelNote"
                    class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">
                    Cancel
                </button>
                <button id="saveNote" class="px-4 py-2 text-white rounded-lg hover:opacity-90 transition bg-indigo-600">
                    Save Note
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Template Modal -->
    <div id="editTemplateModal" class="modal-overlay">
        <div class="modal-content p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold" id="editTemplateTitle">Add New Template</h3>
                <button id="closeEditTemplateModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-medium mb-1">Title</label>
                <input type="text" id="templateTitle"
                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="Template title">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-medium mb-1">Content</label>
                <textarea id="templateContent" rows="6"
                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="Enter your template content here..."></textarea>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancelEditTemplate"
                    class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition">
                    Cancel
                </button>
                <button id="saveTemplate"
                    class="px-4 py-2 text-white rounded hover:opacity-90 transition bg-indigo-600">
                    Save Template
                </button>
                <button id="deleteTemplate"
                    class="px-4 py-2 bg-red-100 text-red-700 rounded hover:bg-red-200 transition hidden">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Document Modal -->
    <div id="documentModal" class="modal-overlay">
        <div class="modal-content p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold" id="documentModalTitle">Add New Document</h3>
                <button id="closeDocumentModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-medium mb-1">Document Name</label>
                <input type="text" id="documentName"
                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="Document name">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-medium mb-1">Document Type</label>
                <select id="documentType"
                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="form">Form</option>
                    <option value="guide">Guide</option>
                    <option value="manual">Manual</option>
                    <option value="template">Template Document</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-medium mb-1">File</label>
                <div class="flex items-center">
                    <div class="file-input-wrapper w-full">
                        <div
                            class="file-input-button w-full flex items-center justify-center py-2 bg-gray-100 hover:bg-gray-200 transition rounded-lg">
                            <i class="fas fa-upload mr-2"></i> Choose File
                        </div>
                        <input type="file" id="documentFile" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.xlsx,.xls">
                    </div>
                </div>
                <p id="selectedFileName" class="mt-2 text-sm text-gray-600">No file selected</p>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-medium mb-1">Description</label>
                <textarea id="documentDescription" rows="3"
                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="Enter a short description of this document..."></textarea>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancelDocument"
                    class="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition">
                    Cancel
                </button>
                <button id="saveDocument"
                    class="px-4 py-2 text-white rounded hover:opacity-90 transition bg-indigo-600">
                    Save Document
                </button>
                <button id="deleteDocument"
                    class="px-4 py-2 bg-red-100 text-red-700 rounded hover:bg-red-200 transition hidden">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Assignment/Forward/Takeover Modal -->
    <div id="assignModal" class="modal-overlay">
        <div class="modal-content p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold" id="assignModalTitle">Assign Ticket</h3>
                <button id="closeAssignModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-medium mb-1">Select Member</label>
                <select id="assignMemberSelect"
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white shadow-sm transition-all duration-200 text-gray-900 font-medium">
                    {% for member in members %}
                    <option value="{{ member._id }}" class="py-2">{{ member.name }} - {{ member.role }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-4" id="forwardNotesContainer" style="display: none;">
                <label class="block text-gray-700 text-sm font-medium mb-1">Notes</label>
                <textarea id="assignNotes"
                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="Add any notes for the forwarded ticket"></textarea>
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancelAssign"
                    class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">
                    Cancel
                </button>
                <button id="confirmAssign"
                    class="px-4 py-2 text-white rounded-lg hover:opacity-90 transition bg-indigo-600">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Email Template Modal -->
    <div id="emailTemplateModal" class="modal-overlay">
        <div class="modal-content p-6 email-template-modal" style="max-width: 800px; max-height: 90vh; width: 90vw;">
            <!-- Header Section -->
            <div class="flex justify-between items-center mb-4 pb-3 border-b border-gray-200">
                <h3 class="text-xl font-semibold text-gray-800">
                    <i class="fas fa-envelope-open-text text-green-600 mr-2"></i>Email Template
                </h3>
                <button id="closeEmailTemplateModal"
                    class="text-gray-500 hover:text-gray-700 transition-colors p-2 rounded-full hover:bg-gray-100">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Scrollable Content Area -->
            <div class="email-template-content overflow-y-auto" style="max-height: calc(90vh - 200px);">
                <!-- Info Tip -->
                <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-sm text-blue-800 leading-relaxed">
                        <i class="fas fa-info-circle mr-2"></i>
                        <strong>Tip:</strong> You can edit the subject and body directly, or load a template and then
                        customize it. The fields are always editable!
                    </p>
                </div>

                <!-- Template Type Selection -->
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2">
                        <i class="fas fa-file-alt mr-2 text-blue-600"></i>Template Type
                    </label>
                    <select id="templateTypeSelect"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white shadow-sm transition-all duration-200">
                        <option value="warranty_claim">Warranty Claim Template</option>
                    </select>
                </div>

                <!-- Recipient Email -->
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2">
                        <i class="fas fa-envelope mr-2 text-purple-600"></i>Recipient Email
                    </label>
                    <input type="email" id="recipientEmail"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50 text-gray-600 cursor-not-allowed"
                        readonly value="{{ ticket.email }}">
                </div>

                <!-- Email Subject -->
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2">
                        <i class="fas fa-tag mr-2 text-orange-600"></i>Subject
                    </label>
                    <input type="text" id="emailSubject"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white cursor-text hover:bg-gray-50 transition-colors shadow-sm"
                        placeholder="Enter email subject...">
                </div>

                <!-- Email Body -->
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2">
                        <i class="fas fa-edit mr-2 text-green-600"></i>Email Body
                    </label>
                    <textarea id="emailBody"
                        class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white cursor-text hover:bg-gray-50 transition-colors shadow-sm resize-vertical"
                        rows="12" placeholder="Enter email body..."></textarea>
                </div>

                <!-- Attachments Section -->
                <div class="mb-6">
                    <label class="block text-gray-700 text-sm font-medium mb-2">
                        <i class="fas fa-paperclip mr-2 text-indigo-600"></i>Available Attachments
                    </label>
                    <div id="availableAttachments"
                        class="space-y-3 max-h-48 overflow-y-auto bg-gray-50 rounded-lg p-4 border border-gray-200">
                        <!-- Attachments will be populated via JavaScript -->
                        <div class="text-center text-gray-500 py-8">
                            <i class="fas fa-paperclip text-2xl mb-2 text-gray-400"></i>
                            <p class="text-sm">No attachments available</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fixed Footer with Action Buttons -->
            <div class="border-t border-gray-200 pt-4 mt-4 bg-white">
                <div class="flex flex-wrap justify-end gap-3">
                    <button id="cancelEmailTemplate"
                        class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors font-medium">
                        <i class="fas fa-times mr-2"></i>Cancel
                    </button>
                    <button id="regenerateAttachments"
                        class="px-4 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-medium"
                        title="Regenerate attachment data for this ticket">
                        <i class="fas fa-sync-alt mr-2"></i>Regenerate
                    </button>
                    <button id="loadTemplate"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium">
                        <i class="fas fa-download mr-2"></i>Load Template
                    </button>
                    <button id="editTemplate"
                        class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition-colors font-medium"
                        style="display: none;">
                        <i class="fas fa-edit mr-2"></i>Edit Template
                    </button>
                    <button id="clearFields"
                        class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-medium">
                        <i class="fas fa-eraser mr-2"></i>Clear
                    </button>
                    <button id="sendEmail"
                        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium">
                        <i class="fas fa-paper-plane mr-2"></i>Send Email
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Layout Container - Left-Right Layout -->
    <div class="main-layout">
        <!-- Sidebar Toggle Button -->
        <button class="sidebar-toggle" id="sidebarToggleMobile" title="Toggle Sidebar">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Parallel Container for App and Sidebar -->
        <div class="parallel-container">
            <!-- App Container - Left Side -->
            <div class="app-container">
                <div class="container main-content max-w-screen-ultra expanded">
                    <div
                        class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 md:mb-6 space-y-2 sm:space-y-0">
                        <a href="/"
                            class="text-indigo-600 hover:text-indigo-800 flex items-center transition text-sm md:text-base">
                            <i class="fas fa-arrow-left mr-1 md:mr-2"></i> Back
                        </a>
                        <div class="flex items-center justify-end space-x-2 md:space-x-4">
                            <span class="text-gray-600 text-sm md:text-base">Welcome, {{ current_user }}</span>
                            <a href="/logout" class="p-1.5 md:p-2 rounded-full hover:bg-gray-200 transition"
                                title="Logout">
                                <i class="fas fa-sign-out-alt text-gray-600 text-lg md:text-xl"></i>
                            </a>
                        </div>
                    </div>

                                            <div class="bg-white rounded-xl shadow-lg overflow-hidden mb-6 transition-all hover:shadow-xl">
                            <div class="p-5 ticket-header priority-{{ ticket.priority|lower }} ticket-header-ultra">
                                <div class="ticket-header-main">
                                    <h1 class="text-xl font-bold text-gray-800 break-words line-clamp-3">#{{
                                        ticket.ticket_id }} - {{ ticket.subject }}</h1>
                                    <div class="flex flex-wrap items-center gap-2 mt-2 badge-container-ultra">
                                        <!-- Priority Badge -->
                                        <span class="px-3 py-1 text-xs rounded-lg font-medium
                                    {% if ticket.priority == 'Urgent' %}bg-red-100 text-red-800
                                    {% elif ticket.priority == 'High' %}bg-orange-100 text-orange-800
                                    {% elif ticket.priority == 'Medium' %}bg-yellow-100 text-yellow-800
                                    {% elif ticket.priority == 'Low' %}bg-green-100 text-green-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                            <i
                                                class="fas fa-{% if ticket.priority == 'Urgent' %}exclamation-triangle{% elif ticket.priority == 'High' %}exclamation{% elif ticket.priority == 'Medium' %}circle{% else %}check{% endif %} mr-1"></i>
                                            {{ ticket.priority }}
                                        </span>

                                        <!-- Status Badge -->
                                        <span
                                            class="px-3 py-1 text-xs rounded-lg font-medium status-{{ ticket.status|lower|replace(' ', '-')|replace('', '') }}">
                                            {{ ticket.status }}
                                        </span>

                                        <!-- Priority Selection Dropdown -->
                                        <div class="relative inline-block">
                                            <select id="prioritySelect" class="px-3 py-1 text-xs rounded-lg font-medium border-none bg-transparent appearance-none cursor-pointer
                                        {% if ticket.priority == 'Urgent' %}text-red-800 bg-red-100
                                        {% elif ticket.priority == 'High' %}text-orange-800 bg-orange-100
                                        {% elif ticket.priority == 'Medium' %}text-yellow-800 bg-yellow-100
                                        {% elif ticket.priority == 'Low' %}text-green-800 bg-green-100
                                        {% else %}text-gray-800 bg-gray-100{% endif %} hover:opacity-80 transition"
                                                data-ticket-id="{{ ticket.ticket_id }}">
                                                <option value="Urgent" {% if ticket.priority=='Urgent' %}selected{%
                                                    endif %}> Urgent</option>
                                                <option value="High" {% if ticket.priority=='High' %}selected{% endif
                                                    %}>
                                                    High</option>
                                                <option value="Medium" {% if ticket.priority=='Medium' %}selected{%
                                                    endif %}> Medium</option>
                                                <option value="Low" {% if ticket.priority=='Low' %}selected{% endif %}>
                                                    
                                                    Low</option>
                                            </select>
                                            <i
                                                class="fas fa-chevron-down absolute right-1 top-1/2 transform -translate-y-1/2 text-xs pointer-events-none"></i>
                                        </div>

                                        <!-- Technician Assignment Dropdown -->
                                        <div class="relative inline-block">
                                            <select id="technicianSelect"
                                                class="px-3 py-1 text-xs rounded-lg font-medium border-none bg-transparent appearance-none cursor-pointer
                                        {% if technician_name %}text-indigo-800 bg-indigo-100{% else %}text-gray-800 bg-gray-100{% endif %} hover:opacity-80 transition"
                                                data-ticket-id="{{ ticket.ticket_id }}">
                                                <option value=""> Select Technician</option>
                                                {% for tech in technicians %}
                                                <option value="{{ tech.id }}" {% if technician_id==tech.id %}selected{%
                                                    endif %}>
                                                     {{ tech.name }} ({{ tech.role or 'Technician' }})
                                                </option>
                                                {% endfor %}
                                            </select>
                                            <i
                                                class="fas fa-chevron-down absolute right-1 top-1/2 transform -translate-y-1/2 text-xs pointer-events-none"></i>
                                        </div>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="flex flex-wrap items-center gap-3 mt-2">
                                    <!-- Importance Button - Available for ALL users including Technical Director -->
                                    <button id="importantBtn"
                                        class="importance-btn {% if ticket.is_important %}important{% endif %} transition-all"
                                        title="Mark as important">
                                        <span class="star-icon">
                                            <i
                                                class="{% if ticket.is_important %}fas fa-star{% else %}far fa-star{% endif %}"></i>
                                        </span>
                                    </button>


                                    <!-- Status Dropdown - Available for ALL users including Technical Director -->
                                    <div class="status-dropdown">
                                        <button id="statusDropdownBtn" class="status-dropdown-btn">
                                            <span id="currentStatusDisplay">{{ ticket.status or 'Set Status' }}</span>
                                            <i class="fas fa-chevron-down"></i>
                                        </button>
                                        <div id="statusDropdownContent" class="status-dropdown-content">
                                            <div class="status-option" data-status="New">New</div>
                                            <div class="status-option" data-status="Form Sent">Form Sent</div>
                                            <div class="status-option" data-status="Awaiting Submission">Awaiting
                                                Submission
                                            </div>
                                            <div class="status-option" data-status="Under Review">Under Review</div>
                                            <div class="status-option" data-status="Info Requested">Info Requested</div>
                                            <div class="status-option" data-status="Warranty Form Received">Warranty
                                                Form
                                                Received</div>
                                            <div class="status-option" data-status="Referred to Tech Director">Referred
                                                to
                                                Tech Director</div>
                                            <div class="status-option" data-status="Approved  Revisit Booked">Approved
                                                
                                                Revisit Booked</div>
                                            <div class="status-option" data-status="Declined  Not Covered">Declined 
                                                Not
                                                Covered</div>
                                            <div class="status-option" data-status="Revisit">Revisit</div>
                                            <div class="status-option" data-status="Closed">Closed</div>
                                        </div>
                                    </div>

                                    <!-- Close Ticket Button - Available for ALL users including Technical Director -->
                                    {% if ticket.status and ticket.status.lower() not in ['resolved', 'closed',
                                    'declined',
                                    'cancelled'] %}
                                    <button id="closeResolvedBtn"
                                        class="px-3 py-1 rounded-xl bg-red-100 text-red-800 hover:bg-red-200 transition">
                                        <i class="fas fa-lock mr-1"></i> Close Ticket
                                    </button>
                                    {% endif %}

                                    <!-- Assignment Management - Available for ALL users including Technical Director -->
                                    {% if not is_tech_director %}
                                    <!-- Take Over Button (Not for Tech Director) -->
                                    {% if not ticket.assignment or ticket.assignment|length == 0 %}
                                    <button id="takeOverBtn"
                                        class="px-3 py-1 rounded-xl bg-blue-100 text-blue-800 hover:bg-blue-200 transition">
                                        <i class="fas fa-hand-paper mr-1"></i> Take Over
                                    </button>
                                    {% elif ticket.assignment and ticket.assignment|length > 0 and
                                    ticket.assigned_member
                                    and ticket.assigned_member|length > 0 %}
                                    <!-- Show assignment status -->
                                    <div
                                        class="px-2 py-1 rounded-lg border border-green-200 assignment-status {% if ticket.assignment[0].is_forwarded %}forwarded-badge{% else %}takeover-badge{% endif %} text-xs">
                                        {% if ticket.assignment[0].is_forwarded %}
                                        <div class="flex items-center">
                                            <i class="fas fa-share mr-1 text-xs"></i>
                                            <span class="font-medium">Forwarded from {{
                                                ticket.forwarded_from_member[0].name
                                                if ticket.forwarded_from_member and ticket.forwarded_from_member|length
                                                > 0
                                                else 'Unknown' }} to {{ ticket.assigned_member[0].name }}</span>
                                            {% if ticket.assigned_member[0]._id|string == session.member_id|string %}
                                            <span class="ml-1 opacity-75 font-bold">(You)</span>
                                            {% endif %}
                                        </div>
                                        {% else %}
                                        <div class="flex items-center">
                                            <i class="fas fa-hand-paper mr-1 text-xs"></i>
                                            <span class="font-medium">Taken over by {{ ticket.assigned_member[0].name
                                                }}</span>
                                            {% if ticket.assigned_member[0]._id|string == session.member_id|string %}
                                            <span class="ml-1 opacity-75 font-bold">(You)</span>
                                            {% endif %}
                                        </div>
                                        {% endif %}
                                        {% if ticket.assignment[0].assigned_at %}
                                        <div class="text-xs opacity-60 mt-1">{{
                                            ticket.assignment[0].assigned_at|format_datetime }}</div>
                                        {% endif %}
                                        {% if ticket.assignment[0].notes %}
                                        <div class="text-xs opacity-60 mt-1 italic">Note: {{ ticket.assignment[0].notes
                                            }}
                                        </div>
                                        {% endif %}
                                    </div>
                                    {% endif %}

                                    <!-- Refer to Tech Director Button (Not for Tech Director) -->
                                    {% set can_refer_to_td = (ticket.status != 'Referred to Tech Director') and
                                    (ticket.status != 'Closed') and (ticket.status != 'Resolved') %}
                                    {% set was_forwarded_back = (ticket.assignment and ticket.assignment|length > 0 and
                                    ticket.assigned_member and ticket.assigned_member|length > 0 and
                                    ticket.assignment[0].get('is_forwarded', False) and
                                    ticket.assignment[0].get('forwarded_from_tech_director', False)) %}

                                    {% if can_refer_to_td %}
                                    {% if was_forwarded_back %}
                                    <button id="referToTechDirectorBtn"
                                        class="px-3 py-1 rounded-xl bg-blue-100 text-blue-800 hover:bg-blue-200 transition"
                                        title="Re-refer this ticket to Technical Director (previously returned)">
                                        <i class="fas fa-redo mr-1"></i> Re-refer to Tech Director
                                    </button>
                                    {% else %}
                                    <button id="referToTechDirectorBtn"
                                        class="px-3 py-1 rounded-xl bg-orange-100 text-orange-800 hover:bg-orange-200 transition"
                                        title="Refer this ticket to Technical Director for expert review">
                                        <i class="fas fa-user-cog mr-1"></i> Refer to Tech Director
                                    </button>
                                    {% endif %}
                                    {% else %}
                                    {% if ticket.status == 'Referred to Tech Director' %}
                                    <div
                                        class="px-3 py-1 rounded-xl bg-orange-50 text-orange-700 border border-orange-200">
                                        <i class="fas fa-check-circle mr-1"></i> Currently with Tech Director
                                    </div>
                                    {% else %}
                                    <div class="px-3 py-1 rounded-xl bg-gray-50 text-gray-700 border border-gray-200">
                                        <i class="fas fa-lock mr-1"></i> Cannot Refer ({{ ticket.status }})
                                    </div>
                                    {% endif %}
                                    {% endif %}
                                    {% endif %}

                                    <!-- Email Template Button - Available for ALL users including Technical Director (only for open tickets) -->
                                    {% if ticket.status and ticket.status.lower() not in ['resolved', 'closed',
                                    'declined',
                                    'cancelled'] %}
                                    <button id="emailTemplateBtn"
                                        class="px-3 py-1 rounded-xl bg-purple-100 text-purple-800 hover:bg-purple-200 transition"
                                        title="Send email using template">
                                        <i class="fas fa-envelope-open-text mr-1"></i> Email Template
                                    </button>
                                    {% endif %}

                                    <!-- Forward Button - Available for both regular users and Technical Director (only for open tickets) -->
                                    {% if ticket.status and ticket.status.lower() not in ['resolved', 'closed',
                                    'declined',
                                    'cancelled'] %}
                                    <button id="forwardBtn"
                                        class="px-3 py-1 rounded-xl {% if is_tech_director %}bg-blue-100 text-blue-800 hover:bg-blue-200{% else %}bg-green-100 text-green-800 hover:bg-green-200{% endif %} transition">
                                        <i class="fas fa-share mr-1"></i> {% if is_tech_director %}Forward to Support
                                        Team{%
                                        else %}Forward{% endif %}
                                    </button>
                                    {% endif %}

                                    {% if is_tech_director %}
                                    <!-- Technical Director View - Show assignment status -->
                                    {% if ticket.assignment and ticket.assignment|length > 0 and ticket.assigned_member
                                    and
                                    ticket.assigned_member|length > 0 %}
                                    <div class="px-3 py-1 rounded-lg border border-gray-200 bg-gray-50">
                                        {% if ticket.assignment[0].is_forwarded %}
                                        <i class="fas fa-share mr-1 text-blue-600"></i>
                                        Forwarded from {{ ticket.forwarded_from_member[0].name if
                                        ticket.forwarded_from_member and ticket.forwarded_from_member|length > 0 else
                                        'Unknown' }} to {{ ticket.assigned_member[0].name }}
                                        {% else %}
                                        <i class="fas fa-hand-paper mr-1 text-green-600"></i>
                                        Taken over by {{ ticket.assigned_member[0].name }}
                                        {% endif %}
                                        {% if ticket.assignment[0].assigned_at %}
                                        <div class="text-xs opacity-75 mt-1">{{
                                            ticket.assignment[0].assigned_at|format_datetime }}</div>
                                        {% endif %}
                                    </div>
                                    {% endif %}
                                    {% endif %}
                                </div>
                            </div>

                            <!-- Ticket Details -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                                <div class="detail-card">
                                    <h3 class="text-sm font-medium text-gray-500">Customer</h3>
                                    <p class="text-gray-800 font-medium break-words truncate">
                                        {% if customer_title or customer_first_name or customer_surname %}
                                        {% if customer_title %}{{ customer_title }} {% endif %}
                                        {% if customer_first_name %}{{ customer_first_name }} {% endif %}
                                        {% if customer_surname %}{{ customer_surname }}{% endif %}
                                        {% else %}
                                        {{ ticket.name }}
                                        {% endif %}
                                    </p>
                                    <p class="text-gray-600 text-sm break-words truncate">{{ ticket.email }}</p>
                                    {% if ticket.phone %}
                                    <p class="text-gray-600 text-sm mt-1 break-words truncate"><i
                                            class="fas fa-phone mr-1"></i> {{ ticket.phone }}</p>
                                    {% endif %}
                                </div>

                                <div class="detail-card">
                                    <h3 class="text-sm font-medium text-gray-500">Created</h3>
                                    <p class="text-gray-800">{{ formatted_date }}</p>
                                </div>

                                <div class="detail-card">
                                    <h3 class="text-sm font-medium text-gray-500">Last Updated</h3>
                                    <p class="text-gray-800">{{ ticket.updated_at|format_datetime }}</p>
                                </div>
                            </div>

                            <!-- Vehicle Information -->
                            {% if vehicle_registration %}
                            <div class="mb-6">
                                <h3 class="text-sm font-medium text-gray-500 mb-2">Vehicle & Claim Information</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 vehicle-info-grid">
                                    {% if vehicle_registration %}
                                    <div class="detail-card flex items-center">
                                        <div class="p-3 rounded-full bg-blue-100 mr-4">
                                            <i class="fas fa-car text-blue-600"></i>
                                        </div>
                                        <div>
                                            <h4 class="text-xs font-medium text-gray-500">Registration</h4>
                                            <p class="text-gray-800 font-semibold break-words truncate">{{
                                                vehicle_registration }}</p>
                                        </div>
                                    </div>
                                    {% endif %}

                                    {% if service_date %}
                                    <div class="detail-card flex items-center">
                                        <div class="p-3 rounded-full bg-purple-100 mr-4">
                                            <i class="fas fa-calendar-check text-purple-600"></i>
                                        </div>
                                        <div>
                                            <h4 class="text-xs font-medium text-gray-500">Service Date</h4>
                                            <p class="text-gray-800 font-semibold">{{ service_date }}</p>
                                        </div>
                                    </div>
                                    {% endif %}

                                    {% if claim_date %}
                                    <div class="detail-card flex items-center">
                                        <div class="p-3 rounded-full bg-yellow-100 mr-4">
                                            <i class="fas fa-calendar-alt text-yellow-600"></i>
                                        </div>
                                        <div>
                                            <h4 class="text-xs font-medium text-gray-500">Claim Date</h4>
                                            <p class="text-gray-800 font-semibold">{{ claim_date }}</p>
                                        </div>
                                    </div>
                                    {% endif %}

                                    <!-- Technician Field -->
                                    {% if technician %}
                                    <div class="detail-card flex items-center">
                                        <div class="p-3 rounded-full bg-indigo-100 mr-4">
                                            <i class="fas fa-user-cog text-indigo-600"></i>
                                        </div>
                                        <div>
                                            <h4 class="text-xs font-medium text-gray-500">Technician</h4>
                                            <p class="text-gray-800 font-semibold">{{ technician }}</p>
                                            {% if technician_info %}
                                            <p class="text-gray-600 text-xs mt-1">
                                                <i class="fas fa-id-badge mr-1"></i> {{ technician_info.user_id }}
                                                {% if technician_info.role %}
                                                <span
                                                    class="ml-2 px-2 py-1 bg-indigo-100 text-indigo-800 text-xs rounded-full">{{
                                                    technician_info.role }}</span>
                                                {% endif %}
                                            </p>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}

                                    <!-- Type of Claim -->
                                    {% if type_of_claim %}
                                    <div class="detail-card flex items-center">
                                        <div class="p-3 rounded-full bg-orange-100 mr-4">
                                            <i class="fas fa-clipboard-list text-orange-600"></i>
                                        </div>
                                        <div>
                                            <h4 class="text-xs font-medium text-gray-500">Type of Claim</h4>
                                            <p class="text-gray-800 font-semibold">{{ type_of_claim }}</p>
                                        </div>
                                    </div>
                                    {% endif %}

                                    <!-- Days Between Service and Claim -->
                                    {% if days_between_service_claim %}
                                    <div class="detail-card flex items-center">
                                        <div class="p-3 rounded-full bg-pink-100 mr-4">
                                            <i class="fas fa-clock text-pink-600"></i>
                                        </div>
                                        <div>
                                            <h4 class="text-xs font-medium text-gray-500">Days Between Service & Claim
                                            </h4>
                                            <p class="text-gray-800 font-semibold">{{ days_between_service_claim }}
                                                day{% if
                                                days_between_service_claim != '1' %}s{% endif %}</p>
                                        </div>
                                    </div>
                                    {% endif %}

                                    <!-- VHC Link -->
                                    {% if vhc_link %}
                                    <div class="detail-card flex items-center">
                                        <div class="p-3 rounded-full bg-cyan-100 mr-4">
                                            <i class="fas fa-link text-cyan-600"></i>
                                        </div>
                                        <div>
                                            <h4 class="text-xs font-medium text-gray-500">VHC (Vehicle Health Check)
                                            </h4>
                                            <a href="{{ vhc_link }}" target="_blank"
                                                class="text-indigo-600 hover:text-indigo-800 flex items-center">
                                                <i class="fas fa-external-link-alt mr-1"></i> View Report
                                            </a>
                                        </div>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}

                            <!-- Checklist Information -->
                            {% if advisories_followed or within_warranty or new_fault_codes or dpf_light_on or
                            eml_light_on
                            %}
                            <div class="mb-6">
                                <h3 class="text-sm font-medium text-gray-500 mb-2">Claim Checklist</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 checklist-grid">
                                    <div class="detail-card">
                                        <ul class="space-y-3">
                                            {% if advisories_followed == '1' %}
                                            <li class="flex items-center">
                                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                                <span>Advisories Followed</span>
                                            </li>
                                            {% endif %}

                                            {% if within_warranty == '1' %}
                                            <li class="flex items-center">
                                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                                <span>Within Warranty Period</span>
                                            </li>
                                            {% endif %}

                                            {% if new_fault_codes == '1' %}
                                            <li class="flex items-center">
                                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                                <span>Provided New Fault Codes</span>
                                            </li>
                                            {% endif %}
                                        </ul>
                                    </div>
                                    <div class="detail-card">
                                        <ul class="space-y-3">
                                            {% if dpf_light_on == '1' %}
                                            <li class="flex items-center">
                                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                                <span>DPF Light On</span>
                                            </li>
                                            {% endif %}

                                            {% if eml_light_on == '1' %}
                                            <li class="flex items-center">
                                                <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                                <span>EML Light On</span>
                                            </li>
                                            {% endif %}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Structured Attachments -->
                            <!-- Enhanced Outcome Section -->
                            <div class="mb-8 bg-white border border-gray-200 rounded-lg p-6 shadow-sm outcome-section">
                                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-6 gap-3">
                                    <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                                        <i class="fas fa-clipboard-check mr-3 text-purple-600"></i> Outcome Assessment
                                    </h3>
                                    <button id="editOutcomeBtn"
                                        class="px-4 py-2 text-sm bg-purple-100 text-purple-800 rounded-lg hover:bg-purple-200 transition">
                                        <i class="fas fa-edit mr-2"></i> Edit Outcome
                                    </button>
                                </div>

                                <!-- Outcome Display View -->
                                <div id="outcomeDisplayView">
                                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                                        {% if outcome_category %}
                                        <div class="detail-card flex items-center">
                                            <div class="p-3 rounded-full bg-purple-100 mr-4">
                                                <i class="fas fa-tags text-purple-600"></i>
                                            </div>
                                            <div>
                                                <h4 class="text-xs font-medium text-gray-500 mb-2">Outcome Category</h4>
                                                <span class="px-2 py-1 text-xs rounded-full font-medium
                                        {% if outcome_category == 'Technician Issue' %}bg-red-100 text-red-800
                                        {% elif outcome_category == 'New Fault' %}bg-orange-100 text-orange-800
                                        {% elif outcome_category == 'Advisories Not Followed' %}bg-yellow-100 text-yellow-800
                                        {% elif outcome_category == 'Driving Style' %}bg-blue-100 text-blue-800
                                        {% elif outcome_category == 'Customer Issue' %}bg-pink-100 text-pink-800
                                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                                                    {{ outcome_category }}
                                                </span>
                                            </div>
                                        </div>
                                        {% else %}
                                        <div class="detail-card flex items-center">
                                            <div class="p-3 rounded-full bg-gray-100 mr-4">
                                                <i class="fas fa-tags text-gray-400"></i>
                                            </div>
                                            <div>
                                                <h4 class="text-xs font-medium text-gray-500 mb-2">Outcome Category</h4>
                                                <span class="text-sm text-gray-400">Not set</span>
                                            </div>
                                        </div>
                                        {% endif %}

                                        <div class="detail-card">
                                            <h4 class="text-xs font-medium text-gray-500 mb-2">Actions Completed</h4>
                                            <div class="space-y-2">
                                                {% if revisit_carried_out == '1' %}
                                                <div class="flex items-center text-green-700">
                                                    <i class="fas fa-check-circle mr-2"></i>
                                                    <span class="text-sm">Revisit Carried Out</span>
                                                </div>
                                                {% endif %}
                                                {% if clean_under_warranty == '1' %}
                                                <div class="flex items-center text-green-700">
                                                    <i class="fas fa-check-circle mr-2"></i>
                                                    <span class="text-sm">Clean Carried Out Under Warranty</span>
                                                </div>
                                                {% endif %}
                                                {% if not revisit_carried_out and not clean_under_warranty %}
                                                <span class="text-sm text-gray-400">No actions completed</span>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>

                                    <div class="detail-card col-span-1 lg:col-span-2">
                                        <h4 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
                                            <i class="fas fa-sticky-note mr-2 text-purple-600"></i> Outcome Notes
                                        </h4>
                                        <div class="bg-gray-50 rounded-lg p-4 min-h-[80px]">
                                            {% if outcome_notes %}
                                            <p class="text-gray-700 text-sm whitespace-pre-wrap leading-relaxed">{{
                                                outcome_notes }}</p>
                                            {% else %}
                                            <span class="text-sm text-gray-400 italic">No notes added</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>

                                <!-- Outcome Edit Form (Initially Hidden) -->
                                <div id="outcomeEditView"
                                    class="hidden bg-gray-50 rounded-lg p-6 border-2 border-purple-200">
                                    <div class="mb-4">
                                        <h4 class="text-lg font-semibold text-gray-800 flex items-center">
                                            <i class="fas fa-edit mr-2 text-purple-600"></i> Edit Outcome Assessment
                                        </h4>
                                    </div>

                                    <form id="outcomeForm" class="space-y-6">
                                        <!-- Grid Layout for Form Fields -->
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            <!-- Outcome Dropdown -->
                                            <div class="md:col-span-2">
                                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                                    <i class="fas fa-tags mr-1"></i> Outcome Category
                                                </label>
                                                <select id="outcomeCategory"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                                    <option value="">Select outcome</option>
                                                    <option value="Technician Issue" {% if
                                                        outcome_category=='Technician Issue' %}selected{% endif %}>
                                                        Technician Issue</option>
                                                    <option value="New Fault" {% if outcome_category=='New Fault'
                                                        %}selected{% endif %}>New Fault</option>
                                                    <option value="Advisories Not Followed" {% if
                                                        outcome_category=='Advisories Not Followed' %}selected{% endif
                                                        %}>
                                                        Advisories Not Followed</option>
                                                    <option value="Driving Style" {% if
                                                        outcome_category=='Driving Style' %}selected{% endif %}>Driving
                                                        Style</option>
                                                    <option value="Customer Issue" {% if
                                                        outcome_category=='Customer Issue' %}selected{% endif %}>
                                                        Customer Issue</option>
                                                    <option value="Other" {% if outcome_category=='Other' %}selected{%
                                                        endif %}>Other</option>
                                                </select>
                                            </div>

                                            <!-- Checkboxes -->
                                            <div class="md:col-span-2">
                                                <label class="block text-sm font-medium text-gray-700 mb-3">
                                                    <i class="fas fa-check-square mr-1"></i> Actions Completed
                                                </label>
                                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                                    <label
                                                        class="flex items-center bg-white p-3 rounded-lg border border-gray-200 hover:border-purple-300 transition cursor-pointer">
                                                        <input type="checkbox" id="revisitCarriedOut"
                                                            class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded"
                                                            {% if revisit_carried_out=='1' %}checked{% endif %}>
                                                        <span class="ml-3 text-sm text-gray-700">Revisit Carried
                                                            Out</span>
                                                    </label>
                                                    <label
                                                        class="flex items-center bg-white p-3 rounded-lg border border-gray-200 hover:border-purple-300 transition cursor-pointer">
                                                        <input type="checkbox" id="cleanUnderWarranty"
                                                            class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded"
                                                            {% if clean_under_warranty=='1' %}checked{% endif %}>
                                                        <span class="ml-3 text-sm text-gray-700">Clean Carried Out Under
                                                            Warranty</span>
                                                    </label>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Outcome Notes - Full Width -->
                                        <div>
                                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                                <i class="fas fa-sticky-note mr-1"></i> Outcome Notes
                                            </label>
                                            <textarea id="outcomeNotes"
                                                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 bg-white"
                                                rows="5"
                                                placeholder="Add detailed outcome information, explanations, or next steps...">{{ outcome_notes or '' }}</textarea>
                                        </div>

                                        <!-- Action Buttons -->
                                        <div
                                            class="flex flex-col sm:flex-row justify-end gap-3 pt-4 border-t border-gray-200">
                                            <button type="button" id="cancelOutcomeBtn"
                                                class="px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition font-medium">
                                                <i class="fas fa-times mr-2"></i>Cancel
                                            </button>
                                            <button type="submit" id="saveOutcomeBtn"
                                                class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-medium">
                                                <i class="fas fa-save mr-2"></i>Save Outcome
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>

                            {# Display Email Attachments (New System) - With Duplicate Removal #}
                            {% if ticket.simple_attachments and ticket.simple_attachments|length > 0 %}

                            {% set unique_attachments = [] %}
                            {% set processed_base_names = [] %}
                            {% for attachment in ticket.simple_attachments %}
                            {% set base_filename = attachment.fileName %}
                            {% if base_filename.startswith('20') and base_filename[8] == '_' and base_filename[15] ==
                            '_' %}
                            {% set base_filename = base_filename[16:] %}
                            {% endif %}
                            {% if base_filename not in processed_base_names %}
                            {% set _ = processed_base_names.append(base_filename) %}
                            {% set _ = unique_attachments.append(attachment) %}
                            {% endif %}
                            {% endfor %}

                            <div class="mb-6">
                                <h3 class="text-sm font-medium text-gray-500 mb-2">Attachments ({{
                                    unique_attachments|length
                                    }})</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 attachments-container">
                                    {% for attachment in unique_attachments %}
                                    <div class="detail-card flex items-start">
                                        <div class="p-3 rounded-full mr-4 
                                {% if attachment.is_warranty %}bg-green-100{% else %}bg-blue-100{% endif %}">
                                            {% if attachment.fileName.lower().endswith('.pdf') %}
                                            <i
                                                class="fas fa-file-pdf {% if attachment.is_warranty %}text-green-600{% else %}text-red-600{% endif %}"></i>
                                            {% elif attachment.fileName.lower().endswith(('.jpg', '.jpeg', '.png',
                                            '.gif'))
                                            %}
                                            <i
                                                class="fas fa-file-image {% if attachment.is_warranty %}text-green-600{% else %}text-purple-600{% endif %}"></i>
                                            {% elif attachment.fileName.lower().endswith(('.doc', '.docx')) %}
                                            <i
                                                class="fas fa-file-word {% if attachment.is_warranty %}text-green-600{% else %}text-blue-600{% endif %}"></i>
                                            {% elif attachment.fileName.lower().endswith(('.xls', '.xlsx')) %}
                                            <i
                                                class="fas fa-file-excel {% if attachment.is_warranty %}text-green-600{% else %}text-green-500{% endif %}"></i>
                                            {% else %}
                                            <i
                                                class="fas fa-file {% if attachment.is_warranty %}text-green-600{% else %}text-gray-600{% endif %}"></i>
                                            {% endif %}
                                        </div>
                                        <div class="flex-1">
                                            <div class="flex items-center gap-2 mb-1">
                                                <h4 class="text-xs font-medium text-gray-500">
                                                    {{ attachment.fileName | truncate(40) }}
                                                </h4>
                                                {% if attachment.is_warranty %}
                                                <span
                                                    class="bg-green-100 text-green-800 px-2 py-0.5 rounded-full text-xs font-medium">
                                                    <i class="fas fa-shield-alt mr-1"></i>Warranty
                                                </span>
                                                {% endif %}
                                            </div>
                                            <div class="flex items-center gap-4">
                                                <button
                                                    onclick="downloadEmailAttachment('{{ ticket.ticket_id }}', '{{ loop.index0 }}', '{{ attachment.fileName }}')"
                                                    class="text-indigo-600 hover:text-indigo-800 flex items-center text-sm transition">
                                                    <i class="fas fa-download mr-1"></i> Download
                                                </button>
                                                {% if attachment.fileName.lower().endswith(('.jpg', '.jpeg', '.png',
                                                '.gif',
                                                '.pdf')) %}
                                                <button
                                                    onclick="previewEmailAttachment('{{ ticket.ticket_id }}', '{{ loop.index0 }}', '{{ attachment.fileName }}')"
                                                    class="text-gray-600 hover:text-gray-800 flex items-center text-sm transition">
                                                    <i class="fas fa-eye mr-1"></i> Preview
                                                </button>
                                                {% endif %}
                                            </div>
                                            {% if attachment.size %}
                                            <p class="text-xs text-gray-400 mt-1">{{ attachment.size_formatted or
                                                (attachment.size | filesizeformat) }}</p>
                                            {% endif %}
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                            {% endif %}




                            <!-- Original Message -->
                            <div class="mb-6">
                                <h3 class="text-sm font-medium text-gray-500 mb-2">Original Message</h3>
                                <div class="original-message-container">
                                    <div class="original-message-content {% if ticket.body|length > 500 %}truncated{% endif %}"
                                        id="originalMessage">
                                        {{ ticket.body }}
                                        <div class="read-more-btn" onclick="expandMessage('originalMessage')">
                                            <i class="fas fa-chevron-down mr-1"></i> Read More
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Conversation Section -->
                        <div class="px-6 py-4 border-t">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-comments mr-2 text-indigo-600"></i> Conversation
                            </h2>

                            {% if not replies %}
                            <div class="text-center text-gray-500 py-8 bg-gray-50 rounded-lg">
                                <i class="fas fa-comment-slash text-3xl mb-2 text-gray-400"></i>
                                <p>No replies yet. Be the first to respond!</p>
                            </div>
                            {% endif %}

                            <div class="conversation-container">
                                {% for reply in replies %}
                                <div
                                    class="message {% if reply.is_customer %}customer-message{% else %}support-message{% endif %}">
                                    <div class="message-header">
                                        <span class="font-medium flex items-center">
                                            {% if reply.is_customer %}
                                            <i class="fas fa-user-circle customer-icon"></i> {{ ticket.name }}
                                            {% else %}
                                            <i class="fas fa-headset support-icon"></i> Support Team
                                            {% endif %}
                                        </span>
                                        <span class="message-time">
                                            <i class="fas fa-clock mr-1"></i>{{ reply.formatted_date }}
                                        </span>
                                    </div>
                                    <div class="reply-message-box {% if reply.message|length > 200 %}truncated{% endif %}"
                                        id="message-{{ loop.index }}">
                                        <div class="message-content">
                                            {{ reply.message }}
                                        </div>
                                        <div class="expand-btn" onclick="expandMessage('message-{{ loop.index }}')">
                                            <i class="fas fa-chevron-down mr-1"></i> Read More
                                        </div>
                                    </div>

                                    {% set downloadable_attachments = [] %}
                                    {% for attachment in reply.attachments %}
                                    {% if attachment.type == 'file' or attachment.source == 'webhook_base64' or
                                    attachment.source == 'webhook' or not attachment.type %}
                                    {% set _ = downloadable_attachments.append(attachment) %}
                                    {% endif %}
                                    {% endfor %}



                                    {% if downloadable_attachments and downloadable_attachments|length > 0 %}
                                    <div class="mt-2 border-t border-gray-100 pt-2">
                                        <div class="text-xs text-gray-500 mb-1 flex items-center justify-between">
                                            <div class="flex items-center">
                                                <i class="fas fa-paperclip mr-1"></i>
                                                Attachments ({{ downloadable_attachments|length }}):
                                            </div>
                                            <!-- Regenerate button for webhook attachments -->
                                            {% if reply.source == 'webhook' or reply.source == 'n8n' %}
                                            <button onclick="regenerateWebhookAttachments()"
                                                class="text-xs bg-orange-100 hover:bg-orange-200 text-orange-600 px-2 py-1 rounded transition"
                                                title="Regenerate webhook attachments if they're not working">
                                                <i class="fas fa-sync-alt mr-1"></i>Regenerate
                                            </button>
                                            {% endif %}
                                        </div>
                                        <div class="flex flex-wrap gap-2">
                                            {% for attachment in downloadable_attachments %}
                                            {% if attachment.type == 'file' or attachment.source in ['webhook_base64',
                                            'webhook'] or not attachment.type %}
                                            <div
                                                class="bg-gray-50 border border-gray-200 rounded-lg p-2 flex items-center justify-between text-xs max-w-xs">
                                                <div class="flex items-center min-w-0 flex-1">
                                                    {% set filename = attachment.filename or attachment.name or
                                                    attachment.original_name or 'Unknown File' %}
                                                    {% if filename.endswith('.pdf') %}
                                                    <i class="fas fa-file-pdf text-red-500 mr-2 flex-shrink-0"></i>
                                                    {% elif filename.endswith('.doc') or filename.endswith('.docx') %}
                                                    <i class="fas fa-file-word text-blue-500 mr-2 flex-shrink-0"></i>
                                                    {% elif filename.endswith('.xls') or filename.endswith('.xlsx') %}
                                                    <i class="fas fa-file-excel text-green-500 mr-2 flex-shrink-0"></i>
                                                    {% elif filename.endswith('.jpg') or filename.endswith('.jpeg') or
                                                    filename.endswith('.png') or filename.endswith('.gif') %}
                                                    <i class="fas fa-file-image text-purple-500 mr-2 flex-shrink-0"></i>
                                                    {% else %}
                                                    <i class="fas fa-file text-gray-500 mr-2 flex-shrink-0"></i>
                                                    {% endif %}
                                                    <div class="min-w-0 flex-1">
                                                        <div class="font-medium truncate max-w-[120px]"
                                                            title="{{ filename }}">{{ filename }}</div>
                                                        {% if attachment.size and attachment.size > 0 %}
                                                        <div class="text-gray-400 text-[10px]">({{ (attachment.size /
                                                            1024)
                                                            | round(1) }} KB)</div>
                                                        {% endif %}

                                                    </div>
                                                </div>
                                                <div class="flex gap-1 ml-2">
                                                    {% set source = attachment.source|default('reply') %}
                                                    {% set can_preview = filename.endswith('.jpg') or
                                                    filename.endswith('.jpeg') or filename.endswith('.png') or
                                                    filename.endswith('.gif') or filename.endswith('.pdf') or
                                                    filename.endswith('.txt') or filename.endswith('.md') %}
                                                    {% set can_download = attachment.type == 'file' or attachment.source
                                                    ==
                                                    'webhook_base64' or attachment.source == 'webhook' %}
                                                    {% if can_preview and can_download %}
                                                    <button
                                                        onclick="previewAttachment('{{ reply._id|e }}', '{{ loop.index0 }}', '{{ filename|e }}', '{{ source|e }}')"
                                                        class="bg-blue-100 hover:bg-blue-200 text-blue-600 px-1.5 py-1 rounded text-[10px] transition"
                                                        title="Preview {{ filename }}">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    {% endif %}
                                                    {% if can_download %}
                                                    <button
                                                        onclick="downloadAttachment('{{ reply._id|e }}', '{{ loop.index0 }}', '{{ filename|e }}', '{{ source|e }}')"
                                                        class="bg-green-100 hover:bg-green-200 text-green-600 px-1.5 py-1 rounded text-[10px] transition"
                                                        title="Download {{ filename }}">
                                                        <i class="fas fa-download"></i>
                                                    </button>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            {% elif attachment.type == 'common-document' %}
                                            <button onclick="viewCommonDocument('{{ attachment.ref }}')"
                                                class="bg-blue-50 hover:bg-blue-100 px-2 py-1 rounded flex items-center text-xs transition">
                                                <i class="fas fa-file-alt text-blue-500 mr-1"></i>
                                                <span>{{ attachment.name|default('Common Document') }}</span>
                                            </button>
                                            {% elif attachment.type == 'text_reference' %}
                                            <div class="bg-green-50 px-2 py-1 rounded flex items-center text-xs cursor-pointer hover:bg-green-100 transition-colors"
                                                onclick="handleTextReferenceAttachment('{{ attachment.name|e }}', '{{ attachment.description|e }}')"
                                                title="Click to view text reference details">
                                                <i class="fas fa-paperclip text-green-500 mr-1"></i>
                                                <span class="font-medium">{{ attachment.name }}</span>
                                                {% if attachment.description %}
                                                <span class="text-gray-500 ml-1">- {{ attachment.description }}</span>
                                                {% endif %}
                                                <span class="text-blue-500 ml-2 text-[10px]">(Text Reference - Click to
                                                    view)</span>
                                            </div>
                                            {% endif %}
                                            {% endfor %}
                                        </div>

                                    </div>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>

                            <!-- Reply Form (only for open tickets) -->
                            {% if ticket.status and ticket.status.lower() not in ['resolved', 'closed', 'declined',
                            'cancelled'] %}
                            <form id="replyForm" class="mt-8 reply-form">
                                <div class="mb-4 relative">
                                    <div class="flex items-start">
                                        <div class="flex-grow">
                                            <!-- Enhanced Modern chat-style input area with drag & drop -->
                                            <div id="replyDropzone"
                                                class="bg-white border border-gray-300 rounded-lg shadow-sm overflow-hidden transition-all duration-200"
                                                data-dropzone="true">
                                                <!-- Text input area -->
                                                <textarea id="response" name="response" rows="3"
                                                    class="w-full px-4 py-3 outline-none border-0 resize-none auto-expand-textarea"
                                                    placeholder="Type your response here... (Drag & drop files or documents here!)"
                                                    style="min-height: 60px; max-height: 300px; overflow-y: auto;">{{ ticket.draft_body }}</textarea>

                                                <!-- Hidden file input -->
                                                <input id="response_attachments" name="response_attachments" type="file"
                                                    multiple class="hidden"
                                                    accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.xlsx,.xls,.txt,.csv,.zip"
                                                    title="Select files to attach to your reply (Max 10MB per file)">

                                                <!-- Enhanced Preview area for ALL attachments (files + common documents) -->
                                                <div id="enhancedAttachmentPreview"
                                                    class="px-4 py-2 border-t border-gray-100 hidden">
                                                    <div class="flex items-center justify-between mb-2">
                                                        <div class="text-xs text-gray-500"> Attachments:</div>
                                                        <button type="button" id="clearAllAttachments"
                                                            class="text-xs text-red-500 hover:text-red-700 hover:bg-red-50 px-2 py-1 rounded">
                                                            Clear All
                                                        </button>
                                                    </div>
                                                    <div id="attachmentPreviewList" class="space-y-2"></div>
                                                </div>

                                                <!-- Bottom toolbar -->
                                                <div
                                                    class="flex items-center justify-between px-4 py-2 border-t border-gray-200">
                                                    <div class="flex items-center space-x-2">
                                                        <!-- Attachment button -->
                                                        <button type="button" id="attachmentBtn"
                                                            class="text-gray-500 hover:text-green-500 focus:outline-none p-1 rounded-full hover:bg-gray-100"
                                                            title="Attach files">
                                                            <i class="fas fa-paperclip text-lg"></i>
                                                            <span
                                                                class="attachment-count hidden absolute -top-1 -right-1 bg-green-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center">0</span>
                                                        </button>

                                                        <!-- Quick response button -->
                                                        <button type="button" id="quickResponseBtn"
                                                            class="text-gray-500 hover:text-indigo-600 focus:outline-none p-1 rounded-full hover:bg-gray-100">
                                                            <i class="fas fa-bolt text-lg"></i>
                                                        </button>

                                                        <!-- Quick response dropdown -->
                                                        <div id="quickResponseDropdown"
                                                            class="absolute left-0 bottom-full mb-2 w-64 bg-white rounded-md shadow-lg z-[100] border border-gray-200">
                                                            <div class="py-1">
                                                                <button type="button"
                                                                    class="quick-response-item block w-full text-left px-4 py-2 text-sm hover:bg-gray-100">
                                                                    <i class="fas fa-check text-green-500 mr-2"></i>
                                                                    Issue
                                                                    Resolved
                                                                </button>
                                                                <button type="button"
                                                                    class="quick-response-item block w-full text-left px-4 py-2 text-sm hover:bg-gray-100">
                                                                    <i
                                                                        class="fas fa-info-circle text-blue-500 mr-2"></i>
                                                                    Need More Information
                                                                </button>
                                                                <button type="button"
                                                                    class="quick-response-item block w-full text-left px-4 py-2 text-sm hover:bg-gray-100">
                                                                    <i class="fas fa-clock text-orange-500 mr-2"></i> In
                                                                    Progress Update
                                                                </button>
                                                                <button type="button"
                                                                    class="quick-response-item block w-full text-left px-4 py-2 text-sm hover:bg-gray-100">
                                                                    <i
                                                                        class="fas fa-calendar-check text-purple-500 mr-2"></i>
                                                                    Schedule Follow-up
                                                                </button>
                                                                <div class="border-t border-gray-200 my-1"></div>
                                                                <button type="button" id="showAttachmentsBtn"
                                                                    class="quick-response-item block w-full text-left px-4 py-2 text-sm hover:bg-gray-100">
                                                                    <i class="fas fa-paperclip text-gray-500 mr-2"></i>
                                                                    Attach Files
                                                                </button>
                                                                <button type="button"
                                                                    class="quick-response-item block w-full text-left px-4 py-2 text-sm hover:bg-gray-100">
                                                                    <i class="fas fa-save text-indigo-500 mr-2"></i>
                                                                    Save as
                                                                    Template
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <!-- Send button -->
                                                    <button type="submit" id="sendBtn"
                                                        class="inline-flex items-center justify-center p-2 rounded-full bg-indigo-600 text-white hover:bg-indigo-700 focus:outline-none">
                                                        <i class="fas fa-paper-plane"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </form>
                            {% else %}
                            <!-- Ticket is closed - show message instead of reply form -->
                            <div class="mt-8 p-6 bg-gray-50 border border-gray-200 rounded-lg text-center">
                                <div class="flex items-center justify-center mb-3">
                                    <i class="fas fa-lock text-gray-500 text-2xl mr-3"></i>
                                    <h3 class="text-lg font-semibold text-gray-700">Ticket Closed</h3>
                                </div>
                                <p class="text-gray-600">This ticket has been {{ ticket.status.lower() }} and is no
                                    longer
                                    accepting new replies.</p>
                                {% if ticket.closed_by and ticket.closed_at %}
                                <p class="text-sm text-gray-500 mt-2">Closed by {{ ticket.closed_by }} on {{
                                    ticket.closed_at|format_datetime }}</p>
                                {% endif %}
                            </div>
                            {% endif %}

                            <!-- File Attachments Section (Hidden) - this is the dropzone for drag and drop -->
                            <div id="attachmentSection" class="hidden">
                                <div id="attachmentDropzone"
                                    class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-indigo-400 transition">
                                    <div class="space-y-1 text-center">
                                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none"
                                            viewBox="0 0 48 48" aria-hidden="true">
                                            <path
                                                d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02"
                                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                                        </svg>
                                        <div class="text-sm text-gray-600">
                                            <label for="response_attachments"
                                                class="relative cursor-pointer rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none">
                                                <span>Upload files</span>
                                            </label>
                                            <p class="pl-1">or drag and drop</p>
                                        </div>
                                        <p class="text-xs text-gray-500">PDF, Word, Excel, Images up to 10MB each</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Template data -->
                <script type="application/json" id="attachments-data">
        {{ attachments|tojson|default('[]')|safe }}
    </script>

                <script>

                    let processedDocuments = new Set(); // Track all processed documents in this session
                    let lastProcessedDocument = null;
                    let lastProcessedTime = 0;

                    //  REMOVED: Old attachment variables - replaced by enhanced system

                    // Notification system
                    function showNotification(message, type = 'success') {
                        const notification = document.getElementById('notification');
                        const notificationMessage = document.getElementById('notification-message');

                        notification.className = `notification ${type}`;
                        notificationMessage.textContent = message;
                        notification.classList.add('show');

                        setTimeout(() => {
                            notification.classList.remove('show');
                        }, 3000);
                    }

                    // Message expansion functionality
                    function expandMessage(elementId) {
                        const element = document.getElementById(elementId);
                        element.classList.toggle('expanded');

                        const btn = element.querySelector('.expand-btn') || element.querySelector('.read-more-btn');
                        if (btn) {
                            if (element.classList.contains('expanded')) {
                                btn.innerHTML = '<i class="fas fa-chevron-up mr-1"></i> Show Less';
                            } else {
                                btn.innerHTML = '<i class="fas fa-chevron-down mr-1"></i> Read More';
                            }
                        }
                    }

                    // Modal control functions - SAFE VERSION: No interference with other buttons
                    function openModal(modalId) {
                        // Close any other open modals first
                        closeAllModals();
                        const modal = document.getElementById(modalId);
                        if (modal) {
                            modal.classList.add('active');
                        }
                    }

                    function closeModal(modalId) {
                        const modal = document.getElementById(modalId);
                        if (modal) {
                            modal.classList.remove('active');

                            // Clean up draft indicator when closing email template modal
                            if (modalId === 'emailTemplateModal') {
                                const draftIndicator = document.getElementById('draftIndicator');
                                if (draftIndicator) {
                                    draftIndicator.remove();
                                }
                            }
                        }
                    }

                    // Close all modals - prevents stuck overlays
                    function closeAllModals() {
                        const activeModals = document.querySelectorAll('.modal-overlay.active');
                        activeModals.forEach(modal => {
                            modal.classList.remove('active');
                        });
                    }

                    // Add escape key to close modals
                    document.addEventListener('keydown', function (event) {
                        if (event.key === 'Escape') {
                            closeAllModals();
                        }
                    });

                    // Close modal when clicking outside - SAFE VERSION
                    document.addEventListener('click', function (event) {
                        if (event.target.classList.contains('modal-overlay') && event.target.classList.contains('active')) {
                            closeModal(event.target.id);
                        }
                    });



                    // Initialize modal cleanup - SAFE: Won't break other buttons
                    function initializeModalCleanup() {
                        // Ensure all modals start closed
                        closeAllModals();

                        // Setup all close buttons to work properly
                        const closeButtons = document.querySelectorAll('[id*="close"], [id*="cancel"]');
                        closeButtons.forEach(button => {
                            // Don't override existing handlers, just ensure modal closes
                            button.addEventListener('click', function (e) {
                                const modal = button.closest('.modal-overlay');
                                if (modal && modal.id) {
                                    closeModal(modal.id);
                                }
                            }, true); // Use capture to ensure it runs
                        });
                    }

                    // Initialize message boxes
                    function initMessageBoxes() {
                        const originalMessage = document.getElementById('originalMessage');
                        if (originalMessage && originalMessage.scrollHeight > originalMessage.clientHeight) {
                            originalMessage.classList.add('truncated');
                        }

                        document.querySelectorAll('.reply-message-box').forEach(box => {
                            if (box.scrollHeight > box.clientHeight) {
                                box.classList.add('truncated');
                            }
                        });
                    }

                    // Notes functionality
                    function loadNotes() {
                        const ticketId = "{{ ticket.ticket_id }}";
                        const notesContainer = document.getElementById('notesContainer');

                        // Get notes from localStorage (replace with API call in production)
                        const notes = JSON.parse(localStorage.getItem(`ticket_notes_${ticketId}`)) || [];

                        if (notes.length === 0) {
                            notesContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-sticky-note"></i>
                        </div>
                        <p>No notes yet. Add your first note!</p>
                    </div>
                `;
                            return;
                        }

                        notesContainer.innerHTML = '';
                        notes.forEach((note, index) => {
                            const noteElement = document.createElement('div');
                            noteElement.className = 'note-card';
                            noteElement.innerHTML = `
                    <div class="note-title">${note.title}</div>
                    <div class="note-content">${note.content}</div>
                    <div class="note-meta">
                        <span>${new Date(note.timestamp).toLocaleString()}</span>
                        <div class="note-actions">
                            <span class="note-action-btn" onclick="editNote(${index})">
                                <i class="fas fa-edit"></i>
                            </span>
                            <span class="note-action-btn" onclick="deleteNote(${index})">
                                <i class="fas fa-trash"></i>
                            </span>
                        </div>
                    </div>
                `;
                            notesContainer.appendChild(noteElement);
                        });
                    }

                    function saveNote() {
                        const title = document.getElementById('noteTitle').value.trim();
                        const content = document.getElementById('noteContent').value.trim();
                        const ticketId = "{{ ticket.ticket_id }}";
                        const noteIndex = document.getElementById('saveNote').getAttribute('data-note-index');

                        if (!title || !content) {
                            showNotification('Please fill in both title and content', 'error');
                            return;
                        }

                        // Get existing notes
                        const notes = JSON.parse(localStorage.getItem(`ticket_notes_${ticketId}`)) || [];

                        if (noteIndex !== null) {
                            // Update existing note
                            notes[noteIndex] = {
                                title,
                                content,
                                timestamp: new Date().toISOString()
                            };
                        } else {
                            // Add new note
                            notes.push({
                                title,
                                content,
                                timestamp: new Date().toISOString()
                            });
                        }

                        // Save back to storage
                        localStorage.setItem(`ticket_notes_${ticketId}`, JSON.stringify(notes));

                        // Refresh notes display
                        loadNotes();

                        // Close modal and show notification
                        closeModal('noteModal');
                        showNotification(noteIndex !== null ? 'Note updated successfully' : 'Note saved successfully');

                        // Clear form
                        document.getElementById('noteTitle').value = '';
                        document.getElementById('noteContent').value = '';
                        document.getElementById('saveNote').removeAttribute('data-note-index');
                    }

                    function editNote(index) {
                        const ticketId = "{{ ticket.ticket_id }}";
                        const notes = JSON.parse(localStorage.getItem(`ticket_notes_${ticketId}`)) || [];

                        if (index >= 0 && index < notes.length) {
                            const note = notes[index];
                            document.getElementById('noteTitle').value = note.title;
                            document.getElementById('noteContent').value = note.content;

                            // Store the index being edited in a data attribute
                            document.getElementById('saveNote').setAttribute('data-note-index', index);

                            openModal('noteModal');
                        }
                    }

                    function deleteNote(index) {
                        if (confirm('Are you sure you want to delete this note?')) {
                            const ticketId = "{{ ticket.ticket_id }}";
                            const notes = JSON.parse(localStorage.getItem(`ticket_notes_${ticketId}`)) || [];

                            if (index >= 0 && index < notes.length) {
                                notes.splice(index, 1);
                                localStorage.setItem(`ticket_notes_${ticketId}`, JSON.stringify(notes));
                                loadNotes();
                                showNotification('Note deleted');
                            }
                        }
                    }

                    // Template functionality
                    function loadTemplates() {
                        const templatesContainer = document.getElementById('templatesContainer');

                        // Get templates from localStorage (replace with API call in production)
                        const templates = JSON.parse(localStorage.getItem('response_templates')) || [];

                        if (templates.length === 0) {
                            templatesContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <p>No templates yet. Add your first template!</p>
                    </div>
                `;
                            return;
                        }

                        templatesContainer.innerHTML = '';
                        templates.forEach((template, index) => {
                            const templateElement = document.createElement('div');
                            templateElement.className = 'template-item';
                            templateElement.innerHTML = `
                    <div class="template-title">${template.title}</div>
                    <div class="template-content">${template.content.substring(0, 100)}${template.content.length > 100 ? '...' : ''}</div>
                    <div class="template-actions">
                        <button class="template-action-btn template-use-btn" onclick="useTemplate(${index})">
                            <i class="fas fa-paper-plane mr-1"></i> Use
                        </button>
                        <button class="template-action-btn template-edit-btn" onclick="editTemplate(${index})">
                            <i class="fas fa-edit mr-1"></i> Edit
                        </button>
                    </div>
                `;
                            templatesContainer.appendChild(templateElement);
                        });
                    }

                    // Helper function to format file size
                    function formatFileSize(bytes) {
                        if (bytes === 0) return '0 Bytes';
                        const k = 1024;
                        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                        const i = Math.floor(Math.log(bytes) / Math.log(k));
                        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                    }

                    // Document functions
                    async function loadDocuments() {

                        const documentsSection = document.getElementById('documentsContainer');

                        if (!documentsSection) {
                            console.error('Documents container not found');
                            return;
                        }

                        try {
                            const response = await fetch('/api/common-documents');
                            const data = await response.json();

                            if (!response.ok) {
                                throw new Error(data.message || 'Failed to load documents');
                            }

                            const documents = data.documents || [];

                            // DEBUG: Log the document structure to see what fields are available
                            console.log(' Loaded documents:', documents);
                            if (documents.length > 0) {
                                console.log(' First document structure:', documents[0]);
                                console.log(' Document has file_content:', 'file_content' in documents[0]);
                                console.log(' Document has file_data:', 'file_data' in documents[0]);
                                console.log(' Document has file_size:', 'file_size' in documents[0]);
                            }

                            // Store documents in localStorage for drag and drop functionality
                            localStorage.setItem('common_documents', JSON.stringify(documents));

                            // Clear the container first
                            documentsSection.innerHTML = '';

                            if (documents.length === 0) {
                                // Show empty state message
                                documentsSection.innerHTML = `
                    <div class="text-center text-gray-500 p-4">
                        <i class="fas fa-folder-open text-3xl mb-2"></i>
                        <p class="text-sm">No documents yet. Click "Add Document" to get started.</p>
                    </div>
                `;
                                return;
                            }

                            // Create document items
                            documents.forEach((doc, arrayIndex) => {


                                if (!doc._id) {
                                    console.error('Document missing _id field:', doc);
                                    return; // Skip this document
                                }

                                const docItem = document.createElement('div');
                                docItem.className = 'document-item flex items-center border-b border-gray-200 p-3 hover:bg-gray-50 cursor-pointer';
                                docItem.dataset.documentId = doc._id;

                                // Choose appropriate icon based on document type
                                let iconClass = 'fas fa-file-alt text-gray-500';
                                if (doc.type === 'form') {
                                    iconClass = 'fas fa-file-contract text-blue-500';
                                } else if (doc.type === 'guide') {
                                    iconClass = 'fas fa-book text-green-500';
                                } else if (doc.type === 'manual') {
                                    iconClass = 'fas fa-file-pdf text-red-500';
                                } else if (doc.type === 'template') {
                                    iconClass = 'fas fa-file-word text-indigo-500';
                                }

                                // Format date and file size
                                const createdDate = new Date(doc.created_at).toLocaleDateString();
                                const fileSize = doc.file_size ? formatFileSize(doc.file_size) : '';

                                docItem.innerHTML = `
                    <i class="${iconClass} text-xl mr-3"></i>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-medium text-gray-900 truncate">${doc.name}</p>
                        <p class="text-xs text-gray-500 truncate">${doc.type.charAt(0).toUpperCase() + doc.type.slice(1)}  ${createdDate}${fileSize ? `  ${fileSize}` : ''}</p>
                        ${doc.description ? `<p class="text-xs text-gray-400 truncate">${doc.description}</p>` : ''}
                    </div>
                    <div class="flex space-x-2">
                       <button type="button" class="view-document-btn text-blue-600 hover:text-blue-800 bg-blue-100 hover:bg-blue-200 px-2 py-1 rounded text-xs" title="Download">
                           <i class="fas fa-download mr-1"></i> Download
                        </button>
                        <button type="button" class="edit-document-btn text-gray-500 hover:text-gray-700" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                       <button type="button" class="delete-document-btn text-red-500 hover:text-red-700" title="Delete">
                           <i class="fas fa-trash"></i>
                       </button>
                    </div>
                `;

                                documentsSection.appendChild(docItem);

                                // Make document draggable
                                docItem.setAttribute('draggable', 'true');
                                docItem.addEventListener('dragstart', function (e) {
                                    // Get the index of this document in the current list
                                    const allDocItems = documentsSection.querySelectorAll('.document-item');
                                    const currentIndex = Array.from(allDocItems).indexOf(docItem);

                                    console.log(` Drag started for document ${doc._id} at index ${currentIndex} (array index: ${arrayIndex})`);
                                    console.log(' Drag data being set:', {
                                        type: 'common-document',
                                        _id: doc._id,
                                        name: doc.name,
                                        documentId: doc._id
                                    });

                                    // ENHANCED DEBUGGING: Log complete document details
                                    console.log(' COMPLETE DOCUMENT DATA FOR DRAG:', {
                                        _id: doc._id,
                                        name: doc.name,
                                        type: doc.type,
                                        description: doc.description,
                                        file_name: doc.file_name,
                                        file_size: doc.file_size,
                                        file_path: doc.file_path,
                                        created_at: doc.created_at,
                                        updated_at: doc.updated_at,
                                        is_active: doc.is_active,
                                        arrayIndex: arrayIndex,
                                        currentIndex: currentIndex,
                                        documentElement: docItem,
                                        elementDataset: docItem.dataset,
                                        doc_type: doc.datatype,
                                        file_data: "",
                                        file_name: ""
                                    });

                                    // Store the drag data for debugging
                                    const dragData = {
                                        type: 'common-document',
                                        _id: doc._id,  // Use actual document ID instead of index
                                        name: doc.name,
                                        documentId: doc._id,
                                        // ENHANCED: Include more document details for debugging
                                        documentType: doc.type,
                                        documentDescription: doc.description,
                                        documentFileName: doc.file_name,
                                        documentFileSize: doc.file_size,
                                        documentFilePath: doc.file_path,
                                        documentCreatedAt: doc.created_at,
                                        documentUpdatedAt: doc.updated_at,
                                        documentIsActive: doc.is_active
                                    };

                                    e.dataTransfer.setData('text', JSON.stringify(dragData));

                                    // Add visual feedback
                                    e.target.classList.add('opacity-50');

                                    // Log the current state of processed documents
                                    console.log(' Current processed documents:', Array.from(processedDocuments));
                                    console.log(' Current processed documents count:', processedDocuments.size);
                                });

                                docItem.addEventListener('dragend', function (e) {
                                    e.target.classList.remove('opacity-50');
                                });

                                // Add view button event handler
                                const viewBtn = docItem.querySelector('.view-document-btn');
                                if (viewBtn) {
                                    viewBtn.addEventListener('click', function (e) {
                                        e.stopPropagation();
                                        console.log('View button clicked, doc._id:', doc._id);
                                        console.log('View button clicked, doc._id type:', typeof doc._id);
                                        console.log('View button clicked, doc._id length:', doc._id ? doc._id.length : 'null/undefined');
                                        viewDocument(doc._id);
                                    });
                                }

                                // Add edit button event handler
                                const editBtn = docItem.querySelector('.edit-document-btn');
                                if (editBtn) {
                                    editBtn.addEventListener('click', function (e) {
                                        e.stopPropagation();
                                        editDocument(doc._id);
                                    });
                                }



                                // Add delete button event handler
                                const deleteBtn = docItem.querySelector('.delete-document-btn');
                                if (deleteBtn) {
                                    deleteBtn.addEventListener('click', function (e) {
                                        e.stopPropagation();
                                        deleteDocument(doc._id);
                                    });
                                }

                                // Add click handler for the entire item (for viewing)
                                docItem.addEventListener('click', function () {
                                    console.log('Document item clicked, doc._id:', doc._id);
                                    console.log('Document item clicked, doc._id type:', typeof doc._id);
                                    console.log('Document item clicked, doc._id length:', doc._id ? doc._id.length : 'null/undefined');
                                    viewDocument(doc._id);
                                });
                            });

                            console.log('Documents loaded and made draggable');

                            // Reset processed documents tracking when documents are reloaded
                            processedDocuments.clear();
                            lastProcessedDocument = null;
                            lastProcessedTime = 0;

                            // Setup drag and drop for reply area
                            // setupReplyDropzone(); // OLD SYSTEM REMOVED

                        } catch (error) {
                            console.error('Error loading documents:', error);
                            documentsSection.innerHTML = `
                    <div class="text-center text-red-500 p-4">
                        <i class="fas fa-exclamation-triangle text-3xl mb-2"></i>
                        <p class="text-sm">Error loading documents: ${error.message}</p>
                    </div>
                `;
                        }
                    }

                    // OLD DRAG & DROP SYSTEM REMOVED - Only enhanced system remains
                    /*
                    function setupReplyDropzone() {
                        // ... entire old function commented out ...
                    }
                    */

                    // OLD FUNCTION REMOVED - Only enhanced system remains
                    /*
                    // Add common document to reply as attachment
                    function addCommonDocumentToReply(documentId, documentName, fullDocumentData = null) {
                        console.log(' addCommonDocumentToReply called with:');
                        console.log('  - documentId:', documentId);
                        console.log('  - documentName:', documentName);
                        console.log('  - fullDocumentData:', fullDocumentData);
                        
                        // Check for duplicate documents before adding
                        const commonDocumentPreview = document.getElementById('commonDocumentPreview');
                        if (commonDocumentPreview) {
                            const existingDoc = commonDocumentPreview.querySelector(`[data-document-id="${documentId}"]`);
                            if (existingDoc) {
                                console.log(' Document already added to reply, skipping duplicate:', documentName);
                                showNotification(` ${documentName} is already added to reply`, 'warning');
                                return;
                            }
                        }
                        
                        // ENHANCED DEBUGGING: Log all available document information
                        if (fullDocumentData) {
                            console.log(' COMPLETE DOCUMENT DATA RECEIVED:');
                            console.log('  - Document ID:', fullDocumentData.documentId);
                            console.log('  - Document Name:', fullDocumentData.name);
                            console.log('  - Document Type:', fullDocumentData.documentType);
                            console.log('  - Document Description:', fullDocumentData.documentDescription);
                            console.log('  - Document File Name:', fullDocumentData.documentFileName);
                            console.log('  - Document File Size:', fullDocumentData.documentFileSize);
                            console.log('  - Document File Path:', fullDocumentData.documentFilePath);
                            console.log('  - Document Created At:', fullDocumentData.documentCreatedAt);
                            console.log('  - Document Updated At:', fullDocumentData.documentUpdatedAt);
                            console.log('  - Document Is Active:', fullDocumentData.documentIsActive);
                            console.log('  - Array Index:', fullDocumentData.index);
                        }
                        
                        // ENHANCED DEBUGGING: Check localStorage for additional context
                        try {
                            const storedDocuments = JSON.parse(localStorage.getItem('common_documents') || '[]');
                            console.log(' Stored documents in localStorage:', storedDocuments.length);
                            
                            const matchingStoredDoc = storedDocuments.find(doc => doc._id === documentId);
                            if (matchingStoredDoc) {
                                console.log(' Found matching document in localStorage:', matchingStoredDoc);
                            } else {
                                console.log(' Document not found in localStorage - ID mismatch?');
                                console.log(' Searching for partial matches...');
                                const partialMatches = storedDocuments.filter(doc => 
                                    doc._id && doc._id.toString().includes(documentId.toString().slice(-4))
                                );
                                console.log(' Partial matches found:', partialMatches);
                            }
                        } catch (localStorageError) {
                            console.error(' Error reading localStorage:', localStorageError);
                        }
                        
                        const commonDocumentDropzone = document.getElementById('commonDocumentDropzone');
                        
                        console.log(' DOM Elements found:');
                        console.log('  - commonDocumentDropzone:', commonDocumentDropzone);
                        console.log('  - commonDocumentPreview:', commonDocumentPreview);
                        
                        // Show the dropzone if hidden
                        commonDocumentDropzone.classList.remove('hidden');
                        
                        // Create preview item
                        const previewItem = document.createElement('div');
                        previewItem.className = 'flex items-center justify-between p-2 bg-blue-50 border border-blue-200 rounded text-sm';
                        previewItem.dataset.documentId = documentId;
                        
                        // ENHANCED: Store all document data in the preview item for debugging
                        if (fullDocumentData) {
                            previewItem.dataset.documentType = fullDocumentData.documentType || '';
                            previewItem.dataset.documentDescription = fullDocumentData.documentDescription || '';
                            previewItem.dataset.documentFileName = fullDocumentData.documentFileName || '';
                            previewItem.dataset.documentFileSize = fullDocumentData.documentFileSize || '';
                            previewItem.dataset.documentFilePath = fullDocumentData.documentFilePath || '';
                            previewItem.dataset.documentCreatedAt = fullDocumentData.documentCreatedAt || '';
                            previewItem.dataset.documentUpdatedAt = fullDocumentData.documentUpdatedAt || '';
                            previewItem.dataset.documentIsActive = fullDocumentData.documentIsActive || '';
                            previewItem.dataset.arrayIndex = fullDocumentData.index || '';
                        }
                        
                        console.log(' Preview item created with dataset:', previewItem.dataset);
                        
                        previewItem.innerHTML = `
                            <div class="flex items-center">
                                <i class="fas fa-file-alt text-blue-500 mr-2"></i>
                                <span class="text-blue-800">${documentName}</span>
                                ${fullDocumentData && fullDocumentData.documentType ? `<span class="text-xs text-blue-600 ml-2">(${fullDocumentData.documentType})</span>` : ''}
                            </div>
                            <button type="button" class="remove-doc-btn text-red-500 hover:text-red-700" title="Remove">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        
                        // Add remove functionality
                        const removeBtn = previewItem.querySelector('.remove-doc-btn');
                        removeBtn.addEventListener('click', function() {
                            previewItem.remove();
                            // Hide dropzone if no more documents
                            if (commonDocumentPreview.children.length === 0) {
                                commonDocumentDropzone.classList.add('hidden');
                            }
                        });
                        
                        commonDocumentPreview.appendChild(previewItem);
                        
                        // Show success notification
                        showNotification(` ${documentName} added to reply`, 'success');
                    }
                    */

                    async function viewDocument(documentId) {
                        try {
                            if (!documentId) {
                                showNotification('No document ID provided', 'error');
                                return;
                            }

                            // Download the document file
                            const downloadUrl = `/api/common-documents/${documentId}/download`;

                            try {
                                const newWindow = window.open(downloadUrl, '_blank');
                                if (!newWindow) {
                                    showNotification('Download failed - popup blocked?', 'error');
                                }
                            } catch (windowError) {
                                showNotification(`Error opening download: ${windowError.message}`, 'error');
                            }

                        } catch (error) {
                            console.error('Error viewing document:', error);
                            showNotification(`Error viewing document: ${error.message}`, 'error');
                        }
                    }

                    async function editDocument(documentId) {
                        try {
                            const response = await fetch(`/api/common-documents/${documentId}`);
                            const data = await response.json();

                            if (!response.ok) {
                                throw new Error(data.message || 'Document not found');
                            }

                            const doc = data.document;

                            document.getElementById('documentName').value = doc.name;
                            document.getElementById('documentType').value = doc.type;
                            document.getElementById('documentDescription').value = doc.description || '';
                            document.getElementById('selectedFileName').textContent = doc.file_name || 'Current file preserved';
                            document.getElementById('documentModalTitle').textContent = 'Edit Document';
                            document.getElementById('deleteDocument').classList.remove('hidden');
                            document.getElementById('saveDocument').setAttribute('data-document-id', documentId);
                            openModal('documentModal');

                        } catch (error) {
                            console.error('Error loading document for editing:', error);
                            showNotification(`Error loading document: ${error.message}`, 'error');
                        }
                    }

                    async function saveDocument() {
                        const name = document.getElementById('documentName').value.trim();
                        const type = document.getElementById('documentType').value;
                        const fileInput = document.getElementById('documentFile');
                        const description = document.getElementById('documentDescription').value.trim();
                        const documentId = document.getElementById('saveDocument').getAttribute('data-document-id');

                        if (!name) {
                            showNotification('Please enter a document name', 'error');
                            return;
                        }

                        // For new documents, require a file
                        if (!documentId && fileInput.files.length === 0) {
                            showNotification('Please select a file for new documents', 'error');
                            return;
                        }

                        try {
                            let response;

                            if (documentId) {
                                // Update existing document (JSON)
                                const documentData = {
                                    name,
                                    type,
                                    description,
                                    file_name: fileInput.files.length > 0 ? fileInput.files[0].name : ''
                                };

                                response = await fetch(`/api/common-documents/${documentId}`, {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify(documentData)
                                });
                            } else {
                                // Create new document with file upload (FormData)
                                const formData = new FormData();
                                formData.append('name', name);
                                formData.append('type', type);
                                formData.append('description', description);
                                formData.append('file', fileInput.files[0]);

                                response = await fetch('/api/common-documents', {
                                    method: 'POST',
                                    body: formData
                                });
                            }

                            const data = await response.json();

                            if (!response.ok) {
                                throw new Error(data.message || 'Failed to save document');
                            }

                            // Refresh documents display
                            await loadDocuments();

                            // Close modal and show notification
                            closeModal('documentModal');
                            showNotification(documentId ? 'Document updated successfully' : 'Document uploaded successfully');

                            // Clear form
                            document.getElementById('documentName').value = '';
                            document.getElementById('documentType').value = 'form';
                            document.getElementById('documentDescription').value = '';
                            document.getElementById('documentFile').value = '';
                            document.getElementById('selectedFileName').textContent = 'No file selected';

                        } catch (error) {
                            console.error('Error saving document:', error);
                            showNotification(`Error saving document: ${error.message}`, 'error');
                        }
                    }

                    async function deleteDocument(documentId) {
                        if (!documentId || !confirm('Are you sure you want to delete this document?')) {
                            return;
                        }

                        try {
                            const response = await fetch(`/api/common-documents/${documentId}`, {
                                method: 'DELETE'
                            });

                            const data = await response.json();

                            if (!response.ok) {
                                throw new Error(data.message || 'Failed to delete document');
                            }

                            // Refresh documents display
                            await loadDocuments();

                            // Close modal if open
                            closeModal('documentModal');
                            showNotification('Document deleted successfully');

                        } catch (error) {
                            console.error('Error deleting document:', error);
                            showNotification(`Error deleting document: ${error.message}`, 'error');
                        }
                    }

                    function useTemplate(index) {
                        const templates = JSON.parse(localStorage.getItem('response_templates')) || [];

                        if (index >= 0 && index < templates.length) {
                            const responseTextarea = document.getElementById('response');
                            responseTextarea.value = templates[index].content;

                            // Trigger auto-expand after applying template
                            if (typeof window.autoExpandTextarea === 'function') {
                                window.autoExpandTextarea(responseTextarea);
                            }

                            showNotification('Template applied to response');
                        }
                    }

                    function editTemplate(index = -1) {
                        const templates = JSON.parse(localStorage.getItem('response_templates')) || [];

                        if (index >= 0 && index < templates.length) {
                            // Editing existing template
                            const template = templates[index];
                            document.getElementById('templateTitle').value = template.title;
                            document.getElementById('templateContent').value = template.content;
                            document.getElementById('editTemplateTitle').textContent = 'Edit Template';
                            document.getElementById('deleteTemplate').classList.remove('hidden');
                            document.getElementById('saveTemplate').setAttribute('data-template-index', index);
                        } else {
                            // Creating new template
                            document.getElementById('templateTitle').value = '';
                            document.getElementById('templateContent').value = '';
                            document.getElementById('editTemplateTitle').textContent = 'Add New Template';
                            document.getElementById('deleteTemplate').classList.add('hidden');
                            document.getElementById('saveTemplate').removeAttribute('data-template-index');
                        }

                        openModal('editTemplateModal');
                    }

                    function saveTemplate() {
                        const title = document.getElementById('templateTitle').value.trim();
                        const content = document.getElementById('templateContent').value.trim();
                        const index = document.getElementById('saveTemplate').getAttribute('data-template-index');

                        if (!title || !content) {
                            showNotification('Please fill in both title and content', 'error');
                            return;
                        }

                        const templates = JSON.parse(localStorage.getItem('response_templates')) || [];

                        if (index !== null) {
                            // Update existing template
                            templates[index] = { title, content };
                        } else {
                            // Add new template
                            templates.push({ title, content });
                        }

                        localStorage.setItem('response_templates', JSON.stringify(templates));
                        loadTemplates();
                        closeModal('editTemplateModal');
                        showNotification(index !== null ? 'Template updated successfully' : 'Template saved successfully');
                    }

                    function deleteTemplate() {
                        const index = document.getElementById('saveTemplate').getAttribute('data-template-index');

                        if (index !== null && confirm('Are you sure you want to delete this template?')) {
                            const templates = JSON.parse(localStorage.getItem('response_templates')) || [];

                            if (index >= 0 && index < templates.length) {
                                templates.splice(index, 1);
                                localStorage.setItem('response_templates', JSON.stringify(templates));
                                loadTemplates();
                                closeModal('editTemplateModal');
                                showNotification('Template deleted');
                            }
                        }
                    }

                    // Status dropdown functionality
                    function setupStatusDropdown() {
                        const dropdownBtn = document.getElementById('statusDropdownBtn');
                        const dropdownContent = document.getElementById('statusDropdownContent');

                        // Toggle dropdown
                        dropdownBtn.addEventListener('click', function (e) {
                            e.stopPropagation();
                            dropdownContent.classList.toggle('show');
                        });

                        // Close dropdown when clicking outside
                        document.addEventListener('click', function () {
                            dropdownContent.classList.remove('show');
                        });

                        // Handle status selection
                        document.querySelectorAll('.status-option').forEach(option => {
                            option.addEventListener('click', async function () {
                                const newStatus = this.getAttribute('data-status');

                                try {
                                    const response = await fetch(`/api/tickets/{{ ticket.ticket_id }}/status`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        },
                                        body: JSON.stringify({
                                            status: newStatus
                                        })
                                    });

                                    if (response.ok) {
                                        // Update ALL status badges on the page with comprehensive search
                                        const oldStatus = '{{ ticket.status }}';
                                        const newStatusClass = newStatus.toLowerCase().replace(/ /g, '-').replace(//g, '');

                                        // Method 1: Update by class selector
                                        const statusBadges = document.querySelectorAll('[class*="status-"]');
                                        statusBadges.forEach(badge => {
                                            if (badge.textContent === oldStatus || badge.textContent.includes(oldStatus)) {
                                                badge.textContent = newStatus;
                                                badge.className = `px-3 py-1 text-xs rounded-lg font-medium status-${newStatusClass}`;
                                            }
                                        });

                                        // Method 2: Update by text content search
                                        const allElements = document.querySelectorAll('*');
                                        allElements.forEach(element => {
                                            if (element.textContent === oldStatus && element.tagName !== 'SCRIPT') {
                                                element.textContent = newStatus;
                                            }
                                        });

                                        // Method 3: Update status dropdown button text
                                        const statusDisplay = document.getElementById('currentStatusDisplay');
                                        if (statusDisplay) {
                                            statusDisplay.textContent = newStatus;
                                        }

                                        // Method 4: Update the status dropdown button styling
                                        const statusDropdownBtn = document.getElementById('statusDropdownBtn');
                                        if (statusDropdownBtn) {
                                            // Remove old status classes and add new one
                                            statusDropdownBtn.className = statusDropdownBtn.className.replace(/status-\S+/g, '');
                                            statusDropdownBtn.classList.add(`status-${newStatusClass}`);
                                        }

                                        // Method 5: Update any elements with data-status attribute
                                        const statusElements = document.querySelectorAll('[data-status]');
                                        statusElements.forEach(element => {
                                            if (element.textContent === oldStatus) {
                                                element.textContent = newStatus;
                                            }
                                        });

                                        showNotification(`Status updated to ${newStatus}`, 'success');
                                    } else {
                                        const error = await response.json();
                                        showNotification(error.message || 'Failed to update status', 'error');
                                    }
                                } catch (error) {
                                    console.error('Error updating status:', error);
                                    showNotification('Failed to update status', 'error');
                                }
                            });
                        });
                    }

                    // Function to initialize status dropdown button styling
                    function initializeStatusButton() {
                        const statusDropdownBtn = document.getElementById('statusDropdownBtn');
                        const currentStatus = '{{ ticket.status }}';

                        if (statusDropdownBtn && currentStatus) {
                            // Remove any existing status classes
                            statusDropdownBtn.className = statusDropdownBtn.className.replace(/status-\S+/g, '');

                            // Add the current status class
                            const statusClass = currentStatus.toLowerCase().replace(/ /g, '-').replace(//g, '');
                            statusDropdownBtn.classList.add(`status-${statusClass}`);
                        }
                    }

                    // Function to force 1500px layout for ALL screen sizes
                    function adjustLayoutForScreenSize() {
                        const appContainer = document.querySelector('.app-container');

                        if (appContainer) {
                            // ALWAYS force 1500px width regardless of screen size
                            appContainer.style.width = '1500px';
                            appContainer.style.maxWidth = '1500px';
                            appContainer.style.margin = '0'; /* Ensure left alignment */

                            // ALWAYS apply professional styling
                            appContainer.style.boxShadow = '0 0 30px rgba(0, 0, 0, 0.1)';
                            appContainer.style.borderRadius = '8px';
                            appContainer.style.marginTop = '20px';
                            appContainer.style.marginBottom = '20px';

                            // ALWAYS set body background
                            document.body.style.backgroundColor = '#f8fafb';

                            // ALWAYS align to left instead of center
                            document.body.style.display = 'flex';
                            document.body.style.justifyContent = 'flex-start'; /* Changed from center to flex-start */
                            document.body.style.alignItems = 'flex-start';
                            document.body.style.minHeight = '100vh';

                            console.log(' Forced 1500px layout applied for all screen sizes with LEFT alignment');
                        }
                    }

                    // Run layout adjustment on window resize
                    window.addEventListener('resize', adjustLayoutForScreenSize);

                    // Also run on initial page load
                    window.addEventListener('load', adjustLayoutForScreenSize);
                    
                    // CRITICAL FIX: Ensure sidebar is hidden after all resources load
                    window.addEventListener('load', function() {
                        setTimeout(() => {
                            const rightSidebar = document.querySelector('.right-sidebar');
                            const appContainer = document.querySelector('.app-container');
                            
                            if (rightSidebar) {
                                // Force hide sidebar after page load
                                rightSidebar.classList.remove('sidebar-open', 'ultra-wide-open', 'mobile-open');
                                rightSidebar.style.transform = 'translateX(200%)';
                                rightSidebar.style.visibility = 'hidden';
                                rightSidebar.style.opacity = '0';
                                rightSidebar.style.pointerEvents = 'none';
                                rightSidebar.style.display = 'none';
                                console.log(' Sidebar forcefully hidden after page load');
                            }
                            
                            if (appContainer) {
                                // Ensure app container is not expanded
                                appContainer.classList.remove('sidebar-open');
                                appContainer.classList.add('sidebar-closed');
                                console.log(' App container set to sidebar-closed after page load');
                            }
                        }, 200); // Slightly longer delay to ensure everything is loaded
                    });
                    document.addEventListener('DOMContentLoaded', function () {
                        // Initialize modal cleanup to prevent stuck overlays
                        initializeModalCleanup();
                        initMessageBoxes();
                        loadNotes();
                        loadTemplates();
                        loadDocuments(); // Load documents on page load
                        setupStatusDropdown();
                        setupAttachmentHandlers(); // Setup attachment handling
                        setupQuickResponseDropdown(); // Setup quick response dropdown
                        initializeStatusButton(); // Initialize status button styling

                        // Initialize fixed-width layout for consistent appearance across screen sizes
                        adjustLayoutForScreenSize();

                        // Initialize sidebar functionality
                        initializeSidebarToggle();
                        
                        // CRITICAL FIX: Ensure sidebar is hidden on page load
                        setTimeout(() => {
                            const rightSidebar = document.querySelector('.right-sidebar');
                            const appContainer = document.querySelector('.app-container');
                            
                            if (rightSidebar) {
                                // Force hide sidebar on page load
                                rightSidebar.classList.remove('sidebar-open', 'ultra-wide-open', 'mobile-open');
                                rightSidebar.style.transform = 'translateX(200%)';
                                rightSidebar.style.visibility = 'hidden';
                                rightSidebar.style.opacity = '0';
                                rightSidebar.style.pointerEvents = 'none';
                                console.log(' Sidebar forcefully hidden on page load');
                            }
                            
                            if (appContainer) {
                                // Ensure app container is not expanded
                                appContainer.classList.remove('sidebar-open');
                                appContainer.classList.add('sidebar-closed');
                                console.log(' App container set to sidebar-closed on page load');
                            }
                        }, 100); // Small delay to ensure DOM is fully ready

                        // Add note button
                        document.getElementById('addNoteBtn').addEventListener('click', function () {
                            document.getElementById('saveNote').removeAttribute('data-note-index');
                            document.getElementById('noteTitle').value = '';
                            document.getElementById('noteContent').value = '';
                            openModal('noteModal');
                        });

                        // Save note button
                        document.getElementById('saveNote').addEventListener('click', saveNote);

                        // Note modal buttons
                        document.getElementById('closeNoteModal').addEventListener('click', () => closeModal('noteModal'));
                        document.getElementById('cancelNote').addEventListener('click', () => closeModal('noteModal'));

                        // Add template button
                        document.getElementById('addTemplateBtn').addEventListener('click', () => editTemplate());

                        // Edit template modal buttons
                        document.getElementById('closeEditTemplateModal').addEventListener('click', () => closeModal('editTemplateModal'));
                        document.getElementById('cancelEditTemplate').addEventListener('click', () => closeModal('editTemplateModal'));
                        document.getElementById('saveTemplate').addEventListener('click', saveTemplate);
                        document.getElementById('deleteTemplate').addEventListener('click', deleteTemplate);

                        // Document Modal
                        const addDocumentBtn = document.getElementById('addDocumentBtn');

                        const closeDocumentModal = document.getElementById('closeDocumentModal');
                        const cancelDocumentBtn = document.getElementById('cancelDocument');
                        const saveDocumentBtn = document.getElementById('saveDocument');
                        const deleteDocumentBtn = document.getElementById('deleteDocument');

                        if (addDocumentBtn) {
                            addDocumentBtn.addEventListener('click', () => {
                                document.getElementById('documentName').value = '';
                                document.getElementById('documentType').value = 'form';
                                document.getElementById('documentFile').value = '';
                                document.getElementById('selectedFileName').textContent = 'No file selected';
                                document.getElementById('documentDescription').value = '';
                                document.getElementById('documentModalTitle').textContent = 'Add New Document';
                                document.getElementById('deleteDocument').classList.add('hidden');
                                document.getElementById('saveDocument').removeAttribute('data-document-id');
                                openModal('documentModal');
                            });
                        }



                        if (closeDocumentModal) {
                            closeDocumentModal.addEventListener('click', () => closeModal('documentModal'));
                        }
                        if (cancelDocumentBtn) {
                            cancelDocumentBtn.addEventListener('click', () => closeModal('documentModal'));
                        }

                        if (saveDocumentBtn) {
                            saveDocumentBtn.addEventListener('click', saveDocument);
                        }

                        if (deleteDocumentBtn) {
                            deleteDocumentBtn.addEventListener('click', () => {
                                const documentId = document.getElementById('saveDocument').getAttribute('data-document-id');
                                if (documentId) {
                                    deleteDocument(documentId);
                                } else {
                                    showNotification('No document selected for deletion', 'error');
                                }
                            });
                        }

                        // Handle file input change event
                        document.getElementById('documentFile').addEventListener('change', function () {
                            const fileName = this.files.length > 0 ? this.files[0].name : 'No file selected';
                            document.getElementById('selectedFileName').textContent = fileName;
                        });

                        // Close Ticket Button functionality (following the same pattern as forward/takeover)
                        const closeResolvedBtn = document.getElementById('closeResolvedBtn');
                        const cancelCloseBtn = document.getElementById('cancelClose');
                        const confirmCloseBtn = document.getElementById('confirmClose');

                        if (closeResolvedBtn) {
                            closeResolvedBtn.addEventListener('click', () => {
                                console.log(' Close button clicked');
                                openModal('confirmModal');
                            });
                        }

                        if (cancelCloseBtn) {
                            cancelCloseBtn.addEventListener('click', () => closeModal('confirmModal'));
                        }

                        if (confirmCloseBtn) {
                            confirmCloseBtn.addEventListener('click', async () => {
                                console.log(' Close confirmation clicked');

                                try {
                                    // Show loading state
                                    confirmCloseBtn.disabled = true;
                                    confirmCloseBtn.innerHTML = ' Closing...';

                                    const response = await fetch(`/api/tickets/{{ ticket.ticket_id }}/close`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                            'Accept': 'application/json'
                                        }
                                    });

                                    const data = await response.json();
                                    console.log('Debug: Response status:', response.status);
                                    console.log('Debug: Response data:', data);

                                    if (!response.ok) {
                                        throw new Error(data.message || 'Failed to close ticket');
                                    }

                                    // Use backend message or default (same pattern as takeover)
                                    const successMessage = data.message || ' Ticket closed successfully!';
                                    showNotification(successMessage, 'success');

                                    // SUCCESS STATE: Show success button state before reload
                                    confirmCloseBtn.disabled = false;
                                    confirmCloseBtn.innerHTML = ' Ticket Closed!';
                                    confirmCloseBtn.style.backgroundColor = '#dcfce7';
                                    confirmCloseBtn.style.color = '#166534';

                                    closeModal('confirmModal');

                                    // Update UI similar to takeover button
                                    setTimeout(() => {
                                        window.location.reload();
                                    }, 1500);

                                } catch (error) {
                                    console.error(' Error closing ticket:', error);
                                    showNotification(error.message || 'Failed to close ticket', 'error');

                                    // Reset button state
                                    confirmCloseBtn.disabled = false;
                                    confirmCloseBtn.innerHTML = 'Confirm Close';
                                }
                            });
                        }

                        // Message Modal
                        const closeMessageModal = document.getElementById('closeMessageModal');
                        if (closeMessageModal) {
                            closeMessageModal.addEventListener('click', () => closeModal('messageModal'));
                        }

                        // Assignment Modal Variables
                        const assignModal = document.getElementById('assignModal');
                        const assignModalTitle = document.getElementById('assignModalTitle');
                        const closeAssignModal = document.getElementById('closeAssignModal');
                        const cancelAssign = document.getElementById('cancelAssign');
                        const confirmAssign = document.getElementById('confirmAssign');
                        const assignMemberSelect = document.getElementById('assignMemberSelect');
                        const forwardNotesContainer = document.getElementById('forwardNotesContainer');
                        const assignNotes = document.getElementById('assignNotes');
                        const ticketId = '{{ ticket.ticket_id }}';
                        const currentUserId = "{{ session.member_id }}";

                        // Take Over Button - FIXED with proper error recovery
                        const takeOverBtn = document.getElementById('takeOverBtn');
                        if (takeOverBtn) {
                            takeOverBtn.addEventListener('click', async function () {
                                // Prevent double clicks
                                takeOverBtn.disabled = true;
                                const originalText = takeOverBtn.innerHTML;
                                takeOverBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Taking Over...';

                                // ALWAYS reset button after 15 seconds as safety fallback
                                const safetyTimeout = setTimeout(() => {
                                    console.log(' SAFETY TIMEOUT: Resetting button after 15 seconds');
                                    takeOverBtn.disabled = false;
                                    takeOverBtn.innerHTML = originalText;
                                    showNotification('Takeover may have completed. Please refresh the page to check.', 'warning');
                                }, 15000);

                                try {
                                    const requestData = {
                                        member_id: currentUserId,
                                        notes: '',
                                        is_forwarded: false,
                                        forwarded_from: null
                                    };

                                    console.log(' TAKEOVER ATTEMPT:', { ticketId, currentUserId });

                                    const response = await fetch(`/api/tickets/${ticketId}/assign`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify(requestData)
                                    });

                                    const data = await response.json();
                                    console.log(' TAKEOVER RESPONSE:', data);

                                    if (response.ok && data.status === 'success') {
                                        clearTimeout(safetyTimeout); // Cancel safety timeout
                                        showNotification(' Ticket taken over successfully!', 'success');

                                        // SUCCESS: Show success state briefly, then reload
                                        takeOverBtn.innerHTML = '<i class="fas fa-check mr-1"></i> Taken Over!';
                                        takeOverBtn.style.backgroundColor = '#dcfce7';
                                        takeOverBtn.style.color = '#166534';

                                        // Simple reload after success
                                        setTimeout(() => {
                                            window.location.reload();
                                        }, 2000);

                                    } else {
                                        clearTimeout(safetyTimeout); // Cancel safety timeout
                                        // Re-enable button on error
                                        takeOverBtn.disabled = false;
                                        takeOverBtn.innerHTML = originalText;
                                        showNotification(data.message || 'Error taking over ticket', 'error');
                                        console.error(' TAKEOVER ERROR:', data);
                                    }
                                } catch (error) {
                                    clearTimeout(safetyTimeout); // Cancel safety timeout
                                    // Re-enable button on exception
                                    takeOverBtn.disabled = false;
                                    takeOverBtn.innerHTML = originalText;
                                    console.error(' TAKEOVER EXCEPTION:', error);
                                    showNotification('Network error while taking over ticket', 'error');
                                }
                            });
                        }

                        // Refer to Tech Director Button - Direct API call
                        const referToTechDirectorBtn = document.getElementById('referToTechDirectorBtn');
                        if (referToTechDirectorBtn) {
                            referToTechDirectorBtn.addEventListener('click', async function () {
                                // Show confirmation dialog
                                if (!confirm('Are you sure you want to refer this ticket to the Technical Director?\n\nThis will:\n Change ticket status to "Referred to Tech Director"\n Send email notification to Tech Director\n Schedule AI-powered reminder via n8n workflow\n\nClick OK to proceed.')) {
                                    return;
                                }

                                // Disable button to prevent double-clicks
                                referToTechDirectorBtn.disabled = true;
                                referToTechDirectorBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Referring...';

                                try {
                                    const response = await fetch(`/api/tickets/${ticketId}/tech-director`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' }
                                    });

                                    const data = await response.json();

                                    if (response.ok && data.status === 'success') {
                                        showNotification(` Ticket successfully referred to Tech Director!\n Real-time Mode: ${data.real_time_mode ? 'Active' : 'Inactive'}\n Webhook: ${data.webhook_queued ? 'Queued' : 'Failed'}\n Email: ${data.email_sent ? 'Sent' : 'Failed'}`, 'success');

                                        // Log the response for debugging
                                        console.log(' Tech Director Referral Success (Real-time):', data);

                                        // REAL-TIME STATUS UPDATE: Update the ticket status to "Referred to Tech Director"
                                        const newStatus = 'Referred to Tech Director';
                                        const oldStatus = '{{ ticket.status }}';
                                        const newStatusClass = newStatus.toLowerCase().replace(/ /g, '-').replace(//g, '');

                                        // Update ALL status badges on the page
                                        const allStatusBadges = document.querySelectorAll('[class*="status-"]');
                                        allStatusBadges.forEach(badge => {
                                            if (badge.textContent === oldStatus || badge.textContent.includes(oldStatus)) {
                                                badge.textContent = newStatus;
                                                badge.className = `px-3 py-1 text-xs rounded-lg font-medium status-${newStatusClass}`;
                                            }
                                        });

                                        // Update status dropdown button text
                                        const statusDisplay = document.getElementById('currentStatusDisplay');
                                        if (statusDisplay) {
                                            statusDisplay.textContent = newStatus;
                                        }

                                        // Update the status dropdown button styling
                                        const statusDropdownBtn = document.getElementById('statusDropdownBtn');
                                        if (statusDropdownBtn) {
                                            statusDropdownBtn.className = statusDropdownBtn.className.replace(/status-\S+/g, '');
                                            statusDropdownBtn.classList.add(`status-${newStatusClass}`);
                                        }

                                        // Update any other status-related elements
                                        const statusElements = document.querySelectorAll('[data-status]');
                                        statusElements.forEach(element => {
                                            if (element.textContent === oldStatus) {
                                                element.textContent = newStatus;
                                            }
                                        });

                                        // Update the Refer to Tech Director button to show "Currently with Tech Director"
                                        referToTechDirectorBtn.disabled = false;
                                        referToTechDirectorBtn.innerHTML = '<i class="fas fa-check-circle mr-1 text-green-600"></i> Successfully Referred!';
                                        referToTechDirectorBtn.classList.add('bg-green-100', 'text-green-800');
                                        referToTechDirectorBtn.classList.remove('bg-orange-100', 'text-orange-800');

                                        // After 3 seconds, change to "Currently with Tech Director" state
                                        setTimeout(() => {
                                            referToTechDirectorBtn.innerHTML = '<i class="fas fa-user-cog mr-1"></i> Currently with Tech Director';
                                            referToTechDirectorBtn.classList.remove('bg-green-100', 'text-green-800');
                                            referToTechDirectorBtn.classList.add('bg-orange-50', 'text-orange-700', 'border', 'border-orange-200');
                                            referToTechDirectorBtn.disabled = true;
                                        }, 3000);
                                    } else {
                                        showNotification(data.message || 'Error referring ticket to Tech Director', 'error');

                                        // Re-enable button on error
                                        referToTechDirectorBtn.disabled = false;
                                        referToTechDirectorBtn.innerHTML = '<i class="fas fa-user-cog mr-1"></i> Refer to Tech Director';
                                    }
                                } catch (error) {
                                    console.error(' Tech Director Referral Error:', error);
                                    showNotification('An error occurred while referring ticket to Tech Director', 'error');

                                    // Re-enable button on error
                                    referToTechDirectorBtn.disabled = false;
                                    referToTechDirectorBtn.innerHTML = '<i class="fas fa-user-cog mr-1"></i> Refer to Tech Director';
                                }
                            });
                        }

                        // Forward Button - Show modal to select member
                        const forwardBtn = document.getElementById('forwardBtn');
                        if (forwardBtn) {
                            forwardBtn.addEventListener('click', function () {
                                assignModalTitle.textContent = 'Forward Ticket';
                                forwardNotesContainer.style.display = 'block';
                                assignModal.classList.add('active');
                            });
                        }

                        // Close assign modal
                        function closeAssignModalFunc() {
                            assignModal.classList.remove('active');
                        }

                        if (closeAssignModal) closeAssignModal.addEventListener('click', closeAssignModalFunc);
                        if (cancelAssign) cancelAssign.addEventListener('click', closeAssignModalFunc);

                        // Confirm assignment (only for forwarding - Take Over bypasses modal)
                        if (confirmAssign) {
                            confirmAssign.addEventListener('click', async function () {
                                const memberId = assignMemberSelect.value;
                                const notes = assignNotes.value;

                                if (!memberId) {
                                    showNotification('Please select a member to forward to', 'error');
                                    return;
                                }

                                try {
                                    const response = await fetch(`/api/tickets/${ticketId}/assign`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            member_id: memberId,
                                            notes: notes,
                                            is_forwarded: true,
                                            forwarded_from: currentUserId
                                        })
                                    });

                                    const data = await response.json();
                                    if (response.ok && data.status === 'success') {
                                        // SMOOTH: Update assignment display instead of full reload
                                        const takeOverBtn = document.getElementById('takeOverBtn');
                                        if (takeOverBtn) {
                                            takeOverBtn.style.display = 'none';
                                        }

                                        // Add assignment badge
                                        const assignmentArea = document.querySelector('.assignment-status-area') || document.querySelector('.px-3.py-1.rounded-lg');
                                        if (assignmentArea) {
                                            assignmentArea.innerHTML = `
                                    <div class="px-3 py-1 rounded-lg bg-blue-50 text-blue-700 border border-blue-200">
                                        <i class="fas fa-share mr-1"></i> Forwarded to ${assignMemberSelect.options[assignMemberSelect.selectedIndex].text}
                                        <span class="text-xs opacity-75 ml-1">(just now)</span>
                                    </div>
                                `;
                                        }

                                        closeModal('assignModal');
                                        showNotification('Ticket forwarded successfully!', 'success');
                                    } else {
                                        showNotification(data.message || 'Error forwarding ticket', 'error');
                                    }
                                } catch (error) {
                                    console.error('Error:', error);
                                    showNotification('An error occurred while forwarding ticket', 'error');
                                }
                            });
                        }

                        // Importance Button
                        const importantBtn = document.getElementById('importantBtn');
                        if (importantBtn) {
                            importantBtn.addEventListener('click', async function () {
                                try {
                                    const response = await fetch(`/api/tickets/{{ ticket.ticket_id }}/important`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' }
                                    });

                                    const data = await response.json();
                                    if (response.ok && data.status === 'success') {
                                        importantBtn.classList.toggle('important');
                                        const icon = importantBtn.querySelector('.star-icon i');

                                        if (icon.classList.contains('far')) {
                                            // Change from empty star to filled star
                                            icon.classList.remove('far');
                                            icon.classList.add('fas');
                                            showNotification('Ticket marked as important');
                                        } else {
                                            // Change from filled star to empty star
                                            icon.classList.remove('fas');
                                            icon.classList.add('far');
                                            showNotification('Ticket importance removed');
                                        }
                                    } else {
                                        showNotification(data.message || 'Error toggling important status', 'error');
                                    }
                                } catch (error) {
                                    console.error('Error:', error);
                                    showNotification('An error occurred while updating ticket status', 'error');
                                }
                            });
                        }



                        // Reply Form - COMPLETELY PREVENT MULTIPLE SUBMISSIONS
                        const replyForm = document.getElementById('replyForm');
                        if (replyForm) {
                            // Global flag to prevent multiple submissions
                            let isSubmitting = false;

                            // Remove ALL existing event listeners by replacing the form
                            const newReplyForm = replyForm.cloneNode(true);
                            replyForm.parentNode.replaceChild(newReplyForm, replyForm);

                            // Get fresh references after replacement
                            const freshForm = document.getElementById('replyForm');
                            const sendBtn = document.getElementById('sendBtn');
                            const responseTextarea = document.querySelector('textarea[name="response"]');

                            // MESSAGE PRESERVATION: Save and restore message content
                            const ticketId = '{{ ticket.ticket_id|e }}';
                            const messageKey = 'ticket_' + ticketId + '_message';

                            // Restore saved message on page load
                            const savedMessage = localStorage.getItem(messageKey);
                            if (savedMessage && !responseTextarea.value.trim()) {
                                responseTextarea.value = savedMessage;
                            }

                            // Save message as user types
                            responseTextarea.addEventListener('input', function () {
                                if (this.value.trim()) {
                                    localStorage.setItem(messageKey, this.value);
                                } else {
                                    localStorage.removeItem(messageKey);
                                }
                            });

                            // SINGLE event listener with aggressive anti-spam protection
                            freshForm.addEventListener('submit', async function (e) {
                                e.preventDefault();
                                e.stopPropagation();



                                // ABSOLUTE PREVENTION OF MULTIPLE SUBMISSIONS
                                if (isSubmitting || sendBtn.disabled) {

                                    return false;
                                }

                                // Validate input
                                if (!responseTextarea.value.trim()) {
                                    alert('Please enter a response');
                                    return false;
                                }

                                // SET GLOBAL FLAG AND DISABLE EVERYTHING
                                isSubmitting = true;
                                sendBtn.disabled = true;
                                sendBtn.style.pointerEvents = 'none';
                                sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Sending...';



                                try {
                                    // Create FormData object to handle both text and file attachments
                                    const formData = new FormData();
                                    formData.append('response', responseTextarea.value);

                                    // ENHANCED: Add files from the new drag & drop attachment system
                                    if (window.currentAttachments && window.currentAttachments.length > 0) {
                                        console.log(` Processing ${window.currentAttachments.length} enhanced attachments`);

                                        // Process enhanced attachments with proper file handling
                                        for (let i = 0; i < window.currentAttachments.length; i++) {
                                            const attachment = window.currentAttachments[i];

                                            if (attachment.type === 'file') {
                                                // Handle uploaded files - they have actual file data
                                                formData.append('response_attachments', attachment.file);
                                                console.log(` Added file attachment: ${attachment.name}`);
                                            } else if (attachment.type === 'common_document') {
                                                //  ENHANCED: Use already-fetched file data from drag & drop
                                                if (attachment.file && attachment.file.size > 0) {
                                                    // File data was already fetched during drag & drop
                                                    formData.append('response_attachments', attachment.file);
                                                    console.log(` Using pre-fetched file data for common document: ${attachment.name} (Size: ${attachment.file.size} bytes)`);
                                                } else {
                                                    // Fallback: fetch file data now (shouldn't happen with enhanced system)
                                                    console.log(` Fallback: Fetching file data for common document: ${attachment.name} (ID: ${attachment.documentId})`);
                                                    try {
                                                        const response = await fetch(`/api/common-documents/${attachment.documentId}/download`);
                                                        if (response.ok) {
                                                            const blob = await response.blob();
                                                            const file = new File([blob], attachment.name, {
                                                                type: attachment.fileType || 'application/octet-stream'
                                                            });
                                                            formData.append('response_attachments', file);
                                                            console.log(` Successfully converted common document to file: ${attachment.name}`);
                                                        } else {
                                                            console.error(` Failed to fetch common document: ${attachment.name}`);
                                                            // Fallback: add as common document reference
                                                            formData.append(`common_document_${i}`, attachment.documentId);
                                                            formData.append(`common_document_name_${i}`, attachment.name);
                                                        }
                                                    } catch (error) {
                                                        console.error(` Error processing common document ${attachment.name}:`, error);
                                                        // Fallback: add as common document reference
                                                        formData.append(`common_document_${i}`, attachment.documentId);
                                                        formData.append(`common_document_name_${i}`, attachment.name);
                                                    }
                                                }
                                            }
                                        }
                                    }

                                    // ENHANCED: Only use the new drag & drop system - remove legacy conflicts
                                    // The new system handles both files and common documents seamlessly

                                    // Debug logging to see what's being sent
                                    console.log(' DEBUG: Enhanced attachments to be sent:', window.currentAttachments);

                                    // Log the final FormData contents
                                    for (let [key, value] of formData.entries()) {
                                        console.log(` FormData: ${key} = ${value}`);
                                    }

                                    // Legacy attachedFiles system removed - enhanced system handles everything

                                    // Add common documents as attachments
                                    const commonDocumentPreview = document.getElementById('commonDocumentPreview');
                                    if (commonDocumentPreview && commonDocumentPreview.children.length > 0) {


                                        for (let i = 0; i < commonDocumentPreview.children.length; i++) {
                                            const docItem = commonDocumentPreview.children[i];
                                            const documentId = docItem.dataset.documentId;
                                            const documentName = docItem.querySelector('span').textContent;



                                            if (documentId) {
                                                // Add document reference to form data in the format expected by backend
                                                formData.append(`common_document_${i}`, documentId);
                                                formData.append(`common_document_name_${i}`, documentName);

                                                // ENHANCED: Add all document metadata to form data for debugging
                                                if (docItem.dataset.documentType) formData.append(`common_document_type_${i}`, docItem.dataset.documentType);
                                                if (docItem.dataset.documentDescription) formData.append(`common_document_description_${i}`, docItem.dataset.documentDescription);
                                                if (docItem.dataset.documentFileName) formData.append(`common_document_filename_${i}`, docItem.dataset.documentFileName);
                                                if (docItem.dataset.documentFileSize) formData.append(`common_document_filesize_${i}`, docItem.dataset.documentFileSize);
                                                if (docItem.dataset.documentFilePath) formData.append(`common_document_filepath_${i}`, docItem.dataset.documentFilePath);
                                                if (docItem.dataset.documentCreatedAt) formData.append(`common_document_created_${i}`, docItem.dataset.documentCreatedAt);
                                                if (docItem.dataset.documentUpdatedAt) formData.append(`common_document_updated_${i}`, docItem.dataset.documentUpdatedAt);
                                                if (docItem.dataset.documentIsActive) formData.append(`common_document_active_${i}`, docItem.dataset.documentIsActive);
                                                if (docItem.dataset.arrayIndex) formData.append(`common_document_arrayindex_${i}`, docItem.dataset.arrayIndex);


                                            }
                                        }

                                    } else {

                                    }



                                    // Send to main API endpoint
                                    const response = await fetch('/api/tickets/' + ticketId + '/reply', {
                                        method: 'POST',
                                        body: formData  // Use FormData instead of URLSearchParams
                                    });



                                    // Also send to n8n webhook (parallel processing)
                                    try {
                                        //  FIXED: Check if ticket was created from email using CORRECT message_id field
                                        const originalMessageId = '{{ ticket.message_id|default("", true) }}';
                                        const creationMethod = '{{ ticket.creation_method|default("", true) }}';

                                        // Email ticket detection: check if message_id exists and is NOT a system-generated ID
                                        const isRealEmailMessageId = originalMessageId && originalMessageId.trim() && !originalMessageId.startsWith('msg-');
                                        const isEmailTicket = creationMethod === 'email' || isRealEmailMessageId;

                                        //  PROCESS ATTACHMENTS for webhook payload
                                        const attachmentData = [];
                                        let totalFiles = 0;

                                        // ENHANCED: Process new drag & drop attachments first
                                        if (window.currentAttachments && window.currentAttachments.length > 0) {
                                            console.log(` Processing ${window.currentAttachments.length} enhanced attachments for webhook`);

                                            for (let i = 0; i < window.currentAttachments.length; i++) {
                                                const attachment = window.currentAttachments[i];

                                                if (attachment.type === 'file') {
                                                    // Process uploaded files
                                                    try {
                                                        const base64Data = await new Promise((resolve, reject) => {
                                                            const reader = new FileReader();
                                                            reader.onload = () => {
                                                                const base64 = reader.result.split(',')[1];
                                                                resolve(base64);
                                                            };
                                                            reader.onerror = reject;
                                                            reader.readAsDataURL(attachment.file);
                                                        });

                                                        attachmentData.push({
                                                            fileName: attachment.name,
                                                            fileData: base64Data,
                                                            size: attachment.size,
                                                            type: attachment.fileType,
                                                            isWarranty: attachment.name.toLowerCase().includes('warranty'),
                                                            source: 'enhanced_drag_drop'
                                                        });
                                                        totalFiles++;
                                                        console.log(` Enhanced file attachment: ${attachment.name} (${attachment.size} bytes)`);
                                                    } catch (error) {
                                                        console.error(` Failed to encode enhanced attachment ${attachment.name}:`, error);
                                                    }
                                                } else if (attachment.type === 'common_document') {
                                                    // Process common document references
                                                    attachmentData.push({
                                                        fileName: attachment.name,
                                                        documentId: attachment.documentId,
                                                        size: attachment.size,
                                                        type: attachment.fileType,
                                                        isWarranty: false,
                                                        source: 'enhanced_common_document',
                                                        isCommonDocument: true
                                                    });
                                                    totalFiles++;
                                                    console.log(` Enhanced common document: ${attachment.name} (ID: ${attachment.documentId})`);
                                                }
                                            }
                                        }

                                        // Process file input attachments (legacy support)
                                        if (fileInput && fileInput.files.length > 0) {

                                            totalFiles += fileInput.files.length;

                                            for (let i = 0; i < fileInput.files.length; i++) {
                                                const file = fileInput.files[i];
                                                try {
                                                    // Convert file to base64 for webhook payload
                                                    const base64Data = await new Promise((resolve, reject) => {
                                                        const reader = new FileReader();
                                                        reader.onload = () => {
                                                            // Remove data:mime/type;base64, prefix
                                                            const base64 = reader.result.split(',')[1];
                                                            resolve(base64);
                                                        };
                                                        reader.onerror = reject;
                                                        reader.readAsDataURL(file);
                                                    });

                                                    attachmentData.push({
                                                        fileName: file.name,
                                                        fileData: base64Data,
                                                        size: file.size,
                                                        type: file.type,
                                                        isWarranty: file.name.toLowerCase().includes('warranty')
                                                    });
                                                    console.log(` Encoded attachment: ${file.name} (${file.size} bytes)`);
                                                } catch (error) {
                                                    console.error(` Failed to encode attachment ${file.name}:`, error);
                                                }
                                            }
                                        }

                                        //  ENHANCED: Process attached files from enhanced attachment system
                                        if (window.currentAttachments && window.currentAttachments.length > 0) {
                                            console.log(` Processing ${window.currentAttachments.length} enhanced attachments for webhook`);

                                            for (let i = 0; i < window.currentAttachments.length; i++) {
                                                const attachment = window.currentAttachments[i];

                                                if (attachment.type === 'file' && attachment.file) {
                                                    // Handle uploaded files
                                                    try {
                                                        const base64Data = await new Promise((resolve, reject) => {
                                                            const reader = new FileReader();
                                                            reader.onload = () => {
                                                                const base64 = reader.result.split(',')[1];
                                                                resolve(base64);
                                                            };
                                                            reader.onerror = reject;
                                                            reader.readAsDataURL(attachment.file);
                                                        });

                                                        attachmentData.push({
                                                            fileName: attachment.name,
                                                            fileData: base64Data,  //  CRITICAL: This is what n8n expects
                                                            size: attachment.size,
                                                            type: attachment.fileType,
                                                            isWarranty: attachment.name.toLowerCase().includes('warranty')
                                                        });
                                                        totalFiles++;
                                                        console.log(` Encoded uploaded file: ${attachment.name} (${attachment.size} bytes)`);
                                                    } catch (error) {
                                                        console.error(` Failed to encode uploaded file ${attachment.name}:`, error);
                                                    }
                                                } else if (attachment.type === 'common_document' && attachment.file) {
                                                    // Handle common documents with file data
                                                    try {
                                                        const base64Data = await new Promise((resolve, reject) => {
                                                            const reader = new FileReader();
                                                            reader.onload = () => {
                                                                const base64 = reader.result.split(',')[1];
                                                                resolve(base64);
                                                            };
                                                            reader.onerror = reject;
                                                            reader.readAsDataURL(attachment.file);
                                                        });

                                                        attachmentData.push({
                                                            fileName: attachment.name,
                                                            fileData: base64Data,  //  CRITICAL: This is what n8n expects
                                                            size: attachment.size,
                                                            type: attachment.fileType,
                                                            isWarranty: attachment.name.toLowerCase().includes('warranty'),
                                                            isCommonDocument: true,
                                                            documentId: attachment.documentId
                                                        });
                                                        totalFiles++;
                                                        console.log(` Encoded common document: ${attachment.name} (${attachment.size} bytes)`);
                                                    } catch (error) {
                                                        console.error(` Failed to encode common document ${attachment.name}:`, error);
                                                    }
                                                }
                                            }
                                        }

                                        // Process common documents for webhook
                                        const commonDocumentPreview = document.getElementById('commonDocumentPreview');
                                        let commonDocData = [];
                                        if (commonDocumentPreview && commonDocumentPreview.children.length > 0) {
                                            console.log(' Processing common documents for webhook...');
                                            commonDocumentPreview.querySelectorAll('[data-document-id]').forEach((item, index) => {
                                                const docId = item.dataset.documentId;
                                                const docName = item.querySelector('span').textContent;

                                                // ENHANCED DEBUGGING: Log all available data for webhook
                                                console.log(` Webhook Common Document ${index + 1}:`);
                                                console.log('  - Document ID:', docId);
                                                console.log('  - Document Name:', docName);
                                                console.log('  - Document Type:', item.dataset.documentType);
                                                console.log('  - Document Description:', item.dataset.documentDescription);
                                                console.log('  - Document File Name:', item.dataset.documentFileName);
                                                console.log('  - Document File Size:', item.dataset.documentFileSize);
                                                console.log('  - Document File Path:', item.dataset.documentFilePath);
                                                console.log('  - Document Created At:', item.dataset.documentCreatedAt);
                                                console.log('  - Document Updated At:', item.dataset.documentUpdatedAt);
                                                console.log('  - Document Is Active:', item.dataset.documentIsActive);
                                                console.log('  - Array Index:', item.dataset.arrayIndex);
                                                console.log('  - Full dataset:', item.dataset);

                                                commonDocData.push({
                                                    document_id: docId,
                                                    document_name: docName,
                                                    type: 'common_document',
                                                    // ENHANCED: Include all metadata for webhook debugging
                                                    document_type: item.dataset.documentType,
                                                    document_description: item.dataset.documentDescription,
                                                    document_filename: item.dataset.documentFileName,
                                                    document_filesize: item.dataset.documentFileSize,
                                                    document_filepath: item.dataset.documentFilePath,
                                                    document_created_at: item.dataset.documentCreatedAt,
                                                    document_updated_at: item.dataset.documentUpdatedAt,
                                                    document_is_active: item.dataset.documentIsActive,
                                                    array_index: item.dataset.arrayIndex
                                                });
                                            });
                                            console.log(' Common documents prepared for webhook:', commonDocData);
                                        }

                                        const webhookData = {
                                            ticket_id: '{{ ticket.ticket_id }}',
                                            response_text: responseTextarea.value,
                                            replyMessage: responseTextarea.value, //  ADDED: replyMessage field for n8n compatibility
                                            timestamp: new Date().toISOString(),
                                            user_id: '{{ session.member_id if session.member_id else "unknown" }}',
                                            ticket_subject: '{{ ticket.subject|default("", true) }}',
                                            subject: '{{ ticket.subject|default("", true) }}', //  ADDED: subject field for n8n compatibility
                                            ticket_status: '{{ ticket.status|default("", true) }}',
                                            customer_email: '{{ ticket.email|default("", true) }}',
                                            customer_name: '{{ ticket.name|default("", true) }}',
                                            priority: '{{ ticket.Priority|default("", true) }}',
                                            has_attachments: totalFiles > 0, //  Updated to reflect actual file count
                                            attachments: attachmentData, //  Include actual attachment data
                                            attachment_count: attachmentData.length, //  Explicit count
                                            has_common_documents: commonDocData.length > 0,
                                            common_documents: commonDocData,
                                            common_document_count: commonDocData.length,
                                            message_id: isRealEmailMessageId ? originalMessageId : false, // Send original email message ID or false
                                            is_email_ticket: isEmailTicket,
                                            creation_method: creationMethod || 'manual',
                                            ticketSource: isEmailTicket ? 'email' : 'manual' //  ADDED: ticketSource field for n8n compatibility
                                        };

                                        console.log(' SENDING TO N8N WEBHOOK:');
                                        console.log('    Original Message ID from DB:', originalMessageId);
                                        console.log('    Is Real Email Message ID:', isRealEmailMessageId);
                                        console.log('    Message ID being sent:', webhookData.message_id);
                                        console.log('    Is Email Ticket:', webhookData.is_email_ticket);
                                        console.log('    Creation Method:', webhookData.creation_method);
                                        console.log('    Total Files Found:', totalFiles);
                                        console.log('    Attachments Processed:', webhookData.attachment_count);
                                        console.log('    Has Attachments:', webhookData.has_attachments);
                                        if (webhookData.attachments && webhookData.attachments.length > 0) {
                                            webhookData.attachments.forEach((att, index) => {
                                                console.log(`    Attachment ${index + 1}: ${att.fileName} (${att.size} bytes, ${att.type})`);
                                                console.log(`    FileData Length: ${att.fileData ? att.fileData.length : 0} chars`);
                                                console.log(`    Has FileData: ${att.fileData ? 'YES' : 'NO'}`);
                                            });
                                        }
                                        console.log('    Has Common Documents:', webhookData.has_common_documents);
                                        console.log('    Common Document Count:', webhookData.common_document_count);
                                        if (webhookData.common_documents && webhookData.common_documents.length > 0) {
                                            webhookData.common_documents.forEach((doc, index) => {
                                                console.log(`    Common Document ${index + 1}: ${doc.document_name} (ID: ${doc.document_id}, Type: ${doc.document_type})`);
                                            });
                                        }
                                        console.log('    Full Payload:', webhookData);

                                        //  FIXED: Removed frontend webhook call to prevent duplicate webhooks
                                        // Backend already handles webhook triggering when reply is saved
                                        // This prevents automatic replies caused by double webhook firing
                                        console.log(' Skipping frontend webhook - backend will handle webhook triggering');
                                    } catch (webhookError) {
                                        console.error(' WEBHOOK PROCESSING ERROR:', webhookError);
                                        // Don't fail the main process if webhook processing fails
                                    }

                                    if (response.ok) {
                                        const data = await response.json();
                                        console.log(' SUCCESS RESPONSE:', data);

                                        // Clear saved message from localStorage since it was sent successfully
                                        localStorage.removeItem(messageKey);

                                        // Clear form immediately
                                        responseTextarea.value = '';

                                        // Reset textarea height after clearing
                                        if (typeof window.autoExpandTextarea === 'function') {
                                            window.autoExpandTextarea(responseTextarea);
                                        }

                                        // Clear file input
                                        const fileInput = document.getElementById('response_attachments');
                                        if (fileInput) {
                                            fileInput.value = '';
                                        }

                                        //  REMOVED: Old attachment clearing - enhanced system handles this

                                        // ENHANCED: Clear new drag & drop attachments
                                        if (window.currentAttachments) {
                                            window.currentAttachments = [];
                                            console.log(' Cleared enhanced attachments');
                                        }

                                        // Hide enhanced attachment preview
                                        const enhancedAttachmentPreview = document.getElementById('enhancedAttachmentPreview');
                                        if (enhancedAttachmentPreview) {
                                            enhancedAttachmentPreview.classList.add('hidden');
                                            const attachmentPreviewList = document.getElementById('attachmentPreviewList');
                                            if (attachmentPreviewList) {
                                                attachmentPreviewList.innerHTML = '';
                                            }
                                        }

                                        // Hide attachment preview if visible (legacy support)
                                        const attachmentPreview = document.getElementById('attachmentPreview');
                                        if (attachmentPreview) {
                                            attachmentPreview.innerHTML = '';
                                            attachmentPreview.classList.add('hidden');
                                        }

                                        // Clear common documents
                                        const commonDocumentDropzone = document.getElementById('commonDocumentDropzone');
                                        const commonDocumentPreview = document.getElementById('commonDocumentPreview');
                                        if (commonDocumentDropzone && commonDocumentPreview) {
                                            commonDocumentPreview.innerHTML = '';
                                            commonDocumentDropzone.classList.add('hidden');
                                        }

                                        // Clear processed documents tracking to allow re-adding documents
                                        processedDocuments.clear();
                                        console.log(' Form submitted - cleared processed documents tracking');

                                        // Show success and redirect quickly
                                        showNotification('Reply sent successfully! ', 'success');

                                        // Notify parent window (index page) that a reply was sent
                                        try {
                                            if (window.opener && !window.opener.closed) {
                                                window.opener.postMessage({
                                                    type: 'replySent',
                                                    ticketId: '{{ ticket.ticket_id }}',
                                                    timestamp: Date.now()
                                                }, '*');
                                            }

                                            // Also notify other tabs via localStorage
                                            localStorage.setItem('newReplyAdded', JSON.stringify({
                                                type: 'replySent',
                                                ticketId: '{{ ticket.ticket_id }}',
                                                timestamp: Date.now()
                                            }));

                                            // Clean up localStorage after a short delay
                                            setTimeout(() => {
                                                localStorage.removeItem('newReplyAdded');
                                            }, 5000);
                                        } catch (error) {
                                            console.log('Could not notify parent window:', error);
                                        }

                                        setTimeout(() => {
                                            window.location.href = `/ticket/{{ ticket.ticket_id }}`;
                                        }, 500);
                                    } else {
                                        const error = await response.json();
                                        console.error(' API ERROR:', error);
                                        alert('Error: ' + error.message);
                                    }
                                } catch (err) {
                                    console.error(' NETWORK ERROR:', err);
                                    alert('An error occurred while sending the response');
                                } finally {
                                    // Reset flags and button after delay to prevent rapid resubmission
                                    // Keep message in localStorage for retry if sending failed
                                    setTimeout(() => {
                                        isSubmitting = false;
                                        sendBtn.disabled = false;
                                        sendBtn.style.pointerEvents = 'auto';
                                        sendBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> Send Response';
                                        console.log(' RESET - Ready for next submission');
                                    }, 2000);
                                }

                                return false;
                            }, { once: false });

                            // Additional protection - remove any other submit handlers
                            freshForm.onsubmit = null;

                            console.log(' REPLY FORM INITIALIZED - Anti-spam protection active');
                        }

                        // Click handler for expanding original message in modal
                        const originalMessage = document.getElementById('originalMessage');
                        if (originalMessage) {
                            originalMessage.addEventListener('click', function (e) {
                                if (e.target.classList.contains('read-more-btn')) return;
                                if (this.classList.contains('truncated')) {
                                    const modalContent = document.getElementById('modalMessageContent');
                                    modalContent.textContent = this.textContent.trim();
                                    openModal('messageModal');
                                }
                            });
                        }

                        // Click handler for expanding reply messages in modal
                        document.querySelectorAll('.reply-message-box').forEach(box => {
                            box.addEventListener('click', function (e) {
                                if (e.target.classList.contains('expand-btn')) return;
                                if (this.classList.contains('truncated')) {
                                    const modalContent = document.getElementById('modalMessageContent');
                                    modalContent.textContent = this.querySelector('.message-content').textContent.trim();
                                    openModal('messageModal');
                                }
                            });
                        });
                    });

                    // Handle file input change event
                    document.getElementById('documentFile').addEventListener('change', function () {
                        const fileName = this.files.length > 0 ? this.files[0].name : 'No file selected';
                        document.getElementById('selectedFileName').textContent = fileName;
                    });

                    // Set up communication with index page
                    function setupIndexPageCommunication() {
                        // Listen for messages from index page
                        window.addEventListener('message', function (event) {
                            if (event.data && event.data.type === 'establishCommunication') {
                                console.log(' Communication established with index page');

                                // Send confirmation back
                                try {
                                    if (event.source && !event.source.closed) {
                                        event.source.postMessage({
                                            type: 'communicationEstablished',
                                            ticketId: '{{ ticket.ticket_id }}',
                                            timestamp: Date.now()
                                        }, '*');
                                    }
                                } catch (error) {
                                    console.log('Could not send confirmation to index page');
                                }
                            }
                        });

                        // Notify index page when this page loads
                        try {
                            if (window.opener && !window.opener.closed) {
                                window.opener.postMessage({
                                    type: 'ticketDetailPageLoaded',
                                    ticketId: '{{ ticket.ticket_id }}',
                                    timestamp: Date.now()
                                }, '*');
                            }
                        } catch (error) {
                            console.log('Could not notify index page of load');
                        }
                    }

                    // Initialize communication
                    setupIndexPageCommunication();

                    // Enhanced Response attachment handling with drag & drop
                    function setupAttachmentHandlers() {
                        console.log('Setting up enhanced attachment handlers with drag & drop');
                        const dropzone = document.getElementById('replyDropzone');
                        const fileInput = document.getElementById('response_attachments');
                        const enhancedAttachmentPreview = document.getElementById('enhancedAttachmentPreview');
                        const attachmentPreviewList = document.getElementById('attachmentPreviewList');
                        const replyForm = document.getElementById('replyForm');
                        const textarea = document.getElementById('response');
                        const responseArea = textarea.parentElement;

                        // Global attachment storage
                        window.currentAttachments = [];

                        // Enhanced drag & drop functionality
                        function setupEnhancedDragAndDrop() {
                            // Make the entire dropzone a drag target
                            dropzone.addEventListener('dragover', function (e) {
                                e.preventDefault();
                                dropzone.classList.add('border-blue-400', 'bg-blue-50');
                                dropzone.style.transform = 'scale(1.01)';
                            });

                            dropzone.addEventListener('dragleave', function (e) {
                                e.preventDefault();
                                dropzone.classList.remove('border-blue-400', 'bg-blue-50');
                                dropzone.style.transform = 'scale(1)';
                            });

                            dropzone.addEventListener('drop', function (e) {
                                e.preventDefault();
                                dropzone.classList.remove('border-blue-400', 'bg-blue-50');
                                dropzone.style.transform = 'scale(1)';

                                console.log('Drop detected in enhanced dropzone');

                                // Handle file drops
                                if (e.dataTransfer.files.length > 0) {
                                    console.log('Files dropped:', e.dataTransfer.files.length);
                                    handleFileDrop(e.dataTransfer.files);
                                }

                                // Handle common document drops
                                if (e.dataTransfer.getData('text')) {
                                    try {
                                        const docData = JSON.parse(e.dataTransfer.getData('text'));
                                        console.log(' RAW DROP DATA PARSED:', docData);
                                        if (docData && docData.type === 'common-document') {
                                            console.log(' Common document dropped in dropzone:', docData);
                                            console.log(' Document ID fields:', {
                                                _id: docData._id,
                                                id: docData.id,
                                                index: docData.index
                                            });
                                            handleCommonDocumentDrop(docData);
                                        }
                                    } catch (err) {
                                        console.error('Error parsing dropped document data:', err);
                                    }
                                }
                            });
                        }

                        // Handle file drops
                        function handleFileDrop(files) {
                            Array.from(files).forEach(file => {
                                if (isValidFile(file)) {
                                    const attachment = {
                                        id: generateAttachmentId(),
                                        type: 'file',
                                        file: file,
                                        name: file.name,
                                        size: file.size,
                                        fileType: file.type || getFileTypeFromName(file.name)
                                    };
                                    addAttachmentToPreview(attachment);
                                }
                            });
                        }

                        // Handle common document drops
                        async function handleCommonDocumentDrop(docData) {
                            console.log(' Common document drop data received:', docData);
                            console.log(' Document data structure:', {
                                _id: docData._id,
                                id: docData.id,
                                index: docData.index,
                                name: docData.name,
                                type: docData.type
                            });

                            try {
                                //  FETCH ACTUAL FILE DATA FROM DATABASE
                                const documentId = docData._id || docData.id || docData.index;
                                console.log(' Fetching file data for common document:', docData.name, '(ID:', documentId + ')');

                                if (!documentId) {
                                    throw new Error('Document ID not found in document data');
                                }

                                const response = await fetch(`/api/common-documents/${documentId}/download`);

                                if (!response.ok) {
                                    throw new Error(`Failed to fetch document: ${response.status} ${response.statusText}`);
                                }

                                // Get the file as a blob to get actual size and content
                                const fileBlob = await response.blob();
                                console.log(' Successfully fetched file blob:', fileBlob);

                                // Create a File object from the blob
                                const fileName = docData.name || 'document';
                                const fileExtension = getFileExtensionFromMimeType(fileBlob.type) || getFileExtensionFromName(fileName);
                                const actualFileName = fileName.includes('.') ? fileName : `${fileName}.${fileExtension}`;

                                const file = new File([fileBlob], actualFileName, { type: fileBlob.type });
                                console.log(' Successfully converted common document to file:', file.name, 'Size:', file.size, 'Type:', file.type);

                                const attachment = {
                                    id: generateAttachmentId(),
                                    type: 'common_document',
                                    documentId: documentId,
                                    name: docData.name,
                                    size: file.size, //  ACTUAL FILE SIZE
                                    fileType: file.type, //  ACTUAL MIME TYPE
                                    file: file, //  ACTUAL FILE OBJECT
                                    originalDocData: docData // Keep reference to original data
                                };

                                console.log(' Created enhanced attachment object:', attachment);
                                addAttachmentToPreview(attachment);

                            } catch (error) {
                                console.error(' Error fetching common document file data:', error);

                                // Fallback: create attachment without file data
                                const attachment = {
                                    id: generateAttachmentId(),
                                    type: 'common_document',
                                    documentId: docData._id || docData.id || docData.index,
                                    name: docData.name,
                                    size: 0,
                                    fileType: docData.fileType || 'application/octet-stream',
                                    error: 'Failed to fetch file data'
                                };

                                console.log(' Created fallback attachment object:', attachment);
                                addAttachmentToPreview(attachment);
                            }
                        }

                        // Add attachment to preview
                        function addAttachmentToPreview(attachment) {
                            console.log(' Adding attachment to preview:', attachment);
                            window.currentAttachments.push(attachment);
                            console.log(' Current attachments array:', window.currentAttachments);
                            renderAttachmentPreview();
                            showEnhancedAttachmentPreview();
                        }

                        // Remove attachment from preview
                        function removeAttachment(attachmentId) {
                            window.currentAttachments = window.currentAttachments.filter(att => att.id !== attachmentId);
                            renderAttachmentPreview();
                            if (window.currentAttachments.length === 0) {
                                hideEnhancedAttachmentPreview();
                            }
                        }

                        // Render attachment preview
                        function renderAttachmentPreview() {
                            attachmentPreviewList.innerHTML = '';

                            window.currentAttachments.forEach(attachment => {
                                const attachmentCard = createAttachmentCard(attachment);
                                attachmentPreviewList.appendChild(attachmentCard);
                            });
                        }

                        // Create attachment card
                        function createAttachmentCard(attachment) {
                            const card = document.createElement('div');
                            card.className = 'flex items-center p-2 bg-gray-50 border border-gray-200 rounded-lg';
                            card.dataset.attachmentId = attachment.id;

                            const icon = getFileTypeIcon(attachment.fileType);
                            const size = formatFileSize(attachment.size);

                            //  ENHANCED: Show different info based on attachment type
                            let statusInfo = '';
                            if (attachment.type === 'common_document') {
                                if (attachment.file && attachment.file.size > 0) {
                                    statusInfo = ` ${size}  ${attachment.fileType}`;
                                } else if (attachment.error) {
                                    statusInfo = ` ${attachment.error}`;
                                } else {
                                    statusInfo = ` Loading file data...`;
                                }
                            } else {
                                statusInfo = `${size}  ${attachment.fileType}`;
                            }

                            card.innerHTML = `
                    <div class="flex items-center flex-1">
                        <div class="text-lg mr-3">${icon}</div>
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-medium text-gray-900 truncate">${attachment.name}</div>
                            <div class="text-xs text-gray-500">${statusInfo}</div>
                        </div>
                    </div>
                    <button type="button" class="ml-2 text-red-500 hover:text-red-700 hover:bg-red-50 p-1 rounded" 
                            onclick="removeAttachment('${attachment.id}')">
                        <i class="fas fa-times"></i>
                    </button>
                `;

                            return card;
                        }

                        // Helper functions
                        function generateAttachmentId() {
                            return 'att_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                        }

                        function isValidFile(file) {
                            const maxSize = 10 * 1024 * 1024; // 10MB
                            const allowedTypes = ['.pdf', '.doc', '.docx', '.jpg', '.jpeg', '.png', '.xlsx', '.xls', '.txt', '.csv', '.zip'];

                            if (file.size > maxSize) {
                                showNotification(`File ${file.name} is too large (max 10MB)`, 'error');
                                return false;
                            }

                            const extension = '.' + file.name.split('.').pop().toLowerCase();
                            if (!allowedTypes.includes(extension)) {
                                showNotification(`File type ${extension} not allowed`, 'error');
                                return false;
                            }

                            return true;
                        }

                        function getFileTypeFromName(filename) {
                            const ext = filename.split('.').pop().toLowerCase();
                            const typeMap = {
                                'pdf': 'application/pdf',
                                'doc': 'application/msword',
                                'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
                                'jpg': 'image/jpeg',
                                'jpeg': 'image/jpeg',
                                'png': 'image/png',
                                'xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                                'xls': 'application/vnd.ms-excel',
                                'txt': 'text/plain',
                                'csv': 'text/csv',
                                'zip': 'application/zip'
                            };
                            return typeMap[ext] || 'application/octet-stream';
                        }

                        function getFileTypeIcon(fileType) {
                            if (fileType.includes('pdf')) return '';
                            if (fileType.includes('word') || fileType.includes('document')) return '';
                            if (fileType.includes('excel') || fileType.includes('spreadsheet')) return '';
                            if (fileType.includes('image')) return '';
                            if (fileType.includes('text')) return '';
                            if (fileType.includes('zip')) return '';
                            return '';
                        }

                        function formatFileSize(bytes) {
                            if (bytes === 0) return '0 Bytes';
                            const k = 1024;
                            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                            const i = Math.floor(Math.log(bytes) / Math.log(k));
                            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                        }

                        //  NEW: Helper functions for file extensions
                        function getFileExtensionFromMimeType(mimeType) {
                            const mimeToExt = {
                                'application/pdf': 'pdf',
                                'application/msword': 'doc',
                                'application/vnd.openxmlformats-officedocument.wordprocessingml.document': 'docx',
                                'image/jpeg': 'jpg',
                                'image/png': 'png',
                                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet': 'xlsx',
                                'application/vnd.ms-excel': 'xls',
                                'text/plain': 'txt',
                                'text/csv': 'csv',
                                'application/zip': 'zip'
                            };
                            return mimeToExt[mimeType] || null;
                        }

                        function getFileExtensionFromName(filename) {
                            const parts = filename.split('.');
                            return parts.length > 1 ? parts[parts.length - 1].toLowerCase() : null;
                        }

                        function showEnhancedAttachmentPreview() {
                            enhancedAttachmentPreview.classList.remove('hidden');
                        }

                        function hideEnhancedAttachmentPreview() {
                            enhancedAttachmentPreview.classList.add('hidden');
                        }

                        //  CRITICAL: Add form submission handler for reply form
                        if (replyForm) {
                            replyForm.addEventListener('submit', async function (e) {
                                e.preventDefault();
                                console.log(' REPLY FORM SUBMISSION - Processing with attachments');

                                const responseText = document.getElementById('response').value.trim();
                                if (!responseText) {
                                    showNotification('Please enter a message before sending', 'error');
                                    return;
                                }

                                // Prepare form data with attachments
                                const formData = new FormData();
                                formData.append('response_text', responseText);

                                // Add attachments if any
                                if (window.currentAttachments && window.currentAttachments.length > 0) {
                                    console.log(' Processing attachments for submission:', window.currentAttachments.length);

                                    window.currentAttachments.forEach((attachment, index) => {
                                        if (attachment.file) {
                                            // For common documents and regular files, use the actual file
                                            formData.append(`attachment_${index}`, attachment.file);
                                            console.log(` Added attachment ${index}: ${attachment.name} (${attachment.size} bytes)`);
                                        } else if (attachment.type === 'common_document' && attachment.documentId) {
                                            // For common documents without file data, fetch it now
                                            console.log(` Common document ${index}: ${attachment.name} - will be processed by backend`);
                                        }
                                    });
                                }

                                try {
                                    // Disable send button during processing
                                    const sendBtn = document.getElementById('sendBtn');
                                    if (sendBtn) {
                                        sendBtn.disabled = true;
                                        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                                    }

                                    // Send to backend
                                    const response = await fetch(`/api/tickets/{{ ticket.ticket_id }}/reply`, {
                                        method: 'POST',
                                        body: formData
                                    });

                                    if (response.ok) {
                                        const result = await response.json();
                                        console.log(' REPLY SENT SUCCESSFULLY:', result);
                                        showNotification('Reply sent successfully! ', 'success');

                                        // Clear form and attachments
                                        document.getElementById('response').value = '';
                                        window.currentAttachments = [];
                                        renderAttachmentPreview();
                                        hideEnhancedAttachmentPreview();

                                        // Refresh page to show new reply
                                        setTimeout(() => {
                                            window.location.reload();
                                        }, 1000);

                                    } else {
                                        const errorData = await response.json();
                                        console.error(' REPLY FAILED:', errorData);
                                        showNotification(`Failed to send reply: ${errorData.message || 'Unknown error'}`, 'error');
                                    }

                                } catch (error) {
                                    console.error(' REPLY ERROR:', error);
                                    showNotification('Error sending reply. Please try again.', 'error');
                                } finally {
                                    // Re-enable send button
                                    const sendBtn = document.getElementById('sendBtn');
                                    if (sendBtn) {
                                        sendBtn.disabled = false;
                                        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                                    }
                                }
                            });

                            console.log(' REPLY FORM SUBMISSION HANDLER ADDED');
                        } else {
                            console.warn(' REPLY FORM NOT FOUND - Cannot add submission handler');
                        }

                        // Setup clear all button
                        const clearAllBtn = document.getElementById('clearAllAttachments');
                        if (clearAllBtn) {
                            clearAllBtn.addEventListener('click', function () {
                                console.log(' Clearing all attachments');
                                window.currentAttachments = [];
                                renderAttachmentPreview();
                                hideEnhancedAttachmentPreview();
                                showNotification('All attachments cleared', 'info');
                            });
                            console.log(' CLEAR ALL ATTACHMENTS BUTTON SETUP COMPLETE');
                        }

                        // Initialize enhanced drag & drop
                        setupEnhancedDragAndDrop();
                        console.log(' ENHANCED ATTACHMENT SYSTEM FULLY INITIALIZED');

                        // Make removeAttachment globally accessible
                        window.removeAttachment = removeAttachment;

                        // ENHANCED: Make common documents in sidebar draggable
                        function makeCommonDocumentsDraggable() {
                            const documentsContainer = document.getElementById('documentsContainer');
                            if (documentsContainer) {
                                // Add drag event listeners to all document items
                                documentsContainer.addEventListener('mousedown', function (e) {
                                    const documentItem = e.target.closest('[data-document-id]');
                                    if (documentItem) {
                                        documentItem.draggable = true;
                                        documentItem.addEventListener('dragstart', function (e) {
                                            const documentId = this.dataset.documentId;
                                            const documentName = this.querySelector('.document-name')?.textContent || 'Document';
                                            const documentSize = this.dataset.documentSize || 0;
                                            const documentType = this.dataset.documentType || 'application/octet-stream';

                                            const dragData = {
                                                type: 'common-document',
                                                index: documentId,
                                                name: documentName,
                                                size: parseInt(documentSize),
                                                fileType: documentType
                                            };

                                            e.dataTransfer.setData('text', JSON.stringify(dragData));
                                            e.dataTransfer.effectAllowed = 'copy';

                                            console.log(` Started dragging common document: ${documentName} (ID: ${documentId})`);
                                        });
                                    }
                                });
                            }
                        }

                        // Initialize draggable common documents
                        makeCommonDocumentsDraggable();

                        //  ENHANCED: Handle standard file input change using new system
                        fileInput.addEventListener('change', function (e) {
                            console.log(' File input change detected', this.files.length, 'files');

                            if (this.files.length === 0) return; // No files selected

                            // Process the new files using the enhanced attachment system
                            Array.from(this.files).forEach(file => {
                                if (isValidFile(file)) {
                                    const attachment = {
                                        id: generateAttachmentId(),
                                        type: 'file',
                                        file: file,
                                        name: file.name,
                                        size: file.size,
                                        fileType: file.type || getFileTypeFromName(file.name)
                                    };
                                    addAttachmentToPreview(attachment);
                                }
                            });

                            // Clear the input to allow selecting the same files again
                            this.value = '';
                        });

                        // Handle click on attachment button - SINGLE SOURCE OF TRUTH
                        const attachmentBtn = document.getElementById('attachmentBtn');
                        if (attachmentBtn) {
                            attachmentBtn.addEventListener('click', function (e) {
                                e.preventDefault(); // Prevent any default action
                                e.stopPropagation(); // Stop event from bubbling
                                console.log('Attachment button clicked');

                                // Trigger file input click
                                fileInput.click();
                            });
                        }

                        // Global flag to prevent duplicate document processing across drop zones

                        // Make the entire text area a drop zone
                        textarea.addEventListener('dragover', function (e) {
                            e.preventDefault();
                            textarea.classList.add('bg-gray-50');
                        });

                        textarea.addEventListener('dragleave', function (e) {
                            e.preventDefault();
                            textarea.classList.remove('bg-gray-50');
                        });

                        textarea.addEventListener('drop', function (e) {
                            e.preventDefault();
                            textarea.classList.remove('bg-gray-50');

                            if (e.dataTransfer.files.length > 0) {
                                console.log(' Files dropped in textarea - using enhanced system');
                                // Process files using enhanced attachment system
                                Array.from(e.dataTransfer.files).forEach(file => {
                                    if (isValidFile(file)) {
                                        const attachment = {
                                            id: generateAttachmentId(),
                                            type: 'file',
                                            file: file,
                                            name: file.name,
                                            size: file.size,
                                            fileType: file.type || getFileTypeFromName(file.name)
                                        };
                                        addAttachmentToPreview(attachment);
                                    }
                                });
                            } else if (e.dataTransfer.getData('text')) {
                                // This might be a document dragged from the Common Documents section
                                try {
                                    const docData = JSON.parse(e.dataTransfer.getData('text'));
                                    console.log('Received dragged data:', docData);

                                    if (docData && docData.type === 'common-document') {
                                        // Validate document data
                                        const documentId = docData._id || docData.id || docData.index;

                                        if (!documentId) {
                                            console.error(' Invalid document data - index is undefined:', docData);
                                            showNotification('Error: Invalid document data', 'error');
                                            return;
                                        }

                                        // Prevent duplicate processing using global flag and timestamp
                                        const currentTime = Date.now();
                                        const docKey = `${documentId}_${docData.name}`;

                                        console.log('Document drop detected:', {
                                            docKey,
                                            _id: documentId,
                                            name: docData.name,
                                            alreadyProcessed: processedDocuments.has(docKey),
                                            lastProcessed: lastProcessedDocument,
                                            timeSinceLast: currentTime - lastProcessedTime
                                        });

                                        if (!processedDocuments.has(docKey)) {
                                            processedDocuments.add(docKey);
                                            lastProcessedDocument = docKey;
                                            lastProcessedTime = currentTime;
                                            console.log(' Processing document drop in textarea:', docKey);
                                            //  FIXED: Call the proper handler to add document to chat
                                            handleCommonDocumentDrop(docData);
                                        } else {
                                            console.log(' Duplicate document drop prevented:', docKey);
                                            showNotification('Document already added to chat', 'info');
                                        }
                                    }
                                } catch (err) {
                                    console.error('Error parsing dragged data:', err);
                                }
                            }
                        });

                        // Handle drag and drop in the dedicated dropzone
                        if (dropzone) {
                            dropzone.addEventListener('dragover', function (e) {
                                e.preventDefault();
                                dropzone.classList.add('border-indigo-500', 'bg-indigo-50');
                            });

                            dropzone.addEventListener('dragleave', function (e) {
                                e.preventDefault();
                                dropzone.classList.remove('border-indigo-500', 'bg-indigo-50');
                            });

                            dropzone.addEventListener('drop', function (e) {
                                e.preventDefault();
                                dropzone.classList.remove('border-indigo-500', 'bg-indigo-50');

                                if (e.dataTransfer.files.length > 0) {
                                    console.log(' Files dropped in dropzone - using enhanced system');
                                    // Process files using enhanced attachment system
                                    Array.from(e.dataTransfer.files).forEach(file => {
                                        if (isValidFile(file)) {
                                            const attachment = {
                                                id: generateAttachmentId(),
                                                type: 'file',
                                                file: file,
                                                name: file.name,
                                                size: file.size,
                                                fileType: file.type || getFileTypeFromName(file.name)
                                            };
                                            addAttachmentToPreview(attachment);
                                        }
                                    });
                                } else if (e.dataTransfer.getData('text')) {
                                    try {
                                        const docData = JSON.parse(e.dataTransfer.getData('text'));
                                        console.log('Received dragged data in dropzone:', docData);

                                        if (docData && docData.type === 'common-document') {
                                            console.log(' Common document detected in second dropzone - forwarding to primary handler');
                                            // Forward common documents to the primary handler instead of processing here
                                            handleCommonDocumentDrop(docData);
                                            return; // Exit early to prevent duplicate processing
                                        }
                                    } catch (err) {
                                        console.error('Error parsing dragged data in dropzone:', err);
                                    }
                                }
                            });
                        }

                        // Note: makeDocumentsDraggable function removed - drag and drop is now handled directly in loadDocuments



                        //  REMOVED: Old helper functions - replaced by enhanced system

                        // Create preview for uploaded files
                        //  REMOVED: Old createAttachmentPreview function - replaced by enhanced system

                        //  REMOVED: Old updateAttachmentCounter and formatFileSize functions - replaced by enhanced system

                        // DUPLICATE EVENT LISTENER REMOVED - Form submission is now handled by the single unified event listener above
                        // This prevents triple submissions and ensures webhook is triggered only once

                        // Add handler for the "Show Attachments" button in dropdown
                        const showAttachmentsBtn = document.getElementById('showAttachmentsBtn');
                        if (showAttachmentsBtn) {
                            showAttachmentsBtn.addEventListener('click', function (e) {
                                e.preventDefault();
                                e.stopPropagation();
                                console.log('Show attachments button clicked');
                                // Just trigger the attachmentBtn click which will trigger file input
                                if (attachmentBtn) {
                                    attachmentBtn.click();
                                }
                                document.getElementById('quickResponseDropdown').style.display = 'none';
                            });
                        }
                    }



                    // Setup quick response dropdown
                    function setupQuickResponseDropdown() {
                        const quickResponseBtn = document.getElementById('quickResponseBtn');
                        const quickResponseDropdown = document.getElementById('quickResponseDropdown');
                        const responseTextarea = document.getElementById('response');
                        const attachmentBtn = document.getElementById('attachmentBtn');

                        if (!quickResponseBtn || !quickResponseDropdown || !responseTextarea) return;

                        // Initially hide the dropdown
                        quickResponseDropdown.style.display = 'none';

                        // Toggle dropdown visibility when clicking the button
                        quickResponseBtn.addEventListener('click', function (e) {
                            e.preventDefault();
                            e.stopPropagation();

                            if (quickResponseBtn.classList.contains('open')) {
                                quickResponseBtn.classList.remove('open');
                                quickResponseDropdown.style.display = 'none';
                            } else {
                                quickResponseBtn.classList.add('open');
                                quickResponseDropdown.style.display = 'block';
                            }
                        });

                        // Close dropdown when clicking outside
                        document.addEventListener('click', function (e) {
                            if (quickResponseBtn && !quickResponseBtn.contains(e.target) &&
                                quickResponseDropdown && quickResponseDropdown.style.display !== 'none') {
                                quickResponseBtn.classList.remove('open');
                                quickResponseDropdown.style.display = 'none';
                            }
                        });

                        // Add click handlers for quick response items
                        document.querySelectorAll('.quick-response-item').forEach(item => {
                            item.addEventListener('click', function (e) {
                                const text = this.textContent.trim();

                                // Insert different template responses based on the selected option
                                let responseTemplate = '';

                                if (text.includes('Issue Resolved')) {
                                    responseTemplate = "I'm pleased to inform you that we have resolved the issue with your claim. The necessary repairs have been authorized and you can proceed with scheduling service at your convenience.\n\nPlease let me know if you need any additional assistance.";
                                } else if (text.includes('Need More Information')) {
                                    responseTemplate = "Thank you for your claim submission. To proceed with your case, we need some additional information:\n\n1. Complete diagnostic report with fault codes\n2. Photos of the affected components\n3. Service history records\n\nPlease provide these at your earliest convenience so we can continue processing your claim.";
                                } else if (text.includes('In Progress Update')) {
                                    responseTemplate = "I wanted to provide you with an update on your claim. We are currently reviewing your case and have forwarded the documentation to our technical specialist.\n\nWe expect to have a decision within 2-3 business days. Thank you for your patience.";
                                } else if (text.includes('Schedule Follow-up')) {
                                    responseTemplate = "I've reviewed your claim and would like to schedule a follow-up call to discuss the next steps. Please let me know your availability in the next few days, and I'll arrange for our technical advisor to contact you directly.";
                                } else if (text.includes('Attach Files')) {
                                    // Trigger attachment button click - this will open the file dialog
                                    if (attachmentBtn) {
                                        attachmentBtn.click();
                                    }
                                    quickResponseDropdown.style.display = 'none';
                                    return;
                                } else if (text.includes('Save as Template')) {
                                    // Open the template modal with current response text
                                    document.getElementById('templateTitle').value = 'New Response Template';
                                    document.getElementById('templateContent').value = responseTextarea.value;
                                    document.getElementById('editTemplateTitle').textContent = 'Save as Template';
                                    document.getElementById('deleteTemplate').classList.add('hidden');
                                    document.getElementById('saveTemplate').removeAttribute('data-template-index');
                                    openModal('editTemplateModal');
                                    quickResponseDropdown.style.display = 'none';
                                    return;
                                }

                                // Insert the template text into the textarea
                                if (responseTemplate) {
                                    // If there's already content, add a line break first
                                    if (responseTextarea.value && !responseTextarea.value.endsWith('\n')) {
                                        responseTextarea.value += '\n\n';
                                    }

                                    responseTextarea.value += responseTemplate;
                                    responseTextarea.focus();

                                    // Move cursor to end of text
                                    responseTextarea.selectionStart = responseTextarea.selectionEnd = responseTextarea.value.length;

                                    // Trigger auto-expand after adding template content
                                    if (typeof window.autoExpandTextarea === 'function') {
                                        window.autoExpandTextarea(responseTextarea);
                                    }

                                    // Hide the dropdown
                                    quickResponseBtn.classList.remove('open');
                                    quickResponseDropdown.style.display = 'none';
                                }
                            });
                        });
                    }

                    // Function to view common documents from reply attachments
                    function viewCommonDocument(documentId) {
                        try {
                            // Download the common document
                            const downloadUrl = `/api/common-documents/${documentId}/download`;

                            // Open in new window/tab
                            const newWindow = window.open(downloadUrl, '_blank');
                            if (!newWindow) {
                                showNotification('Download failed - popup blocked?', 'error');
                            }

                        } catch (error) {
                            showNotification(`Error viewing document: ${error.message}`, 'error');
                        }
                    }

                    // Initialize everything when DOM is loaded
                    document.addEventListener('DOMContentLoaded', function () {
                        // Initialize global variables
                        processedDocuments.clear();
                        lastProcessedDocument = null;
                        lastProcessedTime = 0;

                        // Load existing documents
                        loadDocuments();

                        // Setup event handlers for attachments
                        setupAttachmentHandlers();

                        // Setup quick response dropdown
                        setupQuickResponseDropdown();



                        // Add a function to manually clear processed documents (for debugging)
                        window.clearProcessedDocuments = function () {
                            processedDocuments.clear();
                            lastProcessedDocument = null;
                            lastProcessedTime = 0;
                            console.log(' Manually cleared processed documents tracking');
                            showNotification('Processed documents tracking cleared', 'success');
                        };
                    });

                    // Note: Removed problematic setInterval that was causing duplicate event listeners
                    // Documents are now made draggable only when they are initially loaded

                    // Auto-refresh functionality for webhook replies
                    let lastReplyCount = parseInt('{{ replies|length|default(0) }}', 10);
                    let autoRefreshInterval;

                    function startAutoRefresh() {
                        // Check for new replies every 3 seconds
                        autoRefreshInterval = setInterval(checkForNewReplies, 3000);
                    }

                    function stopAutoRefresh() {
                        if (autoRefreshInterval) {
                            clearInterval(autoRefreshInterval);
                        }
                    }

                    function checkForNewReplies() {
                        fetch(`/api/tickets/{{ ticket.ticket_id }}/reply-count`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success' && data.reply_count > lastReplyCount) {
                                    console.log(` New replies detected! Refreshing page... (${lastReplyCount}  ${data.reply_count})`);
                                    lastReplyCount = data.reply_count;
                                    window.location.reload();
                                }
                            })
                            .catch(error => {
                                console.error('Error checking for new replies:', error);
                            });
                    }

                    // Stop auto-refresh when user is typing or interacting
                    let userActivityTimeout;
                    function resetUserActivity() {
                        clearTimeout(userActivityTimeout);
                        stopAutoRefresh();
                        userActivityTimeout = setTimeout(startAutoRefresh, 10000); // Resume after 10 seconds of inactivity
                    }

                    // Monitor user activity
                    document.addEventListener('keydown', resetUserActivity);
                    document.addEventListener('click', resetUserActivity);
                    document.addEventListener('scroll', resetUserActivity);

                    // Clear processed documents when page is unloaded
                    window.addEventListener('beforeunload', function () {
                        processedDocuments.clear();
                        lastProcessedDocument = null;
                        lastProcessedTime = 0;
                    });

                    document.addEventListener('DOMContentLoaded', function () {
                        console.log(' Ticket Detail page loaded');

                        // Start auto-refresh for new replies
                        startAutoRefresh();

                        // Auto-refresh every 15 seconds for new replies
                        setInterval(checkForNewReplies, 15000);
                        
                        // Check for AI response on page load
                        checkForAIResponse();

                        // AI Response checking function
                        function checkForAIResponse() {
                            console.log(' Checking for AI response...');
                            const ticketId = '{{ ticket.ticket_id }}';
                            
                            // Check URL parameters first
                            const urlParams = new URLSearchParams(window.location.search);
                            const aiResponse = urlParams.get('ai_response');
                            
                            if (aiResponse) {
                                console.log(' Found AI response in URL parameters');
                                populateTextareaWithAIResponse(decodeURIComponent(aiResponse));
                                return;
                            }
                            
                            // Check for AI response in database
                            fetch(`/api/ai/get-response/${ticketId}`)
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success && data.ai_response) {
                                        console.log(' Found AI response in database');
                                        populateTextareaWithAIResponse(data.ai_response);
                                    } else {
                                        console.log(' No AI response found');
                                    }
                                })
                                .catch(error => {
                                    console.log(' Error checking for AI response:', error);
                                });
                        }
                        
                        // Function to populate textarea with AI response
                        function populateTextareaWithAIResponse(aiResponse) {
                            console.log(' Populating textarea with AI response...');
                            const textarea = document.getElementById('response');
                            
                            if (textarea) {
                                console.log(' Found textarea, setting value...');
                                textarea.value = aiResponse;
                                console.log(' Textarea populated with:', aiResponse.substring(0, 100) + '...');
                                
                                // Trigger auto-expand
                                if (window.autoExpandTextarea) {
                                    window.autoExpandTextarea(textarea);
                                }
                                
                                // Trigger input event to save to localStorage
                                textarea.dispatchEvent(new Event('input', { bubbles: true }));
                                
                                // Show notification
                                showNotification('AI response loaded into textarea!', 'success');
                                
                                console.log(' AI response successfully loaded!');
                            } else {
                                console.error(' Textarea not found!');
                            }
                        }

                        // Auto-expand textarea functionality (WhatsApp-style) - GLOBAL SCOPE
                        window.autoExpandTextarea = function (textareaElement) {
                            if (!textareaElement) return;

                            // Temporarily disable transition for measurement
                            const originalTransition = textareaElement.style.transition;
                            textareaElement.style.transition = 'none';

                            // Reset height to auto to get accurate scrollHeight
                            textareaElement.style.height = 'auto';

                            // Get the scroll height (full content height)
                            const scrollHeight = textareaElement.scrollHeight;

                            // Re-enable transition for smooth height change
                            textareaElement.style.transition = originalTransition;

                            // Set the height based on content, respecting min/max limits
                            const minHeight = 60; // minimum height (about 3 lines)
                            const maxHeight = 300; // maximum height (about 15 lines)

                            if (scrollHeight <= maxHeight) {
                                textareaElement.style.height = Math.max(scrollHeight, minHeight) + 'px';
                                textareaElement.style.overflowY = 'hidden';
                            } else {
                                textareaElement.style.height = maxHeight + 'px';
                                textareaElement.style.overflowY = 'auto';
                            }
                        };

                        // Initialize auto-expand for response textarea
                        const responseTextarea = document.getElementById('response');
                        if (responseTextarea) {
                            console.log(' Found response textarea, initializing auto-expand');

                            // Apply auto-expand on input events (main trigger)
                            responseTextarea.addEventListener('input', function () {
                                window.autoExpandTextarea(this);
                            });

                            // Apply auto-expand on page load (for existing content)
                            if (responseTextarea.value && responseTextarea.value.trim()) {
                                setTimeout(() => window.autoExpandTextarea(responseTextarea), 100);
                            }

                            // Apply auto-expand on paste operations
                            responseTextarea.addEventListener('paste', function () {
                                setTimeout(() => window.autoExpandTextarea(this), 50);
                            });

                            // Apply auto-expand on any value changes
                            responseTextarea.addEventListener('change', function () {
                                window.autoExpandTextarea(this);
                            });

                            // Apply auto-expand on focus (in case content was added programmatically)
                            responseTextarea.addEventListener('focus', function () {
                                setTimeout(() => window.autoExpandTextarea(this), 10);
                            });

                            console.log(' Auto-expand textarea initialized successfully');
                        } else {
                            console.error(' Response textarea not found');
                        }

                        // Forward ticket functionality
                        const forwardModal = document.getElementById('forwardModal');
                        const forwardBtn = document.getElementById('forwardBtn');
                        const closeForwardModalBtn = document.getElementById('closeForwardModal');
                        const cancelForwardBtn = document.getElementById('cancelForward');
                        const confirmForwardBtn = document.getElementById('confirmForward');

                        if (forwardBtn) {
                            forwardBtn.addEventListener('click', () => {
                                console.log(' Forward button clicked');

                                // Reset form when opening
                                const memberSelectEl = document.getElementById('forwardMemberSelect');
                                const notesEl = document.getElementById('forwardNotes');
                                if (memberSelectEl) memberSelectEl.value = '';
                                if (notesEl) notesEl.value = '';

                                // Open modal using the helper function
                                openModal('forwardModal');
                            });
                        }

                        if (closeForwardModalBtn) {
                            closeForwardModalBtn.addEventListener('click', () => closeModal('forwardModal'));
                        }

                        if (cancelForwardBtn) {
                            cancelForwardBtn.addEventListener('click', () => closeModal('forwardModal'));
                        }

                        if (confirmForwardBtn) {
                            confirmForwardBtn.addEventListener('click', async () => {
                                console.log(' Forward confirmation clicked');

                                try {
                                    // Get form elements
                                    const memberSelectEl = document.getElementById('forwardMemberSelect');
                                    const notesEl = document.getElementById('forwardNotes');

                                    if (!memberSelectEl || !notesEl) {
                                        showNotification('Form elements not found - please refresh the page', 'error');
                                        return;
                                    }

                                    const memberId = memberSelectEl.value;
                                    const notes = notesEl.value;

                                    // Validation
                                    if (!memberId || memberId.trim() === '' || memberId === 'Select a member...') {
                                        showNotification('Please select a member to forward the ticket to', 'error');
                                        return;
                                    }

                                    // Validate session member_id for forwarding
                                    const sessionMemberId = "{{ session.member_id if session.member_id else '' }}";
                                    if (!sessionMemberId || sessionMemberId === 'None' || sessionMemberId === 'null' || sessionMemberId === '') {
                                        showNotification('Session expired. Please refresh the page and log in again.', 'error');
                                        return;
                                    }

                                    // Prepare API request
                                    const requestBody = {
                                        member_id: memberId.trim(),
                                        notes: notes.trim(),
                                        is_forwarded: true,
                                        forwarded_from: sessionMemberId
                                    };

                                    console.log(' Preparing forward request:', requestBody);

                                    // Disable button to prevent double-clicks
                                    confirmForwardBtn.disabled = true;
                                    confirmForwardBtn.innerHTML = ' Forwarding...';

                                    const response = await fetch(`/api/tickets/{{ ticket.ticket_id }}/assign`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify(requestBody)
                                    });

                                    const data = await response.json();

                                    if (response.ok && data.status === 'success') {
                                        console.log(' Forward SUCCESS!');

                                        // SUCCESS STATE: Show success button state
                                        confirmForwardBtn.disabled = false;
                                        confirmForwardBtn.innerHTML = ' Forwarded Successfully!';
                                        confirmForwardBtn.style.backgroundColor = '#dcfce7';
                                        confirmForwardBtn.style.color = '#166534';

                                        // Close modal and reset form
                                        closeModal('forwardModal');
                                        memberSelectEl.value = '';
                                        notesEl.value = '';

                                        // Show brief success notification
                                        showNotification('Ticket forwarded successfully! Page will refresh...', 'success');

                                        // Refresh the page to show updated assignment
                                        setTimeout(() => {
                                            window.location.reload();
                                        }, 1500);
                                    } else {
                                        console.error(' Forward FAILED:', data);

                                        let errorMessage = 'Failed to forward ticket';
                                        if (data.message) {
                                            errorMessage = data.message;
                                        }

                                        showNotification(errorMessage, 'error');

                                        // Reset button
                                        confirmForwardBtn.disabled = false;
                                        confirmForwardBtn.innerHTML = 'Forward Ticket';
                                    }
                                } catch (error) {
                                    console.error(' Forward Error:', error);

                                    // Reset button
                                    confirmForwardBtn.disabled = false;
                                    confirmForwardBtn.innerHTML = 'Forward Ticket';

                                    showNotification('An error occurred while forwarding ticket', 'error');
                                }
                            });
                        }
                    });

                    // Mobile menu toggle function
                    function toggleMobileMenu() {
                        const mobileMenu = document.getElementById('mobileMenu');
                        if (mobileMenu) {
                            mobileMenu.classList.toggle('hidden');
                        }
                    }

                    // Close mobile menu when clicking outside
                    document.addEventListener('click', function (event) {
                        const mobileMenu = document.getElementById('mobileMenu');
                        const menuButton = document.querySelector('.mobile-menu-btn');

                        if (mobileMenu && !mobileMenu.contains(event.target) && !menuButton.contains(event.target)) {
                            mobileMenu.classList.add('hidden');
                        }
                    });



                    function showWarrantyFormAnalysis(data, ticketId) {
                        const analysis = data.analysis;
                        const suggestions = data.suggestions;

                        let statusColor = analysis.is_warranty_form ? 'green' : 'red';
                        let statusText = analysis.is_warranty_form ? 'Warranty Form Detected' : 'Not a Warranty Form';

                        const modalContent = `
                <div class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50" id="warrantyAnalysisModal">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4">
                        <div class="px-6 py-4 border-b border-gray-200">
                            <h3 class="text-lg font-semibold text-gray-900 flex items-center">
                                <i class="fas fa-robot mr-2 text-blue-600"></i>
                                AI Warranty Form Analysis
                            </h3>
                        </div>
                        
                        <div class="p-6">
                            <div class="mb-4">
                                <div class="flex items-center mb-2">
                                    <span class="px-3 py-1 rounded-full text-sm font-medium bg-${statusColor}-100 text-${statusColor}-800">
                                        ${statusText}
                                    </span>
                                    <span class="ml-3 text-sm text-gray-600">Confidence: ${analysis.confidence}%</span>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-lg p-4 mb-4">
                                <h4 class="font-medium text-gray-700 mb-2">Analysis Details:</h4>
                                <ul class="text-sm text-gray-600 space-y-1">
                                    <li> Valid file type: ${analysis.analysis.valid_file_type ? 'Yes' : 'No'}</li>
                                    <li> Contains warranty keywords: ${analysis.analysis.has_warranty_keywords ? 'Yes' : 'No'}</li>
                                    ${analysis.analysis.detected_keywords && analysis.analysis.detected_keywords.length > 0
                                ? `<li> Detected keywords: ${analysis.analysis.detected_keywords.join(', ')}</li>`
                                : ''}
                                </ul>
                            </div>
                            
                            ${analysis.is_warranty_form ? `
                                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                                    <h4 class="font-medium text-green-800 mb-2">AI Recommendation:</h4>
                                    <p class="text-sm text-green-700">Update ticket status to "Warranty Form Received"</p>
                                </div>
                                
                                <div class="space-y-3">
                                    <p class="text-sm text-gray-700">Is this analysis correct?</p>
                                    <div class="flex space-x-3">
                                        <button onclick="confirmWarrantyForm('${ticketId}', true)" 
                                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                                            <i class="fas fa-check mr-2"></i>Yes, Correct
                                        </button>
                                        <button onclick="confirmWarrantyForm('${ticketId}', false)" 
                                                class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                                            <i class="fas fa-times mr-2"></i>No, Incorrect
                                        </button>
                                    </div>
                                </div>
                            ` : `
                                <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-4">
                                    <h4 class="font-medium text-orange-800 mb-2">Manual Review Required:</h4>
                                    <p class="text-sm text-orange-700">AI couldn't confidently identify this as a warranty form. Please review manually.</p>
                                </div>
                                
                                <div class="space-y-3">
                                    <p class="text-sm text-gray-700">Is this actually a warranty form?</p>
                                    <div class="flex space-x-3">
                                        <button onclick="confirmWarrantyForm('${ticketId}', true)" 
                                                class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                                            <i class="fas fa-check mr-2"></i>Yes, It's a Warranty Form
                                        </button>
                                        <button onclick="confirmWarrantyForm('${ticketId}', false)" 
                                                class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition">
                                            <i class="fas fa-times mr-2"></i>No, It's Not
                                        </button>
                                    </div>
                                </div>
                            `}
                        </div>
                        
                        <div class="px-6 py-4 border-t border-gray-200 flex justify-end">
                            <button onclick="closeWarrantyAnalysisModal()" 
                                    class="px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;

                        document.body.insertAdjacentHTML('beforeend', modalContent);
                    }

                    async function confirmWarrantyForm(ticketId, isCorrect) {
                        try {
                            const response = await fetch(`/api/tickets/${ticketId}/confirm-warranty-form`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({
                                    is_correct: isCorrect,
                                    feedback: isCorrect ? 'User confirmed AI detection' : 'User rejected AI detection'
                                })
                            });

                            const data = await response.json();

                            if (data.status === 'success') {
                                showNotification(data.message, 'success');
                                closeWarrantyAnalysisModal();

                                if (isCorrect && data.new_status) {
                                    // Optionally reload the page to show updated status
                                    // PERFORMANCE FIX: Reduced reload delay
                                    setTimeout(() => window.location.reload(), 3000);
                                }
                            } else {
                                showNotification(data.message || 'Confirmation failed', 'error');
                            }
                        } catch (error) {
                            console.error('Error confirming warranty form:', error);
                            showNotification('Confirmation failed', 'error');
                        }
                    }

                    function closeWarrantyAnalysisModal() {
                        const modal = document.getElementById('warrantyAnalysisModal');
                        if (modal) {
                            modal.remove();
                        }
                    }

                    // Email Template Functionality
                    document.addEventListener('DOMContentLoaded', function () {
                        const emailTemplateBtn = document.getElementById('emailTemplateBtn');
                        const emailTemplateModal = document.getElementById('emailTemplateModal');
                        const closeEmailTemplateModal = document.getElementById('closeEmailTemplateModal');
                        const cancelEmailTemplate = document.getElementById('cancelEmailTemplate');
                        const loadTemplate = document.getElementById('loadTemplate');
                        const editTemplate = document.getElementById('editTemplate');
                        const clearFields = document.getElementById('clearFields');
                        const sendEmail = document.getElementById('sendEmail');
                        const templateTypeSelect = document.getElementById('templateTypeSelect');
                        const emailSubject = document.getElementById('emailSubject');
                        const emailBody = document.getElementById('emailBody');
                        const availableAttachments = document.getElementById('availableAttachments');

                        let currentTemplateData = null;

                        // Open email template modal
                        emailTemplateBtn.addEventListener('click', function () {
                            openModal('emailTemplateModal');
                            resetEmailTemplateForm();

                            // Clear attachments initially - they will only be populated after clicking "Load Template"
                            availableAttachments.innerHTML = '<p class="text-sm text-gray-500">Click "Load Template" to see available attachments.</p>';

                            //  FIXED: Common documents should NEVER load in email template modal
                            // They are completely separate systems and should not interfere
                            console.log(' BLOCKED: Common documents prevented from loading in email template modal');

                            // Focus on subject field after modal opens
                            setTimeout(() => {
                                emailSubject.focus();
                            }, 100);
                        });

                        // Close modal handlers
                        closeEmailTemplateModal.addEventListener('click', () => {
                            closeModal('emailTemplateModal');
                        });
                        cancelEmailTemplate.addEventListener('click', () => {
                            closeModal('emailTemplateModal');
                        });

                        // Close modal on outside click
                        emailTemplateModal.addEventListener('click', (e) => {
                            if (e.target === emailTemplateModal) {
                                closeModal('emailTemplateModal');
                            }
                        });

                        // Load template button
                        loadTemplate.addEventListener('click', async function () {
                            const templateType = templateTypeSelect.value;
                            const ticketId = '{{ ticket.ticket_id }}';

                            if (!templateType) {
                                showNotification('Please select a template type', 'error');
                                return;
                            }

                            try {
                                // Show loading
                                loadTemplate.disabled = true;
                                loadTemplate.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';

                                const response = await fetch(`/api/email-template/${templateType}/${ticketId}`);
                                const data = await response.json();

                                if (response.ok && data.status === 'success') {
                                    currentTemplateData = data.template;

                                    //  CRITICAL DEBUGGING: Log exactly what we received from backend
                                    console.log(' CRITICAL DEBUG: Received template data from backend:', data);
                                    console.log(' CRITICAL DEBUG: Template attachments:', currentTemplateData.attachments);
                                    console.log(' CRITICAL DEBUG: Template data structure:', currentTemplateData);

                                    // Populate form fields
                                    emailSubject.value = currentTemplateData.subject;
                                    emailBody.value = currentTemplateData.body;

                                    // Make fields editable
                                    emailSubject.removeAttribute('readonly');
                                    emailBody.removeAttribute('readonly');

                                    // Update visual styling to show fields are editable
                                    emailSubject.classList.add('bg-white', 'cursor-text');
                                    emailBody.classList.add('bg-white', 'cursor-text');

                                    // Show edit template button
                                    editTemplate.style.display = 'inline-block';

                                    // Populate attachments
                                    populateAttachments(currentTemplateData.attachments);

                                    // Enable send button
                                    sendEmail.disabled = false;

                                    // Show different notification and indicator based on content source
                                    if (currentTemplateData.has_draft && currentTemplateData.content_source === 'draft') {
                                        showNotification(' Draft email content loaded successfully', 'success');

                                        // Add a visual indicator that this is draft content
                                        const draftIndicator = document.createElement('div');
                                        draftIndicator.id = 'draftIndicator';
                                        draftIndicator.className = 'bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4';
                                        draftIndicator.innerHTML = `
                                <div class="flex items-center">
                                    <i class="fas fa-edit text-blue-600 mr-2"></i>
                                    <span class="text-blue-800 font-medium">Draft Content Loaded</span>
                                    <span class="text-blue-600 text-sm ml-2">- This email contains pre-written draft content from the original ticket</span>
                                </div>
                            `;

                                        // Insert before email body
                                        const emailBodyContainer = emailBody.parentNode;
                                        const existingIndicator = document.getElementById('draftIndicator');
                                        if (existingIndicator) {
                                            existingIndicator.remove();
                                        }
                                        emailBodyContainer.insertBefore(draftIndicator, emailBody);
                                    } else {
                                        showNotification(' Template loaded successfully!', 'success');

                                        // Remove draft indicator if it exists
                                        const existingIndicator = document.getElementById('draftIndicator');
                                        if (existingIndicator) {
                                            existingIndicator.remove();
                                        }
                                    }
                                } else {
                                    showNotification(data.message || 'Failed to load template', 'error');
                                }
                            } catch (error) {
                                console.error('Error loading template:', error);
                                showNotification('Error loading template', 'error');
                            } finally {
                                // Reset button
                                loadTemplate.disabled = false;
                                loadTemplate.innerHTML = '<i class="fas fa-download mr-2"></i>Load Template';
                            }
                        });

                        // Regenerate attachments button
                        const regenerateAttachments = document.getElementById('regenerateAttachments');
                        if (regenerateAttachments) {
                            regenerateAttachments.addEventListener('click', async function () {
                                const ticketId = '{{ ticket.ticket_id }}';

                                try {
                                    // Show loading
                                    regenerateAttachments.disabled = true;
                                    regenerateAttachments.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Regenerating...';

                                    const response = await fetch(`/api/tickets/${ticketId}/regenerate-attachments`, {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json',
                                        }
                                    });

                                    const data = await response.json();

                                    if (response.ok) {
                                        if (data.status === 'success') {
                                            showNotification(' Attachments regenerated successfully! You can now click "Load Template" to see them.', 'success');
                                        } else if (data.status === 'warning') {
                                            showNotification(' ' + data.message, 'info');
                                        } else {
                                            showNotification(' ' + data.message, 'warning');
                                        }
                                    } else {
                                        showNotification(' ' + (data.message || 'Failed to regenerate attachments'), 'error');
                                    }

                                } catch (error) {
                                    console.error('Error regenerating attachments:', error);
                                    showNotification(' Error regenerating attachments', 'error');
                                } finally {
                                    // Reset button
                                    regenerateAttachments.disabled = false;
                                    regenerateAttachments.innerHTML = '<i class="fas fa-sync-alt mr-2"></i>Regenerate Attachments';
                                }
                            });
                        }

                        // Debug attachments button (for troubleshooting)
                        const debugAttachments = document.getElementById('debugAttachments');
                        if (debugAttachments) {
                            debugAttachments.addEventListener('click', async function () {
                                const ticketId = '{{ ticket.ticket_id }}';

                                try {
                                    // Show loading
                                    debugAttachments.disabled = true;
                                    debugAttachments.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Debugging...';

                                    const response = await fetch(`/api/debug/attachments/${ticketId}`);
                                    const data = await response.json();

                                    if (response.ok && data.status === 'success') {
                                        console.log(' DEBUG ATTACHMENTS DATA:', data.debug_info);

                                        // Show debug info in a notification
                                        const debugInfo = data.debug_info;
                                        const summary = `Ticket: ${debugInfo.ticket_id}
Main Attachments: ${debugInfo.main_attachments_count}
Metadata Attachments: ${debugInfo.metadata_attachments_count}
Common Documents: ${debugInfo.common_documents_count}
Source: ${debugInfo.ticket_source.processing_method}
Email Ticket: ${debugInfo.ticket_source.is_email_ticket}`;

                                        showNotification(` Debug Info: ${summary}`, 'info');

                                        // Log detailed info to console for developers
                                        console.log(' DETAILED DEBUG INFO:', debugInfo);
                                    } else {
                                        showNotification(data.message || 'Failed to debug attachments', 'error');
                                    }
                                } catch (error) {
                                    console.error('Error debugging attachments:', error);
                                    showNotification('Error debugging attachments', 'error');
                                } finally {
                                    // Reset button
                                    debugAttachments.disabled = false;
                                    debugAttachments.innerHTML = '<i class="fas fa-bug mr-2"></i>Debug Attachments';
                                }
                            });
                        }

                        // Edit template button
                        editTemplate.addEventListener('click', function () {
                            // Make fields editable if they aren't already
                            emailSubject.removeAttribute('readonly');
                            emailBody.removeAttribute('readonly');

                            // Update visual styling to show fields are editable
                            emailSubject.classList.add('bg-white', 'cursor-text');
                            emailBody.classList.add('bg-white', 'cursor-text');

                            // Focus on subject field
                            emailSubject.focus();

                            // Show notification
                            showNotification(' Template is now editable! You can modify the subject and body.', 'info');

                            // Hide edit button since we're already editing
                            editTemplate.style.display = 'none';
                        });

                        // Clear fields button
                        clearFields.addEventListener('click', function () {
                            // Clear the fields
                            emailSubject.value = '';
                            emailBody.value = '';

                            // Clear attachments and show message
                            availableAttachments.innerHTML = '<p class="text-sm text-gray-500">Click "Load Template" to see available attachments.</p>';

                            // Focus on subject field
                            emailSubject.focus();

                            // Show notification
                            showNotification(' Fields cleared! You can now enter new content.', 'info');

                            // Hide edit button if it was showing
                            editTemplate.style.display = 'none';

                            // Reset template data
                            currentTemplateData = null;
                        });

                        // Make fields interactive when user starts typing
                        emailSubject.addEventListener('input', function () {
                            // Ensure field is editable
                            this.removeAttribute('readonly');
                            this.classList.add('bg-white', 'cursor-text');

                            // Add visual feedback for active editing

                            // Auto-scroll to keep the field in view
                            this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        });

                        // Enhanced scrolling for email body
                        emailBody.addEventListener('input', function () {
                            // Ensure field is editable
                            this.removeAttribute('readonly');
                            this.classList.add('bg-white', 'cursor-text');

                            // Auto-scroll to keep the field in view when typing
                            this.scrollIntoView({ behavior: 'smooth', block: 'center' });

                            // Auto-resize textarea
                            this.style.height = 'auto';
                            this.style.height = Math.min(this.scrollHeight, 300) + 'px';
                        });

                        // Enhanced focus management for better UX
                        emailSubject.addEventListener('focus', function () {
                            this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            this.parentElement.classList.add('ring-2', 'ring-green-200');
                        });

                        emailSubject.addEventListener('blur', function () {
                            this.parentElement.classList.remove('ring-2', 'ring-green-200');
                        });

                        emailBody.addEventListener('focus', function () {
                            this.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            this.parentElement.classList.add('ring-2', 'ring-green-200');
                        });

                        emailBody.addEventListener('blur', function () {
                            this.parentElement.classList.remove('ring-2', 'ring-green-200');
                        });

                        // Enhanced template type selection
                        templateTypeSelect.addEventListener('change', function () {
                            // Clear form when template type changes
                            emailSubject.value = '';
                            emailBody.value = '';
                            availableAttachments.innerHTML = '<p class="text-sm text-gray-500">Select a template type and click "Load Template" to see available attachments.</p>';

                            // Show notification
                            showNotification(' Template type changed. Please load the new template.', 'info');

                            // Hide edit button
                            editTemplate.style.display = 'none';

                            // Reset template data
                            currentTemplateData = null;
                        });

                        // Keyboard shortcuts for better accessibility
                        document.addEventListener('keydown', function (e) {
                            // Only apply when email template modal is open
                            if (emailTemplateModal.classList.contains('active')) {
                                // Ctrl/Cmd + Enter to send email
                                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                                    e.preventDefault();
                                    sendEmail.click();
                                }

                                // Escape to close modal
                                if (e.key === 'Escape') {
                                    e.preventDefault();
                                    closeModal('emailTemplateModal');
                                }

                                // Tab navigation enhancement
                                if (e.key === 'Tab') {
                                    // Ensure smooth scrolling when tabbing through fields
                                    setTimeout(() => {
                                        const activeElement = document.activeElement;
                                        if (activeElement && activeElement.closest('.email-template-content')) {
                                            activeElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                                        }
                                    }, 50);
                                }
                            }
                        });

                        // Send email button - ANTI-SPAM PROTECTION ADDED
                        sendEmail.addEventListener('click', async function () {
                            // Allow sending with custom content even without loading template
                            // if (!currentTemplateData) {
                            //     showNotification('Please load a template first', 'error');
                            //     return;
                            // }

                            // PREVENT MULTIPLE SUBMISSIONS
                            if (sendEmail.disabled) {
                                console.log(' EMAIL TEMPLATE BLOCKED - Already sending');
                                return;
                            }

                            // Validate required fields
                            if (!emailSubject.value.trim()) {
                                showNotification('Please enter an email subject', 'error');
                                emailSubject.focus();
                                return;
                            }

                            if (!emailBody.value.trim()) {
                                showNotification('Please enter an email body', 'error');
                                emailBody.focus();
                                return;
                            }

                            //  FIXED: Get selected attachments with proper file data handling
                            const selectedAttachments = [];
                            const checkboxes = availableAttachments.querySelectorAll('input[type="checkbox"]:checked');
                            checkboxes.forEach(checkbox => {
                                const isCommonDocument = checkbox.dataset.isCommonDocument === 'true';
                                const documentId = checkbox.dataset.documentId;
                                const hasFileData = checkbox.dataset.hasData === 'true';
                                const fileData = checkbox.dataset.fileData || '';

                                // Determine the correct file path based on attachment type
                                let correctFilePath = checkbox.dataset.filePath || checkbox.dataset.key || '';
                                if (isCommonDocument && documentId) {
                                    correctFilePath = `/api/common-documents/${documentId}/download`;
                                }

                                //  CRITICAL FIX: Validate file data before sending
                                if (!hasFileData || !fileData || fileData.length < 10) {
                                    console.warn(` ATTACHMENT HAS NO VALID FILE DATA: ${checkbox.dataset.name}`);
                                    console.warn(` File data length: ${fileData ? fileData.length : 0}`);
                                    console.warn(` Has data flag: ${hasFileData}`);
                                }

                                const attachmentData = {
                                    name: checkbox.dataset.name,
                                    file_path: correctFilePath,
                                    key: checkbox.dataset.key || '',
                                    ticket_index: checkbox.dataset.ticketIndex ? parseInt(checkbox.dataset.ticketIndex) : null,
                                    fileData: fileData,  //  FIXED: Include the actual file data
                                    size: parseInt(checkbox.dataset.size) || 0,
                                    type: checkbox.dataset.type || 'file',
                                    is_common_document: isCommonDocument,
                                    document_id: documentId || null,
                                    has_data: hasFileData  //  ADDED: Flag to indicate if file has real data
                                };

                                console.log(' SELECTED EMAIL TEMPLATE ATTACHMENT:', {
                                    name: attachmentData.name,
                                    hasFileData: hasFileData,
                                    fileDataLength: fileData ? fileData.length : 0,
                                    size: attachmentData.size,
                                    type: attachmentData.type
                                });
                                selectedAttachments.push(attachmentData);
                            });

                            // Disable button during processing
                            sendEmail.disabled = true;
                            sendEmail.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Sending...';

                            console.log(' EMAIL TEMPLATE SUBMISSION - Starting');

                            try {
                                // Prepare email data
                                const emailData = {
                                    ticket_id: '{{ ticket.ticket_id }}',
                                    template_type: 'warranty',
                                    custom_subject: emailSubject.value,
                                    custom_body: emailBody.value,
                                    attachments: selectedAttachments
                                };

                                console.log(' EMAIL DATA:', emailData);

                                // Send to API endpoint (if implemented)
                                const response = await fetch('/api/email/send-template', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                    },
                                    body: JSON.stringify(emailData)
                                });

                                if (response.ok) {
                                    const result = await response.json();
                                    console.log(' EMAIL TEMPLATE SUCCESS:', result);
                                    showNotification('Email sent successfully! ', 'success');

                                    // Close modal first
                                    closeModal('emailTemplateModal');

                                    // Refresh the page to show the new email in conversation section
                                    setTimeout(() => {
                                        window.location.reload();
                                    }, 1000);

                                } else {
                                    // Fallback to placeholder behavior if API not implemented
                                    console.log(' EMAIL TEMPLATE PLACEHOLDER - API not yet implemented');
                                    showNotification('Email template prepared! (Integration with email service required for actual sending)', 'success');
                                    closeModal('emailTemplateModal');
                                }

                            } catch (error) {
                                console.error(' EMAIL TEMPLATE ERROR:', error);
                                // Fallback to placeholder behavior
                                showNotification('Email template prepared! (Integration with email service required for actual sending)', 'success');
                                closeModal('emailTemplateModal');
                            } finally {
                                // Reset button after delay to prevent spam
                                setTimeout(() => {
                                    sendEmail.disabled = false;
                                    sendEmail.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Send Email';
                                    console.log(' EMAIL TEMPLATE RESET - Ready for next send');
                                }, 2000);
                            }
                        });

                        // Priority selection functionality
                        const prioritySelect = document.getElementById('prioritySelect');
                        if (prioritySelect) {
                            // Store initial value for reverting on error
                            prioritySelect.dataset.previousPriority = prioritySelect.value;

                            prioritySelect.addEventListener('change', async function () {
                                const newPriority = this.value;
                                const ticketId = this.dataset.ticketId;

                                try {
                                    const response = await fetch(`/api/tickets/${ticketId}/priority`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ priority: newPriority })
                                    });

                                    const data = await response.json();
                                    if (response.ok && data.status === 'success') {
                                        showNotification(`Priority updated to ${newPriority}`, 'success');

                                        // Update the priority badge display in real-time
                                        const priorityBadge = document.querySelector('.ticket-header .px-3.py-1.text-xs.rounded-lg.font-medium');
                                        if (priorityBadge) {
                                            // Update text content
                                            priorityBadge.textContent = '';

                                            // Update icon and text based on new priority
                                            let iconClass, bgClass, textClass;
                                            if (newPriority === 'Urgent') {
                                                iconClass = 'fas fa-exclamation-triangle';
                                                bgClass = 'bg-red-100';
                                                textClass = 'text-red-800';
                                            } else if (newPriority === 'High') {
                                                iconClass = 'fas fa-exclamation';
                                                bgClass = 'bg-orange-100';
                                                textClass = 'text-orange-800';
                                            } else if (newPriority === 'Medium') {
                                                iconClass = 'fas fa-circle';
                                                bgClass = 'bg-yellow-100';
                                                textClass = 'text-yellow-800';
                                            } else if (newPriority === 'Low') {
                                                iconClass = 'fas fa-check';
                                                bgClass = 'bg-green-100';
                                                textClass = 'text-green-800';
                                            }

                                            // Update badge content and styling
                                            priorityBadge.innerHTML = `<i class="${iconClass} mr-1"></i>${newPriority}`;
                                            priorityBadge.className = `px-3 py-1 text-xs rounded-lg font-medium ${bgClass} ${textClass}`;
                                        }

                                        // Update the select styling based on new priority
                                        this.className = this.className.replace(/bg-\w+-100 text-\w+-800/g, '');
                                        this.classList.add('px-3', 'py-1', 'text-xs', 'rounded-full', 'font-medium', 'border-none', 'bg-transparent', 'appearance-none', 'cursor-pointer', 'hover:opacity-80', 'transition');
                                        if (newPriority === 'Urgent') {
                                            this.classList.add('bg-red-100', 'text-red-800');
                                        } else if (newPriority === 'High') {
                                            this.classList.add('bg-orange-100', 'text-orange-800');
                                        } else if (newPriority === 'Medium') {
                                            this.classList.add('bg-yellow-100', 'text-yellow-800');
                                        } else if (newPriority === 'Low') {
                                            this.classList.add('bg-green-100', 'text-green-800');
                                        }

                                        // Store new value as previous for future error handling
                                        this.dataset.previousPriority = newPriority;

                                    } else {
                                        showNotification(data.message || 'Error updating priority', 'error');
                                        // Revert to previous value without page reload
                                        this.value = this.dataset.previousPriority || 'Medium';
                                    }
                                } catch (error) {
                                    console.error('Error updating priority:', error);
                                    showNotification('An error occurred while updating priority', 'error');
                                    // Revert to previous value without page reload
                                    this.value = this.dataset.previousPriority || 'Medium';
                                }
                            });
                        }

                        // Technician assignment functionality
                        const technicianSelect = document.getElementById('technicianSelect');
                        if (technicianSelect) {
                            // Store initial value for reverting on error
                            technicianSelect.dataset.previousTechnician = technicianSelect.value;

                            console.log(' Technician select element found:', technicianSelect);
                            console.log(' Available technicians:', Array.from(technicianSelect.options).map(opt => ({ value: opt.value, text: opt.text })));

                            technicianSelect.addEventListener('change', async function () {
                                const newTechnicianId = this.value;
                                const ticketId = this.dataset.ticketId;

                                console.log(` Assigning technician ${newTechnicianId} to ticket ${ticketId}`);

                                try {
                                    const response = await fetch(`/api/tickets/${ticketId}/technician`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ technician_id: newTechnicianId })
                                    });

                                    console.log(` Response status: ${response.status}`);
                                    const data = await response.json();
                                    console.log(` Response data:`, data);

                                    if (response.ok && data.status === 'success') {
                                        if (newTechnicianId) {
                                            const selectedOption = this.options[this.selectedIndex];
                                            const technicianName = selectedOption.text.replace(' ', '').split(' (')[0];
                                            console.log(` Technician name extracted: ${technicianName}`);
                                            showNotification(`Technician assigned: ${technicianName}`, 'success');

                                            // Update the select styling
                                            this.className = this.className.replace(/bg-\w+-100 text-\w+-800/g, '');
                                            this.classList.add('px-3', 'py-1', 'text-xs', 'rounded-full', 'font-medium', 'border-none', 'bg-transparent', 'appearance-none', 'cursor-pointer', 'hover:opacity-80', 'transition', 'bg-indigo-100', 'text-indigo-800');

                                            // Update technician display in real-time
                                            const technicianDisplay = document.querySelector('.detail-card .text-gray-800.font-semibold');
                                            if (technicianDisplay && technicianDisplay.textContent.includes('{{ technician or "No Technician" }}')) {
                                                technicianDisplay.textContent = technicianName;
                                            }

                                            // Update technician info section if it exists
                                            const technicianInfoSection = document.querySelector('.detail-card .text-gray-600.text-xs');
                                            if (technicianInfoSection) {
                                                const selectedOption = this.options[this.selectedIndex];
                                                const technicianRole = selectedOption.text.match(/\((.*?)\)/)?.[1] || 'Technician';
                                                technicianInfoSection.innerHTML = `<i class="fas fa-id-badge mr-1"></i> ${technicianName} <span class="ml-2 px-2 py-1 bg-indigo-100 text-indigo-800 text-xs rounded-full">${technicianRole}</span>`;
                                            }

                                            // Send immediate update to home page
                                            console.log(` Sending technician update to home page: ${ticketId} -> ${technicianName}`);
                                            sendTechnicianUpdateToHomePage(ticketId, technicianName);

                                            showNotification(`Technician ${technicianName} assigned successfully!`, 'success');

                                            // Store new value as previous for future error handling
                                            this.dataset.previousTechnician = newTechnicianId;
                                        } else {
                                            showNotification('Technician assignment removed', 'success');

                                            // Update the select styling to default
                                            this.className = this.className.replace(/bg-\w+-100 text-\w+-800/g, '');
                                            this.classList.add('px-3', 'py-1', 'text-xs', 'rounded-full', 'font-medium', 'border-none', 'bg-transparent', 'appearance-none', 'cursor-pointer', 'hover:opacity-80', 'transition', 'bg-gray-100', 'text-gray-800');

                                            // Update technician display in real-time when removed
                                            const technicianDisplay = document.querySelector('.detail-card .text-gray-800.font-semibold');
                                            if (technicianDisplay) {
                                                technicianDisplay.textContent = 'No Technician Assigned';
                                            }

                                            // Update technician info section if it exists
                                            const technicianInfoSection = document.querySelector('.detail-card .text-gray-600.text-xs');
                                            if (technicianInfoSection) {
                                                technicianInfoSection.innerHTML = '<i class="fas fa-user-slash mr-1"></i> No technician assigned';
                                            }

                                            // Send immediate update to home page
                                            console.log(` Sending technician removal to home page: ${ticketId} -> null`);
                                            sendTechnicianUpdateToHomePage(ticketId, null);

                                            showNotification('Technician assignment removed!', 'success');

                                            // Store new value as previous for future error handling
                                            this.dataset.previousTechnician = '';
                                        }
                                    } else {
                                        showNotification(data.message || 'Error updating technician assignment', 'error');
                                        // Revert to previous value without page reload
                                        this.value = this.dataset.previousTechnician || '';
                                    }
                                } catch (error) {
                                    console.error('Error updating technician assignment:', error);
                                    showNotification('An error occurred while updating technician assignment', 'error');
                                    // Revert to previous value without page reload
                                    this.value = this.dataset.previousTechnician || '';
                                }
                            });
                        } else {
                            console.error(' Technician select element not found!');
                        }

                        // Outcome editing functionality
                        const editOutcomeBtn = document.getElementById('editOutcomeBtn');
                        const outcomeDisplayView = document.getElementById('outcomeDisplayView');
                        const outcomeEditView = document.getElementById('outcomeEditView');
                        const outcomeForm = document.getElementById('outcomeForm');
                        const cancelOutcomeBtn = document.getElementById('cancelOutcomeBtn');

                        if (editOutcomeBtn) {
                            editOutcomeBtn.addEventListener('click', function () {
                                outcomeDisplayView.classList.add('hidden');
                                outcomeEditView.classList.remove('hidden');
                            });
                        }

                        if (cancelOutcomeBtn) {
                            cancelOutcomeBtn.addEventListener('click', function () {
                                outcomeEditView.classList.add('hidden');
                                outcomeDisplayView.classList.remove('hidden');
                            });
                        }

                        if (outcomeForm) {
                            outcomeForm.addEventListener('submit', async function (e) {
                                e.preventDefault();

                                const outcomeCategory = document.getElementById('outcomeCategory').value;
                                const revisitCarriedOut = document.getElementById('revisitCarriedOut').checked;
                                const cleanUnderWarranty = document.getElementById('cleanUnderWarranty').checked;
                                const outcomeNotes = document.getElementById('outcomeNotes').value;

                                const saveBtn = document.getElementById('saveOutcomeBtn');
                                saveBtn.disabled = true;
                                saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';

                                try {
                                    const ticketId = '{{ ticket.ticket_id }}';
                                    const response = await fetch(`/api/tickets/${ticketId}/outcome`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({
                                            outcome_category: outcomeCategory,
                                            revisit_carried_out: revisitCarriedOut,
                                            clean_under_warranty: cleanUnderWarranty,
                                            outcome_notes: outcomeNotes
                                        })
                                    });

                                    const data = await response.json();
                                    if (response.ok && data.status === 'success') {
                                        showNotification('Outcome information updated successfully', 'success');
                                        // PERFORMANCE FIX: Reduced reload delay
                                        setTimeout(() => window.location.reload(), 3000);
                                    } else {
                                        showNotification(data.message || 'Error updating outcome', 'error');
                                    }
                                } catch (error) {
                                    console.error('Error updating outcome:', error);
                                    showNotification('An error occurred while updating outcome', 'error');
                                } finally {
                                    saveBtn.disabled = false;
                                    saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Outcome';
                                }
                            });
                        }

                        function resetEmailTemplateForm() {
                            emailSubject.value = '';
                            emailBody.value = '';
                            availableAttachments.innerHTML = '<p class="text-sm text-gray-500">Click "Load Template" to see available attachments.</p>';
                            sendEmail.disabled = false;  // Keep button enabled for direct sending
                            currentTemplateData = null;

                            // Ensure fields are editable by default
                            emailSubject.removeAttribute('readonly');
                            emailBody.removeAttribute('readonly');
                            emailSubject.classList.add('bg-white', 'cursor-text');
                            emailBody.classList.add('bg-white', 'cursor-text');

                            // Hide edit template button initially
                            editTemplate.style.display = 'none';

                            // Clean up draft indicator when form is reset
                            const draftIndicator = document.getElementById('draftIndicator');
                            if (draftIndicator) {
                                draftIndicator.remove();
                            }
                        }

                        //  REMOVED: Function to restore common documents - not needed anymore
                        // Common documents are completely separate from email template functionality

                        function populateAttachments(attachments) {
                            if (!attachments || attachments.length === 0) {
                                availableAttachments.innerHTML = '<p class="text-sm text-gray-500">No attachments available for this ticket.</p>';
                                return;
                            }

                            // ============================================================================
                            // ENHANCED CLIENT-SIDE ATTACHMENT VALIDATION WITH DUPLICATE REMOVAL
                            // ============================================================================

                            console.log(' REBUILDING ENHANCED CLIENT ATTACHMENT VALIDATION');
                            console.log(' Raw attachments received:', attachments);

                            //  ENHANCED DEBUGGING: Log detailed attachment structure
                            attachments.forEach((att, index) => {
                                console.log(` ATTACHMENT ${index + 1} DETAILS:`);
                                console.log(`  - Name: ${att.name || att.filename || 'NO_NAME'}`);
                                console.log(`  - Has fileData: ${!!att.fileData}`);
                                console.log(`  - fileData length: ${att.fileData ? att.fileData.length : 0}`);
                                console.log(`  - Has data: ${!!att.data}`);
                                console.log(`  - data length: ${att.data ? att.data.length : 0}`);
                                console.log(`  - Size: ${att.size || 'NO_SIZE'}`);
                                console.log(`  - Type: ${att.type || 'NO_TYPE'}`);
                                console.log(`  - All keys: ${Object.keys(att)}`);
                            });

                            // CLIENT-SIDE DUPLICATE REMOVAL: Remove duplicates before validation
                            const uniqueAttachments = [];
                            const seenNames = new Set();
                            const seenPaths = new Set();
                            const seenContent = new Set();

                            console.log(' CLIENT-SIDE DUPLICATE REMOVAL: Processing attachments for uniqueness');

                            for (const attachment of attachments) {
                                const name = attachment.name || attachment.filename || attachment.fileName || attachment.original_name || '';
                                const path = attachment.file_path || attachment.path || attachment.url || '';
                                const fileData = attachment.fileData || attachment.data || '';
                                const contentHash = `${fileData.length}_${attachment.size || 0}`;

                                // Check for duplicates
                                let isDuplicate = false;

                                if (name && seenNames.has(name)) {
                                    console.log(` CLIENT DUPLICATE DETECTED: ${name} - duplicate name`);
                                    isDuplicate = true;
                                } else if (path && seenPaths.has(path)) {
                                    console.log(` CLIENT DUPLICATE DETECTED: ${name} - duplicate path: ${path}`);
                                    isDuplicate = true;
                                } else if (fileData && seenContent.has(contentHash)) {
                                    console.log(` CLIENT DUPLICATE DETECTED: ${name} - duplicate content`);
                                    isDuplicate = true;
                                }

                                if (!isDuplicate) {
                                    uniqueAttachments.push(attachment);
                                    if (name) seenNames.add(name);
                                    if (path) seenPaths.add(path);
                                    if (fileData) seenContent.add(contentHash);
                                    console.log(` CLIENT UNIQUE ATTACHMENT: ${name}`);
                                } else {
                                    console.log(` CLIENT DUPLICATE REMOVED: ${name}`);
                                }
                            }

                            console.log(` CLIENT DUPLICATE REMOVAL: ${uniqueAttachments.length}/${attachments.length} attachments kept`);

                            // Show user notification if duplicates were removed
                            if (uniqueAttachments.length < attachments.length) {
                                const removedCount = attachments.length - uniqueAttachments.length;
                                showNotification(` Removed ${removedCount} duplicate attachment(s) to prevent confusion`, 'info');
                            }

                            function validateClientAttachment(attachment, index) {
                                // Extract name from any possible field
                                const name = attachment.name || attachment.filename || attachment.fileName || attachment.original_name || '';
                                const filePath = attachment.file_path || attachment.path || attachment.url || '';
                                const hasData = attachment.has_data || attachment.data || false;

                                console.log(` Validating attachment ${index}:`, {
                                    name: name,
                                    filePath: filePath,
                                    hasData: hasData,
                                    source: attachment.source || 'unknown'
                                });

                                // RULE 1: Must have a real name (not generic)
                                if (!name || name.trim() === '') {
                                    console.log(` REJECTED: No name`);
                                    return false;
                                }

                                const nameLower = name.toLowerCase().trim();
                                const fakeNames = ['unknown', 'unknown file', 'unknown_file', 'no name', 'untitled', 'file'];
                                if (fakeNames.includes(nameLower)) {
                                    console.log(` REJECTED: Fake name '${name}'`);
                                    return false;
                                }

                                // RULE 2: Must have either real data OR valid file path
                                const hasRealData = hasData === true || (attachment.data && attachment.data.length > 10);
                                const hasValidPath = filePath && filePath.trim().length > 3;

                                if (!hasRealData && !hasValidPath) {
                                    console.log(` REJECTED: No data and no valid path for '${name}'`);
                                    return false;
                                }

                                // RULE 3: If there's a file path, it must not be a status indicator
                                if (hasValidPath) {
                                    const pathLower = filePath.toLowerCase().trim();
                                    const statusWords = [
                                        'detected', 'true', 'false', 'none', 'null', 'undefined', 'empty',
                                        'yes', 'no', 'found', 'present', 'exists', 'valid', 'invalid'
                                    ];
                                    if (statusWords.includes(pathLower)) {
                                        console.log(` REJECTED: Status indicator path '${filePath}' for '${name}'`);
                                        return false;
                                    }
                                }

                                // RULE 4: Warranty forms must have real file paths or data
                                if (nameLower.includes('warranty') && nameLower.includes('form')) {
                                    if (!hasRealData && !hasValidPath) {
                                        console.log(` REJECTED: Fake warranty form without data '${name}'`);
                                        return false;
                                    }
                                }

                                console.log(` VALIDATED: '${name}' passed all checks`);
                                return true;
                            }

                            // Apply bulletproof validation to unique attachments
                            const validAttachments = uniqueAttachments.filter(validateClientAttachment);

                            console.log(` ENHANCED VALIDATION SUMMARY: ${validAttachments.length}/${uniqueAttachments.length} unique attachments passed validation`);

                            if (validAttachments.length === 0) {
                                availableAttachments.innerHTML = '<p class="text-sm text-gray-500">No attachments available for this ticket.</p>';
                                return;
                            }

                            const attachmentHTML = validAttachments.map(function (attachment) {
                                // Handle different attachment data structures with safe fallbacks
                                const attachmentName = attachment.name || attachment.filename || attachment.fileName || 'File';
                                const attachmentPath = attachment.file_path || attachment.path || '';
                                const attachmentKey = attachment.key || attachment.id || '';
                                const ticketIndex = attachment.ticket_index !== undefined ? attachment.ticket_index : '';
                                const hasData = attachment.has_data || false;

                                console.log(' POPULATING ATTACHMENT:', {
                                    name: attachmentName,
                                    file_path: attachmentPath,
                                    key: attachmentKey,
                                    ticket_index: ticketIndex,
                                    has_data: hasData,
                                    original: attachment
                                });

                                // Add visual indicator for attachments with data
                                const dataIndicator = hasData ? ' ' : ' ';

                                // Add manual ticket attachment indicator
                                const manualIndicator = attachment.is_manual_ticket_attachment ? ' ' : '';

                                // Add size indicator
                                const sizeIndicator = attachment.size ? ` (${(attachment.size / 1024).toFixed(1)} KB)` : '';

                                // Determine the correct file path based on attachment type
                                let correctFilePath = attachmentPath;
                                if (attachment.type === 'common-document' && attachment.document_id) {
                                    // For common documents, use the common document download endpoint
                                    correctFilePath = `/api/common-documents/${attachment.document_id}/download`;
                                }

                                // Add tooltip with attachment details
                                const tooltipText = `Type: ${attachment.type || 'file'}\nSize: ${attachment.size || 0} bytes\nHas Data: ${hasData ? 'Yes' : 'No'}\nManual Ticket: ${attachment.is_manual_ticket_attachment ? 'Yes' : 'No'}`;

                                //  FIXED: Properly handle file data for email template attachments
                                const fileData = attachment.fileData || attachment.data || '';
                                const hasFileData = fileData && fileData.length > 10; // Valid base64 data

                                return '<div class="flex items-center space-x-2 p-2 bg-gray-50 rounded hover:bg-gray-100 transition" title="' + tooltipText + '">' +
                                    '<input type="checkbox" id="attachment_' + attachmentName + '" ' +
                                    'data-name="' + attachmentName + '" ' +
                                    'data-file-path="' + correctFilePath + '" ' +
                                    'data-key="' + attachmentKey + '" ' +
                                    'data-ticket-index="' + (attachment.ticket_index || '') + '" ' +
                                    'data-file-data="' + fileData + '" ' +
                                    'data-size="' + (attachment.size || 0) + '" ' +
                                    'data-type="' + (attachment.type || 'file') + '" ' +
                                    'data-document-id="' + (attachment.document_id || '') + '" ' +
                                    'data-is-common-document="' + (attachment.is_common_document || false) + '" ' +
                                    'data-has-data="' + hasFileData + '" ' +
                                    'class="form-checkbox text-green-600" checked>' +
                                    '<label for="attachment_' + attachmentName + '" class="text-sm text-gray-700 flex-1 cursor-help">' +
                                    '<i class="fas fa-paperclip mr-1"></i>' + attachmentName + dataIndicator + manualIndicator + sizeIndicator +
                                    '</label></div>';
                            }).join('');

                            availableAttachments.innerHTML = attachmentHTML;
                        }
                    });

                    // Email attachment functions
                    function downloadEmailAttachment(ticketId, attachmentIndex, fileName) {
                        const url = `/api/tickets/${ticketId}/attachments/${attachmentIndex}/download`;

                        // Create a temporary link to trigger download
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = fileName;
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);

                        showNotification(`Downloading ${fileName}...`, 'success');
                    }

                    function previewEmailAttachment(ticketId, attachmentIndex, fileName) {
                        const url = `/api/tickets/${ticketId}/attachments/${attachmentIndex}/preview`;

                        // Open preview in new window
                        const previewWindow = window.open(url, '_blank', 'width=800,height=600,scrollbars=yes,resizable=yes');

                        if (!previewWindow) {
                            showNotification('Popup blocked. Please allow popups for preview functionality.', 'error');
                            return;
                        }

                        showNotification(`Opening preview for ${fileName}...`, 'success');
                    }

                    // Ticket attachment functions
                    function downloadTicketAttachment(ticketId, attachmentIndex, fileName) {
                        const url = `/api/tickets/${ticketId}/attachments/${attachmentIndex}/download`;

                        console.log(` Downloading ticket attachment: ${fileName} from ${url}`);

                        // Show downloading indicator
                        showNotification(`Downloading ${fileName}...`, 'info');

                        // Create a temporary link to trigger download
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = fileName;
                        link.style.display = 'none';
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);

                        showNotification(`Download started: ${fileName}`, 'success');

                        // Change button appearance temporarily
                        const button = event.target.closest('button');
                        if (button) {
                            const originalClass = button.className;
                            button.className = 'bg-green-500 text-white px-1.5 py-1 rounded text-[10px] transition';
                            button.innerHTML = '<i class="fas fa-check"></i>';
                            setTimeout(() => {
                                button.className = originalClass;
                                button.innerHTML = '<i class="fas fa-download"></i>';
                            }, 1500);
                        }
                    }

                    function previewTicketAttachment(ticketId, attachmentIndex, fileName) {
                        const url = `/api/tickets/${ticketId}/attachments/${attachmentIndex}/preview`;

                        // Open preview in new window/tab
                        const previewWindow = window.open(url, '_blank', 'width=900,height=700,scrollbars=yes,resizable=yes');

                        if (!previewWindow) {
                            showNotification('Popup blocked. Please allow popups for preview functionality.', 'error');
                            return;
                        }

                        showNotification(`Previewing ${fileName}...`, 'info');

                        // Change button appearance temporarily
                        const button = event.target.closest('button');
                        if (button) {
                            const originalClass = button.className;
                            button.className = 'bg-green-500 text-white px-1.5 py-1 rounded text-[10px] transition';
                            button.innerHTML = '<i class="fas fa-check"></i>';
                            setTimeout(() => {
                                button.className = originalClass;
                                button.innerHTML = '<i class="fas fa-eye"></i>';
                            }, 1500);
                        }
                    }

                    // Unified attachment functions for both reply and ticket attachments
                    function downloadAttachment(replyId, attachmentIndex, fileName, source) {
                        let url;
                        const ticketId = '{{ ticket.ticket_id|e }}';

                        // FIXED: Simplified attachment detection - use reply endpoints for all reply attachments
                        if (replyId && replyId !== 'undefined' && replyId !== 'null') {
                            // This is a reply attachment, use reply endpoint
                            url = `/api/replies/${replyId}/attachments/${parseInt(attachmentIndex)}/download`;
                        } else {
                            // This is a ticket attachment, use ticket endpoint
                            url = `/api/tickets/${ticketId}/attachments/${parseInt(attachmentIndex)}/download`;
                        }

                        // Show downloading indicator
                        showNotification(`Downloading ${fileName}...`, 'info');

                        // First check if the attachment exists and get info
                        fetch(url, { method: 'HEAD' })
                            .then(response => {
                                if (response.ok) {
                                    // Create a temporary link to trigger download
                                    const link = document.createElement('a');
                                    link.href = url;
                                    link.download = fileName;
                                    link.style.display = 'none';
                                    document.body.appendChild(link);
                                    link.click();
                                    document.body.removeChild(link);

                                    showNotification(`Download started: ${fileName}`, 'success');

                                    // Change button appearance temporarily
                                    const button = document.querySelector(`button[onclick*="${fileName}"]`);
                                    if (button) {
                                        const originalClass = button.className;
                                        button.className = 'bg-green-500 text-white px-1.5 py-1 rounded text-[10px] transition';
                                        button.innerHTML = '<i class="fas fa-check"></i>';
                                        setTimeout(() => {
                                            button.className = originalClass;
                                            button.innerHTML = '<i class="fas fa-download"></i>';
                                        }, 1500);
                                    }
                                } else {
                                    // Enhanced error handling with better text_reference support
                                    if (response.status === 400) {
                                        // Try to get detailed error message for text_reference attachments
                                        fetch(url)
                                            .then(errorResponse => errorResponse.json())
                                            .then(errorData => {
                                                if (errorData.attachment_info && errorData.attachment_info.type === 'text_reference') {
                                                    showNotification(`This is a text reference: ${errorData.attachment_info.name}`, 'info');
                                                } else {
                                                    showNotification(`Download failed: ${errorData.error || response.statusText}`, 'error');
                                                }
                                            })
                                            .catch(() => {
                                                showNotification(`Download failed: ${response.statusText}`, 'error');
                                            });
                                    } else if (response.status === 404) {
                                        showNotification(`Attachment not found. Try using the Debug button to check attachment details.`, 'error');
                                    } else if (response.status === 401) {
                                        showNotification(`Authentication required. Please refresh the page and try again.`, 'error');
                                    } else {
                                        showNotification(`Download failed: ${response.statusText}. Try debugging the attachment.`, 'error');
                                    }
                                }
                            })
                            .catch(error => {
                                // Enhanced error handling for network issues
                                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                                    showNotification(`Network error. Please check your connection and try again.`, 'error');
                                } else {
                                    showNotification(`Download error: ${error.message}`, 'error');
                                }
                            });
                    }

                    // Check for new replies function
                    function checkForNewReplies() {
                        const currentTicketId = '{{ ticket.ticket_id|e }}';
                        const currentReplyCount = document.querySelectorAll('.message').length;

                        fetch('/api/tickets/' + currentTicketId + '/reply-count')
                            .then(response => response.json())
                            .then(data => {
                                if (data.reply_count > currentReplyCount) {
                                    console.log(' New replies detected, refreshing page...');
                                    showNotification('New reply received! Refreshing...', 'info');
                                    setTimeout(() => {
                                        window.location.reload();
                                    }, 1000);
                                }
                            })
                            .catch(error => {
                                console.log('Auto-refresh check failed:', error);
                            });
                    }



                    // Function to update technician tag on home page if it's open in another tab
                    function updateHomePageTechnicianTag(ticketId, technicianName) {
                        try {
                            console.log(` Starting technician tag update for ticket ${ticketId} -> ${technicianName || 'None'}`);

                            // Method 1: Try to send a message to the home page if it's open
                            if (window.opener && !window.opener.closed) {
                                console.log(' Sending message to opener window...');
                                window.opener.postMessage({
                                    type: 'updateTechnicianTag',
                                    ticketId: ticketId,
                                    technicianName: technicianName,
                                    timestamp: Date.now()
                                }, '*');
                            }

                            // Method 2: Also try to send to parent window if this is in an iframe
                            if (window.parent && window.parent !== window) {
                                console.log(' Sending message to parent window...');
                                window.parent.postMessage({
                                    type: 'updateTechnicianTag',
                                    ticketId: ticketId,
                                    technicianName: technicianName,
                                    timestamp: Date.now()
                                }, '*');
                            }

                            // Method 3: Try to find other tabs/windows with the same origin
                            console.log(' Broadcasting message to all windows...');
                            window.postMessage({
                                type: 'updateTechnicianTag',
                                ticketId: ticketId,
                                technicianName: technicianName,
                                timestamp: Date.now()
                            }, '*');

                            // Method 4: Try to communicate with localStorage for cross-tab communication
                            try {
                                const updateData = {
                                    type: 'updateTechnicianTag',
                                    ticketId: ticketId,
                                    technicianName: technicianName,
                                    timestamp: Date.now()
                                };
                                localStorage.setItem('technicianUpdate', JSON.stringify(updateData));
                                console.log(' Stored technician update in localStorage');
                            } catch (localStorageError) {
                                console.log(' Could not use localStorage:', localStorageError);
                            }

                            console.log(` Technician update message sent successfully: ${ticketId} -> ${technicianName || 'None'}`);
                        } catch (error) {
                            console.error(' Error sending technician update message:', error);
                        }
                    }

                    // More reliable function to force refresh home page
                    function forceRefreshHomePage(ticketId, technicianName) {
                        console.log(` Force refreshing home page for ticket ${ticketId} -> ${technicianName || 'None'}`);

                        try {
                            // Method 1: Try to refresh the opener window (home page)
                            if (window.opener && !window.opener.closed) {
                                console.log(' Refreshing opener window (home page)...');
                                window.opener.location.reload();
                                return;
                            }

                            // Method 2: Try to refresh parent window
                            if (window.parent && window.parent !== window) {
                                console.log(' Refreshing parent window...');
                                window.parent.location.reload();
                                return;
                            }

                            // Method 3: If no other windows, refresh current page after delay
                            console.log(' No other windows found, refreshing current page in 1 second...');
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);

                        } catch (error) {
                            console.error(' Error refreshing home page:', error);
                            // Fallback: refresh current page
                            setTimeout(() => {
                                window.location.reload();
                            }, 1000);
                        }
                    }

                    function previewAttachment(replyId, attachmentIndex, fileName, source) {
                        let url;
                        const ticketId = '{{ ticket.ticket_id|e }}';

                        // FIXED: Simplified attachment detection - use reply endpoints for all reply attachments
                        if (replyId && replyId !== 'undefined' && replyId !== 'null') {
                            // This is a reply attachment, use reply endpoint
                            url = `/api/replies/${replyId}/attachments/${parseInt(attachmentIndex)}/preview`;
                        } else {
                            // This is a ticket attachment, use ticket endpoint
                            url = `/api/tickets/${ticketId}/attachments/${parseInt(attachmentIndex)}/preview`;
                        }

                        // First check if the attachment can be previewed
                        fetch(url, { method: 'HEAD' })
                            .then(response => {
                                if (response.ok) {
                                    // Open preview in new window/tab
                                    const previewWindow = window.open(url, '_blank', 'width=900,height=700,scrollbars=yes,resizable=yes');

                                    if (!previewWindow) {
                                        showNotification('Popup blocked. Please allow popups for preview functionality.', 'error');
                                        return;
                                    }

                                    showNotification(`Previewing ${fileName}...`, 'info');

                                    // Change button appearance temporarily
                                    const button = document.querySelector(`button[onclick*="${fileName}"]`);
                                    if (button) {
                                        const originalClass = button.className;
                                        button.className = 'bg-blue-500 text-white px-1.5 py-1 rounded text-[10px] transition';
                                        button.innerHTML = '<i class="fas fa-eye-slash"></i>';
                                        setTimeout(() => {
                                            button.className = originalClass;
                                            button.innerHTML = '<i class="fas fa-eye"></i>';
                                        }, 1500);
                                    }
                                } else {
                                    // Enhanced error handling with better text_reference support
                                    if (response.status === 400) {
                                        // Try to get detailed error message for text_reference attachments
                                        fetch(url)
                                            .then(errorResponse => errorResponse.json())
                                            .then(errorData => {
                                                if (errorData.attachment_info && errorData.attachment_info.type === 'text_reference') {
                                                    showNotification(`This is a text reference: ${errorData.attachment_info.name}`, 'info');
                                                } else {
                                                    showNotification(`File type not supported for preview. Try downloading instead.`, 'error');
                                                }
                                            })
                                            .catch(() => {
                                                showNotification(`File type not supported for preview. Try downloading instead.`, 'error');
                                            });
                                    } else if (response.status === 404) {
                                        showNotification(`Attachment not found. Try using the Debug button to check attachment details.`, 'error');
                                    } else if (response.status === 401) {
                                        showNotification(`Authentication required. Please refresh the page and try again.`, 'error');
                                    } else {
                                        showNotification(`Preview failed: ${response.statusText}. Try debugging the attachment.`, 'error');
                                    }
                                }
                            })
                            .catch(error => {
                                // Enhanced error handling for network issues
                                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                                    showNotification(`Network error. Please check your connection and try again.`, 'error');
                                } else {
                                    showNotification(`Preview error: ${error.message}`, 'error');
                                }
                            });
                    }

                    // Function to handle text reference attachments
                    function handleTextReferenceAttachment(attachmentName, description) {
                        const message = description ? `${attachmentName}: ${description}` : attachmentName;
                        showNotification(` Text Reference: ${message}`, 'info');
                    }



                    // Function to regenerate missing attachments for webhook replies
                    function regenerateWebhookAttachments() {
                        const ticketId = '{{ ticket.ticket_id|e }}';

                        showNotification('Regenerating webhook attachments...', 'info');

                        // Call the webhook-specific regenerate attachments endpoint
                        fetch(`/api/tickets/${ticketId}/regenerate-webhook-attachments`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    showNotification('Webhook attachments regenerated successfully! Refreshing page...', 'success');
                                    setTimeout(() => {
                                        window.location.reload();
                                    }, 2000);
                                } else if (data.status === 'warning') {
                                    showNotification(` ${data.message}`, 'info');
                                } else {
                                    showNotification(`Failed to regenerate webhook attachments: ${data.message}`, 'error');
                                }
                            })
                            .catch(error => {
                                console.error('Error regenerating webhook attachments:', error);
                                showNotification('Error regenerating webhook attachments. Please try again.', 'error');
                            });
                    }













                    // Function to send immediate technician update to home page
                    function sendTechnicianUpdateToHomePage(ticketId, technicianName) {
                        console.log(` Sending technician update: ${ticketId} -> ${technicianName || 'None'}`);

                        try {
                            // Method 1: Send message to opener window (home page)
                            if (window.opener && !window.opener.closed) {
                                console.log(' Sending to opener window...');
                                window.opener.postMessage({
                                    type: 'updateTechnicianTag',
                                    ticketId: ticketId,
                                    technicianName: technicianName
                                }, '*');
                            }

                            // Method 2: Send to parent window if in iframe
                            if (window.parent && window.parent !== window) {
                                console.log(' Sending to parent window...');
                                window.parent.postMessage({
                                    type: 'updateTechnicianTag',
                                    ticketId: ticketId,
                                    technicianName: technicianName
                                }, '*');
                            }

                            // Method 3: Broadcast to all windows
                            console.log(' Broadcasting to all windows...');
                            window.postMessage({
                                type: 'updateTechnicianTag',
                                ticketId: ticketId,
                                technicianName: technicianName
                            }, '*');

                            // Method 4: localStorage backup
                            try {
                                const updateData = {
                                    type: 'updateTechnicianTag',
                                    ticketId: ticketId,
                                    technicianName: technicianName
                                };
                                localStorage.setItem('technicianUpdate', JSON.stringify(updateData));
                                console.log(' Stored in localStorage');
                            } catch (localStorageError) {
                                console.log(' localStorage failed:', localStorageError);
                            }

                            // Method 5: Force refresh home page if it's open
                            if (window.opener && !window.opener.closed) {
                                console.log(' Refreshing opener window...');
                                setTimeout(() => {
                                    window.opener.location.reload();
                                }, 1000);
                            }

                            // Method 6: Try to find and update the home page directly if it's in the same window
                            try {
                                const homePageTickets = document.querySelectorAll('.ticket-card');
                                if (homePageTickets.length > 0) {
                                    console.log(' Found ticket cards on current page, updating directly...');
                                    // This means we're on the home page, update directly
                                    updateTechnicianTagOnCurrentPage(ticketId, technicianName);
                                }
                            } catch (directError) {
                                console.log(' Direct update not possible:', directError);
                            }

                            console.log(` Technician update sent successfully: ${ticketId} -> ${technicianName || 'None'}`);
                        } catch (error) {
                            console.error(' Error sending technician update:', error);
                        }
                    }

                    // Sidebar toggle functionality - REMOVED DUPLICATE CODE
                    // This functionality is now handled by the enhanced initializeSidebarToggle() function

                    // Initialize sidebar state based on current screen size
                    if (window.innerWidth >= 1921) {
                        rightSidebar.classList.add('ultra-wide-open');
                        if (sidebarToggle) {
                            sidebarToggle.style.display = 'block';
                            sidebarToggle.title = 'Open Sidebar';
                            const icon = sidebarToggle.querySelector('i');
                            if (icon) icon.className = 'fas fa-bars';
                        }
                    } else if (window.innerWidth <= 1280) {
                        if (sidebarToggle) {
                            sidebarToggle.style.display = 'block';
                            sidebarToggle.title = 'Open Sidebar';
                            const icon = sidebarToggle.querySelector('i');
                            if (icon) icon.className = 'fas fa-bars';
                        }
                    } else {
                        if (sidebarToggle) {
                            sidebarToggle.style.display = 'none';
                        }
                    }

                    // Minimize button functionality - removed conflicting listener
                    // The minimize button now properly closes the sidebar via the listener in initializeSidebarToggle()
                

                    // Function to update technician tag on the current page (if it's the home page)
                    function updateTechnicianTagOnCurrentPage(ticketId, technicianName) {
                        console.log(` Updating technician tag on current page for ticket ${ticketId}: ${technicianName || 'None'}`);

                        // Find the ticket card by ticket ID
                        const ticketCard = document.querySelector(`a[href*="/ticket/${ticketId}"]`)?.closest('.ticket-card');
                        if (!ticketCard) {
                            console.log(` Ticket card not found for ${ticketId}`);
                            return;
                        }

                        // Find or create the technician badge
                        let technicianBadge = ticketCard.querySelector('.technician-badge');

                        if (technicianName) {
                            // Create or update technician badge
                            if (!technicianBadge) {
                                technicianBadge = document.createElement('span');
                                technicianBadge.className = 'technician-badge px-2 py-1 text-xs rounded-full font-medium bg-blue-100 text-blue-800';
                                technicianBadge.innerHTML = ` ${technicianName}`;

                                // Insert after priority badge
                                const priorityBadge = ticketCard.querySelector('.priority-badge');
                                if (priorityBadge) {
                                    priorityBadge.parentNode.insertBefore(technicianBadge, priorityBadge.nextSibling);
                                } else {
                                    // Fallback: insert at the beginning of badges container
                                    const badgesContainer = ticketCard.querySelector('.flex.flex-wrap.items-center.gap-2');
                                    if (badgesContainer) {
                                        badgesContainer.insertBefore(technicianBadge, badgesContainer.firstChild);
                                    }
                                }
                            } else {
                                technicianBadge.innerHTML = ` ${technicianName}`;
                            }

                            console.log(` Technician badge updated for ticket ${ticketId}: ${technicianName}`);
                        } else {
                            // Remove technician badge if it exists
                            if (technicianBadge) {
                                technicianBadge.remove();
                                console.log(` Technician badge removed for ticket ${ticketId}`);
                            }
                        }
                    }

                    // Enhanced sidebar toggle functionality
                    function initializeSidebarToggle() {
                        const sidebarToggle = document.getElementById('sidebarToggleMobile');
                        const rightSidebar = document.querySelector('.right-sidebar');
                        const sidebarOverlay = document.getElementById('sidebarOverlay');
                        const minimizeBtn = document.getElementById('minimizeBtn');

                        if (!sidebarToggle || !rightSidebar) {
                            console.error(' Sidebar elements not found');
                            console.error('sidebarToggle:', sidebarToggle);
                            console.error('rightSidebar:', rightSidebar);
                            return;
                        }

                        console.log(' Initializing sidebar toggle functionality');
                        console.log(' Sidebar toggle button found:', sidebarToggle);
                        console.log(' Right sidebar found:', rightSidebar);

                        // Sidebar toggle click handler
                        sidebarToggle.addEventListener('click', function (e) {
                            e.preventDefault();
                            e.stopPropagation();

                            console.log(' Sidebar toggle clicked');
                            console.log(' Current window width:', window.innerWidth);
                            console.log(' Current sidebar classes:', rightSidebar.className);

                            // Get main content element for expansion
                            const mainContent = document.querySelector('.main-content');

                            // Check if we're on ultra-wide screen
                            if (window.innerWidth >= 1921) {
                                console.log(' Ultra-wide screen detected - toggling ultra-wide-open class');
                                console.log(' Before toggle - sidebar classes:', rightSidebar.className);
                                console.log(' Before toggle - sidebar transform:', rightSidebar.style.transform);
                                
                                rightSidebar.classList.toggle('ultra-wide-open');
                                
                                console.log(' After toggle - sidebar classes:', rightSidebar.className);
                                console.log(' After toggle - sidebar transform:', rightSidebar.style.transform);

                                // Update toggle button icon and main content expansion
                                const icon = this.querySelector('i');
                                const appContainer = document.querySelector('.app-container');
                                
                                if (rightSidebar.classList.contains('ultra-wide-open')) {
                                    console.log(' Sidebar is now OPEN - updating UI');
                                    icon.className = 'fas fa-times';
                                    this.title = 'Close Sidebar';
                                    
                                    // Force sidebar to be visible with all properties
                                    rightSidebar.style.transform = 'translateX(0)';
                                    rightSidebar.style.visibility = 'visible';
                                    rightSidebar.style.opacity = '1';
                                    rightSidebar.style.display = 'block';
                                    rightSidebar.style.pointerEvents = 'auto';
                                    console.log(' Forced sidebar to be visible with all properties');
                                    
                                    // Expand app container when sidebar opens
                                    if (appContainer) {
                                        appContainer.classList.remove('sidebar-closed');
                                        appContainer.classList.add('sidebar-open');
                                        console.log(' App container set to sidebar-open');
                                    }
                                    
                                    // Hide the toggle button when sidebar opens
                                    this.classList.add('hidden');
                                    console.log(' Sidebar opened (ultra-wide) - toggle button hidden');
                                } else {
                                    console.log(' Sidebar is now CLOSED - updating UI');
                                    icon.className = 'fas fa-bars';
                                    this.title = 'Open Sidebar';
                                    
                                    // Force sidebar to be hidden
                                    rightSidebar.style.transform = 'translateX(150%)';
                                    console.log(' Forced sidebar transform to translateX(150%)');
                                    
                                    // Contract app container when sidebar closes
                                    if (appContainer) {
                                        appContainer.classList.remove('sidebar-open');
                                        appContainer.classList.add('sidebar-closed');
                                        console.log(' App container set to sidebar-closed');
                                    }
                                    
                                    // Show the toggle button when sidebar closes
                                    this.classList.remove('hidden');
                                    console.log(' Sidebar closed (ultra-wide) - toggle button shown');
                                }
                            } else {
                                // Standard mobile/tablet behavior
                                rightSidebar.classList.toggle('sidebar-open');

                                // Update toggle button icon and main content expansion
                                const icon = this.querySelector('i');
                                const appContainer = document.querySelector('.app-container');
                                
                                if (rightSidebar.classList.contains('sidebar-open')) {
                                    icon.className = 'fas fa-times';
                                    this.title = 'Close Sidebar';
                                    
                                    // Force sidebar to be visible with all properties
                                    rightSidebar.style.transform = 'translateX(0)';
                                    rightSidebar.style.visibility = 'visible';
                                    rightSidebar.style.opacity = '1';
                                    rightSidebar.style.display = 'block';
                                    rightSidebar.style.pointerEvents = 'auto';
                                    console.log(' Forced sidebar to be visible with all properties');
                                    
                                    // Expand app container when sidebar opens
                                    if (appContainer) {
                                        appContainer.classList.remove('sidebar-closed');
                                        appContainer.classList.add('sidebar-open');
                                    }
                                    if (sidebarOverlay) {
                                        sidebarOverlay.style.display = 'block';
                                        sidebarOverlay.classList.add('active');
                                    }
                                    // Hide the toggle button when sidebar opens
                                    this.classList.add('hidden');
                                    console.log(' Sidebar opened (mobile/tablet) - toggle button hidden');
                                } else {
                                    icon.className = 'fas fa-bars';
                                    this.title = 'Open Sidebar';
                                    // Contract app container when sidebar closes
                                    if (appContainer) {
                                        appContainer.classList.remove('sidebar-open');
                                        appContainer.classList.add('sidebar-closed');
                                    }
                                    if (sidebarOverlay) {
                                        sidebarOverlay.style.display = 'none';
                                        sidebarOverlay.classList.remove('active');
                                    }
                                    // Show the toggle button when sidebar closes
                                    this.classList.remove('hidden');
                                    console.log(' Sidebar closed (mobile/tablet) - toggle button shown');
                                }
                            }
                        });

                        // Overlay click handler
                        if (sidebarOverlay) {
                            sidebarOverlay.addEventListener('click', function () {
                                rightSidebar.classList.remove('sidebar-open');
                                const icon = sidebarToggle.querySelector('i');
                                icon.className = 'fas fa-bars';
                                sidebarToggle.title = 'Open Sidebar';
                                this.style.display = 'none';
                                this.classList.remove('active');
                                
                                // Expand app container to take full width
                                const appContainer = document.querySelector('.app-container');
                                if (appContainer) {
                                    appContainer.classList.remove('sidebar-open');
                                    appContainer.classList.add('sidebar-closed');
                                }
                                
                                // Show the toggle button when sidebar closes
                                sidebarToggle.classList.remove('hidden');
                                
                                console.log(' Sidebar closed via overlay click - toggle button shown');
                            });
                        }

                        // Minimize button click handler - closes the sidebar
                        if (minimizeBtn) {
                            minimizeBtn.addEventListener('click', function () {
                                console.log(' Minimize button clicked - closing sidebar');
                                
                                // Close sidebar based on screen size
                                if (window.innerWidth >= 1921) {
                                    rightSidebar.classList.remove('ultra-wide-open');
                                } else {
                                    rightSidebar.classList.remove('sidebar-open');
                                    if (sidebarOverlay) {
                                        sidebarOverlay.style.display = 'none';
                                        sidebarOverlay.classList.remove('active');
                                    }
                                }
                                
                                // Expand app container to take full width
                                const appContainer = document.querySelector('.app-container');
                                if (appContainer) {
                                    appContainer.classList.remove('sidebar-open');
                                    appContainer.classList.add('sidebar-closed');
                                }
                                
                                // Show the toggle button when sidebar closes
                                sidebarToggle.classList.remove('hidden');
                                
                                // Reset toggle button icon
                                const icon = sidebarToggle.querySelector('i');
                                if (icon) {
                                    icon.className = 'fas fa-bars';
                                    sidebarToggle.title = 'Open Sidebar';
                                }
                                
                                console.log(' Sidebar closed via minimize button - toggle button shown');
                            });
                        }

                        // Close sidebar when clicking outside on mobile
                        document.addEventListener('click', function (e) {
                            if (window.innerWidth <= 1023) {
                                if (!rightSidebar.contains(e.target) &&
                                    !sidebarToggle.contains(e.target) &&
                                    rightSidebar.classList.contains('sidebar-open')) {

                                    rightSidebar.classList.remove('sidebar-open');
                                    const icon = sidebarToggle.querySelector('i');
                                    icon.className = 'fas fa-bars';
                                    sidebarToggle.title = 'Open Sidebar';
                                    if (sidebarOverlay) {
                                        sidebarOverlay.style.display = 'none';
                                        sidebarOverlay.classList.remove('active');
                                    }
                                    
                                    // Expand app container to take full width
                                    const appContainer = document.querySelector('.app-container');
                                    if (appContainer) {
                                        appContainer.classList.remove('sidebar-open');
                                        appContainer.classList.add('sidebar-closed');
                                    }
                                    
                                    // Show the toggle button when sidebar closes
                                    sidebarToggle.classList.remove('hidden');
                                    
                                    console.log(' Sidebar closed via outside click - toggle button shown');
                                }
                            }
                        });

                        // Enhanced window resize handler for comprehensive screen size coverage
                        window.addEventListener('resize', function () {
                            const mainContent = document.querySelector('.main-content');
                            
                            if (window.innerWidth >= 2560) {
                                // Very large screen (2560px+): enhanced ultra-wide behavior
                                console.log(' Resize detected: 2560px+ screen - applying ultra-wide behavior');
                                
                                rightSidebar.classList.remove('sidebar-open', 'mobile-open');
                                rightSidebar.classList.add('ultra-wide-open');
                                console.log(' Added ultra-wide-open class to sidebar');
                                
                                // Force sidebar to be hidden initially
                                rightSidebar.style.transform = 'translateX(150%)';
                                console.log(' Forced sidebar transform to translateX(150%)');
                                
                                // Contract app container when sidebar is hidden
                                const appContainer = document.querySelector('.app-container');
                                if (appContainer) {
                                    appContainer.classList.remove('sidebar-open');
                                    appContainer.classList.add('sidebar-closed');
                                    console.log(' App container set to sidebar-closed');
                                }
                                
                                if (sidebarToggle) {
                                    sidebarToggle.classList.remove('hidden');
                                    sidebarToggle.title = 'Open Sidebar (Ultra-Wide)';
                                    const icon = sidebarToggle.querySelector('i');
                                    if (icon) {
                                        icon.className = 'fas fa-bars';
                                    }
                                    console.log(' Toggle button shown and titled for ultra-wide');
                                }
                                console.log(' Resized to very large screen (2560px+): enhanced sidebar behavior');
                            } else if (window.innerWidth >= 1921) {
                                // Ultra-wide screen: auto-hide sidebar
                                rightSidebar.classList.remove('sidebar-open', 'mobile-open');
                                rightSidebar.classList.add('ultra-wide-open');
                                
                                // Contract app container when sidebar is hidden
                                const appContainer = document.querySelector('.app-container');
                                if (appContainer) {
                                    appContainer.classList.remove('sidebar-open');
                                    appContainer.classList.add('sidebar-closed');
                                }
                                
                                if (sidebarToggle) {
                                    sidebarToggle.classList.remove('hidden');
                                    sidebarToggle.title = 'Open Sidebar';
                                    sidebarToggle.style.width = '56px';
                                    sidebarToggle.style.height = '56px';
                                    sidebarToggle.style.right = '1rem';
                                    const icon = sidebarToggle.querySelector('i');
                                    if (icon) {
                                        icon.className = 'fas fa-bars';
                                        icon.style.fontSize = '1.25rem';
                                    }
                                }
                                console.log(' Resized to ultra-wide: sidebar hidden');
                            } else if (window.innerWidth >= 1711 && window.innerWidth <= 1920) {
                                // Wide desktop (1711px - 1920px): hide sidebar by default
                                rightSidebar.classList.remove('ultra-wide-open', 'sidebar-open');
                                rightSidebar.style.transform = 'translateX(120%)';
                                
                                // Contract app container when sidebar is hidden
                                const appContainer = document.querySelector('.app-container');
                                if (appContainer) {
                                    appContainer.classList.remove('sidebar-open');
                                    appContainer.classList.add('sidebar-closed');
                                }
                                
                                if (sidebarToggle) {
                                    sidebarToggle.classList.remove('hidden');
                                    sidebarToggle.title = 'Open Sidebar';
                                }
                                console.log(' Resized to wide desktop (1711px-1920px): sidebar hidden by default - toggle button shown');
                            } else if (window.innerWidth >= 1281 && window.innerWidth <= 1710) {
                                // Standard desktop (1281px - 1710px): hide sidebar by default
                                rightSidebar.classList.remove('ultra-wide-open', 'sidebar-open');
                                rightSidebar.style.transform = 'translateX(120%)';
                                
                                // Contract app container when sidebar is hidden
                                const appContainer = document.querySelector('.app-container');
                                if (appContainer) {
                                    appContainer.classList.remove('sidebar-open');
                                    appContainer.classList.add('sidebar-closed');
                                }
                                
                                if (sidebarToggle) {
                                    sidebarToggle.classList.remove('hidden');
                                    sidebarToggle.title = 'Open Sidebar';
                                }
                                console.log(' Resized to standard desktop (1281px-1710px): sidebar hidden by default - toggle button shown');
                            } else if (window.innerWidth >= 1025 && window.innerWidth <= 1280) {
                                // Medium desktop: hide sidebar by default but allow toggling
                                rightSidebar.classList.remove('ultra-wide-open', 'sidebar-open');
                                rightSidebar.style.transform = 'translateX(120%)';
                                
                                // Contract app container when sidebar is hidden
                                const appContainer = document.querySelector('.app-container');
                                if (appContainer) {
                                    appContainer.classList.remove('sidebar-open');
                                    appContainer.classList.add('sidebar-closed');
                                }
                                
                                if (sidebarToggle) {
                                    sidebarToggle.classList.remove('hidden');
                                    sidebarToggle.title = 'Open Sidebar';
                                }
                                console.log(' Resized to medium desktop (1025px-1280px): sidebar hidden by default - toggle button shown');
                            } else if (window.innerWidth >= 769 && window.innerWidth <= 1024) {
                                // Tablet landscape: hide sidebar by default
                                rightSidebar.classList.remove('ultra-wide-open', 'sidebar-open');
                                
                                // Contract app container when sidebar is hidden
                                const appContainer = document.querySelector('.app-container');
                                if (appContainer) {
                                    appContainer.classList.remove('sidebar-open');
                                    appContainer.classList.add('sidebar-closed');
                                }
                                
                                if (sidebarToggle) {
                                    sidebarToggle.classList.remove('hidden');
                                    sidebarToggle.title = 'Open Sidebar';
                                }
                                console.log(' Resized to tablet landscape (769px-1024px): sidebar hidden - toggle button shown');
                            } else if (window.innerWidth <= 768) {
                                // Mobile/tablet: hide sidebar by default
                                rightSidebar.classList.remove('ultra-wide-open', 'sidebar-open');
                                
                                // Contract app container when sidebar is hidden
                                const appContainer = document.querySelector('.app-container');
                                if (appContainer) {
                                    appContainer.classList.remove('sidebar-open');
                                    appContainer.classList.add('sidebar-closed');
                                }
                                
                                if (sidebarToggle) {
                                    sidebarToggle.classList.remove('hidden');
                                    sidebarToggle.title = 'Open Sidebar';
                                    const icon = sidebarToggle.querySelector('i');
                                    if (icon) {
                                        icon.className = 'fas fa-bars';
                                    }
                                }
                                console.log(' Resized to mobile/tablet (768px): sidebar hidden - toggle button shown');
                            }
                        });

                        // Enhanced initialization for comprehensive screen size coverage
                        const mainContent = document.querySelector('.main-content');
                        
                        console.log(' Initializing sidebar state for screen width:', window.innerWidth);
                        
                        if (window.innerWidth >= 2560) {
                            // Very large screen (2560px+): enhanced ultra-wide behavior
                            console.log(' Detected 2560px+ screen - applying ultra-wide behavior');
                            
                            // Remove any conflicting classes first
                            rightSidebar.classList.remove('sidebar-open', 'mobile-open');
                            
                            // Add ultra-wide-open class
                            rightSidebar.classList.add('ultra-wide-open');
                            console.log(' Added ultra-wide-open class to sidebar');
                            
                            // Contract app container when sidebar is hidden
                            const appContainer = document.querySelector('.app-container');
                            if (appContainer) {
                                appContainer.classList.remove('sidebar-open');
                                appContainer.classList.add('sidebar-closed');
                                console.log(' App container set to sidebar-closed');
                            } else {
                                console.log(' App container not found');
                            }
                            
                            // Show toggle button
                            sidebarToggle.classList.remove('hidden');
                            sidebarToggle.title = 'Open Sidebar (Ultra-Wide)';
                            console.log(' Toggle button shown and titled for ultra-wide');
                            
                            // Force sidebar to be hidden initially
                            rightSidebar.style.transform = 'translateX(150%)';
                            console.log(' Forced sidebar transform to translateX(150%)');
                            
                            console.log(' Initialized for very large screen (2560px+)');
                        } else if (window.innerWidth >= 1921) {
                            // Ultra-wide screen: auto-hide sidebar
                            rightSidebar.classList.add('ultra-wide-open');
                            
                            // Contract app container when sidebar is hidden
                            const appContainer = document.querySelector('.app-container');
                            if (appContainer) {
                                appContainer.classList.remove('sidebar-open');
                                appContainer.classList.add('sidebar-closed');
                            }
                            
                            sidebarToggle.classList.remove('hidden');
                            sidebarToggle.title = 'Open Sidebar';
                            console.log(' Initialized for ultra-wide screen (1921px+)');
                        } else if (window.innerWidth >= 1711 && window.innerWidth <= 1920) {
                            // Wide desktop (1711px - 1920px): hide sidebar by default
                            rightSidebar.classList.remove('ultra-wide-open', 'sidebar-open');
                            rightSidebar.style.transform = 'translateX(120%)';
                            
                            // Contract app container when sidebar is hidden
                            const appContainer = document.querySelector('.app-container');
                            if (appContainer) {
                                appContainer.classList.remove('sidebar-open');
                                appContainer.classList.add('sidebar-closed');
                            }
                            
                            sidebarToggle.classList.remove('hidden');
                            sidebarToggle.title = 'Open Sidebar';
                            console.log(' Initialized for wide desktop (1711px-1920px): sidebar hidden by default - toggle button shown');
                        } else if (window.innerWidth >= 1281 && window.innerWidth <= 1710) {
                            // Standard desktop (1281px - 1710px): hide sidebar by default
                            rightSidebar.classList.remove('ultra-wide-open', 'sidebar-open');
                            rightSidebar.style.transform = 'translateX(120%)';
                            
                            // Contract app container when sidebar is hidden
                            const appContainer = document.querySelector('.app-container');
                            if (appContainer) {
                                appContainer.classList.remove('sidebar-open');
                                appContainer.classList.add('sidebar-closed');
                            }
                            
                            sidebarToggle.classList.remove('hidden');
                            sidebarToggle.title = 'Open Sidebar';
                            console.log(' Initialized for standard desktop (1281px-1710px): sidebar hidden by default - toggle button shown');
                        } else if (window.innerWidth >= 1025 && window.innerWidth <= 1280) {
                            // Medium desktop: hide sidebar by default but allow toggling
                            rightSidebar.classList.remove('ultra-wide-open', 'sidebar-open');
                            rightSidebar.style.transform = 'translateX(120%)';
                            
                            // Contract app container when sidebar is hidden
                            const appContainer = document.querySelector('.app-container');
                            if (appContainer) {
                                appContainer.classList.remove('sidebar-open');
                                appContainer.classList.add('sidebar-closed');
                            }
                            
                            sidebarToggle.classList.remove('hidden');
                            sidebarToggle.title = 'Open Sidebar';
                            console.log(' Initialized for medium desktop (1025px-1280px): sidebar hidden by default - toggle button shown');
                        } else if (window.innerWidth >= 769 && window.innerWidth <= 1024) {
                            // Tablet landscape: hide sidebar by default
                            rightSidebar.classList.remove('ultra-wide-open', 'sidebar-open');
                            
                            // Contract app container when sidebar is hidden
                            const appContainer = document.querySelector('.app-container');
                            if (appContainer) {
                                appContainer.classList.remove('sidebar-open');
                                appContainer.classList.add('sidebar-closed');
                            }
                            
                            sidebarToggle.classList.remove('hidden');
                            sidebarToggle.title = 'Open Sidebar';
                            console.log(' Initialized for tablet landscape (769px-1024px): sidebar hidden - toggle button shown');
                        } else if (window.innerWidth <= 768) {
                            // Mobile/tablet: hide sidebar by default
                            rightSidebar.classList.remove('ultra-wide-open', 'sidebar-open');
                            
                            // Contract app container when sidebar is hidden
                            const appContainer = document.querySelector('.app-container');
                            if (appContainer) {
                                appContainer.classList.remove('sidebar-open');
                                appContainer.classList.add('sidebar-closed');
                            }
                            
                            sidebarToggle.classList.remove('hidden');
                            sidebarToggle.title = 'Open Sidebar';
                            console.log(' Initialized for mobile/tablet (768px): sidebar hidden - toggle button shown');
                        }

                        console.log(' Sidebar toggle functionality initialized');
                    }

                    // Enhanced test function to verify sidebar toggle is working
                    function testSidebarToggle() {
                        console.log(' Testing sidebar toggle functionality...');
                        console.log(' Current window width:', window.innerWidth);
                        
                        const sidebarToggle = document.getElementById('sidebarToggleMobile');
                        const rightSidebar = document.querySelector('.right-sidebar');
                        const sidebarOverlay = document.getElementById('sidebarOverlay');
                        const minimizeBtn = document.getElementById('minimizeBtn');
                        
                        console.log(' Element search results:');
                        console.log('  - sidebarToggle:', sidebarToggle);
                        console.log('  - rightSidebar:', rightSidebar);
                        console.log('  - sidebarOverlay:', sidebarOverlay);
                        console.log('  - minimizeBtn:', minimizeBtn);
                        
                        if (sidebarToggle) {
                            console.log(' Sidebar toggle button found');
                            console.log('  - ID:', sidebarToggle.id);
                            console.log('  - Classes:', sidebarToggle.className);
                            console.log('  - Display style:', sidebarToggle.style.display);
                            console.log('  - Computed display:', window.getComputedStyle(sidebarToggle).display);
                            console.log('  - Position:', sidebarToggle.style.position);
                            console.log('  - Z-index:', sidebarToggle.style.zIndex);
                            console.log('  - Visible:', sidebarToggle.offsetParent !== null);
                        } else {
                            console.log(' Sidebar toggle button not found');
                        }
                        
                        if (rightSidebar) {
                            console.log(' Right sidebar found');
                            console.log('  - ID:', rightSidebar.id);
                            console.log('  - Classes:', rightSidebar.className);
                            console.log('  - Transform:', rightSidebar.style.transform);
                            console.log('  - Computed transform:', window.getComputedStyle(rightSidebar).transform);
                            console.log('  - Position:', rightSidebar.style.position);
                            console.log('  - Z-index:', rightSidebar.style.zIndex);
                            console.log('  - Visible:', rightSidebar.offsetParent !== null);
                            console.log('  - Bounding rect:', rightSidebar.getBoundingClientRect());
                        } else {
                            console.log(' Right sidebar not found');
                        }

                        if (sidebarOverlay) {
                            console.log(' Sidebar overlay found');
                            console.log('  - ID:', sidebarOverlay.id);
                            console.log('  - Classes:', sidebarOverlay.className);
                        } else {
                            console.log(' Sidebar overlay not found');
                        }

                        if (minimizeBtn) {
                            console.log(' Minimize button found');
                            console.log('  - ID:', minimizeBtn.id);
                            console.log('  - Classes:', minimizeBtn.className);
                        } else {
                            console.log(' Minimize button not found');
                        }

                        // Test CSS classes and styles
                        if (rightSidebar) {
                            console.log(' CSS Analysis:');
                            const computedStyle = window.getComputedStyle(rightSidebar);
                            console.log('  - Computed transform:', computedStyle.transform);
                            console.log('  - Computed position:', computedStyle.position);
                            console.log('  - Computed z-index:', computedStyle.zIndex);
                            console.log('  - Computed display:', computedStyle.display);
                            console.log('  - Computed visibility:', computedStyle.visibility);
                            console.log('  - Computed opacity:', computedStyle.opacity);
                        }
                    }

                    // IMMEDIATE SIDEBAR HIDING - runs as soon as script loads
                    (function() {
                        console.log(' IMMEDIATE SIDEBAR HIDING - forcing sidebar to be completely hidden on page load');
                        
                        // Force sidebar to be completely hidden immediately
                        const rightSidebar = document.querySelector('.right-sidebar');
                        if (rightSidebar) {
                            rightSidebar.style.transform = 'translateX(200%)';
                            rightSidebar.style.pointerEvents = 'none';
                            rightSidebar.style.visibility = 'hidden';
                            rightSidebar.style.opacity = '0';
                            rightSidebar.style.display = 'none';
                            console.log(' Sidebar completely hidden on page load');
                        }
                        
                        // Force app container to be expanded
                        const appContainer = document.querySelector('.app-container');
                        if (appContainer) {
                            appContainer.classList.remove('sidebar-open');
                            appContainer.classList.add('sidebar-closed');
                            console.log(' App container immediately expanded on page load');
                        }
                        
                        // Show toggle button immediately
                        const sidebarToggle = document.getElementById('sidebarToggleMobile');
                        if (sidebarToggle) {
                            sidebarToggle.classList.remove('hidden');
                            sidebarToggle.title = 'Open Sidebar';
                            console.log(' Toggle button immediately shown on page load');
                        }
                    })();

                    // Call test function after a short delay
                    setTimeout(testSidebarToggle, 1000);
                </script>
            </div> <!-- Close main-content container -->
        </div> <!-- Close app-container -->
        
        <!-- Right Sidebar - Now properly positioned inside main-layout but outside app-container -->
        <div id="rightSidebar" class="right-sidebar">
            <!-- Notes Section -->
            <div class="sidebar-section">
                <div class="sidebar-header">
                    <h3 class="sidebar-title">Private Notes</h3>
                    <div class="flex items-center space-x-2">
                        <button id="addNoteBtn" class="add-btn">
                            <i class="fas fa-plus"></i>
                        </button>
                        <button id="minimizeBtn" class="minimize-btn" title="Minimize Sidebar">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <div id="notesContainer">
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-sticky-note"></i>
                        </div>
                        <p>No notes yet. Add your first note!</p>
                    </div>
                </div>
            </div>

            <!-- Templates Section -->
            <div class="sidebar-section">
                <div class="sidebar-header">
                    <h3 class="sidebar-title">Response Templates</h3>
                    <button id="addTemplateBtn" class="add-btn">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div id="templatesContainer">
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <p>No templates yet. Add your first template!</p>
                    </div>
                </div>
            </div>

            <!-- Common Documents Section -->
            <div class="sidebar-section">
                <div class="sidebar-header">
                    <h3 class="sidebar-title">Common Documents</h3>
                    <button id="addDocumentBtn" class="add-btn">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
                <div id="documentsContainer">
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-file-pdf"></i>
                        </div>
                        <p>No documents yet. Add your first document!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar overlay for mobile -->
        <div id="sidebarOverlay" class="sidebar-overlay"></div>
    </div> <!-- Close main-layout -->

</body>

</html>