<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket #{{ ticket.ticket_id }} - AutoAssistGroup Portal</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #4f46e5;
            --urgent: #ef4444;
            --fast: #f59e0b;
            --medium: #ec4899;
            --low: #10b981;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f9fafb;
        }

        /* Custom max-width for 1440px constraint */
        .max-w-1440 {
            max-width: 1440px;
        }

        .ticket-header {
            border-left: 4px solid;
            transition: all 0.3s ease;
        }

        .priority-urgent {
            border-left-color: var(--urgent);
        }

        .priority-fast {
            border-left-color: var(--fast);
        }

        .priority-medium {
            border-left-color: var(--medium);
        }

        .priority-low {
            border-left-color: var(--low);
        }

        .btn-primary {
            background-color: var(--primary);
        }

        .btn-primary:hover {
            background-color: #4338ca;
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            transform: translateX(200%);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            display: flex;
            align-items: center;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background-color: #10b981;
            color: white;
        }

        .notification.error {
            background-color: #ef4444;
            color: white;
        }

        /* Original Message styles */
        .original-message-container {
            background-color: #f8fafc;
            border-radius: 0.75rem;
            border: 1px solid #e2e8f0;
            padding: 1.5rem;
            margin-bottom: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.2s ease;
        }
        
        .original-message-container:hover {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        .original-message-content {
            white-space: pre-line;
            word-break: break-word;
            overflow-wrap: break-word;
            max-height: 200px;
            overflow: hidden;
            position: relative;
            hyphens: auto;
        }

        .original-message-content.expanded {
            max-height: none;
        }

        .read-more-btn {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to bottom, transparent, rgba(248, 250, 252, 0.9));
            padding: 2rem 0 0.5rem;
            text-align: center;
            cursor: pointer;
            color: var(--primary);
            font-weight: 500;
            display: none;
        }

        .original-message-content.truncated .read-more-btn {
            display: block;
        }

        /* Importance button styles */
        .importance-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f9fafb;
            transition: all 0.2s ease;
            border: 1px solid #d1d5db;
        }

        .importance-btn:hover {
            border-color: #9ca3af;
            background-color: #f3f4f6;
        }

        .importance-btn.important {
            border-color: #f59e0b;
            background-color: #fffbeb;
        }

        .importance-btn .star-icon {
            color: #d1d5db;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .importance-btn:hover .star-icon {
            color: #f59e0b;
        }

        .importance-btn.important .star-icon {
            color: #f59e0b;
        }

        /* Conversation styles */
        .conversation-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding: 1rem 0;
        }

        .message {
            display: flex;
            flex-direction: column;
            max-width: 70%;
            border-radius: 1rem;
            padding: 0.75rem 1rem;
            position: relative;
            word-wrap: break-word;
            overflow-wrap: break-word;
            min-width: 0;
        }

        .customer-message {
            align-self: flex-start;
            background-color: #f3f4f6;
            margin-right: 15%;
        }

        .support-message {
            align-self: flex-end;
            background-color: #e0e7ff;
            margin-left: 15%;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .customer-message .message-header {
            color: #4b5563;
        }

        .support-message .message-header {
            color: #1e293b;
        }

        .message-time {
            font-size: 0.75rem;
            font-weight: 600;
            opacity: 0.8;
        }

        .message-content {
            white-space: pre-line;
            word-break: break-word;
            overflow-wrap: break-word;
            font-size: 0.9375rem;
            padding: 8px 0;
            hyphens: auto;
            min-width: 0;
        }

        .reply-message-box {
            max-height: 50px;
            overflow: hidden;
            position: relative;
            transition: max-height 0.3s ease;
        }

        .reply-message-box.expanded {
            max-height: none;
        }

        .reply-message-box .expand-btn {
            position: absolute;
            bottom: 20px;
            left: 6;
            right: 0;
            padding: 20px 0 5px;
            text-align: center;
            cursor: pointer;
            color: rgb(112, 147, 243);
            font-weight: 600;
            display: none;
        }

        .reply-message-box.truncated .expand-btn {
            display: block;
        }

        /* Modern icons */
        .customer-icon {
            color: #4f46e5;
            margin-right: 18px;
            font-size: 1.5rem;
        }

        .support-icon {
            color: #4f46e5;
            margin-right: 8px;
            font-size: 1.2rem;
        }

        /* Modal styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            transform: translateY(20px);
            transition: all 0.3s ease;
            max-width: 90%;
            width: 500px;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        /* Mobile responsive improvements */
        @media (max-width: 768px) {
            .message {
                max-width: 85%;
                margin-left: 10px !important;
                margin-right: 10px !important;
            }
            
            .customer-message {
                margin-right: 5%;
            }
            
            .support-message {
                margin-left: 5%;
            }
            
            .modal-content {
                max-width: 95%;
                margin: 1rem;
            }
            
            .flex.flex-col.md\\:flex-row {
                gap: 1rem;
            }
            
            .grid.grid-cols-1.md\\:grid-cols-3 {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }

        @media (max-width: 480px) {
            .message {
                max-width: 90%;
                padding: 0.5rem 0.75rem;
            }
            
            .ticket-header {
                padding: 1rem !important;
            }
            
            h1 {
                font-size: 1.25rem !important;
                line-height: 1.4;
            }
            
            .px-6 {
                padding-left: 1rem !important;
                padding-right: 1rem !important;
            }
        }

        /* Line clamp utilities for text truncation */
        .line-clamp-1 {
            display: -webkit-box;
            -webkit-line-clamp: 1;
            line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        .line-clamp-3 {
            display: -webkit-box;
            -webkit-line-clamp: 3;
            line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Responsive word breaking */
        .break-words {
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            hyphens: auto;
        }

        /* Pulse animation for assigned badge */
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(1.1);
                opacity: 0.8;
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .assigned-badge::before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #3b82f6;
            margin-right: 6px;
            animation: pulse 1.5s infinite;
        }

        /* Forward/Takeover specific styles */
        .forwarded-badge {
            background-color: #e0f2fe !important;
            color: #0369a1 !important;
            border-left: 3px solid #38bdf8 !important;
        }

        .takeover-badge {
            background-color: #dcfce7 !important;
            color: #166534 !important;
            border-left: 3px solid #4ade80 !important;
        }

        .assignment-status {
            position: relative;
            padding-left: 1.5rem;
        }

        .assignment-status::before {
            content: '';
            position: absolute;
            left: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            width: 0.5rem;
            height: 0.5rem;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }

        .forwarded-badge.assignment-status::before {
            background-color: #0369a1;
        }

        .takeover-badge.assignment-status::before {
            background-color: #166534;
        }

        /* Ultra compact card styling */
        .detail-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            padding: 0.5rem;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease-in-out;
        }

        .detail-card:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            border-color: #cbd5e1;
        }

        /* Extra compact card headers */
        .detail-card h3 {
            color: #64748b;
            font-weight: 500;
            font-size: 0.65rem;
            margin-bottom: 0.25rem;
        }

        .detail-card h4 {
            color: #64748b;
            font-weight: 500;
            font-size: 0.6rem;
            margin-bottom: 0.25rem;
        }

        /* Right sidebar styles - Ultra compact design */
        .right-sidebar {
            width: 340px;
            position: fixed;
            right: 0;
            top: 4rem;
            bottom: 0;
            background: #f8fafc;
            border-left: 1px solid #e2e8f0;
            overflow-y: auto;
            z-index: 42;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            transform: translateX(0);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
        }

        /* Hide sidebar on mobile by default with smooth animations */
        @media (max-width: 1280px) {
            .right-sidebar {
                transform: translateX(100%);
                box-shadow: -4px 0 16px rgba(0, 0, 0, 0.1);
                width: 100%;
                max-width: 340px;
            }
            
            .right-sidebar.mobile-open {
                transform: translateX(0);
                box-shadow: -4px 0 16px rgba(0, 0, 0, 0.12);
            }
            
            /* Add overlay for mobile - lower z-index to allow drag interactions */
            .sidebar-overlay {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.3); /* Lighter overlay */
                z-index: 35; /* Lower z-index */
                opacity: 0;
                visibility: hidden;
                transition: all 0.3s ease;
            }
            
            .sidebar-overlay.active {
                opacity: 1;
                visibility: visible;
            }
            
            /* Ensure draggable elements and main content have higher z-index */
            .main-content, .document-item, .conversation-container, .ticket-header {
                position: relative;
                z-index: 36; /* Higher than overlay */
            }
            
            /* Draggable document items get even higher z-index */
            .document-item[draggable="true"] {
                z-index: 45; /* Higher than sidebar */
            }
            
            /* Interactive form elements should also be above overlay */
            #replyForm, .reply-message-box, .attachment-preview, textarea, input {
                position: relative;
                z-index: 36; /* Higher than overlay */
            }
            
            /* Ensure dropzone for file uploads works */
            #attachmentDropzone, #attachmentSection {
                position: relative;
                z-index: 36;
            }
        }

        /* Adjust main content margins for larger screens */
        @media (min-width: 1281px) {
            .main-content {
                margin-right: 360px; /* Account for sidebar width (350px + padding) */
                max-width: calc(100% - 380px); /* Proper width calculation with breathing room */
                width: auto; /* Ensure proper width calculation */
                padding-right: 1rem; /* Add some breathing room */
            }
            
            /* Ensure container takes full available width */
            .container {
                max-width: none;
                width: 100%;
            }
        }

        /* Comprehensive Responsive Design for Ticket Detail */
        
        /* Small mobile devices (320px - 480px) */
        @media (max-width: 480px) {
            .container {
                padding-left: 0.75rem;
                padding-right: 0.75rem;
            }
            
            .ticket-header {
                padding: 0.625rem;
            }
            
            .detail-card {
                padding: 0.5rem;
                margin-bottom: 0.625rem;
            }
            
            .conversation-container {
                padding: 0.5rem 0;
                gap: 0.75rem;
            }
            
            .message {
                max-width: 90%;
                padding: 0.5rem 0.625rem;
                font-size: 0.875rem;
            }
            
            .customer-message {
                margin-right: 2%;
            }
            
            .support-message {
                margin-left: 2%;
            }
            
            .message-header {
                font-size: 0.75rem;
                margin-bottom: 0.375rem;
            }
            
            .message-time {
                font-size: 0.6875rem;
            }
            
            /* Navigation responsive */
            nav .container {
                padding: 0.5rem;
            }
            
            /* Grid layout for small screens */
            .grid.grid-cols-1.md\\:grid-cols-3 {
                grid-template-columns: repeat(1, 1fr) !important;
                gap: 0.75rem;
            }
            
            /* Button responsiveness */
            .px-2.py-1 {
                padding: 0.375rem 0.5rem;
                font-size: 0.6875rem;
            }
            
            /* Reply form */
            textarea {
                min-height: 80px;
                font-size: 0.875rem;
            }
        }
        
        /* Mobile devices (481px - 768px) */
        @media (min-width: 481px) and (max-width: 768px) {
            .container {
                padding-left: 1rem;
                padding-right: 1rem;
                margin-right: 0 !important;
            }
            
            .main-content {
                margin-right: 0 !important;
                padding: 1rem;
            }
            
            .ticket-header {
                padding: 1rem;
            }
            
            .detail-card {
                padding: 1rem;
            }
            
            .conversation-container {
                padding: 0.5rem 0;
            }
            
            .message {
                max-width: 85%;
                padding: 0.75rem 1rem;
            }
            
            .customer-message {
                margin-right: 7.5%;
            }
            
            .support-message {
                margin-left: 7.5%;
            }
            
            .grid.grid-cols-1.md\\:grid-cols-3 {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 1rem;
            }
            
            /* Touch-friendly buttons */
            button, .btn, a.btn {
                min-height: 44px;
                padding: 0.75rem 1rem;
                touch-action: manipulation;
            }
            
            /* Better spacing for tablet */
            h1 {
                font-size: 1.375rem;
                line-height: 1.25;
            }
            
            /* Modal improvements */
            .modal-content {
                margin: 1rem;
                max-width: calc(100vw - 2rem);
            }
        }
        
        /* Tablet devices (769px - 1024px) */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                padding-left: 1.5rem;
                padding-right: 1.5rem;
                margin-right: 0 !important;
            }
            
            .main-content {
                margin-right: 0 !important;
                padding: 1.5rem;
            }
            
            .ticket-header {
                padding: 1.5rem;
            }
            
            .detail-card {
                padding: 1.25rem;
            }
            
            .message {
                max-width: 80%;
                padding: 0.875rem 1.125rem;
            }
            
            .customer-message {
                margin-right: 10%;
            }
            
            .support-message {
                margin-left: 10%;
            }
            
            /* Better button sizing for tablet */
            button, .btn, a.btn {
                min-height: 44px;
                padding: 0.75rem 1.25rem;
            }
            
            /* Grid improvements */
            .grid.grid-cols-1.md\\:grid-cols-3 {
                grid-template-columns: repeat(3, 1fr);
                gap: 1.5rem;
            }
        }
        
        /* Laptop screens (1025px - 1280px) */
        @media (min-width: 1025px) and (max-width: 1280px) {
            .container {
                max-width: 100%;
                padding-left: 2rem;
                padding-right: 2rem;
                margin-right: 0 !important;
            }
            
            .main-content {
                margin-right: 0 !important;
                padding: 2rem;
            }
            
            .ticket-header {
                padding: 1.75rem;
            }
            
            .detail-card {
                padding: 1.5rem;
            }
            
            .message {
                max-width: 75%;
                padding: 1rem 1.25rem;
            }
            
            .customer-message {
                margin-right: 12.5%;
            }
            
            .support-message {
                margin-left: 12.5%;
            }
            
            /* Full grid layout */
            .grid.grid-cols-1.md\\:grid-cols-3 {
                grid-template-columns: repeat(3, 1fr);
                gap: 2rem;
            }
        }
        
        /* Large desktop screens (1281px+) - With sidebar */
        @media (min-width: 1281px) {
            .container {
                max-width: none;
                margin: 0 auto;
                padding-left: 1.5rem;
                padding-right: 1.5rem;
            }
            
            .main-content {
                margin-right: 370px !important; /* Account for sidebar width */
                padding: 1.5rem;
            }
            
            .ticket-header {
                padding: 1.5rem;
            }
            
            .detail-card {
                padding: 1.25rem;
            }
            
            .message {
                max-width: 70%;
                padding: 1rem 1.5rem;
            }
            
            .customer-message {
                margin-right: 15%;
            }
            
            .support-message {
                margin-left: 15%;
            }
            
            /* Full grid layout for desktop */
            .grid.grid-cols-1.md\\:grid-cols-3 {
                grid-template-columns: repeat(3, 1fr);
                gap: 2rem;
            }
        }
        
        /* Extra large screens (1441px+) */
        @media (min-width: 1441px) {
            .container {
                max-width: 1600px;
                margin: 0 auto;
            }
            
            .main-content {
                margin-right: 370px !important;
                padding: 2.5rem;
            }
            
            .ticket-header {
                padding: 2.5rem;
            }
            
            .detail-card {
                padding: 2rem;
            }
        }

        /* Sidebar toggle button for mobile */
        .sidebar-toggle {
            position: fixed;
            top: 50%;
            right: 1rem;
            transform: translateY(-50%);
            z-index: 43; /* Highest z-index to always be accessible */
            background: var(--primary);
            color: white;
            border: none;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.25rem;
            touch-action: manipulation;
        }

        .sidebar-toggle:hover {
            background: #4338ca;
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.25);
        }
        
        .sidebar-toggle:active {
            transform: translateY(-50%) scale(0.95);
        }

        /* Hide toggle button on desktop and ensure sidebar is visible */
        @media (min-width: 1281px) {
            .sidebar-toggle {
                display: none;
            }
            
            .right-sidebar {
                transform: translateX(0) !important;
                position: fixed;
                right: 0;
                top: 0;
                bottom: 0;
                width: 340px;
                box-shadow: -2px 0 8px rgba(0, 0, 0, 0.1);
            }
            
            .sidebar-overlay {
                display: none !important;
            }
        }



        .sidebar-section {
            margin-bottom: 0.5rem;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            padding: 0.5rem;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: all 0.2s ease-in-out;
        }

        .sidebar-section:hover {
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .sidebar-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #374151;
        }

        .add-btn {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            background: #3b82f6;
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-size: 0.75rem;
        }

        .add-btn:hover {
            background: #2563eb;
        }

        /* Note card styles */
        .note-card {
            background-color: white;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-left: 3px solid #4f46e5;
        }

        .note-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #1e293b;
        }

        .note-content {
            color: #475569;
            font-size: 0.875rem;
            white-space: pre-line;
        }

        .note-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.5rem;
        }

        .note-actions {
            display: flex;
            gap: 0.5rem;
        }

        .note-action-btn {
            color: #64748b;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .note-action-btn:hover {
            color: #4f46e5;
        }

        /* Template styles */
        .template-item {
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .template-item:hover {
            background-color: #f1f5f9;
            border-color: #cbd5e1;
        }

        .template-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .template-content {
            color: #64748b;
            font-size: 0.875rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .template-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .template-action-btn {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            cursor: pointer;
        }

        .template-use-btn {
            background-color: #e0e7ff;
            color: #4f46e5;
        }

        .template-use-btn:hover {
            background-color: #c7d2fe;
        }

        .template-edit-btn {
            background-color: #f1f5f9;
            color: #64748b;
        }

        .template-edit-btn:hover {
            background-color: #e2e8f0;
        }

        /* Document item styles */
        .document-item {
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .document-item:hover {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .document-item button {
            transition: all 0.15s ease;
        }

        .document-item:hover button {
            opacity: 1;
        }

        .empty-state {
            text-align: center;
            padding: 2rem 1rem;
            color: #64748b;
            background: rgba(248, 250, 252, 0.5);
            border: 2px dashed rgba(203, 213, 225, 0.6);
            border-radius: 1rem;
            margin: 0.5rem 0;
            transition: all 0.2s ease-in-out;
        }

        .empty-state:hover {
            border-color: rgba(59, 130, 246, 0.3);
            background: rgba(239, 246, 255, 0.5);
        }

        .empty-icon {
            font-size: 2.5rem;
            margin-bottom: 0.75rem;
            color: #cbd5e1;
            opacity: 0.8;
        }

        .empty-state p {
            font-size: 0.875rem;
            font-weight: 500;
            color: #64748b;
        }

        /* Status dropdown styles */
        .status-dropdown {
            position: relative;
            display: inline-block;
        }

        .status-dropdown-btn {
            padding: 0.5rem 1rem;
            background-color: #f1f5f9;
            border-radius: 0.375rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .status-dropdown-btn:hover {
            background-color: #e2e8f0;
        }

        .status-dropdown-content {
            position: absolute;
            background-color: white;
            min-width: 220px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border-radius: 0.375rem;
            z-index: 50;
            display: none;
        }

        .status-dropdown-content.show {
            display: block;
        }

        .status-option {
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .status-option:hover {
            background-color: #f1f5f9;
        }

        /* Status badge colors - Modern improved styling */
        .status-new {
            background-color: #fef5e7;
            color: #b45309;
            border: 1px solid #fed7aa;
        }

        .status-form-sent {
            background-color: #eff6ff;
            color: #2563eb;
            border: 1px solid #bfdbfe;
        }

        .status-awaiting-submission {
            background-color: #faf5ff;
            color: #7c3aed;
            border: 1px solid #e9d5ff;
        }

        .status-under-review {
            background-color: #fffbeb;
            color: #d97706;
            border: 1px solid #fde68a;
        }

        .status-info-requested {
            background-color: #eff6ff;
            color: #1d4ed8;
            border: 1px solid #bfdbfe;
        }

        .status-referred {
            background-color: #f5f3ff;
            color: #7c2d12;
            border: 1px solid #ddd6fe;
        }

        .status-approved {
            background-color: #f0fdf4;
            color: #15803d;
            border: 1px solid #bbf7d0;
        }

        .status-declined {
            background-color: #fef2f2;
            color: #dc2626;
            border: 1px solid #fecaca;
        }

        .status-closed {
            background-color: #f0fdf4;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
    </style>
</head>

<body class="min-h-screen bg-gray-50">
    <nav class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-3">
            <div class="flex justify-between items-center">
                <div class="flex items-center space-x-4">
                    <a href="/" class="flex items-center">
                        <img src="/static/logo.png" alt="AutoAssistGroup Logo" class="h-8 md:h-10">
                    </a>
                    <div class="hidden md:flex space-x-4">
                        <a href="/" class="px-3 py-2 rounded bg-pink-50 text-pink-600 font-medium">Tickets</a>
                        <a href="/dashboard" class="px-3 py-2 rounded hover:bg-gray-100 transition">Dashboard</a>
                        <a href="/status" class="px-3 py-2 rounded hover:bg-gray-100 transition">Status</a>
                        <a href="/create-ticket" class="px-3 py-2 rounded hover:bg-gray-100 transition">Create Ticket</a>
                        {% if current_user_role == 'Administrator' %}
                        <a href="/technicians" class="px-3 py-2 rounded hover:bg-gray-100 transition">Technicians</a>
                        <a href="/members" class="px-3 py-2 rounded hover:bg-gray-100 transition">Members</a>
                        <a href="/admin" class="px-3 py-2 rounded hover:bg-gray-100 transition">Admin Panel</a>
                        {% endif %}
                    </div>
                </div>
                <div class="flex items-center space-x-2 md:space-x-4">
                    {% if current_user %}
                    <span class="hidden sm:inline text-gray-600 text-sm md:text-base">{{ current_user }}</span>
                    <a href="/logout" class="px-2 py-1 md:px-3 md:py-2 rounded bg-gray-100 hover:bg-gray-200 transition text-xs md:text-sm">Logout</a>
                    {% else %}
                    <a href="/login" class="px-2 py-1 md:px-3 md:py-2 rounded bg-pink-500 hover:bg-pink-600 transition text-white text-xs md:text-sm">Login</a>
                    {% endif %}
                    
                    <!-- Mobile menu button -->
                    <button class="md:hidden p-2 rounded-md hover:bg-gray-100 mobile-menu-btn" onclick="toggleMobileMenu()">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                        </svg>
                    </button>
                </div>
            </div>
            
            <!-- Mobile menu (hidden by default) -->
            <div id="mobileMenu" class="md:hidden mt-4 pb-4 border-t border-gray-200 hidden">
                <div class="flex flex-col space-y-2 pt-4">
                    <a href="/" class="px-3 py-2 rounded bg-pink-50 text-pink-600 font-medium">Tickets</a>
                    <a href="/dashboard" class="px-3 py-2 rounded hover:bg-gray-100 transition">Dashboard</a>
                    <a href="/status" class="px-3 py-2 rounded hover:bg-gray-100 transition">Status</a>
                    <a href="/create-ticket" class="px-3 py-2 rounded hover:bg-gray-100 transition">Create Ticket</a>
                    {% if current_user_role == 'Administrator' %}
                    <a href="/technicians" class="px-3 py-2 rounded hover:bg-gray-100 transition">Technicians</a>
                    <a href="/members" class="px-3 py-2 rounded hover:bg-gray-100 transition">Members</a>
                    <a href="/admin" class="px-3 py-2 rounded hover:bg-gray-100 transition">Admin Panel</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <!-- Notification System -->
    <div id="notification" class="notification hidden">
        <i class="fas fa-check-circle mr-2"></i>
        <span id="notification-message"></span>
    </div>

    <!-- Message Expansion Modal -->
    <div id="messageModal" class="modal-overlay">
        <div class="modal-content p-2">
            <div class="flex justify-between items-center mb-1">
                <h3 class="text-xs font-semibold">Full Message</h3>
                <button id="closeMessageModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="modalMessageContent" class="p-4 bg-gray-50 rounded-lg whitespace-pre-wrap"></div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="modal-overlay">
        <div class="modal-content p-2">
            <h3 class="text-xs font-semibold mb-1">Confirm Ticket Closure</h3>
            <p class="mb-2">Are you sure you want to close this ticket? This action cannot be undone.</p>
            <div class="flex justify-end space-x-1">
                <button id="cancelClose"
                    class="px-2 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition">
                    Cancel
                </button>
                <button id="confirmClose"
                    class="px-2 py-2 text-white rounded hover:opacity-90 transition bg-indigo-600">
                    Confirm Close
                </button>
            </div>
        </div>
    </div>

    <!-- Forward Modal -->
    <div id="forwardModal" class="modal-overlay">
        <div class="modal-content p-2">
            <div class="flex justify-between items-center mb-1">
                <h3 class="text-xs font-semibold">Forward Ticket</h3>
                <button id="closeForwardModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="mb-1">
                <label for="forwardMemberSelect" class="block text-gray-700 text-xs font-medium mb-1">Select Member</label>
                <select id="forwardMemberSelect"
                    class="w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white shadow-sm transition-all duration-200 text-gray-900 font-medium text-sm">
                    <option value="" class="text-gray-500">Select a member...</option>
                    {% for member in members %}
                    <option value="{{ member.id }}">{{ member.name }} ({{ member.role }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-1">
                <label for="forwardNotes" class="block text-gray-700 text-xs font-medium mb-1">Notes</label>
                <textarea id="forwardNotes"
                    class="w-full px-2 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="Add any notes explaining why the ticket is being forwarded"></textarea>
            </div>
            <div class="flex justify-end space-x-1">
                <button id="cancelForward"
                    class="px-2 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition">
                    Cancel
                </button>
                <button id="confirmForward"
                    class="px-2 py-2 text-white rounded hover:opacity-90 transition bg-indigo-600">
                    Forward Ticket
                </button>
            </div>
        </div>
    </div>

    <!-- Add Note Modal -->
    <div id="noteModal" class="modal-overlay">
        <div class="modal-content p-2">
            <div class="flex justify-between items-center mb-1">
                <h3 class="text-xs font-semibold">Add Private Note</h3>
                <button id="closeNoteModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-1">
                <label class="block text-gray-700 text-xs font-medium mb-1">Title</label>
                <input type="text" id="noteTitle"
                    class="w-full px-2 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="Note title">
            </div>
            <div class="mb-1">
                <label class="block text-gray-700 text-xs font-medium mb-1">Content</label>
                <textarea id="noteContent" rows="4"
                    class="w-full px-2 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="Write your note here..."></textarea>
            </div>
            <div class="flex justify-end space-x-1">
                <button id="cancelNote"
                    class="px-2 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition">
                    Cancel
                </button>
                <button id="saveNote" class="px-2 py-2 text-white rounded hover:opacity-90 transition bg-indigo-600">
                    Save Note
                </button>
            </div>
        </div>
    </div>

    <!-- Edit Template Modal -->
    <div id="editTemplateModal" class="modal-overlay">
        <div class="modal-content p-2">
            <div class="flex justify-between items-center mb-1">
                <h3 class="text-xs font-semibold" id="editTemplateTitle">Add New Template</h3>
                <button id="closeEditTemplateModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-1">
                <label class="block text-gray-700 text-xs font-medium mb-1">Title</label>
                <input type="text" id="templateTitle"
                    class="w-full px-2 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="Template title">
            </div>
            <div class="mb-1">
                <label class="block text-gray-700 text-xs font-medium mb-1">Content</label>
                <textarea id="templateContent" rows="6"
                    class="w-full px-2 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="Enter your template content here..."></textarea>
            </div>
            <div class="flex justify-end space-x-1">
                <button id="cancelEditTemplate"
                    class="px-2 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition">
                    Cancel
                </button>
                <button id="saveTemplate"
                    class="px-2 py-2 text-white rounded hover:opacity-90 transition bg-indigo-600">
                    Save Template
                </button>
                <button id="deleteTemplate"
                    class="px-2 py-2 bg-red-100 text-red-700 rounded hover:bg-red-200 transition hidden">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Document Modal -->
    <div id="documentModal" class="modal-overlay">
        <div class="modal-content p-2">
            <div class="flex justify-between items-center mb-1">
                <h3 class="text-xs font-semibold" id="documentModalTitle">Add New Document</h3>
                <button id="closeDocumentModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-1">
                <label class="block text-gray-700 text-xs font-medium mb-1">Document Name</label>
                <input type="text" id="documentName"
                    class="w-full px-2 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="Document name">
            </div>
            <div class="mb-1">
                <label class="block text-gray-700 text-xs font-medium mb-1">Document Type</label>
                <select id="documentType"
                    class="w-full px-2 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="form">Form</option>
                    <option value="guide">Guide</option>
                    <option value="manual">Manual</option>
                    <option value="template">Template Document</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="mb-1">
                <label class="block text-gray-700 text-xs font-medium mb-1">File</label>
                <div class="flex items-center">
                    <div class="file-input-wrapper w-full">
                        <div class="file-input-button w-full flex items-center justify-center py-2 bg-gray-100 hover:bg-gray-200 transition rounded-lg">
                            <i class="fas fa-upload mr-2"></i> Choose File
                        </div>
                        <input type="file" id="documentFile" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.xlsx,.xls">
                    </div>
                </div>
                <p id="selectedFileName" class="mt-2 text-xs text-gray-600">No file selected</p>
            </div>
            <div class="mb-1">
                <label class="block text-gray-700 text-xs font-medium mb-1">Description</label>
                <textarea id="documentDescription" rows="3"
                    class="w-full px-2 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                    placeholder="Enter a short description of this document..."></textarea>
            </div>
            <div class="flex justify-end space-x-1">
                <button id="cancelDocument"
                    class="px-2 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition">
                    Cancel
                </button>
                <button id="saveDocument"
                    class="px-2 py-2 text-white rounded hover:opacity-90 transition bg-indigo-600">
                    Save Document
                </button>
                <button id="deleteDocument"
                    class="px-2 py-2 bg-red-100 text-red-700 rounded hover:bg-red-200 transition hidden">
                    Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Assignment/Forward/Takeover Modal -->
    <div id="assignModal" class="modal-overlay">
        <div class="modal-content p-2">
            <div class="flex justify-between items-center mb-1">
                <h3 class="text-xs font-semibold" id="assignModalTitle">Assign Ticket</h3>
                <button id="closeAssignModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="mb-1">
                <label class="block text-gray-700 text-xs font-medium mb-1">Select Member</label>
                <select id="assignMemberSelect" class="w-full px-3 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 bg-white shadow-sm transition-all duration-200 text-gray-900 font-medium text-sm">
                    {% for member in members %}
                    <option value="{{ member._id }}" class="py-1">{{ member.name }} - {{ member.role }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="mb-1" id="forwardNotesContainer" style="display: none;">
                <label class="block text-gray-700 text-xs font-medium mb-1">Notes</label>
                <textarea id="assignNotes" class="w-full px-2 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Add any notes for the forwarded ticket"></textarea>
            </div>
            <div class="flex justify-end space-x-1">
                <button id="cancelAssign" class="px-2 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">
                    Cancel
                </button>
                <button id="confirmAssign" class="px-2 py-2 text-white rounded-lg hover:opacity-90 transition bg-indigo-600">
                    Confirm
                </button>
            </div>
        </div>
    </div>

    <!-- Email Template Modal -->
    <div id="emailTemplateModal" class="modal-overlay">
        <div class="modal-content p-2" style="max-width: 600px;">
            <div class="flex justify-between items-center mb-1">
                <h3 class="text-xs font-semibold">
                    <i class="fas fa-envelope-open-text text-green-600 mr-2"></i>Email Template
                </h3>
                <button id="closeEmailTemplateModal" class="text-gray-500 hover:text-gray-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="mb-1">
                <label class="block text-gray-700 text-xs font-medium mb-1">Template Type</label>
                <select id="templateTypeSelect" class="w-full px-2 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500">
                    <option value="warranty_claim">Warranty Claim Template</option>
                </select>
            </div>
            
            <div class="mb-1">
                <label class="block text-gray-700 text-xs font-medium mb-1">Recipient Email</label>
                <input type="email" id="recipientEmail" class="w-full px-2 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" readonly value="{{ ticket.email }}">
            </div>
            
            <div class="mb-1">
                <label class="block text-gray-700 text-xs font-medium mb-1">Subject</label>
                <input type="text" id="emailSubject" class="w-full px-2 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" readonly>
            </div>
            
            <div class="mb-1">
                <label class="block text-gray-700 text-xs font-medium mb-1">Email Body</label>
                <textarea id="emailBody" class="w-full px-2 py-2 border rounded-lg focus:ring-2 focus:ring-green-500 focus:border-green-500" rows="10" readonly></textarea>
            </div>
            
            <div class="mb-1">
                <label class="block text-gray-700 text-xs font-medium mb-1">Attachments</label>
                <div id="availableAttachments" class="space-y-2 max-h-32 overflow-y-auto">
                    <!-- Attachments will be populated via JavaScript -->
                </div>
            </div>
            
            <div class="flex justify-end space-x-1">
                <button id="cancelEmailTemplate" class="px-2 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">
                    Cancel
                </button>
                <button id="loadTemplate" class="px-2 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    <i class="fas fa-download mr-2"></i>Load Template
                </button>
                <button id="sendEmail" class="px-2 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition" disabled>
                    <i class="fas fa-paper-plane mr-2"></i>Send Email
                </button>
            </div>
        </div>
    </div>

    <!-- Right Sidebar -->
    <div class="right-sidebar">
        <!-- Notes Section -->
        <div class="sidebar-section">
            <div class="sidebar-header">
                <h3 class="sidebar-title">Private Notes</h3>
                <button id="addNoteBtn" class="add-btn">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div id="notesContainer">
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-sticky-note"></i>
                    </div>
                    <p>No notes yet. Add your first note!</p>
                </div>
            </div>
        </div>

        <!-- Templates Section -->
        <div class="sidebar-section">
            <div class="sidebar-header">
                <h3 class="sidebar-title">Response Templates</h3>
                <button id="addTemplateBtn" class="add-btn">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div id="templatesContainer">
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-file-alt"></i>
                    </div>
                    <p>No templates yet. Add your first template!</p>
                </div>
            </div>
        </div>
        
        <!-- Common Documents Section -->
        <div class="sidebar-section">
            <div class="sidebar-header">
                <h3 class="sidebar-title">Common Documents</h3>
                <button id="addDocumentBtn" class="add-btn">
                    <i class="fas fa-plus"></i>
                </button>
            </div>
            <div id="documentsContainer">
                <div class="empty-state">
                    <div class="empty-icon">
                        <i class="fas fa-file-pdf"></i>
                    </div>
                    <p>No documents yet. Add your first document!</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Sidebar overlay for mobile -->
    <div id="sidebarOverlay" class="sidebar-overlay"></div>
    
    <!-- Sidebar toggle button for mobile -->
    <button id="sidebarToggle" class="sidebar-toggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Detailed Assignment History Modal -->
    <div id="detailedAssignmentHistoryModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-2">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[80vh] overflow-y-auto">
                <div class="flex justify-between items-center p-2 border-b">
                    <h3 class="text-xs font-semibold">Complete Assignment History</h3>
                    <button onclick="closeDetailedAssignmentHistory()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="p-2">
                    {% if ticket.assignment and ticket.assignment|length > 0 %}
                    {% for assignment in ticket.assignment %}
                    <div class="py-1 border-b border-gray-100 last:border-b-0 {% if loop.first %}bg-blue-50 rounded{% endif %}">
                        <div class="flex items-center justify-between">
                            <div class="text-xs {% if loop.first %}font-semibold text-blue-700{% else %}text-gray-700{% endif %}">
                                {% if assignment.is_forwarded %}
                                <i class="fas fa-share mr-1 text-blue-500"></i>Forwarded to {{ ticket.assigned_member[loop.index0].name if ticket.assigned_member|length > loop.index0 else 'Unknown' }}
                                {% else %}
                                <i class="fas fa-user-check mr-1 text-green-500"></i>Assigned to {{ ticket.assigned_member[loop.index0].name if ticket.assigned_member|length > loop.index0 else 'Unknown' }}
                                {% endif %}
                            </div>
                            {% if loop.first %}
                            <span class="text-xs bg-blue-100 text-blue-700 px-1 py-0.5 rounded">Current</span>
                            {% endif %}
                        </div>
                        {% if assignment.assigned_at %}
                        <div class="text-xs text-gray-500 mt-1">
                            <i class="fas fa-clock mr-1"></i>{{ assignment.assigned_at|format_datetime }}
                        </div>
                        {% endif %}
                        {% if assignment.notes %}
                        <div class="text-xs text-gray-600 mt-1 bg-gray-50 p-1 rounded italic">
                            <i class="fas fa-sticky-note mr-1"></i>{{ assignment.notes }}
                        </div>
                        {% endif %}
                        {% if assignment.is_forwarded and ticket.forwarded_from_member and ticket.forwarded_from_member|length > loop.index0 %}
                        <div class="text-xs text-gray-500 mt-1">
                            <i class="fas fa-user mr-1"></i>From: {{ ticket.forwarded_from_member[loop.index0].name }}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="text-xs text-gray-500 text-center py-2">No assignment history available</div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

            <div class="container mx-auto max-w-1440 px-2 sm:px-4 py-3 sm:py-4 main-content">
        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center mb-4 space-y-2 sm:space-y-0">
            <a href="/" class="text-indigo-600 hover:text-indigo-800 flex items-center transition text-xs">            
                <i class="fas fa-arrow-left mr-1 md:mr-2"></i> Back
            </a>
            <div class="flex items-center justify-end space-x-1">
                <span class="text-gray-600 text-xs">Welcome, {{ current_user }}</span>
                <a href="/logout" class="p-1.5 md:p-2 rounded-full hover:bg-gray-200 transition" title="Logout">
                    <i class="fas fa-sign-out-alt text-gray-600 text-xs"></i>
                </a>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md overflow-hidden mb-4 transition-all hover:shadow-lg">
            <div class="p-4 ticket-header priority-{{ ticket.priority|lower }}">
                <div class="flex flex-col lg:flex-row lg:justify-between lg:items-start mb-1 gap-2">
                    <div class="flex-1">
                        <!-- Warranty Detection Badge -->
                        {% if ticket.has_warranty or attachments|selectattr('is_warranty')|list %}
                        <div class="mb-2">
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                <i class="fas fa-shield-alt mr-1"></i>
                                Warranty Form Detected
                            </span>
                        </div>
                        {% endif %}
                        
                        <div class="mb-1">
                            <h1 class="text-xs font-bold text-gray-800 break-words mb-1">#{{ ticket.ticket_id }} - {{ ticket.subject }}</h1>
                            <!-- Priority & Status Row -->
                            <div class="flex flex-wrap items-center gap-2 mb-1">
                            <!-- Priority Badge -->
                                <div class="flex items-center gap-1">
                                    <span class="px-2 py-1 text-xs rounded-md font-medium
                                        {% if ticket.priority == 'Urgent' %}bg-red-100 text-red-700
                                        {% elif ticket.priority == 'High' %}bg-orange-100 text-orange-700
                                        {% elif ticket.priority == 'Medium' %}bg-yellow-100 text-yellow-700
                                        {% elif ticket.priority == 'Low' %}bg-green-100 text-green-700
                                        {% else %}bg-gray-100 text-gray-700{% endif %}">
                                        <i class="fas fa-{% if ticket.priority == 'Urgent' %}exclamation-triangle{% elif ticket.priority == 'High' %}exclamation{% elif ticket.priority == 'Medium' %}circle{% else %}check{% endif %} mr-1"></i>
                                {{ ticket.priority }}
                            </span>

                            <!-- Priority Selection Dropdown -->
                                    <div class="relative">
                                        <select id="prioritySelect" class="px-2 py-1 text-xs rounded-md font-medium border border-gray-200 bg-white appearance-none cursor-pointer hover:bg-gray-50 transition" 
                                    data-ticket-id="{{ ticket.ticket_id }}">
                                    <option value="Urgent" {% if ticket.priority == 'Urgent' %}selected{% endif %}> Urgent</option>
                                    <option value="High" {% if ticket.priority == 'High' %}selected{% endif %}> High</option>
                                    <option value="Medium" {% if ticket.priority == 'Medium' %}selected{% endif %}> Medium</option>
                                    <option value="Low" {% if ticket.priority == 'Low' %}selected{% endif %}> Low</option>
                                </select>
                                        <i class="fas fa-chevron-down absolute right-2 top-1/2 transform -translate-y-1/2 text-xs pointer-events-none text-gray-400"></i>
                                    </div>
                            </div>
                                
                                <!-- Status Badge -->
                                <span class="px-2 py-1 text-xs rounded-md font-medium status-{{ ticket.status|lower|replace(' ', '-')|replace('', '') }}">
                                    <i class="fas fa-circle mr-1"></i>{{ ticket.status }}
                                </span>
                            </div>

                            <!-- Classification & Details Row -->
                            <div class="flex flex-wrap items-center gap-2">

                            <!-- Classification Dropdown -->
                            <div class="relative">
                                <select id="classificationSelect" class="px-2 py-1 text-xs rounded-md font-medium border border-gray-200 appearance-none cursor-pointer hover:bg-gray-50 transition
                                    {% if ticket.classification == 'Technical' %}bg-indigo-100 text-indigo-700
                                    {% elif ticket.classification == 'Payment' %}bg-purple-100 text-purple-700
                                    {% elif ticket.classification == 'Account' %}bg-violet-100 text-violet-700
                                    {% else %}bg-pink-100 text-pink-700{% endif %}" 
                                    data-ticket-id="{{ ticket.ticket_id }}">
                                    <option value="General" {% if ticket.classification == 'General' %}selected{% endif %}> General</option>
                                    <option value="Technical" {% if ticket.classification == 'Technical' %}selected{% endif %}> Technical</option>
                                    <option value="Payment" {% if ticket.classification == 'Payment' %}selected{% endif %}> Payment</option>
                                    <option value="Account" {% if ticket.classification == 'Account' %}selected{% endif %}> Account</option>
                                    <option value="Warranty Claim" {% if ticket.classification == 'Warranty Claim' %}selected{% endif %}> Warranty</option>
                                    <option value="Support" {% if ticket.classification == 'Support' %}selected{% endif %}> Support</option>
                                    <option value="Others" {% if ticket.classification == 'Others' %}selected{% endif %}> Others</option>
                                </select>
                                <i class="fas fa-chevron-down absolute right-2 top-1/2 transform -translate-y-1/2 text-xs pointer-events-none text-gray-400"></i>
                            </div>

                            <!-- Important Badge -->
                            {% if ticket.is_important %}
                                <span class="px-2 py-1 text-xs rounded-md font-medium bg-amber-100 text-amber-700">
                                    <i class="fas fa-star mr-1 text-amber-600"></i>Important
                            </span>
                            {% endif %}

                            <!-- Assigned To Badge with History Dropdown -->
                            {% if ticket.assignment and ticket.assignment|length > 0 and ticket.assigned_member and ticket.assigned_member|length > 0 %}
                            <div class="flex items-center gap-1">
                                <!-- Latest Assignment Badge -->
                                <span class="px-2 py-1 text-xs rounded-md font-medium {% if ticket.assignment[0].is_forwarded %}bg-blue-100 text-blue-700{% else %}bg-emerald-100 text-emerald-700{% endif %}">
                                {% if ticket.assignment[0].is_forwarded %}
                                    <i class="fas fa-share mr-1"></i>Forwarded to {{ ticket.assigned_member[0].name }}
                                {% else %}
                                    <i class="fas fa-user-check mr-1"></i>Assigned to {{ ticket.assigned_member[0].name }}
                                {% endif %}
                                    <span class="ml-1">{% if ticket.assigned_member[0].gender == 'female' %}{% else %}{% endif %}</span>
                            </span>
                                
                                <!-- History Dropdown (only show if multiple assignments) -->
                                {% if ticket.assignment|length > 1 %}
                                <div class="relative">
                                    <button class="px-1 py-1 text-xs bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition" onclick="toggleAssignmentHistory()" title="View assignment history">
                                        <i class="fas fa-history"></i>
                                    </button>
                                    <div id="assignmentHistoryDropdown" class="hidden absolute top-full mt-1 right-0 bg-white border border-gray-200 rounded-md shadow-lg z-50 min-w-[250px]">
                                        <div class="p-2">
                                            <div class="text-xs font-medium text-gray-500 mb-1">Assignment History</div>
                                            {% for assignment in ticket.assignment[1:] %}
                                            <div class="py-1 border-b border-gray-100 last:border-b-0">
                                                <div class="text-xs text-gray-700">
                                                    {% if assignment.is_forwarded %}
                                                    <i class="fas fa-share mr-1 text-blue-500"></i>Forwarded to {{ ticket.assigned_member[loop.index].name if ticket.assigned_member|length > loop.index else 'Unknown' }}
                                                    {% else %}
                                                    <i class="fas fa-user-check mr-1 text-green-500"></i>Assigned to {{ ticket.assigned_member[loop.index].name if ticket.assigned_member|length > loop.index else 'Unknown' }}
                            {% endif %}
                                                </div>
                                                {% if assignment.assigned_at %}
                                                <div class="text-xs text-gray-500 mt-1">{{ assignment.assigned_at|format_datetime }}</div>
                                                {% endif %}
                                                {% if assignment.notes %}
                                                <div class="text-xs text-gray-500 mt-1 italic">{{ assignment.notes }}</div>
                                                {% endif %}
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                            {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex flex-wrap items-center gap-2 lg:justify-end">
                        <!-- Creation Method Badge -->
                        <span class="px-2 py-1 text-xs rounded-md font-medium bg-gray-100 text-gray-600" title="{% if ticket.creation_method in ['manual', 'manual_fallback'] %}Created manually{% elif ticket.creation_method in ['email', 'n8n_email', 'n8n_form', 'simple_json_api'] %}Created from mail{% else %}Creation method unknown{% endif %}">
                            {% if ticket.creation_method in ['manual', 'manual_fallback'] %}
                                <i class="fas fa-user-edit mr-1 text-gray-500"></i>Manual
                            {% elif ticket.creation_method in ['email', 'n8n_email', 'n8n_form', 'simple_json_api'] %}
                                <i class="fas fa-envelope mr-1 text-gray-500"></i>Email
                            {% else %}
                                <i class="fas fa-question-circle mr-1 text-gray-500"></i>Unknown
                            {% endif %}
                        </span>
                        
                        {% if not is_tech_director %}
                        <!-- Importance Button -->
                        <button id="importantBtn"
                            class="px-2 py-1 rounded-md transition-all duration-200 text-xs {% if ticket.is_important %}bg-amber-100 text-amber-700 hover:bg-amber-200{% else %}bg-gray-100 text-gray-600 hover:bg-amber-100 hover:text-amber-600{% endif %}"
                            title="{% if ticket.is_important %}Remove from important{% else %}Mark as important{% endif %}">
                            <i class="{% if ticket.is_important %}fas fa-star text-amber-500{% else %}far fa-star{% endif %} mr-1"></i>
                            {% if ticket.is_important %}Important{% else %}Important{% endif %}
                        </button>

                        <!-- Status Dropdown -->
                        <div class="status-dropdown relative">
                            <button id="statusDropdownBtn" class="px-2 py-1 bg-white border border-gray-200 rounded-md hover:bg-gray-50 transition-all duration-200 flex items-center gap-1 text-gray-700 text-xs">
                                <i class="fas fa-edit text-blue-500"></i>
                                <span>Status</span>
                                <i class="fas fa-chevron-down text-gray-400"></i>
                            </button>
                            <div id="statusDropdownContent" class="status-dropdown-content absolute top-full mt-1 left-0 bg-white rounded-lg shadow-lg border border-gray-200 min-w-[220px] z-50 hidden">
                                <div class="py-2">
                                    <div class="status-option px-2 py-1 hover:bg-gray-50 cursor-pointer text-xs text-gray-700 transition-colors" data-status="New">
                                        <i class="fas fa-circle text-orange-400 mr-2"></i>New
                                </div>
                                    <div class="status-option px-2 py-1 hover:bg-gray-50 cursor-pointer text-xs text-gray-700 transition-colors" data-status="Form Sent">
                                        <i class="fas fa-circle text-blue-400 mr-2"></i>Form Sent
                                    </div>
                                    <div class="status-option px-2 py-1 hover:bg-gray-50 cursor-pointer text-xs text-gray-700 transition-colors" data-status="Awaiting Submission">
                                        <i class="fas fa-circle text-purple-400 mr-2"></i>Awaiting Submission
                                    </div>
                                    <div class="status-option px-2 py-1 hover:bg-gray-50 cursor-pointer text-xs text-gray-700 transition-colors" data-status="Under Review">
                                        <i class="fas fa-circle text-yellow-400 mr-2"></i>Under Review
                                    </div>
                                    <div class="status-option px-2 py-1 hover:bg-gray-50 cursor-pointer text-xs text-gray-700 transition-colors" data-status="Info Requested">
                                        <i class="fas fa-circle text-blue-500 mr-2"></i>Info Requested
                                    </div>
                                    <div class="status-option px-2 py-1 hover:bg-gray-50 cursor-pointer text-xs text-gray-700 transition-colors" data-status="Warranty Form Received">
                                        <i class="fas fa-circle text-indigo-400 mr-2"></i>Warranty Form Received
                                    </div>
                                    <div class="status-option px-2 py-1 hover:bg-gray-50 cursor-pointer text-xs text-gray-700 transition-colors" data-status="Referred to Tech Director">
                                        <i class="fas fa-circle text-violet-400 mr-2"></i>Referred to Tech Director
                                    </div>
                                    <div class="status-option px-2 py-1 hover:bg-gray-50 cursor-pointer text-xs text-gray-700 transition-colors" data-status="Approved  Revisit Booked">
                                        <i class="fas fa-circle text-green-400 mr-2"></i>Approved  Revisit Booked
                                    </div>
                                    <div class="status-option px-2 py-1 hover:bg-gray-50 cursor-pointer text-xs text-gray-700 transition-colors" data-status="Declined  Not Covered">
                                        <i class="fas fa-circle text-red-400 mr-2"></i>Declined  Not Covered
                                    </div>
                                    <div class="status-option px-2 py-1 hover:bg-gray-50 cursor-pointer text-xs text-gray-700 transition-colors" data-status="Closed">
                                        <i class="fas fa-circle text-gray-400 mr-2"></i>Closed
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Close Ticket Button - Only show on open tickets -->
                        {% if ticket.status and ticket.status.lower() not in ['resolved', 'closed', 'declined', 'cancelled'] %}
                        <button id="closeResolvedBtn"
                            class="px-2 py-1 rounded-md bg-red-100 text-red-700 hover:bg-red-200 transition-all duration-200 text-xs">
                            <i class="fas fa-times mr-1"></i>Close
                        </button>
                        {% endif %}
                        {% endif %}

                        {% if not is_tech_director %}
                        <!-- Take Over Button -->
                        {% if not ticket.assignment or ticket.assignment|length == 0 %}
                        <button id="takeOverBtn"
                            class="px-2 py-1 rounded-md bg-blue-100 text-blue-700 hover:bg-blue-200 transition-all duration-200 text-xs">
                            <i class="fas fa-hand-paper mr-1"></i>Take Over
                        </button>
                        {% elif ticket.assignment and ticket.assignment|length > 0 and ticket.assigned_member and ticket.assigned_member|length > 0 %}
                        <!-- Show current assignment with history option -->
                        <div class="flex items-center gap-1">
                            <div class="px-2 py-1 rounded-lg border border-green-200 assignment-status {% if ticket.assignment[0].is_forwarded %}forwarded-badge{% else %}takeover-badge{% endif %}">
                            {% if ticket.assignment[0].is_forwarded %}
                            <i class="fas fa-share mr-1"></i> 
                            Forwarded from {{ ticket.forwarded_from_member[0].name if ticket.forwarded_from_member and ticket.forwarded_from_member|length > 0 else 'Unknown' }} to {{ ticket.assigned_member[0].name }}
                            {% else %}
                            <i class="fas fa-hand-paper mr-1"></i> 
                            Taken over by {{ ticket.assigned_member[0].name }}
                            {% endif %}
                            {% if ticket.assigned_member[0]._id|string == session.member_id|string %}
                            <span class="text-xs opacity-75 font-bold">(You)</span>
                            {% endif %}
                            {% if ticket.assignment[0].assigned_at %}
                            <div class="text-xs opacity-75 mt-1">{{ ticket.assignment[0].assigned_at|format_datetime }}</div>
                            {% endif %}
                            {% if ticket.assignment[0].notes %}
                            <div class="text-xs opacity-75 mt-1 italic">Note: {{ ticket.assignment[0].notes }}</div>
                                {% endif %}
                            </div>
                            
                            <!-- Assignment History Button (only show if multiple assignments) -->
                            {% if ticket.assignment|length > 1 %}
                            <button class="px-1 py-1 text-xs bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition" onclick="toggleDetailedAssignmentHistory()" title="View full assignment history">
                                <i class="fas fa-history"></i>
                            </button>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Refer to Tech Director Button -->
                        {% if ticket.status != 'Referred to Tech Director' %}
                        <button id="referToTechDirectorBtn" class="px-2 py-1 rounded-lg bg-orange-100 text-orange-800 hover:bg-orange-200 transition" title="Refer this ticket to Technical Director for expert review">
                            <i class="fas fa-user-cog mr-1"></i> Refer to Tech Director
                        </button>
                        {% else %}
                        <div class="px-2 py-1 rounded-lg bg-orange-50 text-orange-700 border border-orange-200">
                            <i class="fas fa-check-circle mr-1"></i> Already Referred to Tech Director
                        </div>
                        {% endif %}

                        {% endif %}

                        <!-- Email Template Button - Available for ALL users including Technical Director -->
                        <button id="emailTemplateBtn" class="px-2 py-1 rounded-md bg-purple-100 text-purple-700 hover:bg-purple-200 transition-all duration-200 text-xs" title="Send email using template">
                            <i class="fas fa-envelope mr-1"></i>Email
                        </button>

                        <!-- Forward Button - Available for both regular users and Technical Director -->
                        <button id="forwardBtn"
                            class="px-2 py-1 rounded-md transition-all duration-200 text-xs {% if is_tech_director %}bg-blue-100 text-blue-700 hover:bg-blue-200{% else %}bg-green-100 text-green-700 hover:bg-green-200{% endif %}">
                            <i class="fas fa-share mr-1"></i>{% if is_tech_director %}Forward{% else %}Forward{% endif %}
                        </button>

                        {% if is_tech_director %}
                        <!-- Technical Director View - Show assignment status with history -->
                        {% if ticket.assignment and ticket.assignment|length > 0 and ticket.assigned_member and ticket.assigned_member|length > 0 %}
                        <div class="flex items-center gap-1">
                            <div class="px-2 py-1 rounded-lg border border-gray-200 bg-gray-50">
                            {% if ticket.assignment[0].is_forwarded %}
                            <i class="fas fa-share mr-1 text-blue-600"></i> 
                            Forwarded from {{ ticket.forwarded_from_member[0].name if ticket.forwarded_from_member and ticket.forwarded_from_member|length > 0 else 'Unknown' }} to {{ ticket.assigned_member[0].name }}
                            {% else %}
                            <i class="fas fa-hand-paper mr-1 text-green-600"></i> 
                            Taken over by {{ ticket.assigned_member[0].name }}
                            {% endif %}
                            {% if ticket.assignment[0].assigned_at %}
                            <div class="text-xs opacity-75 mt-1">{{ ticket.assignment[0].assigned_at|format_datetime }}</div>
                            {% endif %}
                        </div>
                            
                            <!-- Assignment History Button for Tech Director -->
                            {% if ticket.assignment|length > 1 %}
                            <button class="px-1 py-1 text-xs bg-gray-100 text-gray-600 rounded hover:bg-gray-200 transition" onclick="toggleDetailedAssignmentHistory()" title="View complete assignment history">
                                <i class="fas fa-history"></i>
                            </button>
                            {% endif %}
                        </div>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>

                <!-- Ticket Details -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                    <div class="detail-card">
                        <h3 class="text-xs font-medium text-gray-500 mb-1">Customer</h3>
                        <p class="text-gray-800 font-medium break-words">
                            {% if customer_title or customer_first_name or customer_surname %}
                                {% if customer_title %}{{ customer_title }} {% endif %}
                                {% if customer_first_name %}{{ customer_first_name }} {% endif %}
                                {% if customer_surname %}{{ customer_surname }}{% endif %}
                            {% else %}
                                {{ ticket.name }}
                            {% endif %}
                        </p>
                        <p class="text-gray-600 text-xs break-words">{{ ticket.email }}</p>
                        {% if ticket.phone %}
                        <p class="text-gray-600 text-xs mt-1 break-words"><i class="fas fa-phone mr-1"></i> {{ ticket.phone }}</p>
                        {% endif %}
                    </div>

                    <div class="detail-card">
                        <h3 class="text-xs font-medium text-gray-500 mb-1">Created</h3>
                        <p class="text-gray-800">{{ formatted_date }}</p>
                    </div>

                    <div class="detail-card">
                        <h3 class="text-xs font-medium text-gray-500 mb-1">Last Updated</h3>
                        <p class="text-gray-800">{{ ticket.updated_at|format_datetime }}</p>
                    </div>
                </div>

                <!-- Vehicle Information -->
                {% if vehicle_registration %}
                <div class="mb-3">
                    <h3 class="text-xs font-medium text-gray-500 mb-1">Vehicle & Claim Information</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
                        {% if vehicle_registration %}
                        <div class="detail-card flex items-center">
                            <div class="p-1 rounded bg-blue-100 mr-2 flex-shrink-0">
                                <i class="fas fa-car text-blue-600 text-xs"></i>
                            </div>
                            <div class="min-w-0 flex-1">
                                <h4 class="text-xs font-medium text-gray-500 mb-1">Registration</h4>
                                <p class="text-gray-800 font-semibold break-words">{{ vehicle_registration }}</p>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if service_date %}
                        <div class="detail-card flex items-center">
                            <div class="p-1 rounded bg-purple-100 mr-2 flex-shrink-0">
                                <i class="fas fa-calendar-check text-purple-600 text-xs"></i>
                            </div>
                            <div class="min-w-0 flex-1">
                                <h4 class="text-xs font-medium text-gray-500 mb-1">Service Date</h4>
                                <p class="text-gray-800 font-semibold break-words">{{ service_date }}</p>
                            </div>
                        </div>
                        {% endif %}
                        
                        {% if claim_date %}
                        <div class="detail-card flex items-center">
                            <div class="p-1 rounded bg-amber-100 mr-2 flex-shrink-0">
                                <i class="fas fa-calendar-alt text-amber-600 text-xs"></i>
                            </div>
                            <div class="min-w-0 flex-1">
                                <h4 class="text-xs font-medium text-gray-500 mb-1">Claim Date</h4>
                                <p class="text-gray-800 font-semibold break-words">{{ claim_date }}</p>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Technician Field -->
                        {% if technician %}
                        <div class="detail-card flex items-center">
                            <div class="p-1 rounded bg-indigo-100 mr-2 flex-shrink-0">
                                <i class="fas fa-user-cog text-indigo-600 text-xs"></i>
                            </div>
                            <div class="min-w-0 flex-1">
                                <h4 class="text-xs font-medium text-gray-500 mb-1">Technician</h4>
                                <p class="text-gray-800 font-semibold break-words">{{ technician }}</p>
                                {% if technician_info %}
                                <p class="text-gray-600 text-xs mt-2">
                                    <i class="fas fa-id-badge mr-1"></i> {{ technician_info.user_id }}
                                    {% if technician_info.role %}
                                    <span class="ml-2 px-2 py-1 bg-indigo-100 text-indigo-800 text-xs rounded-full font-medium">{{ technician_info.role }}</span>
                                    {% endif %}
                                </p>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Type of Claim -->
                        {% if type_of_claim %}
                        <div class="detail-card flex items-center">
                            <div class="p-1 rounded bg-orange-100 mr-2 flex-shrink-0">
                                <i class="fas fa-clipboard-list text-orange-600 text-xs"></i>
                            </div>
                            <div class="min-w-0 flex-1">
                                <h4 class="text-xs font-medium text-gray-500 mb-1">Type of Claim</h4>
                                <p class="text-gray-800 font-semibold break-words">{{ type_of_claim }}</p>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- Days Between Service and Claim -->
                        {% if days_between_service_claim %}
                        <div class="detail-card flex items-center">
                            <div class="p-1 rounded bg-pink-100 mr-2 flex-shrink-0">
                                <i class="fas fa-clock text-pink-600 text-xs"></i>
                            </div>
                            <div class="min-w-0 flex-1">
                                <h4 class="text-xs font-medium text-gray-500 mb-1">Days Between Service & Claim</h4>
                                <p class="text-gray-800 font-semibold break-words">{{ days_between_service_claim }} day{% if days_between_service_claim != '1' %}s{% endif %}</p>
                            </div>
                        </div>
                        {% endif %}
                        
                        <!-- VHC Link -->
                        {% if vhc_link %}
                        <div class="detail-card flex items-center">
                            <div class="p-1 rounded bg-cyan-100 mr-2 flex-shrink-0">
                                <i class="fas fa-link text-cyan-600 text-xs"></i>
                            </div>
                            <div class="min-w-0 flex-1">
                                <h4 class="text-xs font-medium text-gray-500 mb-1">VHC (Vehicle Health Check)</h4>
                                <a href="{{ vhc_link }}" target="_blank" class="text-indigo-600 hover:text-indigo-800 flex items-center font-medium transition-colors">
                                    <i class="fas fa-external-link-alt mr-1"></i>View Report
                                </a>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Checklist Information -->
                {% if advisories_followed or within_warranty or new_fault_codes or dpf_light_on or eml_light_on %}
                <div class="mb-2">
                    <h3 class="text-xs font-medium text-gray-500 mb-1">Claim Checklist</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-1 md:grid-cols-2 gap-2">
                        <div class="detail-card">
                            <ul class="space-y-3">
                                {% if advisories_followed == '1' %}
                                <li class="flex items-center">
                                    <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                    <span>Advisories Followed</span>
                                </li>
                                {% endif %}
                                
                                {% if within_warranty == '1' %}
                                <li class="flex items-center">
                                    <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                    <span>Within Warranty Period</span>
                                </li>
                                {% endif %}
                                
                                {% if new_fault_codes == '1' %}
                                <li class="flex items-center">
                                    <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                    <span>Provided New Fault Codes</span>
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                        <div class="detail-card">
                            <ul class="space-y-3">
                                {% if dpf_light_on == '1' %}
                                <li class="flex items-center">
                                    <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                    <span>DPF Light On</span>
                                </li>
                                {% endif %}
                                
                                {% if eml_light_on == '1' %}
                                <li class="flex items-center">
                                    <i class="fas fa-check-circle text-green-500 mr-2"></i>
                                    <span>EML Light On</span>
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
                {% endif %}

                <!-- Structured Attachments -->
                <!-- Enhanced Outcome Section -->
                <div class="mb-2">
                    <div class="flex justify-between items-center mb-1">
                        <h3 class="text-xs font-medium text-gray-500 flex items-center">
                            <i class="fas fa-clipboard-check mr-2"></i> Outcome Assessment
                        </h3>
                        <button id="editOutcomeBtn" class="px-2 py-1 text-xs bg-purple-100 text-purple-800 rounded-full hover:bg-purple-200 transition">
                            <i class="fas fa-edit mr-1"></i> Edit Outcome
                        </button>
                    </div>
                    
                    <!-- Outcome Display View -->
                    <div id="outcomeDisplayView">
                        <div class="grid grid-cols-1 sm:grid-cols-1 md:grid-cols-2 gap-2 mb-1">
                            {% if outcome_category %}
                            <div class="detail-card flex items-center">
                                <div class="p-3 rounded-full bg-purple-100 mr-4">
                                    <i class="fas fa-tags text-purple-600"></i>
                                </div>
                                <div>
                                    <h4 class="text-xs font-medium text-gray-500">Outcome Category</h4>
                                    <span class="px-2 py-1 text-xs rounded-full font-medium
                                        {% if outcome_category == 'Technician Issue' %}bg-red-100 text-red-800
                                        {% elif outcome_category == 'New Fault' %}bg-orange-100 text-orange-800
                                        {% elif outcome_category == 'Advisories Not Followed' %}bg-yellow-100 text-yellow-800
                                        {% elif outcome_category == 'Driving Style' %}bg-blue-100 text-blue-800
                                        {% elif outcome_category == 'Customer Issue' %}bg-pink-100 text-pink-800
                                        {% else %}bg-gray-100 text-gray-800{% endif %}">
                                        {{ outcome_category }}
                                    </span>
                                </div>
                            </div>
                            {% else %}
                            <div class="detail-card flex items-center">
                                <div class="p-3 rounded-full bg-gray-100 mr-4">
                                    <i class="fas fa-tags text-gray-400"></i>
                                </div>
                                <div>
                                    <h4 class="text-xs font-medium text-gray-500">Outcome Category</h4>
                                    <span class="text-xs text-gray-400">Not set</span>
                                </div>
                            </div>
                            {% endif %}
                            
                            <div class="detail-card">
                                <h4 class="text-xs font-medium text-gray-500 mb-1">Actions Completed</h4>
                                <div class="space-y-2">
                                    {% if revisit_carried_out == '1' %}
                                    <div class="flex items-center text-green-700">
                                        <i class="fas fa-check-circle mr-2"></i>
                                        <span class="text-xs">Revisit Carried Out</span>
                                    </div>
                                    {% endif %}
                                    {% if clean_under_warranty == '1' %}
                                    <div class="flex items-center text-green-700">
                                        <i class="fas fa-check-circle mr-2"></i>
                                        <span class="text-xs">Clean Carried Out Under Warranty</span>
                                    </div>
                                    {% endif %}
                                    {% if not revisit_carried_out and not clean_under_warranty %}
                                    <span class="text-xs text-gray-400">No actions completed</span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="detail-card">
                            <h4 class="text-xs font-medium text-gray-500 mb-1">Outcome Notes</h4>
                            {% if outcome_notes %}
                            <p class="text-gray-700 text-xs whitespace-pre-wrap">{{ outcome_notes }}</p>
                            {% else %}
                            <span class="text-xs text-gray-400">No notes added</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <!-- Outcome Edit Form (Initially Hidden) -->
                    <div id="outcomeEditView" class="hidden">
                        <form id="outcomeForm" class="space-y-4">
                            <!-- Outcome Dropdown -->
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Outcome Category</label>
                                <select id="outcomeCategory" class="w-full px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                    <option value="">Select outcome</option>
                                    <option value="Technician Issue" {% if outcome_category == 'Technician Issue' %}selected{% endif %}>Technician Issue</option>
                                    <option value="New Fault" {% if outcome_category == 'New Fault' %}selected{% endif %}>New Fault</option>
                                    <option value="Advisories Not Followed" {% if outcome_category == 'Advisories Not Followed' %}selected{% endif %}>Advisories Not Followed</option>
                                    <option value="Driving Style" {% if outcome_category == 'Driving Style' %}selected{% endif %}>Driving Style</option>
                                    <option value="Customer Issue" {% if outcome_category == 'Customer Issue' %}selected{% endif %}>Customer Issue</option>
                                    <option value="Other" {% if outcome_category == 'Other' %}selected{% endif %}>Other</option>
                                </select>
                            </div>
                            
                            <!-- Checkboxes -->
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Actions</label>
                                <div class="space-y-2">
                                    <label class="flex items-center">
                                        <input type="checkbox" id="revisitCarriedOut" class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded" {% if revisit_carried_out == '1' %}checked{% endif %}>
                                        <span class="ml-2 text-xs text-gray-700">Revisit Carried Out</span>
                                    </label>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="cleanUnderWarranty" class="h-4 w-4 text-purple-600 focus:ring-purple-500 border-gray-300 rounded" {% if clean_under_warranty == '1' %}checked{% endif %}>
                                        <span class="ml-2 text-xs text-gray-700">Clean Carried Out Under Warranty</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Outcome Notes -->
                            <div>
                                <label class="block text-xs font-medium text-gray-700 mb-1">Outcome Notes</label>
                                <textarea id="outcomeNotes" class="w-full px-2 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500" rows="4" placeholder="Add outcome details or further explanation...">{{ outcome_notes or '' }}</textarea>
                            </div>
                            
                            <!-- Action Buttons -->
                            <div class="flex justify-end space-x-1">
                                <button type="button" id="cancelOutcomeBtn" class="px-2 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">
                                    Cancel
                                </button>
                                <button type="submit" id="saveOutcomeBtn" class="px-2 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                                    <i class="fas fa-save mr-2"></i>Save Outcome
                                </button>
                            </div>
                        </form>
                    </div>
                </div>

                <!--  NEW SIMPLE APP STYLE ATTACHMENTS -->
                {% if ticket.simple_attachments and ticket.simple_attachments|length > 0 %}
                <div class="mb-4">
                    <h3 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-paperclip mr-2"></i>
                        Attachments ({{ ticket.simple_attachments|length }})
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-2">
                        {% for attachment in ticket.simple_attachments %}
                        <div class="attachment-item bg-gray-50 border-2 border-dashed border-gray-300 rounded-lg p-2 text-center hover:bg-gray-100 hover:border-blue-400 transition-all">
                            <div class="attachment-icon text-xl mb-1 text-blue-500">
                                {% set extension = attachment.fileName.split('.')[-1].lower() %}
                                {% if extension == 'pdf' %}
                                {% elif extension in ['png', 'jpg', 'jpeg', 'gif'] %}
                                {% elif extension in ['doc', 'docx'] %}
                                {% elif extension in ['xls', 'xlsx'] %}
                                {% elif extension == 'txt' %}
                                {% elif extension in ['zip', 'rar'] %}
                                {% else %}
                                {% endif %}
                            </div>
                            <div class="attachment-name font-medium text-gray-800 mb-1 text-xs break-all">
                                {{ attachment.fileName }}
                            </div>
                            <div class="attachment-actions flex gap-1 justify-center flex-wrap">
                                <a href="/api/attachment/{{ attachment.id }}" 
                                   class="px-2 py-1 bg-blue-500 text-white text-xs rounded hover:bg-blue-600 transition flex items-center gap-1"
                                   download>
                                            <i class="fas fa-download"></i> Download
                                </a>
                                {% set viewable_extensions = ['png', 'jpg', 'jpeg', 'gif', 'pdf'] %}
                                {% if extension in viewable_extensions %}
                                <a href="/api/attachment/{{ attachment.id }}?preview=true" 
                                   target="_blank"
                                   class="px-2 py-1 bg-green-500 text-white text-xs rounded hover:bg-green-600 transition flex items-center gap-1">
                                    <i class="fas fa-eye"></i> Preview
                                </a>
                                {% endif %}
                                    </div>
                            {% if attachment.is_warranty %}
                            <div class="mt-1">
                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                    <i class="fas fa-shield-alt mr-1"></i>
                                    Warranty
                                </span>
                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}



                <!-- Original Message -->
                <div class="mb-4">
                    <h3 class="text-sm font-medium text-gray-700 mb-3 flex items-center">
                        <i class="fas fa-envelope mr-2 text-indigo-600"></i> Original Message
                    </h3>
                    <div class="original-message-container">
                        <div class="original-message-content {% if ticket.body|length > 500 %}truncated{% endif %}"
                            id="originalMessage">
                            {{ ticket.body }}
                            <div class="read-more-btn" onclick="expandMessage('originalMessage')">
                                <i class="fas fa-chevron-down mr-1"></i> Read More
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Conversation Section -->
            <div class="px-6 py-4 border-t">
                <h2 class="text-sm font-semibold text-gray-800 mb-3 flex items-center">
                    <i class="fas fa-comments mr-2 text-indigo-600"></i> Conversation
                </h2>

                {% if not replies %}
                <div class="text-center text-gray-500 py-8 bg-gray-50 rounded-lg border-2 border-dashed border-gray-200">
                    <i class="fas fa-comment-slash text-4xl mb-3 text-gray-400"></i>
                    <p class="text-sm font-medium text-gray-600">No replies yet. Be the first to respond!</p>
                    <p class="text-xs text-gray-400 mt-1">Start the conversation by adding a reply below</p>
                </div>
                {% endif %}

                <div class="conversation-container">
                    {% for reply in replies %}
                    <div class="message {% if reply.is_customer %}customer-message{% else %}support-message{% endif %}">
                        <div class="message-header">
                            <span class="font-medium flex items-center">
                                {% if reply.is_customer %}
                                <i class="fas fa-user-circle customer-icon"></i> {{ ticket.name }}
                                {% else %}
                                <i class="fas fa-headset support-icon"></i> Support Team
                                {% endif %}
                            </span>
                            <span class="message-time">
                                <i class="fas fa-clock mr-1"></i>{{ reply.formatted_date }}
                            </span>
                        </div>
                        <div class="reply-message-box {% if reply.message|length > 200 %}truncated{% endif %}"
                            id="message-{{ loop.index }}">
                            <div class="message-content">
                                {{ reply.message }}
                            </div>
                            <div class="expand-btn" onclick="expandMessage('message-{{ loop.index }}')">
                                <i class="fas fa-chevron-down mr-1"></i> Read More
                            </div>
                        </div>
                        
                        {% if reply.attachments and reply.attachments|length > 0 %}
                        <div class="mt-2 border-t border-gray-100 pt-2">
                            <div class="text-xs text-gray-500 mb-1">Attachments:</div>
                            <div class="space-y-1">
                                {% for attachment in reply.attachments %}
                                    {% if attachment.type == 'file' %}
                                    <div class="flex items-center gap-2 p-1 bg-gray-50 rounded">
                                        <!-- Enhanced File Icon -->
                                        {% set filename = attachment.name %}
                                        {% if filename.endswith('.pdf') %}
                                            <i class="fas fa-file-pdf text-red-600 text-xs"></i>
                                        {% elif filename.endswith('.doc') or filename.endswith('.docx') %}
                                            <i class="fas fa-file-word text-blue-600 text-xs"></i>
                                        {% elif filename.endswith('.xls') or filename.endswith('.xlsx') %}
                                            <i class="fas fa-file-excel text-green-600 text-xs"></i>
                                        {% elif filename.endswith('.jpg') or filename.endswith('.jpeg') or filename.endswith('.png') or filename.endswith('.gif') %}
                                            <i class="fas fa-file-image text-purple-600 text-xs"></i>
                                        {% elif filename.endswith('.zip') or filename.endswith('.rar') %}
                                            <i class="fas fa-file-archive text-yellow-600 text-xs"></i>
                                        {% else %}
                                            <i class="fas fa-file text-gray-600 text-xs"></i>
                                        {% endif %}
                                        
                                        <!-- File Info -->
                                        <div class="flex-1 min-w-0">
                                            <p class="text-xs font-medium text-gray-800 truncate" title="{{ filename }}">
                                                {{ filename | truncate(20) }}
                                            </p>
                                            {% set file_ext = filename.split('.')[-1].upper() if '.' in filename else 'FILE' %}
                                            <p class="text-xs text-gray-500">
                                                {{ file_ext }}
                                                {% if attachment.size is defined and attachment.size > 0 %}
                                                 <span class="file-size-display" data-size="{{ attachment.size }}">{{ attachment.size }} bytes</span>
                                                {% endif %}
                                            </p>
                                        </div>
                                        
                                        <!-- Action Buttons -->
                                        <div class="flex gap-1">
                                            {% set is_viewable = filename.lower().endswith(('.pdf', '.jpg', '.jpeg', '.png', '.gif', '.txt')) %}
                                            {% if is_viewable %}
                                            <button class="px-1 py-1 bg-blue-100 text-blue-700 hover:bg-blue-200 rounded text-xs transition view-attachment-btn" 
                                                    data-filename="{{ filename }}" data-index="{{ loop.index0 }}" title="View">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            {% endif %}
                                            <button class="px-1 py-1 bg-gray-100 text-gray-700 hover:bg-gray-200 rounded text-xs transition download-attachment-btn" 
                                                    data-filename="{{ filename }}" data-index="{{ loop.index0 }}" title="Download">
                                                <i class="fas fa-download"></i>
                                            </button>
                                        </div>
                                    </div>
                                    {% elif attachment.type == 'common_doc' %}
                                    <div class="flex items-center gap-2 p-1 bg-blue-50 rounded">
                                        <i class="fas fa-file-alt text-blue-600 text-xs"></i>
                                        <div class="flex-1">
                                            <p class="text-xs font-medium text-blue-800">{{ attachment.ref }}</p>
                                            <p class="text-xs text-blue-600">Common Document</p>
                                        </div>
                                    <button onclick="viewCommonDocument('{{ attachment.ref }}')"
                                                class="px-1 py-1 bg-blue-100 text-blue-700 hover:bg-blue-200 rounded text-xs transition" title="View">
                                            <i class="fas fa-eye"></i>
                                    </button>
                                    </div>
                                    {% elif attachment.type == 'text_reference' %}
                                    <div class="flex items-center gap-2 p-1 bg-yellow-50 rounded">
                                        <i class="fas fa-tag text-yellow-600 text-xs"></i>
                                        <div class="flex-1">
                                            <p class="text-xs font-medium text-yellow-800">{{ attachment.name }}</p>
                                        {% if attachment.description %}
                                            <p class="text-xs text-yellow-600">{{ attachment.description }}</p>
                                        {% endif %}
                                        </div>
                                    </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                <!-- Reply Form -->
                <form id="replyForm" class="mt-2">
                    <div class="mb-1 relative">
                        <div class="flex items-start">
                            <div class="flex-grow">
                                <!-- Modern chat-style input area -->
                                <div class="bg-white border border-gray-300 rounded-lg shadow-sm overflow-hidden">
                                    <!-- Text input area -->
                                    <textarea id="response" name="response" rows="3"
                                        class="w-full px-2 py-1 outline-none border-0 resize-none"
                                        placeholder="Type your response here...">{{ ticket.draft_body }}</textarea>
                                        
                                    <!-- Hidden file input -->
                                    <input id="response_attachments" name="response_attachments" type="file" multiple class="hidden" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.xlsx,.xls">
                                    
                                    <!-- Preview area for attachments -->
                                    <div id="attachmentPreview" class="px-2 py-2 border-t border-gray-100 hidden"></div>
                                    
                                    <!-- Bottom toolbar -->
                                    <div class="flex items-center justify-between px-2 py-2 border-t border-gray-200">
                                        <div class="flex items-center space-x-1">
                                            <!-- Attachment button -->
                                            <button type="button" id="attachmentBtn" class="text-gray-500 hover:text-green-500 focus:outline-none p-1 rounded-full hover:bg-gray-100">
                                                <i class="fas fa-paperclip text-xs"></i>
                                            </button>
                                            

                                        </div>
                                        
                                        <!-- Send button -->
                                        <button type="submit" id="sendBtn" class="inline-flex items-center justify-center p-2 rounded-full bg-indigo-600 text-white hover:bg-indigo-700 focus:outline-none">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
                
                <!-- File Attachments Section (Hidden) - this is the dropzone for drag and drop -->
                <div id="attachmentSection" class="hidden">
                    <div id="attachmentDropzone" class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-indigo-400 transition">
                        <div class="space-y-1 text-center">
                            <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                            <div class="text-xs text-gray-600">
                                <label for="response_attachments" class="relative cursor-pointer rounded-md font-medium text-indigo-600 hover:text-indigo-500 focus-within:outline-none">
                                    <span>Upload files</span>
                                </label>
                                <p class="pl-1">or drag and drop</p>
                            </div>
                            <p class="text-xs text-gray-500">PDF, Word, Excel, Images up to 10MB each</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--  SIMPLE APP STYLE MODAL FOR ATTACHMENT PREVIEW -->
    <div id="attachmentModal" class="fixed inset-0 bg-black bg-opacity-80 z-50 hidden">
        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white p-5 rounded-lg max-w-[90%] max-h-[90%] overflow-auto">
            <span class="absolute right-4 top-4 text-3xl cursor-pointer text-gray-500 hover:text-gray-800" onclick="closeAttachmentModal()">&times;</span>
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        //  SIMPLE APP STYLE ATTACHMENT FUNCTIONS
        function previewAttachment(attachmentId, fileName) {
            const modal = document.getElementById('attachmentModal');
            const modalContent = document.getElementById('modalContent');
            
            const extension = fileName.split('.').pop().toLowerCase();
            
            if (['png', 'jpg', 'jpeg', 'gif'].includes(extension)) {
                modalContent.innerHTML = `
                    <h3 class="text-lg font-bold mb-4"> ${fileName}</h3>
                    <img src="/api/attachment/${attachmentId}" style="max-width: 100%; max-height: 70vh;" alt="${fileName}">
                `;
            } else if (extension === 'pdf') {
                modalContent.innerHTML = `
                    <h3 class="text-lg font-bold mb-4"> ${fileName}</h3>
                    <iframe src="/api/attachment/${attachmentId}" style="width: 100%; height: 70vh;" frameborder="0"></iframe>
                `;
            }
            
            modal.classList.remove('hidden');
        }

        function closeAttachmentModal() {
            document.getElementById('attachmentModal').classList.add('hidden');
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('attachmentModal');
            if (event.target === modal) {
                modal.classList.add('hidden');
            }
        }

    <script>
        // Notification system
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationMessage = document.getElementById('notification-message');

            notification.className = `notification ${type}`;
            notificationMessage.textContent = message;
            notification.classList.add('show');

            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Message expansion functionality
        function expandMessage(elementId) {
            const element = document.getElementById(elementId);
            element.classList.toggle('expanded');

            const btn = element.querySelector('.expand-btn') || element.querySelector('.read-more-btn');
            if (btn) {
                if (element.classList.contains('expanded')) {
                    btn.innerHTML = '<i class="fas fa-chevron-up mr-1"></i> Show Less';
                } else {
                    btn.innerHTML = '<i class="fas fa-chevron-down mr-1"></i> Read More';
                }
            }
        }

        // Modal control functions
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Assignment history dropdown functions
        function toggleAssignmentHistory() {
            const dropdown = document.getElementById('assignmentHistoryDropdown');
            dropdown.classList.toggle('hidden');
        }

        function toggleDetailedAssignmentHistory() {
            const modal = document.getElementById('detailedAssignmentHistoryModal');
            modal.classList.remove('hidden');
        }

        function closeDetailedAssignmentHistory() {
            const modal = document.getElementById('detailedAssignmentHistoryModal');
            modal.classList.add('hidden');
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('assignmentHistoryDropdown');
            if (dropdown && !e.target.closest('.relative')) {
                dropdown.classList.add('hidden');
            }
        });



        // Initialize message boxes
        function initMessageBoxes() {
            const originalMessage = document.getElementById('originalMessage');
            if (originalMessage && originalMessage.scrollHeight > originalMessage.clientHeight) {
                originalMessage.classList.add('truncated');
            }

            document.querySelectorAll('.reply-message-box').forEach(box => {
                if (box.scrollHeight > box.clientHeight) {
                    box.classList.add('truncated');
                }
            });
        }

        // Notes functionality
        function loadNotes() {
            const ticketId = "{{ ticket.ticket_id }}";
            const notesContainer = document.getElementById('notesContainer');

            // Get notes from localStorage (replace with API call in production)
            const notes = JSON.parse(localStorage.getItem(`ticket_notes_${ticketId}`)) || [];

            if (notes.length === 0) {
                notesContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-sticky-note"></i>
                        </div>
                        <p>No notes yet. Add your first note!</p>
                    </div>
                `;
                return;
            }

            notesContainer.innerHTML = '';
            notes.forEach((note, index) => {
                const noteElement = document.createElement('div');
                noteElement.className = 'note-card';
                noteElement.innerHTML = `
                    <div class="note-title">${note.title}</div>
                    <div class="note-content">${note.content}</div>
                    <div class="note-meta">
                        <span>${new Date(note.timestamp).toLocaleString()}</span>
                        <div class="note-actions">
                            <span class="note-action-btn" onclick="editNote(${index})">
                                <i class="fas fa-edit"></i>
                            </span>
                            <span class="note-action-btn" onclick="deleteNote(${index})">
                                <i class="fas fa-trash"></i>
                            </span>
                        </div>
                    </div>
                `;
                notesContainer.appendChild(noteElement);
            });
        }

        function saveNote() {
            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').value.trim();
            const ticketId = "{{ ticket.ticket_id }}";
            const noteIndex = document.getElementById('saveNote').getAttribute('data-note-index');

            if (!title || !content) {
                showNotification('Please fill in both title and content', 'error');
                return;
            }

            // Get existing notes
            const notes = JSON.parse(localStorage.getItem(`ticket_notes_${ticketId}`)) || [];

            if (noteIndex !== null) {
                // Update existing note
                notes[noteIndex] = {
                    title,
                    content,
                    timestamp: new Date().toISOString()
                };
            } else {
                // Add new note
                notes.push({
                    title,
                    content,
                    timestamp: new Date().toISOString()
                });
            }

            // Save back to storage
            localStorage.setItem(`ticket_notes_${ticketId}`, JSON.stringify(notes));

            // Refresh notes display
            loadNotes();

            // Close modal and show notification
            closeModal('noteModal');
            showNotification(noteIndex !== null ? 'Note updated successfully' : 'Note saved successfully');

            // Clear form
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteContent').value = '';
            document.getElementById('saveNote').removeAttribute('data-note-index');
        }

        function editNote(index) {
            const ticketId = "{{ ticket.ticket_id }}";
            const notes = JSON.parse(localStorage.getItem(`ticket_notes_${ticketId}`)) || [];

            if (index >= 0 && index < notes.length) {
                const note = notes[index];
                document.getElementById('noteTitle').value = note.title;
                document.getElementById('noteContent').value = note.content;

                // Store the index being edited in a data attribute
                document.getElementById('saveNote').setAttribute('data-note-index', index);

                openModal('noteModal');
            }
        }

        function deleteNote(index) {
            if (confirm('Are you sure you want to delete this note?')) {
                const ticketId = "{{ ticket.ticket_id }}";
                const notes = JSON.parse(localStorage.getItem(`ticket_notes_${ticketId}`)) || [];

                if (index >= 0 && index < notes.length) {
                    notes.splice(index, 1);
                    localStorage.setItem(`ticket_notes_${ticketId}`, JSON.stringify(notes));
                    loadNotes();
                    showNotification('Note deleted');
                }
            }
        }

        // Template functionality
        function loadTemplates() {
            const templatesContainer = document.getElementById('templatesContainer');

            // Get templates from localStorage (replace with API call in production)
            const templates = JSON.parse(localStorage.getItem('response_templates')) || [];

            if (templates.length === 0) {
                templatesContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">
                            <i class="fas fa-file-alt"></i>
                        </div>
                        <p>No templates yet. Add your first template!</p>
                    </div>
                `;
                return;
            }

            templatesContainer.innerHTML = '';
            templates.forEach((template, index) => {
                const templateElement = document.createElement('div');
                templateElement.className = 'template-item';
                templateElement.innerHTML = `
                    <div class="template-title">${template.title}</div>
                    <div class="template-content">${template.content.substring(0, 100)}${template.content.length > 100 ? '...' : ''}</div>
                    <div class="template-actions">
                        <button class="template-action-btn template-use-btn" onclick="useTemplate(${index})">
                            <i class="fas fa-paper-plane mr-1"></i> Use
                        </button>
                        <button class="template-action-btn template-edit-btn" onclick="editTemplate(${index})">
                            <i class="fas fa-edit mr-1"></i> Edit
                        </button>
                    </div>
                `;
                templatesContainer.appendChild(templateElement);
            });
        }
        
        // Document functions
        function loadDocuments() {
            console.log('Loading documents from localStorage');
            const documentsSection = document.getElementById('documentsContainer');
            
            if (!documentsSection) {
                console.error('Documents container not found');
                return;
            }
            
            const documents = JSON.parse(localStorage.getItem('common_documents')) || [];
            console.log(`Found ${documents.length} documents`);
            
            // Clear the container first
            documentsSection.innerHTML = '';
            
            if (documents.length === 0) {
                // Show empty state message
                documentsSection.innerHTML = `
                    <div class="text-center text-gray-500 p-4">
                        <i class="fas fa-folder-open text-3xl mb-1"></i>
                        <p class="text-xs">No documents yet. Click "Add Document" to get started.</p>
                    </div>
                `;
                return;
            }
            
            // Create document items
            documents.forEach((doc, index) => {
                const docItem = document.createElement('div');
                docItem.className = 'document-item flex items-center border-b border-gray-200 p-3 hover:bg-gray-50 cursor-pointer';
                docItem.dataset.index = index;
                
                // Choose appropriate icon based on document type
                let iconClass = 'fas fa-file-alt text-gray-500';
                if (doc.type === 'form') {
                    iconClass = 'fas fa-file-contract text-blue-500';
                } else if (doc.type === 'guide') {
                    iconClass = 'fas fa-book text-green-500';
                } else if (doc.type === 'manual') {
                    iconClass = 'fas fa-file-pdf text-red-500';
                } else if (doc.type === 'template') {
                    iconClass = 'fas fa-file-word text-indigo-500';
                }
                
                docItem.innerHTML = `
                    <i class="${iconClass} text-xs mr-2"></i>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs font-medium text-gray-900 truncate">${doc.name}</p>
                        <p class="text-xs text-gray-500 truncate">${doc.type.charAt(0).toUpperCase() + doc.type.slice(1)}</p>
                    </div>
                    <div class="flex space-x-1">
                        <button type="button" class="view-document-btn text-blue-500 hover:text-blue-700" title="View">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button type="button" class="edit-document-btn text-gray-500 hover:text-gray-700" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                    </div>
                `;
                
                documentsSection.appendChild(docItem);
                
                // Make document draggable
                docItem.setAttribute('draggable', 'true');
                docItem.addEventListener('dragstart', function(e) {
                    console.log(`Drag started for document ${index}`);
                    e.dataTransfer.setData('text', JSON.stringify({
                        type: 'common-document',
                        index: index
                    }));
                    // Add visual feedback
                    e.target.classList.add('opacity-50');
                });
                
                docItem.addEventListener('dragend', function(e) {
                    e.target.classList.remove('opacity-50');
                });
                
                // Add view button event handler
                const viewBtn = docItem.querySelector('.view-document-btn');
                if (viewBtn) {
                    viewBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        viewDocument(index);
                    });
                }
                
                // Add edit button event handler
                const editBtn = docItem.querySelector('.edit-document-btn');
                if (editBtn) {
                    editBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        editDocument(index);
                    });
                }
                
                // Add click handler for the entire item (for viewing)
                docItem.addEventListener('click', function() {
                    viewDocument(index);
                });
            });
            
            console.log('Documents loaded and made draggable');
        }
        
        function viewDocument(index) {
            const documents = JSON.parse(localStorage.getItem('common_documents')) || [];
            if (index >= 0 && index < documents.length) {
                const doc = documents[index];
                if (doc.url) {
                    window.open(doc.url, '_blank');
                } else {
                    showNotification('Document URL not available', 'error');
                }
            }
        }
        
        function editDocument(index) {
            const documents = JSON.parse(localStorage.getItem('common_documents')) || [];
            if (index >= 0 && index < documents.length) {
                const doc = documents[index];
                document.getElementById('documentName').value = doc.name;
                document.getElementById('documentType').value = doc.type;
                document.getElementById('documentDescription').value = doc.description || '';
                document.getElementById('selectedFileName').textContent = doc.fileName || 'Current file preserved';
                document.getElementById('documentModalTitle').textContent = 'Edit Document';
                document.getElementById('deleteDocument').classList.remove('hidden');
                document.getElementById('saveDocument').setAttribute('data-document-index', index);
                openModal('documentModal');
            }
        }
        
        function saveDocument() {
            const name = document.getElementById('documentName').value.trim();
            const type = document.getElementById('documentType').value;
            const fileInput = document.getElementById('documentFile');
            const description = document.getElementById('documentDescription').value.trim();
            const index = document.getElementById('saveDocument').getAttribute('data-document-index');
            
            if (!name) {
                showNotification('Please enter a document name', 'error');
                return;
            }
            
            // For this demo, we'll simulate file storage with localStorage
            // In a real app, you would upload files to a server and store URLs
            
            const documents = JSON.parse(localStorage.getItem('common_documents')) || [];
            
            // File handling would be different in a real app
            const hasNewFile = fileInput.files.length > 0;
            const fileName = hasNewFile ? fileInput.files[0].name : (index !== null ? documents[index].fileName : null);
            
            if (index !== null) {
                // Update existing document
                documents[index] = {
                    ...documents[index],
                    name,
                    type,
                    description,
                    fileName: fileName || documents[index].fileName,
                    // In a real app, if hasNewFile is true, you'd upload the file and update the URL
                    lastModified: new Date().toISOString()
                };
            } else {
                // Add new document
                if (!hasNewFile) {
                    showNotification('Please select a file', 'error');
                    return;
                }
                
                // In a real app, you'd upload the file and get a URL
                documents.push({
                    name,
                    type,
                    description,
                    fileName,
                    url: '#', // Placeholder URL
                    uploadDate: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                });
            }
            
            // Save updated documents
            localStorage.setItem('common_documents', JSON.stringify(documents));
            
            // Refresh documents display
            loadDocuments();
            
            // Close modal and show notification
            closeModal('documentModal');
            showNotification(index !== null ? 'Document updated successfully' : 'Document saved successfully');
        }
        
        function deleteDocument() {
            const index = document.getElementById('saveDocument').getAttribute('data-document-index');
            
            if (index !== null && confirm('Are you sure you want to delete this document?')) {
                const documents = JSON.parse(localStorage.getItem('common_documents')) || [];
                
                if (index >= 0 && index < documents.length) {
                    // In a real app, you might need to delete the file from server
                    documents.splice(index, 1);
                    localStorage.setItem('common_documents', JSON.stringify(documents));
                    loadDocuments();
                    closeModal('documentModal');
                    showNotification('Document deleted successfully');
                }
            }
        }

        function useTemplate(index) {
            const templates = JSON.parse(localStorage.getItem('response_templates')) || [];

            if (index >= 0 && index < templates.length) {
                document.getElementById('response').value = templates[index].content;
                showNotification('Template applied to response');
            }
        }

        function editTemplate(index = -1) {
            const templates = JSON.parse(localStorage.getItem('response_templates')) || [];

            if (index >= 0 && index < templates.length) {
                // Editing existing template
                const template = templates[index];
                document.getElementById('templateTitle').value = template.title;
                document.getElementById('templateContent').value = template.content;
                document.getElementById('editTemplateTitle').textContent = 'Edit Template';
                document.getElementById('deleteTemplate').classList.remove('hidden');
                document.getElementById('saveTemplate').setAttribute('data-template-index', index);
            } else {
                // Creating new template
                document.getElementById('templateTitle').value = '';
                document.getElementById('templateContent').value = '';
                document.getElementById('editTemplateTitle').textContent = 'Add New Template';
                document.getElementById('deleteTemplate').classList.add('hidden');
                document.getElementById('saveTemplate').removeAttribute('data-template-index');
            }

            openModal('editTemplateModal');
        }

        function saveTemplate() {
            const title = document.getElementById('templateTitle').value.trim();
            const content = document.getElementById('templateContent').value.trim();
            const index = document.getElementById('saveTemplate').getAttribute('data-template-index');

            if (!title || !content) {
                showNotification('Please fill in both title and content', 'error');
                return;
            }

            const templates = JSON.parse(localStorage.getItem('response_templates')) || [];

            if (index !== null) {
                // Update existing template
                templates[index] = { title, content };
            } else {
                // Add new template
                templates.push({ title, content });
            }

            localStorage.setItem('response_templates', JSON.stringify(templates));
            loadTemplates();
            closeModal('editTemplateModal');
            showNotification(index !== null ? 'Template updated successfully' : 'Template saved successfully');
        }

        function deleteTemplate() {
            const index = document.getElementById('saveTemplate').getAttribute('data-template-index');

            if (index !== null && confirm('Are you sure you want to delete this template?')) {
                const templates = JSON.parse(localStorage.getItem('response_templates')) || [];

                if (index >= 0 && index < templates.length) {
                    templates.splice(index, 1);
                    localStorage.setItem('response_templates', JSON.stringify(templates));
                    loadTemplates();
                    closeModal('editTemplateModal');
                    showNotification('Template deleted');
                }
            }
        }

        // Status dropdown functionality
        function setupStatusDropdown() {
            const dropdownBtn = document.getElementById('statusDropdownBtn');
            const dropdownContent = document.getElementById('statusDropdownContent');

            // Toggle dropdown - Fix: Use hidden class instead of show
            if (dropdownBtn && dropdownContent) {
            dropdownBtn.addEventListener('click', function (e) {
                e.stopPropagation();
                    dropdownContent.classList.toggle('hidden');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', function () {
                    dropdownContent.classList.add('hidden');
            });
            }

            // Handle status selection
            document.querySelectorAll('.status-option').forEach(option => {
                option.addEventListener('click', async function () {
                    const newStatus = this.getAttribute('data-status');

                    try {
                        const response = await fetch(`/api/tickets/{{ ticket.ticket_id }}/status`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                status: newStatus
                            })
                        });

                        if (response.ok) {
                            window.location.reload();
                        } else {
                            const error = await response.json();
                            showNotification(error.message || 'Failed to update status', 'error');
                        }
                    } catch (error) {
                        console.error('Error updating status:', error);
                        showNotification('Failed to update status', 'error');
                    }
                });
            });
        }

        // ============ CONSOLIDATED BUTTON INITIALIZATION - FIXED VERSION ============
        document.addEventListener('DOMContentLoaded', function () {
            console.log(' Initializing Ticket Detail Page - CLEAN VERSION');
            
            // Initialize core components
            initMessageBoxes();
            loadNotes();
            loadTemplates();
            loadDocuments();
            setupStatusDropdown();
            setupAttachmentHandlers();
            
            // Initialize all button functionality
            initializeAllButtonsFinal();
        });
        
        function initializeAllButtonsFinal() {
            console.log(' Setting up all buttons with proper event handling');
            
            const ticketId = '{{ ticket.ticket_id }}';
            const currentUserId = "{{ session.member_id }}";
            
            // ============ TAKE OVER BUTTON ============
            const takeOverBtn = document.getElementById('takeOverBtn');
            if (takeOverBtn) {
                takeOverBtn.addEventListener('click', async function() {
                    try {
                        console.log(' Take Over button clicked');
                        takeOverBtn.disabled = true;
                        takeOverBtn.innerHTML = ' Taking Over...';
                        
                        const response = await fetch(`/api/tickets/${ticketId}/assign`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                member_id: currentUserId,
                                notes: '',
                                is_forwarded: false,
                                forwarded_from: null
                            })
                        });

                        const data = await response.json();
                        if (response.ok && data.status === 'success') {
                            showNotification(' Ticket taken over successfully!', 'success');
                            // PERFORMANCE FIX: Reduced reload delay
                        setTimeout(() => window.location.reload(), 3000);
                        } else {
                            showNotification(data.message || 'Error taking over ticket', 'error');
                            takeOverBtn.disabled = false;
                            takeOverBtn.innerHTML = '<i class="fas fa-hand-paper mr-1"></i>Take Over';
                        }
                    } catch (error) {
                        console.error(' Take Over Error:', error);
                        showNotification('An error occurred while taking over ticket', 'error');
                        takeOverBtn.disabled = false;
                        takeOverBtn.innerHTML = '<i class="fas fa-hand-paper mr-1"></i>Take Over';
                    }
                });
            }

            // ============ REFER TO TECH DIRECTOR BUTTON ============
            const referToTechDirectorBtn = document.getElementById('referToTechDirectorBtn');
            if (referToTechDirectorBtn) {
                referToTechDirectorBtn.addEventListener('click', async function() {
                    if (!confirm('Are you sure you want to refer this ticket to the Technical Director?\n\nThis will:\n Change ticket status to "Referred to Tech Director"\n Send email notification to Tech Director\n Schedule AI-powered reminder via n8n workflow\n\nClick OK to proceed.')) {
                        return;
                    }

                    try {
                        console.log(' Refer to Tech Director clicked');
                        referToTechDirectorBtn.disabled = true;
                        referToTechDirectorBtn.innerHTML = ' Referring...';

                        const response = await fetch(`/api/tickets/${ticketId}/tech-director`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });

                        const data = await response.json();
                        
                        if (response.ok && data.status === 'success') {
                            showNotification(` Ticket successfully referred to Tech Director!\n Real-time Mode: ${data.real_time_mode ? 'Active' : 'Inactive'}\n Webhook: ${data.webhook_queued ? 'Queued' : 'Failed'}\n Email: ${data.email_sent ? 'Sent' : 'Failed'}`, 'success');
                            
                            // Log the response for debugging
                            console.log(' Tech Director Referral Success (Real-time):', data);
                            
                            // Reload page after brief delay to show updated status
                            // PERFORMANCE FIX: Reduced reload delay
                        setTimeout(() => window.location.reload(), 3000);
                        } else {
                            showNotification(data.message || 'Error referring ticket to Tech Director', 'error');
                            
                            // Re-enable button on error
                            referToTechDirectorBtn.disabled = false;
                            referToTechDirectorBtn.innerHTML = '<i class="fas fa-user-cog mr-1"></i> Refer to Tech Director';
                        }
                    } catch (error) {
                        console.error(' Tech Director Referral Error:', error);
                        showNotification('An error occurred while referring ticket to Tech Director', 'error');
                        
                        // Re-enable button on error
                        referToTechDirectorBtn.disabled = false;
                        referToTechDirectorBtn.innerHTML = '<i class="fas fa-user-cog mr-1"></i> Refer to Tech Director';
                    }
                });
            }

            // Forward Button - Show modal to select member
            const forwardBtn = document.getElementById('forwardBtn');
            if (forwardBtn) {
                forwardBtn.addEventListener('click', function() {
                    assignModalTitle.textContent = 'Forward Ticket';
                    forwardNotesContainer.style.display = 'block';
                    assignModal.classList.add('active');
                });
            }

            // Close assign modal
            function closeAssignModalFunc() {
                assignModal.classList.remove('active');
            }

            if (closeAssignModal) closeAssignModal.addEventListener('click', closeAssignModalFunc);
            if (cancelAssign) cancelAssign.addEventListener('click', closeAssignModalFunc);

            // Confirm assignment (only for forwarding - Take Over bypasses modal)
            if (confirmAssign) {
                confirmAssign.addEventListener('click', async function() {
                    const memberId = assignMemberSelect.value;
                    const notes = assignNotes.value;

                    if (!memberId) {
                        showNotification('Please select a member to forward to', 'error');
                        return;
                    }

                    try {
                        const response = await fetch(`/api/tickets/${ticketId}/assign`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                member_id: memberId,
                                notes: notes,
                                is_forwarded: true,
                                forwarded_from: currentUserId
                            })
                        });

                        const data = await response.json();
                        if (response.ok && data.status === 'success') {
                            showNotification(`Ticket forwarded successfully!`, 'success');
                            // PERFORMANCE FIX: Reduced reload delay
                        setTimeout(() => window.location.reload(), 3000);
                        } else {
                            showNotification(data.message || 'Error forwarding ticket', 'error');
                        }
                    } catch (error) {
                        console.error('Error:', error);
                        showNotification('An error occurred while forwarding ticket', 'error');
                    }
                });
            }

            //  IMPORTANCE BUTTON - FIXED
            const importantBtn = document.getElementById('importantBtn');
            if (importantBtn && !importantBtn._eventListenerAdded) {
                console.log(' Setting up Important button');
                importantBtn.addEventListener('click', async function () {
                    try {
                        console.log(' Important button clicked');
                        
                        // Disable button during request
                        importantBtn.disabled = true;
                        
                        const response = await fetch(`/api/tickets/{{ ticket.ticket_id }}/important`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' }
                        });

                        const data = await response.json();
                        if (response.ok && data.status === 'success') {
                            // Find the icon directly within the button
                            const icon = importantBtn.querySelector('i');

                            if (icon) {
                            if (icon.classList.contains('far')) {
                                // Change from empty star to filled star
                                icon.classList.remove('far');
                                    icon.classList.add('fas', 'text-amber-500');
                                    importantBtn.classList.remove('bg-gray-100', 'text-gray-600');
                                    importantBtn.classList.add('bg-amber-100', 'text-amber-700');
                                    showNotification(' Ticket marked as important', 'success');
                            } else {
                                // Change from filled star to empty star
                                    icon.classList.remove('fas', 'text-amber-500');
                                icon.classList.add('far');
                                    importantBtn.classList.remove('bg-amber-100', 'text-amber-700');
                                    importantBtn.classList.add('bg-gray-100', 'text-gray-600');
                                    showNotification(' Ticket importance removed', 'success');
                                }
                            }
                        } else {
                            showNotification(data.message || 'Error toggling important status', 'error');
                        }
                    } catch (error) {
                        console.error(' Important button error:', error);
                        showNotification('An error occurred while updating importance', 'error');
                    } finally {
                        // Re-enable button
                        importantBtn.disabled = false;
                    }
                });
                importantBtn._eventListenerAdded = true;
            }
            
            // Mobile sidebar toggle functionality
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebar = document.querySelector('.right-sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            
            if (sidebarToggle && sidebar && sidebarOverlay) {
                // Toggle sidebar on button click
                sidebarToggle.addEventListener('click', function() {
                    sidebar.classList.toggle('mobile-open');
                    sidebarOverlay.classList.toggle('active');
                    
                    // Update icon
                    const icon = sidebarToggle.querySelector('i');
                    if (sidebar.classList.contains('mobile-open')) {
                        icon.classList.replace('fa-bars', 'fa-times');
                    } else {
                        icon.classList.replace('fa-times', 'fa-bars');
                    }
                });
                
                // Close sidebar when clicking overlay
                sidebarOverlay.addEventListener('click', function() {
                    sidebar.classList.remove('mobile-open');
                    sidebarOverlay.classList.remove('active');
                    
                    const icon = sidebarToggle.querySelector('i');
                    icon.classList.replace('fa-times', 'fa-bars');
                });
                
                // Close sidebar on escape key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && sidebar.classList.contains('mobile-open')) {
                        sidebar.classList.remove('mobile-open');
                        sidebarOverlay.classList.remove('active');
                        
                        const icon = sidebarToggle.querySelector('i');
                        icon.classList.replace('fa-times', 'fa-bars');
                    }
                });
            }

            // Reply Form
            const replyForm = document.getElementById('replyForm');
            if (replyForm) {
                replyForm.addEventListener('submit', async function (e) {
                    e.preventDefault();

                    const sendBtn = document.getElementById('sendBtn');
                    const responseTextarea = document.querySelector('textarea[name="response"]');

                    // Disable button during submission
                    sendBtn.disabled = true;
                    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Sending...';

                    try {
                        const response = await fetch(`/api/tickets/{{ ticket.ticket_id }}/reply`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: new URLSearchParams({
                                response: responseTextarea.value
                            })
                        });

                        if (response.ok) {
                            // Clear the textarea after successful submission
                            responseTextarea.value = '';
                            // Redirect to refresh the page and show the reply
                            window.location.href = `/ticket/{{ ticket.ticket_id }}`;
                        } else {
                            const error = await response.json();
                            alert('Error: ' + error.message);
                        }
                    } catch (err) {
                        console.error('Error:', err);
                        alert('An error occurred while sending the response');
                    } finally {
                        sendBtn.disabled = false;
                        sendBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i> Send Response';
                    }
                });
            }

            // Click handler for expanding original message in modal
            const originalMessage = document.getElementById('originalMessage');
            if (originalMessage) {
                originalMessage.addEventListener('click', function (e) {
                    if (e.target.classList.contains('read-more-btn')) return;
                    if (this.classList.contains('truncated')) {
                        const modalContent = document.getElementById('modalMessageContent');
                        modalContent.textContent = this.textContent.trim();
                        openModal('messageModal');
                    }
                });
            }

            // Click handler for expanding reply messages in modal
            document.querySelectorAll('.reply-message-box').forEach(box => {
                box.addEventListener('click', function (e) {
                    if (e.target.classList.contains('expand-btn')) return;
                    if (this.classList.contains('truncated')) {
                        const modalContent = document.getElementById('modalMessageContent');
                        modalContent.textContent = this.querySelector('.message-content').textContent.trim();
                        openModal('messageModal');
                    }
                });
            });
        });

        // Handle file input change event
        document.getElementById('documentFile').addEventListener('change', function() {
            const fileName = this.files.length > 0 ? this.files[0].name : 'No file selected';
            document.getElementById('selectedFileName').textContent = fileName;
        });
        
        // Response attachment handling
        function setupAttachmentHandlers() {
            console.log('Setting up attachment handlers');
            const dropzone = document.getElementById('attachmentDropzone');
            const fileInput = document.getElementById('response_attachments');
            const attachmentPreview = document.getElementById('attachmentPreview');
            const replyForm = document.getElementById('replyForm');
            const textarea = document.getElementById('response');
            const responseArea = textarea.parentElement;
            // Use a Set to track unique files and prevent duplicates
            let attachedFilesSet = new Set();
            let attachedFiles = [];
            
            // Handle standard file input change
            fileInput.addEventListener('change', function(e) {
                console.log('File input change detected', this.files.length, 'files');
                
                if (this.files.length === 0) return; // No files selected
                
                // Reset the files array to avoid duplicates
                attachedFiles = [];
                
                // Process the new files
                handleAttachedFiles(this.files);
                
                // Clear the input to allow selecting the same files again
                this.value = '';
            });
            
            // Handle click on attachment button - SINGLE SOURCE OF TRUTH
            const attachmentBtn = document.getElementById('attachmentBtn');
            if (attachmentBtn) {
                attachmentBtn.addEventListener('click', function(e) {
                    e.preventDefault(); // Prevent any default action
                    e.stopPropagation(); // Stop event from bubbling
                    console.log('Attachment button clicked');
                    
                    // Trigger file input click
                    fileInput.click();
                });
            }
            
            // Make the entire text area a drop zone
            textarea.addEventListener('dragover', function(e) {
                e.preventDefault();
                textarea.classList.add('bg-gray-50');
            });
            
            textarea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                textarea.classList.remove('bg-gray-50');
            });
            
            textarea.addEventListener('drop', function(e) {
                e.preventDefault();
                textarea.classList.remove('bg-gray-50');
                
                if (e.dataTransfer.files.length > 0) {
                    console.log('Files dropped in textarea');
                    handleAttachedFiles(e.dataTransfer.files);
                } else if (e.dataTransfer.getData('text')) {
                    // This might be a document dragged from the Common Documents section
                    try {
                        const docData = JSON.parse(e.dataTransfer.getData('text'));
                        if (docData && docData.type === 'common-document') {
                            addCommonDocumentAttachment(docData.index);
                        }
                    } catch (err) {
                        console.error('Error parsing dragged data:', err);
                    }
                }
            });
            
            // Handle drag and drop in the dedicated dropzone
            if (dropzone) {
                dropzone.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    dropzone.classList.add('border-indigo-500', 'bg-indigo-50');
                });
                
                dropzone.addEventListener('dragleave', function(e) {
                    e.preventDefault();
                    dropzone.classList.remove('border-indigo-500', 'bg-indigo-50');
                });
                
                dropzone.addEventListener('drop', function(e) {
                    e.preventDefault();
                    dropzone.classList.remove('border-indigo-500', 'bg-indigo-50');
                    
                    if (e.dataTransfer.files.length > 0) {
                        console.log('Files dropped in dropzone');
                        handleAttachedFiles(e.dataTransfer.files);
                    } else if (e.dataTransfer.getData('text')) {
                        try {
                            const docData = JSON.parse(e.dataTransfer.getData('text'));
                            if (docData && docData.type === 'common-document') {
                                addCommonDocumentAttachment(docData.index);
                            }
                        } catch (err) {
                            console.error('Error parsing dragged data:', err);
                        }
                    }
                });
            }
            
            // Make document items in Common Documents section draggable
            function makeDocumentsDraggable() {
                console.log('Making documents draggable');
                const docItems = document.querySelectorAll('.document-item');
                
                docItems.forEach((item, index) => {
                    console.log(`Making document ${index} draggable`);
                    item.setAttribute('draggable', 'true');
                    
                    item.addEventListener('dragstart', function(e) {
                        console.log(`Drag started for document ${index}`);
                        e.dataTransfer.setData('text', JSON.stringify({
                            type: 'common-document',
                            index: index
                        }));
                    });
                });
            }
            
            // Call this function after loading documents
            const originalLoadDocuments = window.loadDocuments;
            window.loadDocuments = function() {
                console.log('Overridden loadDocuments called');
                originalLoadDocuments.call();
                setTimeout(makeDocumentsDraggable, 100); // Give time for DOM updates
            };
            
            // Make sure we call makeDocumentsDraggable once right away
            setTimeout(makeDocumentsDraggable, 500);
            
            // Helper function to generate a unique ID for files
            function getFileId(file) {
                return `${file.name}-${file.size}-${file.lastModified}`;
            }
            
            // Handle files added through input or drop
            function handleAttachedFiles(files) {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const fileId = getFileId(file);
                    
                    // Check file size (10MB max)
                    if (file.size > 10 * 1024 * 1024) {
                        showNotification(`File ${file.name} is too large. Maximum size is 10MB.`, 'error');
                        continue;
                    }
                    
                    // Skip if this file is already attached (prevent duplicates)
                    if (attachedFilesSet.has(fileId)) {
                        console.log(`File ${file.name} already attached, skipping`);
                        continue;
                    }
                    
                    // Add to tracked files
                    attachedFilesSet.add(fileId);
                    attachedFiles.push(file);
                    
                    // Create preview item
                    createAttachmentPreview(file, fileId);
                }
                
                // Show the preview area if we have attachments
                if (attachedFiles.length > 0 && attachmentPreview.classList.contains('hidden')) {
                    attachmentPreview.classList.remove('hidden');
                }
            }
            
            // Add a document from Common Documents
            function addCommonDocumentAttachment(index) {
                console.log(`Adding common document attachment: ${index}`);
                const documents = JSON.parse(localStorage.getItem('common_documents')) || [];
                console.log('Available documents:', documents);
                
                if (index >= 0 && index < documents.length) {
                    const doc = documents[index];
                    console.log('Adding document:', doc);
                    
                    // Check if this document is already attached (prevent duplicates)
                    const docId = `common-doc-${index}`;
                    if (document.querySelector(`input[data-doc-id="${docId}"]`)) {
                        console.log(`Document ${doc.name} already attached, skipping`);
                        return;
                    }
                    
                    // In a real app, you would have the actual file or a reference to it
                    // For this demo, we'll simulate it with a placeholder
                    const commonDocPreview = document.createElement('div');
                    commonDocPreview.className = 'inline-flex items-center bg-indigo-50 rounded-md px-2 py-1 mr-2 mb-1';
                    commonDocPreview.dataset.docId = docId;
                    
                    let iconClass = 'fas fa-file-alt text-gray-500';
                    if (doc.type === 'form') {
                        iconClass = 'fas fa-file-contract text-blue-500';
                    } else if (doc.type === 'guide') {
                        iconClass = 'fas fa-book text-green-500';
                    } else if (doc.type === 'manual') {
                        iconClass = 'fas fa-file-pdf text-red-500';
                    } else if (doc.type === 'template') {
                        iconClass = 'fas fa-file-word text-indigo-500';
                    }
                    
                    commonDocPreview.innerHTML = `
                        <i class="${iconClass} mr-1 text-xs"></i>
                        <span class="text-xs font-medium truncate max-w-[120px]">${doc.name}</span>
                        <button type="button" class="remove-attachment ml-1 text-gray-400 hover:text-red-500 focus:outline-none">
                            <i class="fas fa-times-circle text-xs"></i>
                        </button>
                        <input type="hidden" name="common_document_ids[]" value="${index}" data-doc-id="${docId}">
                    `;
                    
                    if (attachmentPreview.classList.contains('hidden')) {
                        attachmentPreview.classList.remove('hidden');
                    }
                    
                    attachmentPreview.appendChild(commonDocPreview);
                    
                    // Add remove functionality
                    const removeBtn = commonDocPreview.querySelector('.remove-attachment');
                    removeBtn.addEventListener('click', function() {
                        commonDocPreview.remove();
                        // Hide preview area if empty
                        if (attachmentPreview.children.length === 0) {
                            attachmentPreview.classList.add('hidden');
                        }
                    });
                    
                    showNotification(`Added document: ${doc.name}`);
                } else {
                    console.error(`Invalid document index: ${index}`);
                }
            }
            
            // Create preview for uploaded files
            function createAttachmentPreview(file, fileId) {
                const preview = document.createElement('div');
                preview.className = 'inline-flex items-center bg-gray-100 rounded-md px-2 py-1 mr-2 mb-1';
                preview.dataset.fileId = fileId;
                
                let iconClass = 'fas fa-file text-gray-500';
                const fileType = file.name.split('.').pop().toLowerCase();
                
                if (['pdf'].includes(fileType)) {
                    iconClass = 'fas fa-file-pdf text-red-500';
                } else if (['doc', 'docx'].includes(fileType)) {
                    iconClass = 'fas fa-file-word text-blue-500';
                } else if (['xls', 'xlsx'].includes(fileType)) {
                    iconClass = 'fas fa-file-excel text-green-500';
                } else if (['jpg', 'jpeg', 'png', 'gif'].includes(fileType)) {
                    iconClass = 'fas fa-file-image text-purple-500';
                }
                
                preview.innerHTML = `
                    <i class="${iconClass} mr-1 text-xs"></i>
                    <span class="text-xs font-medium truncate max-w-[120px]" title="${file.name}">${file.name}</span>
                    <span class="text-xs text-gray-500 mx-1">(${formatFileSize(file.size)})</span>
                    <button type="button" class="remove-attachment text-gray-400 hover:text-red-500 focus:outline-none">
                        <i class="fas fa-times-circle text-xs"></i>
                    </button>
                `;
                
                if (attachmentPreview.classList.contains('hidden')) {
                    attachmentPreview.classList.remove('hidden');
                }
                
                attachmentPreview.appendChild(preview);
                
                // Add remove functionality
                const removeBtn = preview.querySelector('.remove-attachment');
                removeBtn.addEventListener('click', function() {
                    const index = attachedFiles.indexOf(file);
                    if (index > -1) {
                        attachedFiles.splice(index, 1);
                    }
                    attachedFilesSet.delete(fileId);
                    preview.remove();
                    
                    // Hide preview area if empty
                    if (attachmentPreview.children.length === 0) {
                        attachmentPreview.classList.add('hidden');
                    }
                });
            }
            
            // Format file size for display
            function formatFileSize(bytes) {
                if (bytes < 1024) return bytes + ' B';
                else if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
                else return (bytes / 1048576).toFixed(1) + ' MB';
            }

            // Advanced attachment viewing function
            function viewAttachment(filename) {
                const fileUrl = `/uploads/${filename}`;
                const fileExtension = filename.split('.').pop().toLowerCase();
                
                // Determine if file can be viewed in browser
                const viewableExtensions = ['pdf', 'jpg', 'jpeg', 'png', 'gif', 'txt', 'html'];
                
                if (viewableExtensions.includes(fileExtension)) {
                    // Open in new tab for viewing
                    window.open(fileUrl, '_blank');
                } else {
                    // For non-viewable files, trigger download
                    downloadAttachment(filename);
                }
            }

            //  FIXED: Enhanced download function for both manual and email attachments
            function downloadAttachment(filename, attachmentIndex) {
                // If attachmentIndex is provided (new way), use the API endpoint
                if (typeof attachmentIndex !== 'undefined') {
                    const ticketId = '{{ ticket.ticket_id }}';
                    const apiUrl = `/api/tickets/${ticketId}/attachments/${attachmentIndex}/download`;
                    
                    const link = document.createElement('a');
                    link.href = apiUrl;
                    link.download = filename;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    console.log(` Downloading attachment via API: ${filename} (index: ${attachmentIndex})`);
                } else {
                    // Fallback to old method (for backwards compatibility)
                    const link = document.createElement('a');
                    link.href = `/uploads/${filename}`;
                    link.download = filename;
                    link.style.display = 'none';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    console.log(` Downloading attachment via uploads: ${filename}`);
                }
            }
            
            //  FIXED: Enhanced viewing function for both types
            function viewAttachment(filename, attachmentIndex) {
                const fileExtension = filename.split('.').pop().toLowerCase();
                const viewableExtensions = ['pdf', 'jpg', 'jpeg', 'png', 'gif', 'txt', 'html'];
                
                if (viewableExtensions.includes(fileExtension)) {
                    if (typeof attachmentIndex !== 'undefined') {
                        // For API-based attachments, we need to download and view
                        const ticketId = '{{ ticket.ticket_id }}';
                        const apiUrl = `/api/tickets/${ticketId}/attachments/${attachmentIndex}/download`;
                        window.open(apiUrl, '_blank');
                        console.log(` Viewing attachment via API: ${filename}`);
                    } else {
                        // For uploaded files, use the old method
                        const fileUrl = `/uploads/${filename}`;
                        window.open(fileUrl, '_blank');
                        console.log(` Viewing attachment via uploads: ${filename}`);
                    }
                } else {
                    // For non-viewable files, trigger download
                    downloadAttachment(filename, attachmentIndex);
                }
            }

            // Get file type info for display
            function getFileTypeInfo(filename) {
                const extension = filename.split('.').pop().toLowerCase();
                const fileTypes = {
                    'pdf': { icon: 'fas fa-file-pdf', color: 'text-red-600', type: 'PDF Document' },
                    'doc': { icon: 'fas fa-file-word', color: 'text-blue-600', type: 'Word Document' },
                    'docx': { icon: 'fas fa-file-word', color: 'text-blue-600', type: 'Word Document' },
                    'xls': { icon: 'fas fa-file-excel', color: 'text-green-600', type: 'Excel Spreadsheet' },
                    'xlsx': { icon: 'fas fa-file-excel', color: 'text-green-600', type: 'Excel Spreadsheet' },
                    'jpg': { icon: 'fas fa-file-image', color: 'text-purple-600', type: 'JPEG Image' },
                    'jpeg': { icon: 'fas fa-file-image', color: 'text-purple-600', type: 'JPEG Image' },
                    'png': { icon: 'fas fa-file-image', color: 'text-purple-600', type: 'PNG Image' },
                    'gif': { icon: 'fas fa-file-image', color: 'text-purple-600', type: 'GIF Image' },
                    'txt': { icon: 'fas fa-file-alt', color: 'text-gray-600', type: 'Text File' },
                    'zip': { icon: 'fas fa-file-archive', color: 'text-yellow-600', type: 'ZIP Archive' },
                    'rar': { icon: 'fas fa-file-archive', color: 'text-yellow-600', type: 'RAR Archive' }
                };
                
                return fileTypes[extension] || { icon: 'fas fa-file', color: 'text-gray-600', type: 'File' };
            }
            
            // Update form submission to include files
            if (replyForm) {
                replyForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const sendBtn = document.getElementById('sendBtn');
                    const responseTextarea = document.querySelector('textarea[name="response"]');
                    
                    // Validate that there's text content or attachments
                    if (!responseTextarea.value.trim() && attachedFiles.length === 0 && 
                        document.querySelectorAll('input[name="common_document_ids[]"]').length === 0) {
                        alert('Please enter a response or add attachments before sending.');
                        return;
                    }
                    
                    // Disable button during submission
                    sendBtn.disabled = true;
                    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                    
                    // Create FormData object for submission
                    const formData = new FormData();
                    formData.append('response', responseTextarea.value);
                    
                    // Add attached files
                    attachedFiles.forEach((file, i) => {
                        formData.append(`attachment_${i}`, file);
                    });
                    
                    // Add common document references
                    document.querySelectorAll('input[name="common_document_ids[]"]').forEach((input, i) => {
                        formData.append(`common_document_${i}`, input.value);
                    });
                    
                    // Submit the form using fetch API
                    fetch(`/api/tickets/{{ ticket.ticket_id }}/reply`, {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => {
                        if (response.ok) {
                            // Clear the textarea after successful submission
                            responseTextarea.value = '';
                            // Redirect to refresh the page and show the reply
                            window.location.href = `/ticket/{{ ticket.ticket_id }}`;
                        } else {
                            return response.json().then(error => {
                                throw new Error(error.message || 'An error occurred');
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Error: ' + error.message);
                        
                        // Re-enable button
                        sendBtn.disabled = false;
                        sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                    });
                });
            }
            
            // Add handler for the "Show Attachments" button in dropdown
            const showAttachmentsBtn = document.getElementById('showAttachmentsBtn');
            if (showAttachmentsBtn) {
                showAttachmentsBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Show attachments button clicked');
                    // Just trigger the attachmentBtn click which will trigger file input
                    if (attachmentBtn) {
                        attachmentBtn.click();
                    }

                });
            }
        }
        


        // Function to view common documents from reply attachments
        function viewCommonDocument(index) {
            viewDocument(parseInt(index));
        }

        // Initialize everything when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing components');
            
            // Add sample documents for testing if none exist
            if (!localStorage.getItem('common_documents')) {
                console.log('No documents found, adding samples');
                const sampleDocs = [
                    {
                        name: 'Warranty Claim Form',
                        type: 'form',
                        file: null,
                        description: 'Standard form for warranty claim submissions.'
                    },
                    {
                        name: 'DPF Troubleshooting Guide',
                        type: 'guide',
                        file: null,
                        description: 'Guide for diagnosing common DPF issues.'
                    },
                    {
                        name: 'Service Procedure Manual',
                        type: 'manual',
                        file: null,
                        description: 'Official service procedures for warranty work.'
                    }
                ];
                localStorage.setItem('common_documents', JSON.stringify(sampleDocs));
            }
            
            // Load existing documents
            loadDocuments();
            
            // Setup event handlers for attachments
            setupAttachmentHandlers();
            


        });
        
        // Call makeDocumentsDraggable periodically to catch any new documents
        setInterval(function() {
            const docItems = document.querySelectorAll('.document-item:not([draggable="true"])');
            if (docItems.length > 0) {
                console.log(`Found ${docItems.length} new document items to make draggable`);
                docItems.forEach((item, index) => {
                    item.setAttribute('draggable', 'true');
                    
                    item.addEventListener('dragstart', function(e) {
                        const allItems = document.querySelectorAll('.document-item');
                        const thisIndex = Array.from(allItems).indexOf(item);
                        console.log(`Drag started for document ${thisIndex}`);
                        e.dataTransfer.setData('text', JSON.stringify({
                            type: 'common-document',
                            index: thisIndex
                        }));
                    });
                });
            }
        }, 2000);

        document.addEventListener('DOMContentLoaded', function() {
            console.log(' Ticket Detail page loaded');
            
            // Forward ticket functionality
            const forwardModal = document.getElementById('forwardModal');
            const forwardBtn = document.getElementById('forwardBtn');
            const closeForwardModalBtn = document.getElementById('closeForwardModal');
            const cancelForwardBtn = document.getElementById('cancelForward');
            const confirmForwardBtn = document.getElementById('confirmForward');
            
            if (forwardBtn) {
                forwardBtn.addEventListener('click', () => {
                    console.log(' Forward button clicked');
                    
                    // Reset form when opening
                    const memberSelectEl = document.getElementById('forwardMemberSelect');
                    const notesEl = document.getElementById('forwardNotes');
                    if (memberSelectEl) memberSelectEl.value = '';
                    if (notesEl) notesEl.value = '';
                    
                    // Open modal using the helper function
                    openModal('forwardModal');
                });
            }
            
            if (closeForwardModalBtn) {
                closeForwardModalBtn.addEventListener('click', () => closeModal('forwardModal'));
            }
            
            if (cancelForwardBtn) {
                cancelForwardBtn.addEventListener('click', () => closeModal('forwardModal'));
            }

            if (confirmForwardBtn) {
                confirmForwardBtn.addEventListener('click', async () => {
                    console.log(' Forward confirmation clicked');
                    
                    try {
                        // Get form elements
                        const memberSelectEl = document.getElementById('forwardMemberSelect');
                        const notesEl = document.getElementById('forwardNotes');
                        
                        if (!memberSelectEl || !notesEl) {
                            showNotification('Form elements not found - please refresh the page', 'error');
                            return;
                        }
                        
                        const memberId = memberSelectEl.value;
                        const notes = notesEl.value;

                        // Validation
                        if (!memberId || memberId.trim() === '' || memberId === 'Select a member...') {
                            showNotification('Please select a member to forward the ticket to', 'error');
                            return;
                        }

                        // Validate session member_id for forwarding
                        const sessionMemberId = "{{ session.member_id if session.member_id else '' }}";
                        if (!sessionMemberId || sessionMemberId === 'None' || sessionMemberId === 'null' || sessionMemberId === '') {
                            showNotification('Session expired. Please refresh the page and log in again.', 'error');
                            return;
                        }

                        // Prepare API request
                        const requestBody = {
                            member_id: memberId.trim(),
                            notes: notes.trim(),
                            is_forwarded: true,
                            forwarded_from: sessionMemberId
                        };

                        console.log(' Preparing forward request:', requestBody);

                        // Disable button to prevent double-clicks
                        confirmForwardBtn.disabled = true;
                        confirmForwardBtn.innerHTML = ' Forwarding...';

                        const response = await fetch(`/api/tickets/{{ ticket.ticket_id }}/assign`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(requestBody)
                        });

                        const data = await response.json();

                        if (response.ok && data.status === 'success') {
                            console.log(' Forward SUCCESS!');
                            
                            const successMessage = data.message || `Ticket successfully forwarded!`;
                            showNotification(successMessage, 'success');
                            
                            // Close modal and reset form
                            closeModal('forwardModal');
                            memberSelectEl.value = '';
                            notesEl.value = '';
                            
                            // Refresh the page to show updated assignment
                            setTimeout(() => {
                                window.location.reload();
                            }, 1500);
                        } else {
                            console.error(' Forward FAILED:', data);
                            
                            let errorMessage = 'Failed to forward ticket';
                            if (data.message) {
                                errorMessage = data.message;
                            }
                            
                            showNotification(errorMessage, 'error');
                            
                            // Reset button
                            confirmForwardBtn.disabled = false;
                            confirmForwardBtn.innerHTML = 'Forward Ticket';
                        }
                    } catch (error) {
                        console.error(' Forward Error:', error);
                        
                        // Reset button
                        confirmForwardBtn.disabled = false;
                        confirmForwardBtn.innerHTML = 'Forward Ticket';
                        
                        showNotification('An error occurred while forwarding ticket', 'error');
                    }
                });
            }
        });

        // Mobile menu toggle function
        function toggleMobileMenu() {
            const mobileMenu = document.getElementById('mobileMenu');
            if (mobileMenu) {
                mobileMenu.classList.toggle('hidden');
            }
        }

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(event) {
            const mobileMenu = document.getElementById('mobileMenu');
            const menuButton = document.querySelector('.mobile-menu-btn');
            
            if (mobileMenu && !mobileMenu.contains(event.target) && !menuButton.contains(event.target)) {
                mobileMenu.classList.add('hidden');
            }
        });

        // AI Warranty Form Analysis
        async function analyzeWarrantyForm(ticketId) {
            try {
                const button = event.target.closest('button');
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Analyzing...';
                button.disabled = true;

                const response = await fetch(`/api/tickets/${ticketId}/analyze-warranty-form`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();

                if (data.status === 'success') {
                    showWarrantyFormAnalysis(data, ticketId);
                } else {
                    showNotification(data.message || 'Analysis failed', 'error');
                }

                button.innerHTML = originalText;
                button.disabled = false;
            } catch (error) {
                console.error('Error analyzing warranty form:', error);
                showNotification('Analysis failed', 'error');
                
                const button = event.target.closest('button');
                button.innerHTML = '<i class="fas fa-robot mr-1"></i> AI Analyze';
                button.disabled = false;
            }
        }

        function showWarrantyFormAnalysis(data, ticketId) {
            const analysis = data.analysis;
            const suggestions = data.suggestions;
            
            let statusColor = analysis.is_warranty_form ? 'green' : 'red';
            let statusText = analysis.is_warranty_form ? 'Warranty Form Detected' : 'Not a Warranty Form';
            
            const modalContent = `
                <div class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50" id="warrantyAnalysisModal">
                    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4">
                        <div class="px-6 py-2 border-b border-gray-200">
                            <h3 class="text-xs font-semibold text-gray-900 flex items-center">
                                <i class="fas fa-robot mr-2 text-blue-600"></i>
                                AI Warranty Form Analysis
                            </h3>
                        </div>
                        
                        <div class="p-2">
                            <div class="mb-1">
                                <div class="flex items-center mb-1">
                                    <span class="px-2 py-1 rounded-full text-xs font-medium bg-${statusColor}-100 text-${statusColor}-800">
                                        ${statusText}
                                    </span>
                                    <span class="ml-3 text-xs text-gray-600">Confidence: ${analysis.confidence}%</span>
                                </div>
                            </div>
                            
                            <div class="bg-gray-50 rounded-lg p-4 mb-1">
                                <h4 class="font-medium text-gray-700 mb-1">Analysis Details:</h4>
                                <ul class="text-xs text-gray-600 space-y-1">
                                    <li> Valid file type: ${analysis.analysis.valid_file_type ? 'Yes' : 'No'}</li>
                                    <li> Contains warranty keywords: ${analysis.analysis.has_warranty_keywords ? 'Yes' : 'No'}</li>
                                    ${analysis.analysis.detected_keywords && analysis.analysis.detected_keywords.length > 0 
                                        ? `<li> Detected keywords: ${analysis.analysis.detected_keywords.join(', ')}</li>` 
                                        : ''}
                                </ul>
                            </div>
                            
                            ${analysis.is_warranty_form ? `
                                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-1">
                                    <h4 class="font-medium text-green-800 mb-1">AI Recommendation:</h4>
                                    <p class="text-xs text-green-700">Update ticket status to "Warranty Form Received"</p>
                                </div>
                                
                                <div class="space-y-3">
                                    <p class="text-xs text-gray-700">Is this analysis correct?</p>
                                    <div class="flex space-x-1">
                                        <button onclick="confirmWarrantyForm('${ticketId}', true)" 
                                                class="bg-green-600 hover:bg-green-700 text-white px-2 py-2 rounded-lg text-xs font-medium transition">
                                            <i class="fas fa-check mr-2"></i>Yes, Correct
                                        </button>
                                        <button onclick="confirmWarrantyForm('${ticketId}', false)" 
                                                class="bg-red-600 hover:bg-red-700 text-white px-2 py-2 rounded-lg text-xs font-medium transition">
                                            <i class="fas fa-times mr-2"></i>No, Incorrect
                                        </button>
                                    </div>
                                </div>
                            ` : `
                                <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-1">
                                    <h4 class="font-medium text-orange-800 mb-1">Manual Review Required:</h4>
                                    <p class="text-xs text-orange-700">AI couldn't confidently identify this as a warranty form. Please review manually.</p>
                                </div>
                                
                                <div class="space-y-3">
                                    <p class="text-xs text-gray-700">Is this actually a warranty form?</p>
                                    <div class="flex space-x-1">
                                        <button onclick="confirmWarrantyForm('${ticketId}', true)" 
                                                class="bg-green-600 hover:bg-green-700 text-white px-2 py-2 rounded-lg text-xs font-medium transition">
                                            <i class="fas fa-check mr-2"></i>Yes, It's a Warranty Form
                                        </button>
                                        <button onclick="confirmWarrantyForm('${ticketId}', false)" 
                                                class="bg-gray-600 hover:bg-gray-700 text-white px-2 py-2 rounded-lg text-xs font-medium transition">
                                            <i class="fas fa-times mr-2"></i>No, It's Not
                                        </button>
                                    </div>
                                </div>
                            `}
                        </div>
                        
                        <div class="px-6 py-2 border-t border-gray-200 flex justify-end">
                            <button onclick="closeWarrantyAnalysisModal()" 
                                    class="px-2 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalContent);
        }

        async function confirmWarrantyForm(ticketId, isCorrect) {
            try {
                const response = await fetch(`/api/tickets/${ticketId}/confirm-warranty-form`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        is_correct: isCorrect,
                        feedback: isCorrect ? 'User confirmed AI detection' : 'User rejected AI detection'
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    showNotification(data.message, 'success');
                    closeWarrantyAnalysisModal();
                    
                    if (isCorrect && data.new_status) {
                        // Optionally reload the page to show updated status
                        // PERFORMANCE FIX: Reduced reload delay
                        setTimeout(() => window.location.reload(), 3000);
                    }
                } else {
                    showNotification(data.message || 'Confirmation failed', 'error');
                }
            } catch (error) {
                console.error('Error confirming warranty form:', error);
                showNotification('Confirmation failed', 'error');
            }
        }

        function closeWarrantyAnalysisModal() {
            const modal = document.getElementById('warrantyAnalysisModal');
            if (modal) {
                modal.remove();
            }
        }

        // Email Template Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const emailTemplateBtn = document.getElementById('emailTemplateBtn');
            const emailTemplateModal = document.getElementById('emailTemplateModal');
            const closeEmailTemplateModal = document.getElementById('closeEmailTemplateModal');
            const cancelEmailTemplate = document.getElementById('cancelEmailTemplate');
            const loadTemplate = document.getElementById('loadTemplate');
            const sendEmail = document.getElementById('sendEmail');
            const templateTypeSelect = document.getElementById('templateTypeSelect');
            const emailSubject = document.getElementById('emailSubject');
            const emailBody = document.getElementById('emailBody');
            const availableAttachments = document.getElementById('availableAttachments');

            let currentTemplateData = null;

            // Email Template Button - CONSOLIDATED (moved to main initialization)

            // Close modal handlers
            closeEmailTemplateModal.addEventListener('click', () => closeModal('emailTemplateModal'));
            cancelEmailTemplate.addEventListener('click', () => closeModal('emailTemplateModal'));
            
            // Close modal on outside click
            emailTemplateModal.addEventListener('click', (e) => {
                if (e.target === emailTemplateModal) {
                    closeModal('emailTemplateModal');
                }
            });

            // Load template button
            loadTemplate.addEventListener('click', async function() {
                const templateType = templateTypeSelect.value;
                const ticketId = '{{ ticket.ticket_id }}';

                if (!templateType) {
                    showNotification('Please select a template type', 'error');
                    return;
                }

                try {
                    // Show loading
                    loadTemplate.disabled = true;
                    loadTemplate.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';

                    const response = await fetch(`/api/email-template/${templateType}/${ticketId}`);
                    const data = await response.json();

                    if (response.ok && data.status === 'success') {
                        currentTemplateData = data.template;
                        
                        // Populate form fields
                        emailSubject.value = currentTemplateData.subject;
                        emailBody.value = currentTemplateData.body;
                        
                        // Populate attachments
                        populateAttachments(currentTemplateData.attachments);
                        
                        // Enable send button
                        sendEmail.disabled = false;
                        
                        showNotification('Template loaded successfully!', 'success');
                    } else {
                        showNotification(data.message || 'Failed to load template', 'error');
                    }
                } catch (error) {
                    console.error('Error loading template:', error);
                    showNotification('Error loading template', 'error');
                } finally {
                    // Reset button
                    loadTemplate.disabled = false;
                    loadTemplate.innerHTML = '<i class="fas fa-download mr-2"></i>Load Template';
                }
            });

            // Send email button (placeholder - would integrate with actual email service)
            sendEmail.addEventListener('click', function() {
                if (!currentTemplateData) {
                    showNotification('Please load a template first', 'error');
                    return;
                }

                // Get selected attachments
                const selectedAttachments = [];
                const checkboxes = availableAttachments.querySelectorAll('input[type="checkbox"]:checked');
                checkboxes.forEach(checkbox => {
                    selectedAttachments.push({
                        name: checkbox.dataset.name,
                        file_path: checkbox.dataset.filePath
                    });
                });

                // In production, this would send the actual email
                const emailData = {
                    to: currentTemplateData.recipient_email,
                    subject: emailSubject.value,
                    body: emailBody.value,
                    attachments: selectedAttachments
                };

                console.log('Email would be sent with data:', emailData);
                
                // Show success message (placeholder)
                showNotification('Email template prepared! (Integration with email service required for actual sending)', 'success');
                closeModal('emailTemplateModal');
            });

            // Priority selection functionality
            const prioritySelect = document.getElementById('prioritySelect');
            if (prioritySelect) {
                prioritySelect.addEventListener('change', async function() {
                    const newPriority = this.value;
                    const ticketId = this.dataset.ticketId;
                    
                    try {
                        const response = await fetch(`/api/tickets/${ticketId}/priority`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ priority: newPriority })
                        });
                        
                        const data = await response.json();
                        if (response.ok && data.status === 'success') {
                            showNotification(`Priority updated to ${newPriority}`, 'success');
                            
                            // Update the select styling based on new priority
                            this.className = this.className.replace(/bg-\w+-100 text-\w+-800/g, '');
                            this.classList.add('px-2', 'py-1', 'text-xs', 'rounded-full', 'font-medium', 'border-none', 'bg-transparent', 'appearance-none', 'cursor-pointer', 'hover:opacity-80', 'transition');
                            if (newPriority === 'Urgent') {
                                this.classList.add('bg-red-100', 'text-red-800');
                            } else if (newPriority === 'High') {
                                this.classList.add('bg-orange-100', 'text-orange-800');
                            } else if (newPriority === 'Medium') {
                                this.classList.add('bg-yellow-100', 'text-yellow-800');
                            } else if (newPriority === 'Low') {
                                this.classList.add('bg-green-100', 'text-green-800');
                            }
                            
                        } else {
                            showNotification(data.message || 'Error updating priority', 'error');
                            // Revert to previous value
                            location.reload();
                        }
                    } catch (error) {
                        console.error('Error updating priority:', error);
                        showNotification('An error occurred while updating priority', 'error');
                        location.reload();
                    }
                });
            }

            // Classification selection functionality
            const classificationSelect = document.getElementById('classificationSelect');
            if (classificationSelect) {
                classificationSelect.addEventListener('change', async function() {
                    const newClassification = this.value;
                    const ticketId = this.dataset.ticketId;
                    
                    try {
                        const response = await fetch(`/api/tickets/${ticketId}/classification`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ classification: newClassification })
                        });
                        
                        const data = await response.json();
                        if (response.ok && data.status === 'success') {
                            showNotification(`Classification updated to ${newClassification}`, 'success');
                            
                            // Update the select styling based on new classification
                            this.className = this.className.replace(/bg-\w+-100 text-\w+-700/g, '');
                            this.classList.add('px-2', 'py-1', 'text-xs', 'rounded-md', 'font-medium', 'border', 'border-gray-200', 'appearance-none', 'cursor-pointer', 'hover:bg-gray-50', 'transition');
                            if (newClassification === 'Technical') {
                                this.classList.add('bg-indigo-100', 'text-indigo-700');
                            } else if (newClassification === 'Payment') {
                                this.classList.add('bg-purple-100', 'text-purple-700');
                            } else if (newClassification === 'Account') {
                                this.classList.add('bg-violet-100', 'text-violet-700');
                            } else {
                                this.classList.add('bg-pink-100', 'text-pink-700');
                            }
                            
                        } else {
                            showNotification(data.message || 'Error updating classification', 'error');
                            // Revert to previous value
                            location.reload();
                        }
                    } catch (error) {
                        console.error('Error updating classification:', error);
                        showNotification('An error occurred while updating classification', 'error');
                        location.reload();
                    }
                });
            }

            // Outcome editing functionality
            const editOutcomeBtn = document.getElementById('editOutcomeBtn');
            const outcomeDisplayView = document.getElementById('outcomeDisplayView');
            const outcomeEditView = document.getElementById('outcomeEditView');
            const outcomeForm = document.getElementById('outcomeForm');
            const cancelOutcomeBtn = document.getElementById('cancelOutcomeBtn');

            if (editOutcomeBtn) {
                editOutcomeBtn.addEventListener('click', function() {
                    outcomeDisplayView.classList.add('hidden');
                    outcomeEditView.classList.remove('hidden');
                });
            }

            if (cancelOutcomeBtn) {
                cancelOutcomeBtn.addEventListener('click', function() {
                    outcomeEditView.classList.add('hidden');
                    outcomeDisplayView.classList.remove('hidden');
                });
            }

            if (outcomeForm) {
                outcomeForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const ticketId = "{{ ticket.ticket_id }}";
                    const outcomeCategory = document.getElementById('outcomeCategory').value;
                    const revisitCarriedOut = document.getElementById('revisitCarriedOut').checked;
                    const cleanUnderWarranty = document.getElementById('cleanUnderWarranty').checked;
                    const outcomeNotes = document.getElementById('outcomeNotes').value;
                    
                    const saveBtn = document.getElementById('saveOutcomeBtn');
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
                    
                    try {
                        const response = await fetch(`/api/tickets/${ticketId}/outcome`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                outcome_category: outcomeCategory,
                                revisit_carried_out: revisitCarriedOut,
                                clean_under_warranty: cleanUnderWarranty,
                                outcome_notes: outcomeNotes
                            })
                        });
                        
                        const data = await response.json();
                        if (response.ok && data.status === 'success') {
                            showNotification('Outcome information updated successfully', 'success');
                            
                            // Hide edit form and show display view immediately
                            outcomeEditView.classList.add('hidden');
                            outcomeDisplayView.classList.remove('hidden');
                            
                            // Force cache-busting reload to ensure fresh data from database
                            setTimeout(() => {
                                window.location.href = window.location.href + '?t=' + Date.now();
                            }, 2000);
                        } else {
                            showNotification(data.message || 'Error updating outcome', 'error');
                        }
                    } catch (error) {
                        console.error('Error updating outcome:', error);
                        showNotification('An error occurred while updating outcome', 'error');
                    } finally {
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Save Outcome';
                    }
                });
            }

            function resetEmailTemplateForm() {
                emailSubject.value = '';
                emailBody.value = '';
                availableAttachments.innerHTML = '';
                sendEmail.disabled = true;
                currentTemplateData = null;
            }

            function populateAttachments(attachments) {
                if (!attachments || attachments.length === 0) {
                    availableAttachments.innerHTML = '<p class="text-xs text-gray-500">No attachments available for this ticket.</p>';
                    return;
                }

                const attachmentHTML = attachments.map(attachment => `
                    <div class="flex items-center space-x-1 p-2 bg-gray-50 rounded">
                        <input type="checkbox" id="attachment_${attachment.name}" 
                               data-name="${attachment.name}" 
                               data-file-path="${attachment.file_path}"
                               class="form-checkbox text-green-600">
                        <label for="attachment_${attachment.name}" class="text-xs text-gray-700 flex-1">
                            <i class="fas fa-paperclip mr-1"></i>${attachment.name}
                        </label>
                    </div>
                `).join('');

                availableAttachments.innerHTML = attachmentHTML;
            }
        });

        // REMOVED - Duplicate DOMContentLoaded listener that was causing conflicts

        //  FINAL BUTTON FIX - OVERRIDE ALL CONFLICTS
        // REMOVED - Duplicate setTimeout override causing conflicts

        // Initialize attachment button handlers
        function initializeAttachmentButtons() {
            // View attachment handlers
            document.querySelectorAll('.view-attachment-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const filename = this.getAttribute('data-filename');
                    const index = this.getAttribute('data-index');
                    if (typeof viewAttachment === 'function') {
                        viewAttachment(filename, parseInt(index));
                    }
                });
            });

            // Download attachment handlers
            document.querySelectorAll('.download-attachment-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const filename = this.getAttribute('data-filename');
                    const index = this.getAttribute('data-index');
                    if (typeof downloadAttachment === 'function') {
                        downloadAttachment(filename, parseInt(index));
                    }
                });
            });
        }

        // Format file sizes
        function formatFileSizes() {
            document.querySelectorAll('.file-size-display').forEach(element => {
                const bytes = parseInt(element.getAttribute('data-size')) || 0;
                if (bytes < 1024) {
                    element.textContent = bytes + ' B';
                } else if (bytes < 1048576) {
                    element.textContent = (bytes / 1024).toFixed(1) + ' KB';
                } else {
                    element.textContent = (bytes / 1048576).toFixed(1) + ' MB';
                }
            });
        }

        // Initialize on DOM load
        document.addEventListener('DOMContentLoaded', function() {
            initializeAttachmentButtons();
            formatFileSizes();
        });
    </script>
</body>
</html>
